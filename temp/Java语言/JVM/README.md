# JVM

## å®šä¹‰

Java Virtual Machineï¼ŒJAVAç¨‹åºçš„**è¿è¡Œç¯å¢ƒ**ï¼ˆJAVAäºŒè¿›åˆ¶å­—èŠ‚ç çš„è¿è¡Œç¯å¢ƒï¼‰

## å¥½å¤„

- $\textcolor{OliveGreen}{ä¸€æ¬¡ç¼–å†™ï¼Œåˆ°å¤„è¿è¡Œ}$
- $\textcolor{OliveGreen}{è‡ªåŠ¨å†…å­˜ç®¡ç†ï¼Œåƒåœ¾å›æ”¶æœºåˆ¶}$
- $\textcolor{OliveGreen}{æ•°ç»„ä¸‹æ ‡è¶Šç•Œæ£€æŸ¥}$

## æ¯”è¾ƒ

JVM JRE JDKçš„åŒºåˆ«

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150422.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150422.png)



# å†…å­˜ç»“æ„

## æ•´ä½“æ¶æ„

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150440.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150440.png)



### 1.ç¨‹åºè®¡æ•°å™¨

#### 1.1 ä½œç”¨

$\textcolor{OliveGreen}{ç”¨äºä¿å­˜jvmä¸­ä¸‹ä¸€æ¡æ‰€è¦æ‰§è¡Œçš„æŒ‡ä»¤çš„åœ°å€}$

#### 1.2 ç‰¹ç‚¹

- $\textcolor{OliveGreen}{çº¿ç¨‹ç§æœ‰}$
  - CPUä¼šä¸ºæ¯ä¸ªçº¿ç¨‹åˆ†é…æ—¶é—´ç‰‡ï¼Œå½“å½“å‰çº¿ç¨‹çš„æ—¶é—´ç‰‡ä½¿ç”¨å®Œä»¥åï¼ŒCPUå°±ä¼šå»æ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹ä¸­çš„ä»£ç 
  - ç¨‹åºè®¡æ•°å™¨æ˜¯**æ¯ä¸ªçº¿ç¨‹**æ‰€**ç§æœ‰**çš„ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹çš„æ—¶é—´ç‰‡ç”¨å®Œï¼Œåˆè¿”å›æ¥æ‰§è¡Œå½“å‰çº¿ç¨‹çš„ä»£ç æ—¶ï¼Œé€šè¿‡ç¨‹åºè®¡æ•°å™¨å¯ä»¥çŸ¥é“åº”è¯¥æ‰§è¡Œå“ªä¸€å¥æŒ‡ä»¤
- $\textcolor{OliveGreen}{ä¸ä¼šå­˜åœ¨å†…å­˜æº¢å‡º}$



### 2.è™šæ‹Ÿæœºæ ˆ

- -Xss

#### 2.1 å®šä¹‰

- æ¯ä¸ª**çº¿ç¨‹**è¿è¡Œéœ€è¦çš„å†…å­˜ç©ºé—´ï¼Œç§°ä¸º**è™šæ‹Ÿæœºæ ˆ**
- æ¯ä¸ªæ ˆç”±å¤šä¸ª**æ ˆå¸§**ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜
- æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰**ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§**ï¼Œå¯¹åº”ç€**å½“å‰æ­£åœ¨æ‰§è¡Œçš„æ–¹æ³•**

##### æ¼”ç¤º

```java
public class Main {
	public static void main(String[] args) {
		method1();
	}

	private static void method1() {
		method2(1, 2);
	}

	private static int method2(int a, int b) {
		int c = a + b;
		return c;
	}
}
```

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150534.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150534.png)

åœ¨æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°ï¼Œä¸»ç±»ä¸­çš„æ–¹æ³•åœ¨è¿›å…¥è™šæ‹Ÿæœºæ ˆçš„æ—¶å€™ï¼Œç¬¦åˆæ ˆçš„ç‰¹ç‚¹

##### é—®é¢˜è¾¨æ

- åƒåœ¾å›æ”¶æ˜¯å¦æ¶‰åŠæ ˆå†…å­˜ï¼Ÿ
  - **ä¸éœ€è¦**ã€‚å› ä¸ºè™šæ‹Ÿæœºæ ˆä¸­æ˜¯ç”±ä¸€ä¸ªä¸ªæ ˆå¸§ç»„æˆçš„ï¼Œåœ¨æ–¹æ³•æ‰§è¡Œå®Œæ¯•åï¼Œå¯¹åº”çš„æ ˆå¸§å°±ä¼šè¢«å¼¹å‡ºæ ˆã€‚æ‰€ä»¥æ— éœ€é€šè¿‡åƒåœ¾å›æ”¶æœºåˆ¶å»å›æ”¶å†…å­˜ã€‚
- æ ˆå†…å­˜çš„åˆ†é…è¶Šå¤§è¶Šå¥½å—ï¼Ÿ
  - ä¸æ˜¯ã€‚å› ä¸º**ç‰©ç†å†…å­˜æ˜¯ä¸€å®šçš„**ï¼Œæ ˆå†…å­˜è¶Šå¤§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤šçš„é€’å½’è°ƒç”¨ï¼Œä½†æ˜¯å¯æ‰§è¡Œçš„çº¿ç¨‹æ•°å°±ä¼šè¶Šå°‘ã€‚
- æ–¹æ³•å†…çš„å±€éƒ¨å˜é‡æ˜¯å¦æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ
  - å¦‚æœæ–¹æ³•å†…**å±€éƒ¨å˜é‡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´**ï¼Œåˆ™æ˜¯**çº¿ç¨‹å®‰å…¨**çš„
  - å¦‚æœå¦‚æœ**å±€éƒ¨å˜é‡å¼•ç”¨äº†å¯¹è±¡**ï¼Œå¹¶**é€ƒç¦»äº†æ–¹æ³•çš„ä½œç”¨èŒƒå›´**ï¼Œåˆ™éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜

#### 2.2 å†…å­˜æº¢å‡º

`Java.lang.stackOverflowError` æ ˆå†…å­˜æº¢å‡º

##### åŸå› 

- $\textcolor{OliveGreen}{è™šæ‹Ÿæœºæ ˆä¸­ï¼Œæ ˆå¸§è¿‡å¤šï¼ˆæ— é™é€’å½’ï¼‰}$
- $\textcolor{OliveGreen}{æ¯ä¸ªæ ˆå¸§æ‰€å ç”¨è¿‡å¤§}$

#### 2.3 çº¿ç¨‹è¿è¡Œè¯Šæ–­

CPUå ç”¨è¿‡é«˜

- Linuxç¯å¢ƒä¸‹è¿è¡ŒæŸäº›ç¨‹åºçš„æ—¶å€™ï¼Œå¯èƒ½å¯¼è‡´CPUçš„å ç”¨è¿‡é«˜ï¼Œè¿™æ—¶éœ€è¦å®šä½å ç”¨CPUè¿‡é«˜çš„çº¿ç¨‹
  - `top`å‘½ä»¤ï¼ŒæŸ¥çœ‹æ˜¯å“ªä¸ª**è¿›ç¨‹**å ç”¨CPUè¿‡é«˜
  - `ps H -eo pid, tid, %cpu | grep + è¿›ç¨‹id`  é€šè¿‡ `ps`å‘½ä»¤è¿›ä¸€æ­¥æŸ¥çœ‹æ˜¯å“ªä¸ª**çº¿ç¨‹**å ç”¨CPUè¿‡é«˜
  - `jstack + è¿›ç¨‹id` é€šè¿‡æŸ¥çœ‹è¿›ç¨‹ä¸­çš„çº¿ç¨‹çš„`tid`ï¼Œé€šè¿‡`ps`å‘½ä»¤æŸ¥çœ‹çš„`tid`æ¥**å¯¹æ¯”å®šä½**ï¼Œæ³¨æ„`jstack`æŸ¥æ‰¾å‡ºçš„çº¿ç¨‹`tid`æ˜¯**16è¿›åˆ¶çš„**ï¼Œ**éœ€è¦è½¬æ¢**



### 3.æœ¬åœ°æ–¹æ³•æ ˆ

ä¸€äº›å¸¦æœ‰`native`**å…³é”®å­—**çš„æ–¹æ³•å°±æ˜¯éœ€è¦JAVAå»è°ƒç”¨æœ¬åœ°çš„Cæˆ–è€…C++æ–¹æ³•ï¼Œå› ä¸ºJAVAæœ‰æ—¶å€™æ²¡æ³•ç›´æ¥å’Œæ“ä½œç³»ç»Ÿåº•å±‚äº¤äº’ï¼Œæ‰€ä»¥éœ€è¦ç”¨åˆ°æœ¬åœ°æ–¹æ³•



### 4.å †

- -Xmx

#### 4.1 å®šä¹‰

é€šè¿‡newå…³é”®å­—**åˆ›å»ºçš„å¯¹è±¡**éƒ½ä¼šè¢«æ”¾åœ¨å †å†…å­˜

##### ç‰¹ç‚¹

- $\textcolor{OliveGreen}{æ‰€æœ‰çº¿ç¨‹å…±äº«ï¼Œå †å†…å­˜ä¸­çš„å¯¹è±¡éƒ½éœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜}$
- $ \textcolor{OliveGreen}{æœ‰åƒåœ¾å›æ”¶æœºåˆ¶}$

#### 4.2 å †å†…å­˜æº¢å‡º

`java.lang.OutofMemoryError: Java heap space ` å †å†…å­˜æº¢å‡º

#### 4.3 å †å†…å­˜è¯Šæ–­å·¥å…·

- `jps`
  - æŸ¥çœ‹å½“å‰ç³»ç»Ÿä¸­æœ‰å“ªäº›javaè¿›ç¨‹

- `jmap`
  - æŸ¥çœ‹å †å†…å­˜å ç”¨æƒ…å†µï¼ˆæŸä¸€æ—¶åˆ»ï¼‰

- `jconsole`
  - å›¾å½¢åŒ–ç•Œé¢ï¼Œå¤šåŠŸèƒ½çš„ç›‘æµ‹å·¥å…·ï¼Œå¯ä»¥è¿ç»­ç›‘æµ‹

- `jvirsalvm`



### 5.æ–¹æ³•åŒº

#### 5.1 ç»“æ„

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150547.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150547.png)

#### 5.2 å†…å­˜æº¢å‡º

- 1.8ä»¥å‰ä¼šå¯¼è‡´**æ°¸ä¹…ä»£**å†…å­˜æº¢å‡º 
  - `-XX:MaxPermSize=8m`
  - `java.lang.OutOfMemoryError: PermGen space`
- 1.8ä»¥åä¼šå¯¼è‡´**å…ƒç©ºé—´**å†…å­˜æº¢å‡º
  - å…ƒç©ºé—´ä½¿ç”¨ç³»ç»Ÿå†…å­˜
  - ` -XX:MaxMetaspaceSize=8m`
  - `java.lang.OutOfMemoryError: Metaspace`

#### 5.3 è¿è¡Œæ—¶å¸¸é‡æ± 

- äºŒè¿›åˆ¶å­—èŠ‚ç çš„ç»„æˆ
  - ç±»çš„åŸºæœ¬ä¿¡æ¯
  - å¸¸é‡æ± 
  - ç±»çš„æ–¹æ³•å®šä¹‰ï¼ˆåŒ…å«äº†è™šæ‹ŸæœºæŒ‡ä»¤ï¼‰

- é€šè¿‡åç¼–è¯‘æ¥æŸ¥çœ‹ç±»çš„ä¿¡æ¯

  - è·å¾—å¯¹åº”ç±»çš„.classæ–‡ä»¶

  - åœ¨æ§åˆ¶å°è¾“å…¥ javap -v ç±»çš„è·¯å¾„

    ```
    javap -v xxx.class
    ```

  - åœ¨æ§åˆ¶å°çœ‹åˆ°åç¼–è¯‘ä»¥åç±»çš„ä¿¡æ¯äº†

    - ç±»çš„åŸºæœ¬ä¿¡æ¯

      [![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150618.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150618.png)

    - å¸¸é‡æ± 

      [![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150630.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150630.png)

      [![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150641.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150641.png)

    - è™šæ‹Ÿæœºä¸­æ‰§è¡Œç¼–è¯‘çš„æ–¹æ³•ï¼ˆæ¡†å†…çš„æ˜¯çœŸæ­£ç¼–è¯‘æ‰§è¡Œçš„å†…å®¹ï¼Œ**#å·çš„å†…å®¹éœ€è¦åœ¨å¸¸é‡æ± ä¸­æŸ¥æ‰¾**ï¼‰

      [![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150653.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150653.png)

##### å¸¸é‡æ± ä¸è¿è¡Œæ—¶å¸¸é‡æ± çš„åŒºåˆ«

- å¸¸é‡æ± 
  - å°±æ˜¯ä¸€å¼ è¡¨ï¼ˆå¦‚ä¸Šå›¾ä¸­çš„constant poolï¼‰ï¼Œè™šæ‹ŸæœºæŒ‡ä»¤æ ¹æ®è¿™å¼ å¸¸é‡è¡¨æ‰¾åˆ°è¦æ‰§è¡Œçš„ç±»åã€æ–¹æ³•åã€å‚æ•°ç±»å‹ã€å­—é¢é‡ä¿¡æ¯
- è¿è¡Œæ—¶å¸¸é‡æ± 
  - å¸¸é‡æ± æ˜¯*.classæ–‡ä»¶ä¸­çš„ï¼Œå½“è¯¥**ç±»è¢«åŠ è½½ä»¥å**ï¼Œå®ƒçš„å¸¸é‡æ± ä¿¡æ¯å°±ä¼š**æ”¾å…¥è¿è¡Œæ—¶å¸¸é‡æ± **ï¼Œå¹¶æŠŠé‡Œé¢çš„**ç¬¦å·åœ°å€å˜ä¸ºçœŸå®åœ°å€**

#### 

#### 5.4 å¸¸é‡æ± ä¸ä¸²æ± çš„å…³ç³»

#### 5.5 **ä¸²æ± ** $String\space Table$

- ç‰¹å¾
  - å¸¸é‡æ± ä¸­çš„å­—ç¬¦ä¸²ä»…æ˜¯ç¬¦å·ï¼Œåªæœ‰**åœ¨è¢«ç”¨åˆ°æ—¶æ‰ä¼šè½¬åŒ–ä¸ºå¯¹è±¡**
  - åˆ©ç”¨ä¸²æ± çš„æœºåˆ¶ï¼Œæ¥é¿å…é‡å¤åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡
  - å­—ç¬¦ä¸²**å˜é‡**æ‹¼æ¥çš„åŸç†æ˜¯ **StringBuilder**
  - å­—ç¬¦ä¸²**å¸¸é‡**æ‹¼æ¥çš„åŸç†æ˜¯**ç¼–è¯‘å™¨ä¼˜åŒ–**
  - å¯ä»¥ä½¿ç”¨**internæ–¹æ³•**ï¼Œä¸»åŠ¨å°†ä¸²æ± ä¸­è¿˜æ²¡æœ‰çš„å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥ä¸²æ± ä¸­
  - **æ³¨æ„**ï¼šæ— è®ºæ˜¯ä¸²æ± è¿˜æ˜¯å †é‡Œé¢çš„å­—ç¬¦ä¸²ï¼Œéƒ½æ˜¯å¯¹è±¡

ç”¨æ¥æ”¾å­—ç¬¦ä¸²å¯¹è±¡ä¸”é‡Œé¢çš„**å…ƒç´ ä¸é‡å¤**



```java
public class StringTableStudy {
	public static void main(String[] args) {
		String a = "a"; 
		String b = "b";
		String ab = "ab";
	}
}
```

å¸¸é‡æ± ä¸­çš„ä¿¡æ¯ï¼Œéƒ½ä¼šè¢«åŠ è½½åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼Œä½†è¿™æ˜¯a b ab ä»…æ˜¯å¸¸é‡æ± ä¸­çš„ç¬¦å·ï¼Œ**è¿˜æ²¡æœ‰æˆä¸ºjavaå­—ç¬¦ä¸²**

```
0: ldc           #2                  // String a
2: astore_1
3: ldc           #3                  // String b
5: astore_2
6: ldc           #4                  // String ab
8: astore_3
9: returnCopy
```

- å½“æ‰§è¡Œåˆ° ldc #2 æ—¶ï¼Œä¼šæŠŠç¬¦å· a å˜ä¸º â€œaâ€ å­—ç¬¦ä¸²å¯¹è±¡ï¼Œ**å¹¶æ”¾å…¥ä¸²æ± ä¸­**ï¼ˆhashtableç»“æ„ ä¸å¯æ‰©å®¹ï¼‰

- å½“æ‰§è¡Œåˆ° ldc #3 æ—¶ï¼Œä¼šæŠŠç¬¦å· b å˜ä¸º â€œbâ€ å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¹¶æ”¾å…¥ä¸²æ± ä¸­

- å½“æ‰§è¡Œåˆ° ldc #4 æ—¶ï¼Œä¼šæŠŠç¬¦å· ab å˜ä¸º â€œabâ€ å­—ç¬¦ä¸²å¯¹è±¡ï¼Œå¹¶æ”¾å…¥ä¸²æ± ä¸­

æœ€ç»ˆ **StringTable [â€œaâ€, â€œbâ€, â€œabâ€]**

**æ³¨æ„**ï¼šå­—ç¬¦ä¸²å¯¹è±¡çš„åˆ›å»ºéƒ½æ˜¯**æ‡’æƒ°çš„**ï¼Œåªæœ‰å½“è¿è¡Œåˆ°é‚£ä¸€è¡Œå­—ç¬¦ä¸²ä¸”åœ¨ä¸²æ± ä¸­ä¸å­˜åœ¨çš„æ—¶å€™ï¼ˆå¦‚ ldc #2ï¼‰æ—¶ï¼Œè¯¥å­—ç¬¦ä¸²æ‰ä¼šè¢«åˆ›å»ºå¹¶æ”¾å…¥ä¸²æ± ä¸­ã€‚



ä½¿ç”¨æ‹¼æ¥**å­—ç¬¦ä¸²å˜é‡å¯¹è±¡**åˆ›å»ºå­—ç¬¦ä¸²çš„è¿‡ç¨‹

```java
public class StringTableStudy {
	public static void main(String[] args) {
		String a = "a";
		String b = "b";
		String ab = "ab";
		// æ‹¼æ¥å­—ç¬¦ä¸²å¯¹è±¡æ¥åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²
		String ab2 = a+b; 
	}
}
```

åç¼–è¯‘åçš„ç»“æœ

```console
 	  Code:
      stack=2, locals=6, args_size=1
         0: ldc           #2         // String a
         2: astore_1
         3: ldc           #3         // String b
         5: astore_2
         6: ldc           #4         // String ab
         8: astore_3
         9: new           #5         // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6         // Method java/lang/StringBuilder."<init>":()V
        16: aload_1
        17: invokevirtual #7         // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
        //ab3åˆå§‹åŒ–æ—¶ç›´æ¥ä»ä¸²æ± ä¸­è·å–å­—ç¬¦ä¸²
        29: ldc           #4                  // String ab
        31: astore        5
        33: return
```

é€šè¿‡æ‹¼æ¥çš„æ–¹å¼æ¥åˆ›å»ºå­—ç¬¦ä¸²çš„**è¿‡ç¨‹**æ˜¯ï¼š`new StringBuilder().append(â€œaâ€).append(â€œbâ€).toString()`

æœ€åçš„toStringæ–¹æ³•çš„è¿”å›å€¼æ˜¯ä¸€ä¸ª**æ–°çš„å­—ç¬¦ä¸²**ï¼Œä½†å­—ç¬¦ä¸²çš„**å€¼**å’Œæ‹¼æ¥çš„å­—ç¬¦ä¸²ä¸€è‡´ï¼Œä½†æ˜¯ä¸¤ä¸ªä¸åŒçš„å­—ç¬¦ä¸²ï¼Œ**ä¸€ä¸ªå­˜åœ¨äºä¸²æ± ä¹‹ä¸­ï¼Œä¸€ä¸ªå­˜åœ¨äºå †å†…å­˜ä¹‹ä¸­**

```java
String ab = "ab";
String ab2 = a+b;
//ç»“æœä¸ºfalse,å› ä¸ºabæ˜¯å­˜åœ¨äºä¸²æ± ä¹‹ä¸­ï¼Œab2æ˜¯ç”±StringBufferçš„toStringæ–¹æ³•æ‰€è¿”å›çš„ä¸€ä¸ªå¯¹è±¡ï¼Œå­˜åœ¨äºå †å†…å­˜ä¹‹ä¸­
System.out.println(ab == ab2); // false
```



ä½¿ç”¨**æ‹¼æ¥å­—ç¬¦ä¸²å¸¸é‡å¯¹è±¡**çš„æ–¹æ³•åˆ›å»ºå­—ç¬¦ä¸²

```java
public class StringTableStudy {
	public static void main(String[] args) {
		String a = "a";
		String b = "b";
		String ab = "ab";
		String ab2 = a+b;
		//ä½¿ç”¨æ‹¼æ¥å­—ç¬¦ä¸²çš„æ–¹æ³•åˆ›å»ºå­—ç¬¦ä¸²
		String ab3 = "a" + "b";
    
    System.out.println(ab == ab3); // true
	}
}
```

åç¼–è¯‘åçš„ç»“æœ

```
 	  Code:
      stack=2, locals=6, args_size=1
         0: ldc           #2                  // String a
         2: astore_1
         3: ldc           #3                  // String b
         5: astore_2
         6: ldc           #4                  // String ab
         8: astore_3
         9: new           #5                  // class java/lang/StringBuilder
        12: dup
        13: invokespecial #6                  // Method java/lang/StringBuilder."<init>":()V
        16: aload_1
        17: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        20: aload_2
        21: invokevirtual #7                  // Method java/lang/StringBuilder.append:(Ljava/lang/String;)Ljava/lang/StringBuilder;
        24: invokevirtual #8                  // Method java/lang/StringBuilder.toString:()Ljava/lang/String;
        27: astore        4
        //ab3åˆå§‹åŒ–æ—¶ç›´æ¥ä»ä¸²æ± ä¸­è·å–å­—ç¬¦ä¸²
        29: ldc           #4                  // String ab
        31: astore        5
        33: returnCopy
```

- ä½¿ç”¨**æ‹¼æ¥å­—ç¬¦ä¸²å¸¸é‡**çš„æ–¹æ³•æ¥åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸º**å†…å®¹æ˜¯å¸¸é‡ï¼Œjavacåœ¨ç¼–è¯‘æœŸä¼šè¿›è¡Œä¼˜åŒ–ï¼Œç»“æœå·²åœ¨ç¼–è¯‘æœŸç¡®å®šä¸ºab**ï¼Œè€Œåˆ›å»ºabçš„æ—¶å€™å·²ç»åœ¨ä¸²æ± ä¸­æ”¾å…¥äº†â€œabâ€ï¼Œæ‰€ä»¥ab3ç›´æ¥ä»ä¸²æ± ä¸­è·å–å€¼ï¼Œæ‰€ä»¥è¿›è¡Œçš„æ“ä½œå’Œ ab = â€œabâ€ ä¸€è‡´ã€‚

- ä½¿ç”¨**æ‹¼æ¥å­—ç¬¦ä¸²å˜é‡**çš„æ–¹æ³•æ¥åˆ›å»ºæ–°çš„å­—ç¬¦ä¸²æ—¶ï¼Œå› ä¸ºå†…å®¹æ˜¯å˜é‡ï¼Œåªèƒ½**åœ¨è¿è¡ŒæœŸç¡®å®šå®ƒçš„å€¼ï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨StringBuilderæ¥åˆ›å»º**

  

##### internæ–¹æ³• 1.8

è°ƒç”¨å­—ç¬¦ä¸²å¯¹è±¡çš„internæ–¹æ³•ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥åˆ°ä¸²æ± ä¸­

- å¦‚æœä¸²æ± ä¸­æ²¡æœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥æˆåŠŸ
- å¦‚æœæœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥å¤±è´¥

æ— è®ºæ”¾å…¥æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè¿”å›**ä¸²æ± ä¸­**çš„å­—ç¬¦ä¸²å¯¹è±¡

**æ³¨æ„**ï¼šæ­¤æ—¶å¦‚æœè°ƒç”¨internæ–¹æ³•æˆåŠŸï¼Œå †å†…å­˜ä¸ä¸²æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼›å¦‚æœå¤±è´¥ï¼Œåˆ™ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡

**ä¾‹1**

```java
public class Main {
	public static void main(String[] args) {
		// ä¸²æ± ï¼š"a" "b" 
    // å †ï¼šstr new StringBuild.append("a").appned("b").toStirng()
    // å †ï¼šnew String("a") 
    // å †ï¼šnew String("b") 
		String str = new String("a") + new String("b");
		
    // è°ƒç”¨strçš„internæ–¹æ³•ï¼Œæ­¤æ—¶ä¸²æ± ä¸­æ²¡æœ‰"ab"ï¼Œåˆ™ä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡æ”¾å…¥åˆ°ä¸²æ± ä¸­ï¼Œæ­¤æ—¶å †å†…å­˜ä¸ä¸²æ± ä¸­çš„"ab"æ˜¯åŒä¸€ä¸ªå¯¹è±¡
   	// å°†"ab"å¯¹è±¡è¿”å›ç»™str2
		String str2 = str.intern();
		
    // ç»™str3èµ‹å€¼ï¼Œå› ä¸ºæ­¤æ—¶ä¸²æ± ä¸­å·²æœ‰"ab"ï¼Œåˆ™ç›´æ¥å°†ä¸²æ± ä¸­çš„å†…å®¹è¿”å›
		String str3 = "ab";
		
    // å› ä¸ºå †å†…å­˜ä¸ä¸²æ± ä¸­çš„"ab"æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œæ‰€ä»¥ä»¥ä¸‹ä¸¤æ¡è¯­å¥æ‰“å°çš„éƒ½ä¸ºtrue
		System.out.println(str == st2); // true
		System.out.println(str == str3); // true
	}
}
```

**ä¾‹2**

```java
public class Main {
	public static void main(String[] args) {
    // æ­¤å¤„åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡"ab"ï¼Œå› ä¸ºä¸²æ± ä¸­è¿˜æ²¡æœ‰"ab"ï¼Œæ‰€ä»¥å°†å…¶æ”¾å…¥ä¸²æ± ä¸­
		String str3 = "ab";
    
    // ä¸²æ± ï¼š"a" "b" è¢«æ”¾å…¥ä¸²æ± ä¸­
    // å †ï¼šstr
		String str = new String("a") + new String("b");
   
    // æ­¤æ—¶å› ä¸ºåœ¨åˆ›å»ºstr3æ—¶ï¼Œ"ab"å·²å­˜åœ¨ä¸ä¸²æ± ä¸­ï¼Œæ‰€ä»¥æ”¾å…¥å¤±è´¥ï¼Œä½†æ˜¯ä¼šè¿”å›ä¸²æ± ä¸­çš„"ab"
		String str2 = str.intern();
     
    // å †ä¸­ä¸ä¸²æ± ä¸­"ab"ä¸ä¸€æ ·
		System.out.println(str == str2);  // false
		System.out.println(str == str3); // false
		System.out.println(str2 == str3);  // true
	}
}
```



##### internæ–¹æ³• 1.6

è°ƒç”¨å­—ç¬¦ä¸²å¯¹è±¡çš„internæ–¹æ³•ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å°è¯•æ”¾å…¥åˆ°ä¸²æ± ä¸­

- å¦‚æœä¸²æ± ä¸­æ²¡æœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡**å¤åˆ¶**ä¸€ä»½ï¼Œå†æ”¾å…¥åˆ°ä¸²æ± ä¸­
- å¦‚æœæœ‰è¯¥å­—ç¬¦ä¸²å¯¹è±¡ï¼Œåˆ™æ”¾å…¥å¤±è´¥

æ— è®ºæ”¾å…¥æ˜¯å¦æˆåŠŸï¼Œéƒ½ä¼šè¿”å›**ä¸²æ± ä¸­**çš„å­—ç¬¦ä¸²å¯¹è±¡

**æ³¨æ„**ï¼šæ­¤æ—¶æ— è®ºè°ƒç”¨internæ–¹æ³•æˆåŠŸä¸å¦ï¼Œä¸²æ± ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡å’Œå †å†…å­˜ä¸­çš„å­—ç¬¦ä¸²å¯¹è±¡**éƒ½ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡**

**ä¾‹1**

```java
public class Main {
	public static void main(String[] args) {
		// ä¸²æ± ï¼š"a" "b" 
    // å †ï¼šstr new StringBuild.append("a").appned("b").toStirng()
    // å †ï¼šnew String("a") 
    // å †ï¼šnew String("b") 
		String str = new String("a") + new String("b");
		
    // è°ƒç”¨strçš„internæ–¹æ³•ï¼Œæ­¤æ—¶ä¸²æ± ä¸­æ²¡æœ‰"ab"ï¼Œåˆ™ä¼šå°†è¯¥å­—ç¬¦ä¸²å¯¹è±¡å¤åˆ¶ä¸€ä»½æ”¾å…¥åˆ°ä¸²æ± ä¸­ï¼Œæ­¤æ—¶å †å†…å­˜ä¸ä¸²æ± ä¸­çš„"ab"ä¸æ˜¯æ˜¯åŒä¸€ä¸ªå¯¹è±¡
    // ä¸²æ± ï¼šstr2
		String str2 = str.intern();
		
    // ç»™str3èµ‹å€¼ï¼Œå› ä¸ºæ­¤æ—¶ä¸²æ± ä¸­å·²æœ‰"ab"ï¼Œåˆ™ç›´æ¥å°†ä¸²æ± ä¸­çš„å†…å®¹è¿”å›
    // ä¸²æ± ï¼šstr3
		String str3 = "ab";
		
    // å †å†…å­˜å¹¶ä¸æ˜¯ä¸ä¸²æ± "abä¸ºåŒä¸€ä¸ªå¯¹è±¡
		System.out.println(str == st2); // false
		System.out.println(str == str3); // false
    System.out.println(str2 == str3); // true
	}
}
```

**ä¾‹2**

```java
public class Main {
	public static void main(String[] args) {
    // æ­¤å¤„åˆ›å»ºå­—ç¬¦ä¸²å¯¹è±¡"ab"ï¼Œå› ä¸ºä¸²æ± ä¸­è¿˜æ²¡æœ‰"ab"ï¼Œæ‰€ä»¥å°†å…¶æ”¾å…¥ä¸²æ± ä¸­
		String str3 = "ab";
    
    // ä¸²æ± ï¼š"a" "b" è¢«æ”¾å…¥ä¸²æ± ä¸­
    // å †ï¼šstr
		String str = new String("a") + new String("b");
   
    // æ­¤æ—¶å› ä¸ºåœ¨åˆ›å»ºstr3æ—¶ï¼Œ"ab"å·²å­˜åœ¨ä¸ä¸²æ± ä¸­ï¼Œæ‰€ä»¥æ”¾å…¥å¤±è´¥ï¼Œè¿”å›ä¸²æ± ä¸­çš„"ab"
		String str2 = str.intern();
     
    // å †ä¸­ä¸ä¸²æ± ä¸­"ab"ä¸ä¸€æ ·
		System.out.println(str == str2);  // false
		System.out.println(str == str3); // false
		System.out.println(str2 == str3);  // true
	}
}
```



##### é¢è¯•é¢˜

```java
// jvm1.8
public class Main {
	public static void main(String[] args) {
    // ä¸²æ± ï¼šs1 s2 s3 s5 s6
    // å †ï¼šs4
		String s1 = "a";
    String s2 = "b";
    String s3 = "a" + "b";
    String s4 = s1 + s2;
    String s5 = "ab";
    String s6 = s4.intern();
    
    System.out.println(s3 == s4); // false
    System.out.println(s3 == s5); // true
    System.out.println(s3 == s6); // true
    
    // ä¸²æ± ï¼š"c" "d" x1="cd"
    // å †ï¼šx2="cd"
    String x2 = new String("c") + new String("d");
    String x1 = "cd";
    // ä¸²æ± ä¸­å·²ç»å­˜åœ¨"cd"ï¼Œæ”¾å…¥å¤±è´¥
    x2.intern();
    
    System.out.println(x1 == x2); // false
	}
}
```



#### 5.6 StringTable ä½ç½®

![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150547.png)



#### 5.7 StringTable åƒåœ¾å›æ”¶

StringTableåœ¨å†…å­˜ç´§å¼ æ—¶ï¼Œä¼šå‘ç”Ÿåƒåœ¾å›æ”¶



#### 5.8 StringTable è°ƒä¼˜

- å› ä¸ºStringTableæ˜¯ç”±HashTableå®ç°çš„ï¼Œæ‰€ä»¥å¯ä»¥**é€‚å½“å¢åŠ HashTableæ¡¶çš„ä¸ªæ•°**ï¼Œæ¥å‡å°‘å­—ç¬¦ä¸²æ”¾å…¥ä¸²æ± æ‰€éœ€è¦çš„æ—¶é—´

  ```
  -XX:StringTableSize=xxxx(ğŸª£ä¸ªæ•°)
  ```

- è€ƒè™‘æ˜¯å¦éœ€è¦å°†å­—ç¬¦ä¸²å¯¹è±¡å…¥æ± 

  å¯ä»¥é€šè¿‡**internæ–¹æ³•å‡å°‘é‡å¤å…¥æ± **



### 6.ç›´æ¥å†…å­˜

- å±äºæ“ä½œç³»ç»Ÿï¼Œå¸¸è§äºNIOæ“ä½œæ—¶ï¼Œ**ç”¨äºæ•°æ®ç¼“å†²åŒº**
- åˆ†é…å›æ”¶æˆæœ¬è¾ƒé«˜ï¼Œä½†è¯»å†™æ€§èƒ½é«˜
- ä¸å—JVMå†…å­˜å›æ”¶ç®¡ç†

#### æ–‡ä»¶è¯»å†™æµç¨‹

- IO

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150715.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150715.png)

- DirectBuffer

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150736.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150736.png)

ç›´æ¥å†…å­˜æ˜¯æ“ä½œç³»ç»Ÿå’ŒJavaä»£ç **éƒ½å¯ä»¥è®¿é—®çš„ä¸€å—åŒºåŸŸ**ï¼Œæ— éœ€å°†ä»£ç ä»ç³»ç»Ÿå†…å­˜å¤åˆ¶åˆ°Javaå †å†…å­˜ï¼Œä»è€Œæé«˜äº†æ•ˆç‡

#### é‡Šæ”¾åŸç† â“

ç›´æ¥å†…å­˜çš„å›æ”¶ä¸æ˜¯é€šè¿‡JVMçš„åƒåœ¾å›æ”¶æ¥é‡Šæ”¾çš„ï¼Œè€Œæ˜¯é€šè¿‡ `unsafe.freeMemory` æ¥æ‰‹åŠ¨é‡Šæ”¾

```java
// é€šè¿‡ByteBufferç”³è¯·1Mçš„ç›´æ¥å†…å­˜
ByteBuffer byteBuffer = ByteBuffer.allocateDirect(_1M);Copy
```

ç”³è¯·ç›´æ¥å†…å­˜ï¼Œä½†JVMå¹¶ä¸èƒ½å›æ”¶ç›´æ¥å†…å­˜ä¸­çš„å†…å®¹ï¼Œå®ƒæ˜¯å¦‚ä½•å®ç°å›æ”¶çš„å‘¢ï¼Ÿ

allocateDirectçš„å®ç°

```java
public static ByteBuffer allocateDirect(int capacity) {
    return new DirectByteBuffer(capacity);
}
```

DirectByteBufferç±»

```java
DirectByteBuffer(int cap) {   // package-private
   
    super(-1, 0, cap, cap);
    boolean pa = VM.isDirectMemoryPageAligned();
    int ps = Bits.pageSize();
    long size = Math.max(1L, (long)cap + (pa ? ps : 0));
    Bits.reserveMemory(size, cap);

    long base = 0;
    try {
        base = unsafe.allocateMemory(size); //ç”³è¯·å†…å­˜
    } catch (OutOfMemoryError x) {
        Bits.unreserveMemory(size, cap);
        throw x;
    }
    unsafe.setMemory(base, size, (byte) 0);
    if (pa && (base % ps != 0)) {
        // Round up to page boundary
        address = base + ps - (base & (ps - 1));
    } else {
        address = base;
    }
    cleaner = Cleaner.create(this, new Deallocator(base, size, cap)); //é€šè¿‡è™šå¼•ç”¨ï¼Œæ¥å®ç°ç›´æ¥å†…å­˜çš„é‡Šæ”¾ï¼Œthisä¸ºè™šå¼•ç”¨çš„å®é™…å¯¹è±¡
    att = null;
}
```

è¿™é‡Œè°ƒç”¨äº†ä¸€ä¸ªCleanerçš„createæ–¹æ³•ï¼Œä¸”åå°çº¿ç¨‹è¿˜ä¼šå¯¹è™šå¼•ç”¨çš„å¯¹è±¡ç›‘æµ‹ï¼Œå¦‚æœè™šå¼•ç”¨çš„å®é™…å¯¹è±¡ï¼ˆè¿™é‡Œæ˜¯DirectByteBufferï¼‰è¢«å›æ”¶ä»¥åï¼Œå°±ä¼šè°ƒç”¨Cleanerçš„cleanæ–¹æ³•ï¼Œæ¥æ¸…é™¤ç›´æ¥å†…å­˜ä¸­å ç”¨çš„å†…å­˜

```java
public void clean() {
       if (remove(this)) {
           try {
               this.thunk.run(); //è°ƒç”¨runæ–¹æ³•
           } catch (final Throwable var2) {
               AccessController.doPrivileged(new PrivilegedAction<Void>() {
                   public Void run() {
                       if (System.err != null) {
                           (new Error("Cleaner terminated abnormally", var2)).printStackTrace();
                       }

                       System.exit(1);
                       return null;
                   }
               });
           }
```

å¯¹åº”å¯¹è±¡çš„runæ–¹æ³•

```java
public void run() {
    if (address == 0) {
        // Paranoia
        return;
    }
    unsafe.freeMemory(address); //é‡Šæ”¾ç›´æ¥å†…å­˜ä¸­å ç”¨çš„å†…å­˜
    address = 0;
    Bits.unreserveMemory(size, capacity);
}Copy
```

##### ç›´æ¥å†…å­˜çš„å›æ”¶æœºåˆ¶æ€»ç»“

- ä½¿ç”¨äº†Unsafeç±»æ¥å®Œæˆç›´æ¥å†…å­˜çš„åˆ†é…å›æ”¶ï¼Œå›æ”¶éœ€è¦ä¸»åŠ¨è°ƒç”¨freeMemoryæ–¹æ³•
- ByteBufferçš„å®ç°å†…éƒ¨ä½¿ç”¨äº†Cleanerï¼ˆè™šå¼•ç”¨ï¼‰æ¥æ£€æµ‹ByteBufferã€‚ä¸€æ—¦ByteBufferè¢«åƒåœ¾å›æ”¶ï¼Œé‚£ä¹ˆä¼šç”±ReferenceHandleræ¥è°ƒç”¨Cleanerçš„cleanæ–¹æ³•è°ƒç”¨freeMemoryæ¥é‡Šæ”¾å†…å­˜



## åƒåœ¾å›æ”¶

### 1.å¦‚ä½•åˆ¤æ–­å¯¹è±¡å¯ä»¥å›æ”¶

#### 1.1 å¼•ç”¨è®¡æ•°æ³•

å¼Šç«¯ï¼šå¾ªç¯å¼•ç”¨æ—¶ï¼Œä¸¤ä¸ªå¯¹è±¡çš„è®¡æ•°éƒ½ä¸º1ï¼Œå¯¼è‡´ä¸¤ä¸ªå¯¹è±¡éƒ½æ— æ³•è¢«é‡Šæ”¾

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150750.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150750.png)

#### 1.2 å¯è¾¾æ€§åˆ†æç®—æ³• â“

- JVMä¸­çš„åƒåœ¾å›æ”¶å™¨é€šè¿‡**å¯è¾¾æ€§åˆ†æ**æ¥æ¢ç´¢æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡
- æ‰«æå †ä¸­çš„å¯¹è±¡ï¼Œçœ‹èƒ½å¦æ²¿ç€GC Rootå¯¹è±¡ä¸ºèµ·ç‚¹çš„å¼•ç”¨é“¾æ‰¾åˆ°è¯¥å¯¹è±¡ï¼Œå¦‚æœ**æ‰¾ä¸åˆ°ï¼Œåˆ™è¡¨ç¤ºå¯ä»¥å›æ”¶**
- å¯ä»¥ä½œä¸ºGC Rootçš„å¯¹è±¡
  - è™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡
  - æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡
  - æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡
  - æœ¬åœ°æ–¹æ³•æ ˆä¸­JNIï¼ˆå³ä¸€èˆ¬è¯´çš„Nativeæ–¹æ³•ï¼‰å¼•ç”¨çš„å¯¹è±¡

#### 1.3 5ç§å¼•ç”¨

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150800.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150800.png)

##### 1.3.1 å¼ºå¼•ç”¨

â€‹	åªæœ‰GC Root**éƒ½ä¸å¼•ç”¨**è¯¥å¯¹è±¡æ—¶ï¼Œæ‰ä¼šå›æ”¶**å¼ºå¼•ç”¨**å¯¹è±¡

â€‹	å¦‚ä¸Šå›¾Bã€Cå¯¹è±¡éƒ½ä¸å¼•ç”¨A1å¯¹è±¡æ—¶ï¼ŒA1å¯¹è±¡æ‰ä¼šè¢«å›æ”¶

##### 1.3.2 è½¯å¼•ç”¨

â€‹	å½“GC RootæŒ‡å‘è½¯å¼•ç”¨å¯¹è±¡æ—¶ï¼Œåœ¨**å†…å­˜ä¸è¶³æ—¶**ï¼Œä¼š**å›æ”¶è½¯å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡**

â€‹	å¦‚ä¸Šå›¾å¦‚æœBå¯¹è±¡ä¸å†å¼•ç”¨A2å¯¹è±¡ä¸”å†…å­˜ä¸è¶³æ—¶ï¼Œè½¯å¼•ç”¨æ‰€å¼•ç”¨çš„A2å¯¹è±¡å°±ä¼šè¢«å›æ”¶

â€‹	è½¯å¼•ç”¨çš„ä½¿ç”¨

```java
public class Demo1 {
	public static void main(String[] args) {
		final int _4M = 4 * 1024 * 1024;
		// ä½¿ç”¨è½¯å¼•ç”¨å¯¹è±¡ listå’ŒSoftReferenceæ˜¯å¼ºå¼•ç”¨ï¼Œè€ŒSoftReferenceå’Œbyteæ•°ç»„åˆ™æ˜¯è½¯å¼•ç”¨
		List<SoftReference<byte[]>> list = new ArrayList<>();
		SoftReference<byte[]> ref= new SoftReference<>(new byte[_4M]);
	}
}Copy
```

â€‹	å¦‚æœåœ¨åƒåœ¾å›æ”¶æ—¶å‘ç°å†…å­˜ä¸è¶³ï¼Œåœ¨å›æ”¶è½¯å¼•ç”¨æ‰€æŒ‡å‘çš„å¯¹è±¡æ—¶ï¼Œ**è½¯å¼•ç”¨æœ¬èº«ä¸ä¼šè¢«æ¸…ç†**

â€‹	å¦‚æœæƒ³è¦**æ¸…ç†è½¯å¼•ç”¨**ï¼Œéœ€è¦ä½¿**ç”¨å¼•ç”¨é˜Ÿåˆ—**

```java
public class Demo1 {
	public static void main(String[] args) {
		final int _4M = 4*1024*1024;
		// ä½¿ç”¨å¼•ç”¨é˜Ÿåˆ—ï¼Œç”¨äºç§»é™¤å¼•ç”¨ä¸ºç©ºçš„è½¯å¼•ç”¨å¯¹è±¡
		ReferenceQueue<byte[]> queue = new ReferenceQueue<>();
		// ä½¿ç”¨è½¯å¼•ç”¨å¯¹è±¡ listå’ŒSoftReferenceæ˜¯å¼ºå¼•ç”¨ï¼Œè€ŒSoftReferenceå’Œbyteæ•°ç»„åˆ™æ˜¯è½¯å¼•ç”¨
		List<SoftReference<byte[]>> list = new ArrayList<>();
		SoftReference<byte[]> ref= new SoftReference<>(new byte[_4M]);

		// éå†å¼•ç”¨é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰å…ƒç´ ï¼Œåˆ™ç§»é™¤
		Reference<? extends byte[]> poll = queue.poll();
		while(poll != null) {
			// å¼•ç”¨é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œåˆ™ä»é›†åˆä¸­ç§»é™¤è¯¥å…ƒç´ 
			list.remove(poll);
			//ç§»åŠ¨åˆ°å¼•ç”¨é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ 
			po ll = queue.poll();
		}
	}
}
```

**å¤§æ¦‚æ€è·¯ä¸ºï¼š**æŸ¥çœ‹å¼•ç”¨é˜Ÿåˆ—ä¸­æœ‰æ— è½¯å¼•ç”¨ï¼Œå¦‚æœæœ‰ï¼Œåˆ™å°†è¯¥è½¯å¼•ç”¨ä»å­˜æ”¾å®ƒçš„é›†åˆä¸­ç§»é™¤ï¼ˆè¿™é‡Œä¸ºä¸€ä¸ªlisté›†åˆï¼‰

##### 1.3.3 å¼±å¼•ç”¨

â€‹	åªæœ‰å¼±å¼•ç”¨å¼•ç”¨è¯¥å¯¹è±¡æ—¶ï¼Œåœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œ**æ— è®ºå†…å­˜æ˜¯å¦å……è¶³**ï¼Œéƒ½ä¼šå›æ”¶å¼±å¼•ç”¨æ‰€å¼•ç”¨çš„å¯¹è±¡

â€‹	å¦‚ä¸Šå›¾å¦‚æœBå¯¹è±¡ä¸å†å¼•ç”¨A3å¯¹è±¡ï¼Œåˆ™A3å¯¹è±¡ä¼šè¢«å›æ”¶

â€‹	**å¼±å¼•ç”¨çš„ä½¿ç”¨å’Œè½¯å¼•ç”¨ç±»ä¼¼**ï¼Œåªæ˜¯å°† **SoftReference æ¢ä¸ºäº† WeakReference**

##### 1.3.4 è™šå¼•ç”¨

å½“è™šå¼•ç”¨å¯¹è±¡æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«å›æ”¶ä»¥åï¼Œè™šå¼•ç”¨å¯¹è±¡å°±ä¼šè¢«æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œè°ƒç”¨è™šå¼•ç”¨çš„æ–¹æ³•

- è™šå¼•ç”¨çš„ä¸€ä¸ªä½“ç°æ˜¯**é‡Šæ”¾ç›´æ¥å†…å­˜æ‰€åˆ†é…çš„å†…å­˜**ï¼Œå½“å¼•ç”¨çš„å¯¹è±¡ByteBufferè¢«åƒåœ¾å›æ”¶ä»¥åï¼Œè™šå¼•ç”¨å¯¹è±¡Cleanerå°±ä¼šè¢«æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨Cleanerçš„cleanæ–¹æ³•æ¥é‡Šæ”¾ç›´æ¥å†…å­˜
- å¦‚ä¸Šå›¾ï¼ŒBå¯¹è±¡ä¸å†å¼•ç”¨ByteBufferå¯¹è±¡ï¼ŒByteBufferå°±ä¼šè¢«å›æ”¶ã€‚ä½†æ˜¯ç›´æ¥å†…å­˜ä¸­çš„å†…å­˜è¿˜æœªè¢«å›æ”¶ã€‚è¿™æ—¶éœ€è¦å°†è™šå¼•ç”¨å¯¹è±¡Cleaneræ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œç„¶åè°ƒç”¨å®ƒçš„cleanæ–¹æ³•æ¥é‡Šæ”¾ç›´æ¥å†…å­˜

##### 1.3.5 ç»ˆç»“å™¨å¼•ç”¨

æ‰€æœ‰çš„ç±»éƒ½ç»§æ‰¿è‡ªObjectç±»ï¼ŒObjectç±»æœ‰ä¸€ä¸ªfinalizeæ–¹æ³•ã€‚å½“æŸä¸ªå¯¹è±¡ä¸å†è¢«å…¶ä»–çš„å¯¹è±¡æ‰€å¼•ç”¨æ—¶ï¼Œä¼šå…ˆå°†ç»ˆç»“å™¨å¼•ç”¨å¯¹è±¡æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œç„¶åæ ¹æ®ç»ˆç»“å™¨å¼•ç”¨å¯¹è±¡æ‰¾åˆ°å®ƒæ‰€å¼•ç”¨çš„å¯¹è±¡ï¼Œç„¶åè°ƒç”¨è¯¥å¯¹è±¡çš„finalizeæ–¹æ³•ã€‚è°ƒç”¨ä»¥åï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«åƒåœ¾å›æ”¶äº†

- å¦‚ä¸Šå›¾ï¼ŒBå¯¹è±¡ä¸å†å¼•ç”¨A4å¯¹è±¡ã€‚è¿™æ˜¯ç»ˆç»“å™¨å¯¹è±¡å°±ä¼šè¢«æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œå¼•ç”¨é˜Ÿåˆ—ä¼šæ ¹æ®å®ƒï¼Œæ‰¾åˆ°å®ƒæ‰€å¼•ç”¨çš„å¯¹è±¡ã€‚ç„¶åè°ƒç”¨è¢«å¼•ç”¨å¯¹è±¡çš„finalizeæ–¹æ³•ã€‚è°ƒç”¨ä»¥åï¼Œè¯¥å¯¹è±¡å°±å¯ä»¥è¢«åƒåœ¾å›æ”¶äº†

##### å¼•ç”¨é˜Ÿåˆ—

- è½¯å¼•ç”¨å’Œå¼±å¼•ç”¨**å¯ä»¥é…åˆ**å¼•ç”¨é˜Ÿåˆ—
  - åœ¨**å¼±å¼•ç”¨**å’Œ**è™šå¼•ç”¨**æ‰€å¼•ç”¨çš„å¯¹è±¡è¢«å›æ”¶ä»¥åï¼Œä¼šå°†è¿™äº›å¼•ç”¨æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ä¸­ï¼Œæ–¹ä¾¿ä¸€èµ·å›æ”¶è¿™äº›è½¯/å¼±å¼•ç”¨å¯¹è±¡
- è™šå¼•ç”¨å’Œç»ˆç»“å™¨å¼•ç”¨**å¿…é¡»é…åˆ**å¼•ç”¨é˜Ÿåˆ—
  - è™šå¼•ç”¨å’Œç»ˆç»“å™¨å¼•ç”¨åœ¨ä½¿ç”¨æ—¶ä¼šå…³è”ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—



### 2.åƒåœ¾å›æ”¶ç®—æ³•

#### 2.1 æ ‡è®°-æ¸…é™¤

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150813.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150813.png)

**å®šä¹‰**ï¼šæ ‡è®°æ¸…é™¤ç®—æ³•é¡¾åæ€ä¹‰ï¼Œæ˜¯æŒ‡åœ¨è™šæ‹Ÿæœºæ‰§è¡Œåƒåœ¾å›æ”¶çš„è¿‡ç¨‹ä¸­ï¼Œå…ˆé‡‡ç”¨æ ‡è®°ç®—æ³•ç¡®å®šå¯å›æ”¶å¯¹è±¡ï¼Œç„¶ååƒåœ¾æ”¶é›†å™¨æ ¹æ®æ ‡è¯†æ¸…é™¤ç›¸åº”çš„å†…å®¹ï¼Œç»™å †å†…å­˜è…¾å‡ºç›¸åº”çš„ç©ºé—´

- è¿™é‡Œçš„è…¾å‡ºå†…å­˜ç©ºé—´å¹¶ä¸æ˜¯å°†å†…å­˜ç©ºé—´çš„å­—èŠ‚æ¸…0ï¼Œè€Œæ˜¯è®°å½•ä¸‹è¿™æ®µå†…å­˜çš„èµ·å§‹ç»“æŸåœ°å€ï¼Œä¸‹æ¬¡åˆ†é…å†…å­˜çš„æ—¶å€™ï¼Œä¼šç›´æ¥**è¦†ç›–**è¿™æ®µå†…å­˜

**ç¼ºç‚¹**ï¼š**å®¹æ˜“äº§ç”Ÿå¤§é‡çš„å†…å­˜ç¢ç‰‡**ï¼Œå¯èƒ½æ— æ³•æ»¡è¶³å¤§å¯¹è±¡çš„å†…å­˜åˆ†é…ï¼Œä¸€æ—¦å¯¼è‡´æ— æ³•åˆ†é…å¯¹è±¡ï¼Œé‚£å°±ä¼šå¯¼è‡´jvmå¯åŠ¨gcï¼Œä¸€æ—¦å¯åŠ¨gcï¼Œæˆ‘ä»¬çš„åº”ç”¨ç¨‹åºå°±ä¼šæš‚åœï¼Œè¿™å°±å¯¼è‡´åº”ç”¨çš„å“åº”é€Ÿåº¦å˜æ…¢

#### 2.2 æ ‡è®°-æ•´ç†

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150827.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150827.png)

æ ‡è®°-æ•´ç† ä¼šå°†ä¸è¢«GC Rootå¼•ç”¨çš„å¯¹è±¡å›æ”¶ï¼Œæ¸…æ¥šå…¶å ç”¨çš„å†…å­˜ç©ºé—´ã€‚ç„¶åæ•´ç†å‰©ä½™çš„å¯¹è±¡ï¼Œå¯ä»¥æœ‰æ•ˆé¿å…å› å†…å­˜ç¢ç‰‡è€Œå¯¼è‡´çš„é—®é¢˜ï¼Œä½†æ˜¯å› ä¸ºæ•´ä½“éœ€è¦æ¶ˆè€—ä¸€å®šçš„æ—¶é—´ï¼Œæ‰€ä»¥æ•ˆç‡è¾ƒä½

#### 2.3 å¤åˆ¶

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150842.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150842.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150856.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150856.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150907.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150907.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150919.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150919.png)

å°†å†…å­˜åˆ†ä¸ºç­‰å¤§å°çš„ä¸¤ä¸ªåŒºåŸŸï¼ŒFROMå’ŒTOï¼ˆTOä¸­ä¸ºç©ºï¼‰ã€‚å…ˆå°†è¢«GC Rootå¼•ç”¨çš„å¯¹è±¡ä»FROMæ”¾å…¥TOä¸­ï¼Œå†å›æ”¶ä¸è¢«GC Rootå¼•ç”¨çš„å¯¹è±¡ã€‚ç„¶åäº¤æ¢FROMå’ŒTOã€‚è¿™æ ·ä¹Ÿå¯ä»¥é¿å…å†…å­˜ç¢ç‰‡çš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šå ç”¨åŒå€çš„å†…å­˜ç©ºé—´ã€‚

### 3.åˆ†ä»£å›æ”¶

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150931.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150931.png)

#### 3.1 å›æ”¶æµç¨‹

æ–°åˆ›å»ºçš„å¯¹è±¡éƒ½è¢«æ”¾åœ¨äº†**æ–°ç”Ÿä»£çš„ä¼Šç”¸å›­**ä¸­

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150939.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150939.png)

å½“ä¼Šç”¸å›­ä¸­çš„å†…å­˜ä¸è¶³æ—¶ï¼Œå°±ä¼šè¿›è¡Œä¸€æ¬¡åƒåœ¾å›æ”¶ï¼Œè¿™æ—¶çš„å›æ”¶å«åš **Minor GC**

Minor GC ä¼šå°†**ä¼Šç”¸å›­å’Œå¹¸å­˜åŒºFROM**å­˜æ´»çš„å¯¹è±¡**å…ˆ**å¤åˆ¶åˆ° **å¹¸å­˜åŒº TO**ä¸­ï¼Œ å¹¶è®©å…¶**å¯¿å‘½åŠ 1**ï¼Œå†**äº¤æ¢ä¸¤ä¸ªå¹¸å­˜åŒº**

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150946.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150946.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608150955.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608150955.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151002.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151002.png)

å†æ¬¡åˆ›å»ºå¯¹è±¡ï¼Œè‹¥æ–°ç”Ÿä»£çš„ä¼Šç”¸å›­åˆæ»¡äº†ï¼Œåˆ™ä¼š**å†æ¬¡è§¦å‘ Minor GC**ï¼ˆä¼šè§¦å‘ **stop the world**ï¼Œ æš‚åœå…¶ä»–ç”¨æˆ·çº¿ç¨‹ï¼Œåªè®©åƒåœ¾å›æ”¶çº¿ç¨‹å·¥ä½œï¼‰ï¼Œè¿™æ—¶ä¸ä»…ä¼šå›æ”¶ä¼Šç”¸å›­ä¸­çš„åƒåœ¾ï¼Œ**è¿˜ä¼šå›æ”¶å¹¸å­˜åŒºä¸­çš„åƒåœ¾**ï¼Œå†å°†æ´»è·ƒå¯¹è±¡å¤åˆ¶åˆ°å¹¸å­˜åŒºTOä¸­ã€‚å›æ”¶ä»¥åä¼šäº¤æ¢ä¸¤ä¸ªå¹¸å­˜åŒºï¼Œå¹¶è®©å¹¸å­˜åŒºä¸­çš„å¯¹è±¡**å¯¿å‘½åŠ 1**

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151010.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151010.png)

å¦‚æœå¹¸å­˜åŒºä¸­çš„å¯¹è±¡çš„**å¯¿å‘½è¶…è¿‡æŸä¸ªé˜ˆå€¼**ï¼ˆæœ€å¤§ä¸º15ï¼Œ4bitï¼‰ï¼Œå°±ä¼šè¢«**æ”¾å…¥è€å¹´ä»£**ä¸­

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151018.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151018.png)

å¦‚æœæ–°ç”Ÿä»£è€å¹´ä»£ä¸­çš„å†…å­˜éƒ½æ»¡äº†ï¼Œå°±ä¼šå…ˆè§¦å‘Minor GCï¼Œå†è§¦å‘**Full GC**ï¼Œæ‰«æ**æ–°ç”Ÿä»£å’Œè€å¹´ä»£ä¸­**æ‰€æœ‰ä¸å†ä½¿ç”¨çš„å¯¹è±¡å¹¶å›æ”¶

#### 3.2 GC åˆ†æ

##### 3.2.1 GCç›¸å…³å‚æ•°

|        å«ä¹‰        | å‚æ•°                                                         |
| :----------------: | :----------------------------------------------------------- |
|     å †åˆå§‹å¤§å°     | -Xms                                                         |
|     å †æœ€å¤§å¤§å°     | -Xmx æˆ– -XX:MaxHeapSize=size                                 |
|     æ–°ç”Ÿä»£å¤§å°     | -Xmn æˆ– -XX:NewSize=size + -XX:MaxNewSize=size               |
| å¹¸å­˜åŒºæ¯”ä¾‹ï¼ˆåŠ¨æ€ï¼‰ | -XX:initialSurvivorRation=ratio æˆ– -XX:+UseAdaptiveSizePolicy |
|     å¹¸å­˜åŒºæ¯”ä¾‹     | -XX:SurvivorRatio=ratio                                      |
|      æ™‹å‡é˜ˆå€¼      | -XX:MaxTenuringThreshold=threshold                           |
|      æ™‹å‡è¯¦æƒ…      | -XX:+PrintTenuringDistribution                               |
|       GCè¯¦æƒ…       | -XX:+PrintGCDetails -verbose:gc                              |
|  FullGCå‰MinorGC   | -XX:+ScavengeBeforeFullGC                                    |

##### 3.2.2 å¤§å¯¹è±¡å¤„ç†ç­–ç•¥

å½“é‡åˆ°ä¸€ä¸ª**è¾ƒå¤§çš„å¯¹è±¡**æ—¶ï¼Œå°±ç®—æ–°ç”Ÿä»£çš„**ä¼Šç”¸å›­**ä¸ºç©ºï¼Œä¹Ÿ**æ— æ³•å®¹çº³è¯¥å¯¹è±¡**æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡**ç›´æ¥æ™‹å‡ä¸ºè€å¹´ä»£**

##### 3.2.3 çº¿ç¨‹å†…å­˜æº¢å‡º

æŸä¸ªçº¿ç¨‹çš„å†…å­˜æº¢å‡ºäº†è€ŒæŠ›å¼‚å¸¸ï¼ˆout of memoryï¼‰ï¼Œä¸ä¼šè®©å…¶ä»–çš„çº¿ç¨‹ç»“æŸè¿è¡Œ

è¿™æ˜¯å› ä¸ºå½“ä¸€ä¸ªçº¿ç¨‹**æŠ›å‡ºOOMå¼‚å¸¸å**ï¼Œ**å®ƒæ‰€å æ®çš„å†…å­˜èµ„æºä¼šå…¨éƒ¨è¢«é‡Šæ”¾æ‰**ï¼Œä»è€Œä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„è¿è¡Œï¼Œ**è¿›ç¨‹ä¾ç„¶æ­£å¸¸**



### 4.åƒåœ¾å›æ”¶å™¨

#### ç›¸å…³æ¦‚å¿µ

**å¹¶è¡Œæ”¶é›†**ï¼šæŒ‡å¤šæ¡åƒåœ¾æ”¶é›†çº¿ç¨‹å¹¶è¡Œå·¥ä½œï¼Œä½†æ­¤æ—¶**ç”¨æˆ·çº¿ç¨‹ä»å¤„äºç­‰å¾…çŠ¶æ€**ã€‚

**å¹¶å‘æ”¶é›†**ï¼šæŒ‡ç”¨æˆ·çº¿ç¨‹ä¸åƒåœ¾æ”¶é›†çº¿ç¨‹**åŒæ—¶å·¥ä½œ**ï¼ˆä¸ä¸€å®šæ˜¯å¹¶è¡Œçš„å¯èƒ½ä¼šäº¤æ›¿æ‰§è¡Œï¼‰ã€‚**ç”¨æˆ·ç¨‹åºåœ¨ç»§ç»­è¿è¡Œ**ï¼Œè€Œåƒåœ¾æ”¶é›†ç¨‹åºè¿è¡Œåœ¨å¦ä¸€ä¸ªCPUä¸Š

**ååé‡**ï¼šå³CPUç”¨äº**è¿è¡Œç”¨æˆ·ä»£ç çš„æ—¶é—´**ä¸CPU**æ€»æ¶ˆè€—æ—¶é—´**çš„æ¯”å€¼ï¼ˆååé‡ = è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ / ( è¿è¡Œç”¨æˆ·ä»£ç æ—¶é—´ + åƒåœ¾æ”¶é›†æ—¶é—´ )ï¼‰ï¼Œä¹Ÿå°±æ˜¯ã€‚ä¾‹å¦‚ï¼šè™šæ‹Ÿæœºå…±è¿è¡Œ100åˆ†é’Ÿï¼Œåƒåœ¾æ”¶é›†å™¨èŠ±æ‰1åˆ†é’Ÿï¼Œé‚£ä¹ˆååé‡å°±æ˜¯99%

#### 4.1 ä¸²è¡Œ

- å•çº¿ç¨‹
- å†…å­˜è¾ƒå°ï¼Œä¸ªäººç”µè„‘ï¼ˆCPUæ ¸æ•°è¾ƒå°‘ï¼‰

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151027.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151027.png)

**å®‰å…¨ç‚¹**ï¼šè®©å…¶ä»–çº¿ç¨‹éƒ½åœ¨è¿™ä¸ªç‚¹åœä¸‹æ¥ï¼Œä»¥å…åƒåœ¾å›æ”¶æ—¶ç§»åŠ¨å¯¹è±¡åœ°å€ï¼Œä½¿å¾—å…¶ä»–çº¿ç¨‹æ‰¾ä¸åˆ°è¢«ç§»åŠ¨çš„å¯¹è±¡

å› ä¸ºæ˜¯ä¸²è¡Œçš„ï¼Œæ‰€ä»¥åªæœ‰ä¸€ä¸ªåƒåœ¾å›æ”¶çº¿ç¨‹ã€‚ä¸”åœ¨è¯¥çº¿ç¨‹æ‰§è¡Œå›æ”¶å·¥ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹è¿›å…¥**é˜»å¡**çŠ¶æ€

##### 4.1.1 Serial æ”¶é›†å™¨

Serialæ”¶é›†å™¨æ˜¯æœ€åŸºæœ¬çš„ã€å‘å±•å†å²æœ€æ‚ ä¹…çš„æ”¶é›†å™¨

**ç‰¹ç‚¹ï¼š**å•çº¿ç¨‹ã€ç®€å•é«˜æ•ˆï¼ˆä¸å…¶ä»–æ”¶é›†å™¨çš„å•çº¿ç¨‹ç›¸æ¯”ï¼‰ï¼Œé‡‡ç”¨**å¤åˆ¶ç®—æ³•**ã€‚å¯¹äºé™å®šå•ä¸ªCPUçš„ç¯å¢ƒæ¥è¯´ï¼ŒSerialæ”¶é›†å™¨ç”±äºæ²¡æœ‰çº¿ç¨‹äº¤äº’çš„å¼€é”€ï¼Œä¸“å¿ƒåšåƒåœ¾æ”¶é›†è‡ªç„¶å¯ä»¥è·å¾—æœ€é«˜çš„å•çº¿ç¨‹æ‰‹æœºæ•ˆç‡ã€‚æ”¶é›†å™¨è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œå¿…é¡»æš‚åœå…¶ä»–æ‰€æœ‰çš„å·¥ä½œçº¿ç¨‹ï¼Œç›´åˆ°å®ƒç»“æŸï¼ˆStop The Worldï¼‰

##### 4.1.2 ParNew æ”¶é›†å™¨

ParNewæ”¶é›†å™¨å…¶å®å°±æ˜¯Serialæ”¶é›†å™¨çš„å¤šçº¿ç¨‹ç‰ˆæœ¬

**ç‰¹ç‚¹**ï¼šå¤šçº¿ç¨‹ã€ParNewæ”¶é›†å™¨é»˜è®¤å¼€å¯çš„æ”¶é›†çº¿ç¨‹æ•°ä¸CPUçš„æ•°é‡ç›¸åŒï¼Œåœ¨CPUéå¸¸å¤šçš„ç¯å¢ƒä¸­ï¼Œå¯ä»¥ä½¿ç”¨-XX:ParallelGCThreadså‚æ•°æ¥é™åˆ¶åƒåœ¾æ”¶é›†çš„çº¿ç¨‹æ•°ã€‚å’ŒSerialæ”¶é›†å™¨ä¸€æ ·å­˜åœ¨Stop The Worldé—®é¢˜

##### 4.1.3 Serial Old æ”¶é›†å™¨

Serial Oldæ˜¯Serialæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬

**ç‰¹ç‚¹**ï¼šåŒæ ·æ˜¯å•çº¿ç¨‹æ”¶é›†å™¨ï¼Œé‡‡ç”¨**æ ‡è®°-æ•´ç†ç®—æ³•**

#### 4.2 ååé‡ä¼˜å…ˆ

- å¤šçº¿ç¨‹
- å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸CPU
- **å•ä½æ—¶é—´å†…**ï¼ŒSTWï¼ˆstop the worldï¼Œåœæ‰å…¶ä»–æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼‰æ—¶é—´æœ€çŸ­
- **JDK1.8é»˜è®¤ä½¿ç”¨**çš„åƒåœ¾å›æ”¶å™¨

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151039.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151039.png)

##### 4.2.1 Parallel Scavenge æ”¶é›†å™¨

ä¸ååé‡å…³ç³»å¯†åˆ‡ï¼Œæ•…ä¹Ÿç§°ä¸ºååé‡ä¼˜å…ˆæ”¶é›†å™¨

**ç‰¹ç‚¹**ï¼šå±äºæ–°ç”Ÿä»£æ”¶é›†å™¨ä¹Ÿæ˜¯é‡‡ç”¨**å¤åˆ¶ç®—æ³•**çš„æ”¶é›†å™¨ï¼ˆç”¨åˆ°äº†æ–°ç”Ÿä»£çš„å¹¸å­˜åŒºï¼‰ï¼Œåˆæ˜¯å¹¶è¡Œçš„å¤šçº¿ç¨‹æ”¶é›†å™¨ï¼ˆä¸ParNewæ”¶é›†å™¨ç±»ä¼¼ï¼‰

è¯¥æ”¶é›†å™¨çš„ç›®æ ‡æ˜¯è¾¾åˆ°ä¸€ä¸ªå¯æ§åˆ¶çš„ååé‡ã€‚è¿˜æœ‰ä¸€ä¸ªå€¼å¾—å…³æ³¨çš„ç‚¹æ˜¯ï¼š**GCè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥**ï¼ˆä¸ParNewæ”¶é›†å™¨æœ€é‡è¦çš„ä¸€ä¸ªåŒºåˆ«ï¼‰

**GCè‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥**ï¼šParallel Scavengeæ”¶é›†å™¨å¯è®¾ç½®-XX:+UseAdptiveSizePolicyå‚æ•°ã€‚å½“å¼€å…³æ‰“å¼€æ—¶**ä¸éœ€è¦**æ‰‹åŠ¨æŒ‡å®šæ–°ç”Ÿä»£çš„å¤§å°ï¼ˆ-Xmnï¼‰ã€Edenä¸SurvivoråŒºçš„æ¯”ä¾‹ï¼ˆ-XX:SurvivorRationï¼‰ã€æ™‹å‡è€å¹´ä»£çš„å¯¹è±¡å¹´é¾„ï¼ˆ-XX:PretenureSizeThresholdï¼‰ç­‰ï¼Œè™šæ‹Ÿæœºä¼šæ ¹æ®ç³»ç»Ÿçš„è¿è¡ŒçŠ¶å†µæ”¶é›†æ€§èƒ½ç›‘æ§ä¿¡æ¯ï¼ŒåŠ¨æ€è®¾ç½®è¿™äº›å‚æ•°ä»¥æä¾›æœ€ä¼˜çš„åœé¡¿æ—¶é—´å’Œæœ€é«˜çš„ååé‡ï¼Œè¿™ç§è°ƒèŠ‚æ–¹å¼ç§°ä¸ºGCçš„è‡ªé€‚åº”è°ƒèŠ‚ç­–ç•¥ã€‚

Parallel Scavengeæ”¶é›†å™¨ä½¿ç”¨ä¸¤ä¸ªå‚æ•°æ§åˆ¶ååé‡ï¼š

- XX:MaxGCPauseMillis æ§åˆ¶æœ€å¤§çš„åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´
- XX:GCRatio ç›´æ¥è®¾ç½®ååé‡çš„å¤§å°

##### 4.2.2 Parallel Old æ”¶é›†å™¨

æ˜¯Parallel Scavengeæ”¶é›†å™¨çš„è€å¹´ä»£ç‰ˆæœ¬

**ç‰¹ç‚¹**ï¼šå¤šçº¿ç¨‹ï¼Œé‡‡ç”¨**æ ‡è®°-æ•´ç†ç®—æ³•**ï¼ˆè€å¹´ä»£æ²¡æœ‰å¹¸å­˜åŒºï¼‰

#### 4.3 å“åº”æ—¶é—´ä¼˜å…ˆ

- å¤šçº¿ç¨‹
- å †å†…å­˜è¾ƒå¤§ï¼Œå¤šæ ¸CPU
- å°½å¯èƒ½è®©å•æ¬¡STWæ—¶é—´å˜çŸ­ï¼ˆå°½é‡ä¸å½±å“å…¶ä»–çº¿ç¨‹è¿è¡Œï¼‰

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151052.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151052.png)

##### 4.3.1 CMS æ”¶é›†å™¨

Concurrent Mark Sweepï¼Œä¸€ç§ä»¥è·å–**æœ€çŸ­å›æ”¶åœé¡¿æ—¶é—´**ä¸ºç›®æ ‡çš„**è€å¹´ä»£**æ”¶é›†å™¨

**ç‰¹ç‚¹**ï¼šåŸºäº**æ ‡è®°-æ¸…é™¤ç®—æ³•**å®ç°ã€‚å¹¶å‘æ”¶é›†ã€ä½åœé¡¿ï¼Œä½†æ˜¯ä¼šäº§ç”Ÿå†…å­˜ç¢ç‰‡

**åº”ç”¨åœºæ™¯**ï¼šé€‚ç”¨äºæ³¨é‡æœåŠ¡çš„å“åº”é€Ÿåº¦ï¼Œå¸Œæœ›ç³»ç»Ÿåœé¡¿æ—¶é—´æœ€çŸ­ï¼Œç»™ç”¨æˆ·å¸¦æ¥æ›´å¥½çš„ä½“éªŒç­‰åœºæ™¯ä¸‹ã€‚å¦‚webç¨‹åºã€b/sæœåŠ¡

**CMSæ”¶é›†å™¨çš„è¿è¡Œè¿‡ç¨‹åˆ†ä¸ºä¸‹åˆ—4æ­¥ï¼š**

**åˆå§‹æ ‡è®°**ï¼šæ ‡è®°GC Rootsèƒ½ç›´æ¥åˆ°çš„å¯¹è±¡ã€‚é€Ÿåº¦å¾ˆå¿«ä½†æ˜¯**ä»å­˜åœ¨Stop The Worldé—®é¢˜**

**å¹¶å‘æ ‡è®°**ï¼šè¿›è¡ŒGC Roots Tracing çš„è¿‡ç¨‹ï¼Œæ‰¾å‡ºå­˜æ´»å¯¹è±¡ä¸”ç”¨æˆ·çº¿ç¨‹å¯å¹¶å‘æ‰§è¡Œ

**é‡æ–°æ ‡è®°**ï¼šä¸ºäº†**ä¿®æ­£å¹¶å‘æ ‡è®°æœŸé—´**å› ç”¨æˆ·ç¨‹åºç»§ç»­è¿è¡Œè€Œå¯¼è‡´æ ‡è®°äº§ç”Ÿå˜åŠ¨çš„é‚£ä¸€éƒ¨åˆ†å¯¹è±¡çš„æ ‡è®°è®°å½•ã€‚ä»ç„¶å­˜åœ¨Stop The Worldé—®é¢˜

**å¹¶å‘æ¸…é™¤**ï¼šå¯¹æ ‡è®°çš„å¯¹è±¡è¿›è¡Œæ¸…é™¤å›æ”¶

CMSæ”¶é›†å™¨çš„å†…å­˜å›æ”¶è¿‡ç¨‹æ˜¯ä¸ç”¨æˆ·çº¿ç¨‹ä¸€èµ·**å¹¶å‘æ‰§è¡Œ**çš„

#### 4.4 G1 â“

Garbage First

JDK 9ä»¥åé»˜è®¤ä½¿ç”¨ï¼Œè€Œä¸”**æ›¿ä»£äº†CMS æ”¶é›†å™¨**

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200909201212.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200909201212.png)

##### 4.4.1 é€‚ç”¨åœºæ™¯

- åŒæ—¶æ³¨é‡ååé‡å’Œä½å»¶è¿Ÿï¼ˆå“åº”æ—¶é—´ï¼‰
- è¶…å¤§å †å†…å­˜ï¼ˆå†…å­˜å¤§çš„ï¼‰ï¼Œä¼šå°†å †å†…å­˜åˆ’åˆ†ä¸ºå¤šä¸ª**å¤§å°ç›¸ç­‰**çš„åŒºåŸŸ
- æ•´ä½“ä¸Šæ˜¯**æ ‡è®°-æ•´ç†**ç®—æ³•ï¼Œä¸¤ä¸ªåŒºåŸŸä¹‹é—´æ˜¯**å¤åˆ¶**ç®—æ³•

**ç›¸å…³å‚æ•°**ï¼šJDK8 å¹¶ä¸æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œæ‰€éœ€è¦å‚æ•°å¼€å¯

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151100.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151100.png)

##### 4.4.2 G1åƒåœ¾å›æ”¶é˜¶æ®µ

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151109.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151109.png)

æ–°ç”Ÿä»£ä¼Šç”¸å›­åƒåœ¾å›æ”¶â€”â€“>å†…å­˜ä¸è¶³ï¼Œæ–°ç”Ÿä»£å›æ”¶+å¹¶å‘æ ‡è®°â€”â€“>å›æ”¶æ–°ç”Ÿä»£ä¼Šç”¸å›­ã€å¹¸å­˜åŒºã€è€å¹´ä»£å†…å­˜â€”â€”>æ–°ç”Ÿä»£ä¼Šç”¸å›­åƒåœ¾å›æ”¶(é‡æ–°å¼€å§‹)

###### 4.4.2.1 Young Collection

**åˆ†åŒºç®—æ³•region**

åˆ†ä»£æ˜¯æŒ‰å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸåˆ’åˆ†ï¼Œåˆ†åŒºåˆ™æ˜¯å°†å †ç©ºé—´åˆ’åˆ†è¿ç»­å‡ ä¸ªä¸åŒå°åŒºé—´ï¼Œæ¯ä¸€ä¸ªå°åŒºé—´ç‹¬ç«‹å›æ”¶ï¼Œå¯ä»¥æ§åˆ¶ä¸€æ¬¡å›æ”¶å¤šå°‘ä¸ªå°åŒºé—´ï¼Œæ–¹ä¾¿æ§åˆ¶ GC äº§ç”Ÿçš„åœé¡¿æ—¶é—´

Eï¼šä¼Šç”¸å›­ Sï¼šå¹¸å­˜åŒº Oï¼šè€å¹´ä»£

- ä¼šSTW

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151119.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151119.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151129.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151129.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151140.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151140.png)

###### 4.4.2.2 Young Collection + CM

CMï¼šå¹¶å‘æ ‡è®°

- åœ¨ Young GC æ—¶ä¼š**å¯¹ GC Root è¿›è¡Œåˆå§‹æ ‡è®°**
- åœ¨è€å¹´ä»£**å ç”¨å †å†…å­˜çš„æ¯”ä¾‹**è¾¾åˆ°é˜ˆå€¼æ—¶ï¼Œå¯¹è¿›è¡Œå¹¶å‘æ ‡è®°ï¼ˆä¸ä¼šSTWï¼‰ï¼Œé˜ˆå€¼å¯ä»¥æ ¹æ®ç”¨æˆ·æ¥è¿›è¡Œè®¾å®š

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151150.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151150.png)

###### 4.2.2.3 Mixed Collection

ä¼šå¯¹ E S O è¿›è¡Œ**å…¨é¢çš„å›æ”¶**

- æœ€ç»ˆæ ‡è®°
- **æ‹·è´**å­˜æ´»

`-XX:MaxGCPauseMills:xxx` ç”¨äºæŒ‡å®šæœ€é•¿çš„åœé¡¿æ—¶é—´

**é—®**ï¼šä¸ºä»€ä¹ˆæœ‰çš„è€å¹´ä»£è¢«æ‹·è´äº†ï¼Œæœ‰çš„æ²¡æ‹·è´ï¼Ÿ

å› ä¸ºæŒ‡å®šäº†æœ€å¤§åœé¡¿æ—¶é—´ï¼Œå¦‚æœå¯¹æ‰€æœ‰è€å¹´ä»£éƒ½è¿›è¡Œå›æ”¶ï¼Œè€—æ—¶å¯èƒ½è¿‡é«˜ã€‚ä¸ºäº†ä¿è¯æ—¶é—´ä¸è¶…è¿‡è®¾å®šçš„åœé¡¿æ—¶é—´ï¼Œä¼š**å›æ”¶æœ€æœ‰ä»·å€¼çš„è€å¹´ä»£**ï¼ˆå›æ”¶åï¼Œèƒ½å¤Ÿå¾—åˆ°æ›´å¤šå†…å­˜ï¼‰

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151201.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151201.png)

##### 4.4.3 Full GC

**å¯¹æ¯”**

```
- SerialGC
-- æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc
-- è€å¹´ä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - full gc

- ParallelGC
-- æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc
-- è€å¹´ä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - full gc

- CMS
-- æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc
-- è€å¹´ä»£å†…å­˜ä¸è¶³

- G1
-- æ–°ç”Ÿä»£å†…å­˜ä¸è¶³å‘ç”Ÿçš„åƒåœ¾æ”¶é›† - minor gc
-- è€å¹´ä»£å†…å­˜ä¸è¶³
```

G1åœ¨è€å¹´ä»£å†…å­˜ä¸è¶³æ—¶ï¼ˆè€å¹´ä»£æ‰€å å†…å­˜è¶…è¿‡é˜ˆå€¼ï¼‰

- å¦‚æœåƒåœ¾äº§ç”Ÿé€Ÿåº¦æ…¢äºåƒåœ¾å›æ”¶é€Ÿåº¦ï¼Œä¸ä¼šè§¦å‘Full GCï¼Œè¿˜æ˜¯å¹¶å‘åœ°è¿›è¡Œæ¸…ç†
- å¦‚æœåƒåœ¾äº§ç”Ÿé€Ÿåº¦å¿«äºåƒåœ¾å›æ”¶é€Ÿåº¦ï¼Œä¾¿ä¼šè§¦å‘Full GC

##### 4.4.4 Young Collection è·¨ä»£å¼•ç”¨

- æ–°ç”Ÿä»£å›æ”¶çš„è·¨ä»£å¼•ç”¨ï¼ˆè€å¹´ä»£å¼•ç”¨æ–°ç”Ÿä»£ï¼‰é—®é¢˜

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151211.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151211.png)

- å¡è¡¨ä¸Remembered Set
  - Remembered Set å­˜åœ¨äºEä¸­ï¼Œç”¨äºä¿å­˜æ–°ç”Ÿä»£å¯¹è±¡å¯¹åº”çš„è„å¡
    - è„å¡ï¼šOè¢«åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸï¼ˆä¸€ä¸ªåŒºåŸŸ512Kï¼‰ï¼Œå¦‚æœè¯¥åŒºåŸŸå¼•ç”¨äº†æ–°ç”Ÿä»£å¯¹è±¡ï¼Œåˆ™è¯¥åŒºåŸŸè¢«ç§°ä¸ºè„å¡
- åœ¨å¼•ç”¨å˜æ›´æ—¶é€šè¿‡ post-write barried + dirty card queue
- concurrent refinement threads æ›´æ–° Remembered Set

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151222.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151222.png)

##### 4.4.5 Remark

**é‡æ–°æ ‡è®°é˜¶æ®µ**

åœ¨åƒåœ¾å›æ”¶æ—¶ï¼Œæ”¶é›†å™¨å¤„ç†å¯¹è±¡çš„è¿‡ç¨‹ä¸­

- é»‘è‰²ï¼šå·²è¢«å¤„ç†ï¼Œéœ€è¦ä¿ç•™çš„ 
- ç°è‰²ï¼šæ­£åœ¨å¤„ç†ä¸­çš„
- ç™½è‰²ï¼šè¿˜æœªå¤„ç†çš„

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151229.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151229.png)

ä½†æ˜¯åœ¨**å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­**ï¼Œæœ‰å¯èƒ½Aè¢«å¤„ç†äº†ä»¥åæœªå¼•ç”¨Cï¼Œä½†è¯¥å¤„ç†è¿‡ç¨‹è¿˜æœªç»“æŸï¼Œåœ¨å¤„ç†è¿‡ç¨‹ç»“æŸä¹‹å‰Aå¼•ç”¨äº†Cï¼Œè¿™æ—¶å°±ä¼šç”¨åˆ°remark

è¿‡ç¨‹å¦‚ä¸‹

- ä¹‹å‰Cæœªè¢«å¼•ç”¨ï¼Œè¿™æ—¶Aå¼•ç”¨äº†Cï¼Œå°±ä¼šç»™CåŠ ä¸€ä¸ªå†™å±éšœï¼Œå†™å±éšœçš„æŒ‡ä»¤ä¼šè¢«æ‰§è¡Œï¼Œå°†Cæ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—å½“ä¸­ï¼Œå¹¶å°†Cå˜ä¸º å¤„ç†ä¸­ çŠ¶æ€
- åœ¨**å¹¶å‘æ ‡è®°**é˜¶æ®µç»“æŸä»¥åï¼Œé‡æ–°æ ‡è®°é˜¶æ®µä¼šSTWï¼Œç„¶åå°†æ”¾åœ¨è¯¥é˜Ÿåˆ—ä¸­çš„å¯¹è±¡é‡æ–°å¤„ç†ï¼Œå‘ç°æœ‰å¼ºå¼•ç”¨å¼•ç”¨å®ƒï¼Œå°±ä¼šå¤„ç†å®ƒ

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151239.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151239.png)

##### 4.4.6 JDK 8u20 å­—ç¬¦ä¸²å»é‡

é»˜è®¤å¼€å¯ `-XX:+UseStringDeduplication`

```java
String s1 = new String("hello"); // char[]{'h','e','l','l','o'}
String s2 = new String("hello"); // char[]{'h','e','l','l','o'}
```

è¿‡ç¨‹

- å°†æ‰€æœ‰æ–°åˆ†é…çš„å­—ç¬¦ä¸²ï¼ˆåº•å±‚æ˜¯char[]ï¼‰æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—
- å½“æ–°ç”Ÿä»£å›æ”¶æ—¶ï¼ŒG1å¹¶å‘æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤çš„å­—ç¬¦ä¸²
- å¦‚æœå­—ç¬¦ä¸²çš„å€¼ä¸€æ ·ï¼Œå°±è®©ä»–ä»¬**å¼•ç”¨åŒä¸€ä¸ªå­—ç¬¦ä¸²å¯¹è±¡**
- æ³¨æ„ï¼Œå…¶ä¸ String.intern çš„åŒºåˆ«
  - internå…³æ³¨çš„æ˜¯å­—ç¬¦ä¸²å¯¹è±¡ï¼ŒStringTable(ä¸²æ± )
  - å­—ç¬¦ä¸²å»é‡å…³æ³¨çš„æ˜¯char[]
  - åœ¨JVMå†…éƒ¨ï¼Œä½¿ç”¨äº†ä¸åŒçš„å­—ç¬¦ä¸²æ ‡

ä¼˜ç‚¹ä¸ç¼ºç‚¹

- èŠ‚çœäº†å¤§é‡å†…å­˜
- æ–°ç”Ÿä»£å›æ”¶æ—¶é—´ç•¥å¾®å¢åŠ ï¼Œå¯¼è‡´ç•¥å¾®å¤šå ç”¨CPU

##### 4.4.7 JDK 8u40 å¹¶å‘æ ‡è®°ç±»å¸è½½

é»˜è®¤å¼€å¯ `-XX:+ClassUnloadingWithConcurrentMark`

åœ¨å¹¶å‘æ ‡è®°é˜¶æ®µç»“æŸä»¥åï¼Œå°±èƒ½çŸ¥é“å“ªäº›ç±»ä¸å†è¢«ä½¿ç”¨ã€‚å¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨çš„æ‰€æœ‰ç±»éƒ½ä¸åœ¨ä½¿ç”¨ï¼Œåˆ™å¸è½½å®ƒæ‰€åŠ è½½çš„æ‰€æœ‰ç±»

##### 4.4.8 JDK 8u60 å›æ”¶å·¨å‹å¯¹è±¡

- ä¸€ä¸ªå¯¹è±¡å¤§äºregionçš„ä¸€åŠæ—¶ï¼Œå°±ç§°ä¸ºå·¨å‹å¯¹è±¡
- G1ä¸ä¼šå¯¹å·¨å‹å¯¹è±¡è¿›è¡Œæ‹·è´
- å›æ”¶æ—¶è¢«ä¼˜å…ˆè€ƒè™‘
- G1ä¼šè·Ÿè¸ªè€å¹´ä»£æ‰€æœ‰incomingå¼•ç”¨ï¼Œå¦‚æœè€å¹´ä»£incomingå¼•ç”¨ä¸º0çš„å·¨å‹å¯¹è±¡å°±å¯ä»¥åœ¨æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ—¶å¤„ç†æ‰

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151249.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151249.png)

##### 4.4.9 JDK 9å¹¶å‘æ ‡è®°èµ·å§‹æ—¶é—´çš„è°ƒæ•´

- å¹¶å‘æ ‡è®°å¿…é¡»åœ¨å¯¹å †ç©ºé—´å æ»¡å‰å®Œæˆï¼Œå¦åˆ™é€€åŒ–ä¸ºFULLGC

### 5.GC è°ƒä¼˜

æŸ¥çœ‹è™šæ‹Ÿæœºå‚æ•°å‘½ä»¤

```
JAVA/JDK8.0/bin/java -XX:+PrintFlagsFinal -version | findstr "GC"Copy
```

å¯ä»¥æ ¹æ®å‚æ•°å»æŸ¥è¯¢å…·ä½“çš„ä¿¡æ¯

#### 5.1 è°ƒä¼˜é¢†åŸŸ

- å†…å­˜
- é”ç«äº‰
- CPUå ç”¨
- IO
- GC

#### 5.2 ç¡®å®šç›®æ ‡

ä½å»¶è¿Ÿ or é«˜ååé‡ï¼Ÿ é€‰æ‹©åˆé€‚çš„GC

- CMS G1 ZGCï¼ˆä½å»¶è¿Ÿï¼‰
- ParallelGCï¼ˆé«˜ååé‡ï¼‰
- Zingï¼ˆä½å»¶è¿Ÿï¼‰

#### 5.3 æœ€å¿«çš„GCæ˜¯ä¸å‘ç”ŸGC

é¦–å…ˆæ’é™¤å‡å°‘å› ä¸ºè‡ªèº«ç¼–å†™çš„ä»£ç è€Œå¼•å‘çš„å†…å­˜é—®é¢˜

- æŸ¥çœ‹Full GCå‰åçš„å†…å­˜å ç”¨ï¼Œè€ƒè™‘ä»¥ä¸‹å‡ ä¸ªé—®é¢˜
  - åŠ è½½çš„å†…å­˜æ•°æ®å¤ªå¤šï¼Ÿ
  - æ•°æ®è¡¨ç¤ºæ˜¯å¦å¤ªè‡ƒè‚¿
    - å¯¹è±¡å›¾
    - å¯¹è±¡å¤§å°
  - æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼

#### 5.4 æ–°ç”Ÿä»£è°ƒä¼˜

- æ–°ç”Ÿä»£çš„ç‰¹ç‚¹
  - æ‰€æœ‰çš„ new æ“ä½œåˆ†é…å†…å­˜éƒ½æ˜¯éå¸¸å»‰ä»·çš„
    - TLABï¼ˆthread-local allocation bufferï¼‰
  - æ­»äº¡å¯¹è±¡çš„å›æ”¶ä»£ä»·æ˜¯é›¶
  - å¤§éƒ¨åˆ†å¯¹è±¡ç”¨è¿‡å³æ­»ï¼ˆæœç”Ÿå¤•æ­»ï¼‰
  - MInor GC æ‰€ç”¨æ—¶é—´è¿œå°äº Full GC
- æ–°ç”Ÿä»£å†…å­˜è¶Šå¤§è¶Šå¥½ä¹ˆï¼Ÿ`-Xmn`
  - ä¸æ˜¯
  - å­˜åœ¨çš„é—®é¢˜
    - æ–°ç”Ÿä»£å†…å­˜å¤ªå°ï¼šé¢‘ç¹è§¦å‘Minor GCï¼Œä¼šSTWï¼Œä¼šä½¿å¾—ååé‡ä¸‹é™
    - æ–°ç”Ÿä»£å†…å­˜å¤ªå¤§ï¼šè€å¹´ä»£å†…å­˜å æ¯”æœ‰æ‰€é™ä½ï¼Œä¼šæ›´é¢‘ç¹åœ°è§¦å‘Full GCã€‚è€Œä¸”è§¦å‘Minor GCæ—¶ï¼Œæ¸…ç†æ–°ç”Ÿä»£æ‰€èŠ±è´¹çš„æ—¶é—´ä¼šæ›´é•¿
    - Oracleï¼š$25\%heap\space size\lt generation\lt 50\%heap\space size $
  - æ–°ç”Ÿä»£å†…å­˜è®¾ç½®ä¸ºèƒ½å®¹çº³ `[å¹¶å‘é‡*(è¯·æ±‚-å“åº”)]` çš„æ•°æ®ä¸ºå®œ

#### 5.5 å¹¸å­˜åŒºè°ƒä¼˜

- å¹¸å­˜åŒºéœ€è¦èƒ½å¤Ÿä¿å­˜ `å½“å‰æ´»è·ƒå¯¹è±¡+éœ€è¦æ™‹å‡çš„å¯¹è±¡`
- æ™‹å‡é˜ˆå€¼é…ç½®å¾—å½“ï¼Œè®©é•¿æ—¶é—´å­˜æ´»çš„å¯¹è±¡å°½å¿«æ™‹å‡
  - `-XX:MaxTenuringThreshold=threshold`
  - å¸Œæœ›è®©ç”Ÿå‘½å‘¨æœŸçŸ­çš„å¯¹è±¡é€šè¿‡ minor gc å›æ”¶ï¼Œè€Œä¸æ˜¯æ™‹å‡è‡³è€å¹´ä»£

#### 5.6 è€å¹´ä»£è°ƒä¼˜ 

ä»¥ CMS ä¸ºä¾‹

- CMSçš„è€å¹´ä»£å†…å­˜è¶Šå¤§è¶Šå¥½
- è€å¹´ä»£è°ƒä¼˜ä¹‹å‰å…ˆå°è¯•ä¸è¿›è¡Œè°ƒä¼˜
  - ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œè‹¥æ²¡æœ‰å‘ç”Ÿ FULL GCï¼Œè¯´æ˜è€å¹´ä»£çš„å†…å­˜å·²ç»è¶³å¤Ÿå¤§ï¼Œå°è¯•å…ˆè°ƒè¯•æ–°ç”Ÿä»£
- è§‚å¯Ÿå‘ç”Ÿ FULL GCçš„è€å¹´ä»£å†…å­˜å ç”¨ï¼Œè®²è€å¹´ä»£å†…å­˜é¢„è®¾è°ƒå¤§ $\frac{1}{4} \sim \frac{1}{3}$
  - `-XX:CMSInitaiatingOccupancyFraction=percent`

#### 5.7 GCè°ƒä¼˜çš„æ¡ˆä¾‹

- æ¡ˆä¾‹1ï¼ŒFULL GC å’Œ Minor GC é¢‘ç¹
  - å¢å¤§æ–°ç”Ÿä»£çš„å†…å­˜
- æ¡ˆä¾‹2ï¼Œè¯·æ±‚é«˜å³°æœŸå‘ç”Ÿ FULL GCï¼Œå•æ¬¡æš‚åœæ—¶é—´ç‰¹åˆ«é•¿ï¼ˆCMSï¼‰
  - ä¸šåŠ¡éœ€è¦ä½å»¶è¿Ÿï¼Œå•æ¬¡æš‚åœæ—¶é—´ç‰¹åˆ«é•¿
  - å‘ç°æ˜¯é‡æ–°æ ‡è®°é˜¶æ®µæ—¶é—´è¿‡é•¿ï¼Œåœ¨é‡æ–°æ ‡è®°ä¹‹å‰å¯¹æ–°ç”Ÿä»£åšåƒåœ¾æ¸…ç† `-XX:+CMSScavengeBeforeRemark`
- æ¡ˆä¾‹3ï¼Œè€å¹´ä»£å……è£•æƒ…å†µä¸‹ï¼Œå‘ç”Ÿ FULL GCï¼ˆJDK1.7ï¼‰
  - æ–¹æ³•åŒºé‡‡ç”¨æ°¸ä¹…ä»£ï¼ˆéå…ƒç©ºé—´ï¼‰ï¼Œæ°¸ä¹…ä»£çš„ç©ºé—´ä¸è¶³



## ç±»åŠ è½½ä¸å­—èŠ‚ç æŠ€æœ¯

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151300.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151300.png)

### 1.ç±»æ–‡ä»¶ç»“æ„

#### 1.1 HelloWorld.java

```java
public class HelloWorld {
    public static void main(String[] args) {
        System.out.println("Hello World");
    }
}
```

æ‰§è¡Œ `javac -parameters -d . HelloWorld.java ` ï¼Œç”Ÿæˆ HelloWorld.class

æ‰§è¡Œ `od -t xC HelloWorld.class`

```
0000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09 
0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07 
0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29 
0000060 56 01 00 04 43 6f 64 65 01 00 0f 4c 69 6e 65 4e 
0000100 75 6d 62 65 72 54 61 62 6c 65 01 00 12 4c 6f 63 
0000120 61 6c 56 61 72 69 61 62 6c 65 54 61 62 6c 65 01 
0000140 00 04 74 68 69 73 01 00 1d 4c 63 6e 2f 69 74 63 
0000160 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 6f 
0000200 57 6f 72 6c 64 3b 01 00 04 6d 61 69 6e 01 00 16 
0000220 28 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 
0000240 69 6e 67 3b 29 56 01 00 04 61 72 67 73 01 00 13 
0000260 5b 4c 6a 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 
0000300 6e 67 3b 01 00 10 4d 65 74 68 6f 64 50 61 72 61 
0000320 6d 65 74 65 72 73 01 00 0a 53 6f 75 72 63 65 46 
0000340 69 6c 65 01 00 0f 48 65 6c 6c 6f 57 6f 72 6c 64
0000360 2e 6a 61 76 61 0c 00 07 00 08 07 00 1d 0c 00 1e 
0000400 00 1f 01 00 0b 68 65 6c 6c 6f 20 77 6f 72 6c 64 
0000420 07 00 20 0c 00 21 00 22 01 00 1b 63 6e 2f 69 74 
0000440 63 61 73 74 2f 6a 76 6d 2f 74 35 2f 48 65 6c 6c 
0000460 6f 57 6f 72 6c 64 01 00 10 6a 61 76 61 2f 6c 61 
0000500 6e 67 2f 4f 62 6a 65 63 74 01 00 10 6a 61 76 61 
0000520 2f 6c 61 6e 67 2f 53 79 73 74 65 6d 01 00 03 6f 
0000540 75 74 01 00 15 4c 6a 61 76 61 2f 69 6f 2f 50 72 
0000560 69 6e 74 53 74 72 65 61 6d 3b 01 00 13 6a 61 76 
0000600 61 2f 69 6f 2f 50 72 69 6e 74 53 74 72 65 61 6d 
0000620 01 00 07 70 72 69 6e 74 6c 6e 01 00 15 28 4c 6a 
0000640 61 76 61 2f 6c 61 6e 67 2f 53 74 72 69 6e 67 3b 
0000660 29 56 00 21 00 05 00 06 00 00 00 00 00 02 00 01 
0000700 00 07 00 08 00 01 00 09 00 00 00 2f 00 01 00 01 
0000720 00 00 00 05 2a b7 00 01 b1 00 00 00 02 00 0a 00 
0000740 00 00 06 00 01 00 00 00 04 00 0b 00 00 00 0c 00 
0000760 01 00 00 00 05 00 0c 00 0d 00 00 00 09 00 0e 00 
0001000 0f 00 02 00 09 00 00 00 37 00 02 00 01 00 00 00 
0001020 09 b2 00 02 12 03 b6 00 04 b1 00 00 00 02 00 0a 
0001040 00 00 00 0a 00 02 00 00 00 06 00 08 00 07 00 0b 
0001060 00 00 00 0c 00 01 00 00 00 09 00 10 00 11 00 00 
0001100 00 12 00 00 00 05 01 00 10 00 00 00 01 00 13 00 
0001120 00 00 02 00 14
```

æ ¹æ® JVM è§„èŒƒï¼Œ**ç±»æ–‡ä»¶ç»“æ„**å¦‚ä¸‹

```
ClassFile{
u4 			 			 magic
u2             minor_version;    
u2             major_version;    
u2             constant_pool_count;    
cp_info        constant_pool[constant_pool_count-1];    
u2             access_flags;    
u2             this_class;    
u2             super_class;   
u2             interfaces_count;    
u2             interfaces[interfaces_count];   
u2             fields_count;    
field_info     fields[fields_count];   
u2             methods_count;    
method_info    methods[methods_count];    
u2             attributes_count;    
attribute_info attributes[attributes_count];
}
```

#### 1.2 é­”æ•°

`u4 magic`

å­—èŠ‚ç æ–‡ä»¶çš„0ï½3å­—èŠ‚

0000000 **ca fe ba be** 00 00 00 34 00 23 0a 00 06 00 15 09

#### 1.2 ç‰ˆæœ¬

`u2 minor_version`

`u2 major_version`

å­—èŠ‚ç æ–‡ä»¶çš„4ï½7å­—èŠ‚

0000000 ca fe ba be **00 00 00 34** 00 23 0a 00 06 00 15 09

00 34ï¼ˆ52ï¼‰ä»£è¡¨ JDK8

#### 1.3 å¸¸é‡æ± 

å­—èŠ‚ç æ–‡ä»¶çš„8ï½9å­—èŠ‚

0000000 ca fe ba be 00 00 00 34 **00 23** 0a 00 06 00 15 09

00 23ï¼ˆ35ï¼‰è¡¨ç¤ºå¸¸é‡æ± æœ‰ #1ï½#34 é¡¹ï¼Œæ³¨æ„ #0 é¡¹ä¸è®¡å…¥ï¼Œä¹Ÿæ²¡æœ‰å€¼

- ç¬¬ #1 é¡¹å’Œ 0a ä»£è¡¨ä¸€ä¸ª Method ä¿¡æ¯ï¼Œ00 06 å’Œ 00 15ï¼ˆ21ï¼‰è¡¨ç¤ºå®ƒå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #6 å’Œ #21 é¡¹æ¥è·å¾—è¿™ä¸ªæ–¹æ³•çš„ [æ‰€å±ç±»] å’Œ [æ–¹æ³•å]
  - `00000000 ca fe ba be 00 00 00 34 00 23 0a 00 06 00 15 09`
- ç¬¬ #2 é¡¹ 09 è¡¨ç¤ºä¸€ä¸ª Filedä¿¡æ¯ï¼Œ00 16ï¼ˆ22ï¼‰å’Œ 00 17ï¼ˆ23ï¼‰ è¡¨ç¤ºå¼•ç”¨å¸¸é‡æ± ä¸­ #22 å’Œ #23é¡¹æ¥è·å¾—è¿™ä¸ªæ–¹æ³•çš„ [æ‰€å±ç±»] å’Œ [æ–¹æ³•å]
  - `0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07`
- ç¬¬ #3 é¡¹ 08 è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡åç§°ï¼Œ00 18ï¼ˆ24ï¼‰è¡¨ç¤ºå¼•ç”¨äº†å¸¸é‡æ± ä¸­ #24 é¡¹
  - `0000020 00 16 00 17 08 00 18 0a 00 19 00 1a 07 00 1b 07`
- $...$
- ç¬¬ #7 é¡¹ 01 è¡¨ç¤ºä¸€ä¸ª utf8 ä¸²ï¼Œ00 06 è¡¨ç¤ºé•¿åº¦ï¼Œ3c 69 6e 74 3eæ˜¯ [\<init>]
  - `0000040 00 1c 01 00 06 3c 69 6e 69 74 3e 01 00 03 28 29  `

### 2.å­—èŠ‚ç æŒ‡ä»¤

#### 2.1 å‚è€ƒï¼š[Oracle-JVM](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-6.html#jvms-6.5)

- init
- main

#### 2.2 javapå·¥å…·

Oracle æä¾›äº† **javap** å·¥å…·æ¥åç¼–è¯‘ class æ–‡ä»¶

```
javap -v Main.classCopy
javap -v HelloWorld.class
Classfile .class
  Last modified 2020-6-6; size 434 bytes
  MD5 checksum df1dce65bf6fb0b4c1de318051f4a67e
  Compiled from "HelloWorld.java"
public class com.nyima.JVM.day5.HelloWorld
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #6.#15         // java/lang/Object."<init>":()V
   #2 = Fieldref           #16.#17        // java/lang/System.out:Ljava/io/PrintStream;
   #3 = String             #18            // hello world
   #4 = Methodref          #19.#20        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #5 = Class              #21            // com/nyima/JVM/day5/Demo1
   #6 = Class              #22            // java/lang/Object
   #7 = Utf8               <init>
   #8 = Utf8               ()V
   #9 = Utf8               Code
  #10 = Utf8               LineNumberTable
  #11 = Utf8               main
  #12 = Utf8               ([Ljava/lang/String;)V
  #13 = Utf8               SourceFile
  #14 = Utf8               Demo1.java
  #15 = NameAndType        #7:#8          // "<init>":()V
  #16 = Class              #23            // java/lang/System
  #17 = NameAndType        #24:#25        // out:Ljava/io/PrintStream;
  #18 = Utf8               hello world
  #19 = Class              #26            // java/io/PrintStream
  #20 = NameAndType        #27:#28        // println:(Ljava/lang/String;)V
  #21 = Utf8               com/nyima/JVM/day5/Demo1
  #22 = Utf8               java/lang/Object
  #23 = Utf8               java/lang/System
  #24 = Utf8               out
  #25 = Utf8               Ljava/io/PrintStream;
  #26 = Utf8               java/io/PrintStream
  #27 = Utf8               println
  #28 = Utf8               (Ljava/lang/String;)V
{
  public com.nyima.JVM.day5.HelloWorld();
    descriptor: ()V
    flags: ACC_PUBLIC
    Code:
      stack=1, locals=1, args_size=1
         0: aload_0
         1: invokespecial #1                  // Method java/lang/Object."<init>":()V
         4: return
      LineNumberTable:
        line 7: 0

  public static void main(java.lang.String[]);
    descriptor: ([Ljava/lang/String;)V
    flags: ACC_PUBLIC, ACC_STATIC
    Code:
      stack=2, locals=1, args_size=1
         0: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
         3: ldc           #3                  // String hello world
         5: invokevirtual #4                  // Method java/io/PrintStream.println:(Ljava/lang/String;)V

         8: return
      LineNumberTable:
        line 9: 0
        line 10: 8
}Copy
```

#### 2.3 å›¾è§£æ–¹æ³•æ‰§è¡Œæµç¨‹

```java
public class Demo3_1 {    
	public static void main(String[] args) {        
		int a = 10;        
		int b = Short.MAX_VALUE + 1;        
		int c = a + b;        
		System.out.println(c);   
    } 
}Copy
```

**å¸¸é‡æ± è½½å…¥è¿è¡Œæ—¶å¸¸é‡æ± **

å¸¸é‡æ± ä¹Ÿå±äºæ–¹æ³•åŒºï¼Œclassæ–‡ä»¶å¸¸é‡æ± æ–‡ä»¶å­˜å‚¨åœ¨è¿è¡Œæ—¶å¸¸é‡æ± 

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151317.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151317.png)

**æ–¹æ³•å­—èŠ‚ç è½½å…¥æ–¹æ³•åŒº**

**mainçº¿ç¨‹å¼€å§‹è¿è¡Œï¼Œåˆ†é…æ ˆå¸§å†…å­˜**

ï¼ˆstack=2ï¼Œlocals=4ï¼‰ å¯¹åº”æ“ä½œæ•°æ ˆæœ‰2ä¸ªç©ºé—´ï¼ˆæ¯ä¸ªç©ºé—´4ä¸ªå­—èŠ‚ï¼‰ï¼Œå±€éƒ¨å˜é‡è¡¨ä¸­æœ‰4ä¸ªæ§½ä½

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151325.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151325.png)

**æ‰§è¡Œå¼•æ“å¼€å§‹æ‰§è¡Œå­—èŠ‚ç **

**bipush 10**

- å°†ä¸€ä¸ª byte å‹å…¥æ“ä½œæ•°æ ˆï¼Œï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰ï¼Œç±»ä¼¼çš„æŒ‡ä»¤è¿˜æœ‰

  - sipush å°†ä¸€ä¸ª short å‹å…¥æ“ä½œæ•°æ ˆï¼ˆå…¶é•¿åº¦ä¼šè¡¥é½ 4 ä¸ªå­—èŠ‚ï¼‰
  - ldc å°†ä¸€ä¸ª int å‹å…¥æ“ä½œæ•°æ ˆ
  - ldc2_w å°†ä¸€ä¸ª long å‹å…¥æ“ä½œæ•°æ ˆï¼ˆ**åˆ†ä¸¤æ¬¡å‹å…¥**ï¼Œå› ä¸º long æ˜¯ 8 ä¸ªå­—èŠ‚ï¼‰
  - è¿™é‡Œå°çš„æ•°å­—éƒ½æ˜¯å’Œå­—èŠ‚ç æŒ‡ä»¤å­˜åœ¨ä¸€èµ·ï¼Œ**è¶…è¿‡ short èŒƒå›´çš„æ•°å­—å­˜å…¥äº†å¸¸é‡æ± **

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151336.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151336.png)

**istore 1**

å°†æ“ä½œæ•°æ ˆæ ˆé¡¶å…ƒç´ å¼¹å‡ºï¼Œæ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1 ä¸­

å¯¹åº”ä»£ç ä¸­çš„ `a = 10`

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151346.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151346.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151412.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151412.png)

**ldc #3**

è¯»å–è¿è¡Œæ—¶å¸¸é‡æ± ä¸­#3ï¼Œå³32768ï¼ˆè¶…è¿‡shortæœ€å¤§å€¼èŒƒå›´çš„æ•°ä¼šè¢«æ”¾åˆ°è¿è¡Œæ—¶å¸¸é‡æ± ä¸­ï¼‰ï¼Œå°†å…¶åŠ è½½åˆ°æ“ä½œæ•°æ ˆä¸­

æ³¨æ„ Short.MAX_VALUE æ˜¯ 32767ï¼Œæ‰€ä»¥ 32768 = Short.MAX_VALUE + 1 å®é™…æ˜¯åœ¨ç¼–è¯‘æœŸé—´è®¡ç®—å¥½çš„

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151421.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151421.png)

**istore 2**

å°†æ“ä½œæ•°æ ˆä¸­çš„å…ƒç´ å¼¹å‡ºï¼Œæ”¾åˆ°å±€éƒ¨å˜é‡è¡¨çš„2å·ä½ç½®

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151432.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151432.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151441.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151441.png)

**iload1 iload2**

å°†å±€éƒ¨å˜é‡è¡¨ä¸­1å·ä½ç½®å’Œ2å·ä½ç½®çš„å…ƒç´ æ”¾å…¥æ“ä½œæ•°æ ˆä¸­

- å› ä¸ºåªèƒ½åœ¨æ“ä½œæ•°æ ˆä¸­æ‰§è¡Œè¿ç®—æ“ä½œ

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151450.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151450.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151459.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151459.png)

**iadd**

å°†æ“ä½œæ•°æ ˆä¸­çš„ä¸¤ä¸ªå…ƒç´ **å¼¹å‡ºæ ˆ**å¹¶ç›¸åŠ ï¼Œç»“æœåœ¨å‹å…¥æ“ä½œæ•°æ ˆä¸­

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151508.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151508.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151523.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151523.png)

**istore 3**

å°†æ“ä½œæ•°æ ˆä¸­çš„å…ƒç´ å¼¹å‡ºï¼Œæ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„3å·ä½ç½®

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151547.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151547.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151555.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151555.png)

**getstatic #4**

åœ¨è¿è¡Œæ—¶å¸¸é‡æ± ä¸­æ‰¾åˆ°#4ï¼Œå‘ç°æ˜¯ä¸€ä¸ªå¯¹è±¡

åœ¨å †å†…å­˜ä¸­æ‰¾åˆ°è¯¥å¯¹è±¡ï¼Œå¹¶å°†å…¶**å¼•ç”¨**æ”¾å…¥æ“ä½œæ•°æ ˆä¸­

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151605.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151605.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151613.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151613.png)

**iload 3**

å°†å±€éƒ¨å˜é‡è¡¨ä¸­3å·ä½ç½®çš„å…ƒç´ å‹å…¥æ“ä½œæ•°æ ˆä¸­

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151624.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151624.png)

**invokevirtual 5**

æ‰¾åˆ°å¸¸é‡æ±  #5 é¡¹ï¼Œå®šä½åˆ°æ–¹æ³•åŒº java/io/PrintStream.println:(I)V æ–¹æ³•

ç”Ÿæˆæ–°çš„æ ˆå¸§ï¼ˆåˆ†é… localsã€stackç­‰ï¼‰

ä¼ é€’å‚æ•°ï¼Œæ‰§è¡Œæ–°æ ˆå¸§ä¸­çš„å­—èŠ‚ç 

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151632.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151632.png)

æ‰§è¡Œå®Œæ¯•ï¼Œå¼¹å‡ºæ ˆå¸§

æ¸…é™¤ main æ“ä½œæ•°æ ˆå†…å®¹

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200608151640.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200608151640.png)

**return**
å®Œæˆ main æ–¹æ³•è°ƒç”¨ï¼Œå¼¹å‡º main æ ˆå¸§ï¼Œç¨‹åºç»“æŸ

**ç»ƒä¹ ï¼šåˆ†æa++ï¼ˆp112ï¼‰**

#### 2.4 å­—èŠ‚ç æŒ‡ä»¤

##### 2.4.1 æ¡ä»¶åˆ¤æ–­

##### 2.4.2 å¾ªç¯æ§åˆ¶

**ç»ƒä¹ ï¼šåˆ†æx = 0**

```java
public class Demo2 {
	public static void main(String[] args) {
		int i = 0;
		int x = 0;
		while(i < 10) {
			x = x++;
			i++;
		}
		System.out.println(x); // x = 0
	}
}Copy
```

ä¸ºä»€ä¹ˆæœ€ç»ˆçš„xç»“æœä¸º0å‘¢ï¼Ÿ é€šè¿‡åˆ†æå­—èŠ‚ç æŒ‡ä»¤å³å¯çŸ¥æ™“

```
Code:
     stack=2, locals=3, args_size=1	//æ“ä½œæ•°æ ˆåˆ†é…2ä¸ªç©ºé—´ï¼Œå±€éƒ¨å˜é‡è¡¨åˆ†é…3ä¸ªç©ºé—´
        0: iconst_0	//å‡†å¤‡ä¸€ä¸ªå¸¸æ•°0
        1: istore_1	//å°†å¸¸æ•°0æ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„1å·æ§½ä½ i=0
        2: iconst_0	//å‡†å¤‡ä¸€ä¸ªå¸¸æ•°0
        3: istore_2	//å°†å¸¸æ•°0æ”¾å…¥å±€éƒ¨å˜é‡çš„2å·æ§½ä½ x=0	
        4: iload_1		//å°†å±€éƒ¨å˜é‡è¡¨1å·æ§½ä½çš„æ•°æ”¾å…¥æ“ä½œæ•°æ ˆä¸­
        5: bipush        10	//å°†æ•°å­—10æ”¾å…¥æ“ä½œæ•°æ ˆä¸­ï¼Œæ­¤æ—¶æ“ä½œæ•°æ ˆä¸­æœ‰2ä¸ªæ•°
        7: if_icmpge     21	//æ¯”è¾ƒæ“ä½œæ•°æ ˆä¸­çš„ä¸¤ä¸ªæ•°ï¼Œå¦‚æœä¸‹é¢çš„æ•°å¤§äºä¸Šé¢çš„æ•°ï¼Œå°±è·³è½¬åˆ°21ã€‚è¿™é‡Œçš„æ¯”è¾ƒæ˜¯å°†ä¸¤ä¸ªæ•°åšå‡æ³•ã€‚å› ä¸ºæ¶‰åŠè¿ç®—æ“ä½œï¼Œæ‰€ä»¥ä¼šå°†ä¸¤ä¸ªæ•°å¼¹å‡ºæ“ä½œæ•°æ ˆæ¥è¿›è¡Œè¿ç®—ã€‚è¿ç®—ç»“æŸåæ“ä½œæ•°æ ˆä¸ºç©º
       10: iload_2		//å°†å±€éƒ¨å˜é‡2å·æ§½ä½çš„æ•°æ”¾å…¥æ“ä½œæ•°æ ˆä¸­ï¼Œæ”¾å…¥çš„å€¼æ˜¯0
       11: iinc          2, 1	//å°†å±€éƒ¨å˜é‡2å·æ§½ä½çš„æ•°åŠ 1ï¼Œè‡ªå¢åï¼Œæ§½ä½ä¸­çš„å€¼ä¸º1
       14: istore_2	//å°†æ“ä½œæ•°æ ˆä¸­çš„æ•°æ”¾å…¥åˆ°å±€éƒ¨å˜é‡è¡¨çš„2å·æ§½ä½ï¼Œ2å·æ§½ä½çš„å€¼åˆå˜ä¸ºäº†0
       15: iinc          1, 1 //1å·æ§½ä½çš„å€¼è‡ªå¢1
       18: goto          4 //è·³è½¬åˆ°ç¬¬4æ¡æŒ‡ä»¤
       21: getstatic     #2                  // Field java/lang/System.out:Ljava/io/PrintStream;
       24: iload_2
       25: invokevirtual #3                  // Method java/io/PrintStream.println:(I)V
       28: returnCopy
```

##### 2.4.3 æ„é€ æ–¹æ³•

- **cinit()**

```java
public class Demo3 {
	static int i = 10;

	static {
		i = 20;
	}

	static {
		i = 30;
	}

	public static void main(String[] args) {
		System.out.println(i); //ç»“æœä¸º30
	}
}
```

ç¼–è¯‘å™¨ä¼šæŒ‰**ä»ä¸Šè‡³ä¸‹**çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ static é™æ€ä»£ç å—å’Œé™æ€æˆå‘˜èµ‹å€¼çš„ä»£ç ï¼Œ**åˆå¹¶**ä¸ºä¸€ä¸ªç‰¹æ®Šçš„æ–¹æ³• **cinit()V** 

```
stack=1, locals=0, args_size=0
         0: bipush        10
         2: putstatic     #3                  // Field i:I
         5: bipush        20
         7: putstatic     #3                  // Field i:I
        10: bipush        30
        12: putstatic     #3                  // Field i:I
        15: returnCopy
```

- **init()**

```java
public class Demo4 {
	private String a = "s1";

	{
		b = 20;
	}

	private int b = 10;

	{
		a = "s2";
	}

	public Demo4(String a, int b) {
		this.a = a;
		this.b = b;
	}

	public static void main(String[] args) {
		Demo4 d = new Demo4("s3", 30);
		System.out.println(d.a); // "s3"
		System.out.println(d.b); // 30
	}
}
```

ç¼–è¯‘å™¨ä¼šæŒ‰**ä»ä¸Šè‡³ä¸‹**çš„é¡ºåºï¼Œæ”¶é›†æ‰€æœ‰ {} ä»£ç å—å’Œæˆå‘˜å˜é‡èµ‹å€¼çš„ä»£ç ï¼Œ**å½¢æˆæ–°çš„æ„é€ æ–¹æ³•**ï¼Œä½†**åŸå§‹æ„é€ æ–¹æ³•**å†…çš„ä»£ç **æ€»æ˜¯åœ¨å**

```
Code:
     stack=2, locals=3, args_size=3
        0: aload_0
        1: invokespecial #1                  // Method java/lang/Object."<init>":()V
        4: aload_0
        5: ldc           #2                  // String s1
        7: putfield      #3                  // Field a:Ljava/lang/String;
       10: aload_0
       11: bipush        20
       13: putfield      #4                  // Field b:I
       16: aload_0
       17: bipush        10
       19: putfield      #4                  // Field b:I
       22: aload_0
       23: ldc           #5                  // String s2
       25: putfield      #3                  // Field a:Ljava/lang/String;
       //åŸå§‹æ„é€ æ–¹æ³•åœ¨æœ€åæ‰§è¡Œ
       28: aload_0
       29: aload_1
       30: putfield      #3                  // Field a:Ljava/lang/String;
       33: aload_0
       34: iload_2
       35: putfield      #4                  // Field b:I
       38: returnCopy
```

#### 2.5 æ–¹æ³•è°ƒç”¨

```
public class Demo5 {
	public Demo5() {

	}

	private void test1() {

	}

	private final void test2() {

	}

	public void test3() {

	}

	public static void test4() {

	}

	public static void main(String[] args) {
		Demo5 demo5 = new Demo5();
		demo5.test1();
		demo5.test2();
		demo5.test3();
		Demo5.test4();
	}
}Copy
```

ä¸åŒæ–¹æ³•åœ¨è°ƒç”¨æ—¶ï¼Œå¯¹åº”çš„è™šæ‹ŸæœºæŒ‡ä»¤æœ‰æ‰€åŒºåˆ«

- ç§æœ‰ã€æ„é€ ã€è¢«finalä¿®é¥°çš„æ–¹æ³•ï¼Œåœ¨è°ƒç”¨æ—¶éƒ½ä½¿ç”¨**invokespecial**æŒ‡ä»¤
- æ™®é€šæˆå‘˜æ–¹æ³•åœ¨è°ƒç”¨æ—¶ï¼Œä½¿ç”¨invokespecialæŒ‡ä»¤ã€‚å› ä¸ºç¼–è¯‘æœŸé—´æ— æ³•ç¡®å®šè¯¥æ–¹æ³•çš„å†…å®¹ï¼Œåªæœ‰åœ¨è¿è¡ŒæœŸé—´æ‰èƒ½ç¡®å®š
- é™æ€æ–¹æ³•åœ¨è°ƒç”¨æ—¶ä½¿ç”¨invokestaticæŒ‡ä»¤

```
Code:
      stack=2, locals=2, args_size=1
         0: new           #2                  // class com/nyima/JVM/day5/Demo5 
         3: dup
         4: invokespecial #3                  // Method "<init>":()V
         7: astore_1
         8: aload_1
         9: invokespecial #4                  // Method test1:()V
        12: aload_1
        13: invokespecial #5                  // Method test2:()V
        16: aload_1
        17: invokevirtual #6                  // Method test3:()V
        20: invokestatic  #7                  // Method test4:()V
        23: returnCopy
```

- new æ˜¯åˆ›å»ºã€å¯¹è±¡ã€‘ï¼Œç»™å¯¹è±¡åˆ†é…å †å†…å­˜ï¼Œæ‰§è¡ŒæˆåŠŸä¼šå°†ã€**å¯¹è±¡å¼•ç”¨**ã€‘å‹å…¥æ“ä½œæ•°æ ˆ
- dup æ˜¯èµ‹å€¼æ“ä½œæ•°æ ˆæ ˆé¡¶çš„å†…å®¹ï¼Œæœ¬ä¾‹å³ä¸ºã€**å¯¹è±¡å¼•ç”¨**ã€‘ï¼Œä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä»½å¼•ç”¨å‘¢ï¼Œä¸€ä¸ªæ˜¯è¦é…åˆ invokespecial è°ƒç”¨è¯¥å¯¹è±¡çš„æ„é€ æ–¹æ³• â€œinitâ€:()V ï¼ˆä¼šæ¶ˆè€—æ‰æ ˆé¡¶ä¸€ä¸ªå¼•ç”¨ï¼‰ï¼Œå¦ä¸€ä¸ªè¦ é…åˆ astore_1 èµ‹å€¼ç»™å±€éƒ¨å˜é‡
- ç»ˆæ–¹æ³•ï¼ˆï¬nalï¼‰ï¼Œç§æœ‰æ–¹æ³•ï¼ˆprivateï¼‰ï¼Œæ„é€ æ–¹æ³•éƒ½æ˜¯ç”± invokespecial æŒ‡ä»¤æ¥è°ƒç”¨ï¼Œå±äºé™æ€ç»‘å®š
- æ™®é€šæˆå‘˜æ–¹æ³•æ˜¯ç”± invokevirtual è°ƒç”¨ï¼Œå±äº**åŠ¨æ€ç»‘å®š**ï¼Œå³æ”¯æŒå¤šæ€ æˆå‘˜æ–¹æ³•ä¸é™æ€æ–¹æ³•è°ƒç”¨çš„å¦ä¸€ä¸ªåŒºåˆ«æ˜¯ï¼Œæ‰§è¡Œæ–¹æ³•å‰æ˜¯å¦éœ€è¦ã€å¯¹è±¡å¼•ç”¨ã€‘

#### å¤šæ€åŸç†

å› ä¸ºæ™®é€šæˆå‘˜æ–¹æ³•éœ€è¦åœ¨è¿è¡Œæ—¶æ‰èƒ½ç¡®å®šå…·ä½“çš„å†…å®¹ï¼Œæ‰€ä»¥è™šæ‹Ÿæœºéœ€è¦è°ƒç”¨**invokevirtual**æŒ‡ä»¤

åœ¨æ‰§è¡ŒinvokevirtualæŒ‡ä»¤æ—¶ï¼Œç»å†äº†ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤

- å…ˆé€šè¿‡æ ˆå¸§ä¸­å¯¹è±¡çš„å¼•ç”¨æ‰¾åˆ°å¯¹è±¡
- åˆ†æå¯¹è±¡å¤´ï¼Œæ‰¾åˆ°å¯¹è±¡å®é™…çš„Class
- Classç»“æ„ä¸­æœ‰**vtable**
- æŸ¥è¯¢vtableæ‰¾åˆ°æ–¹æ³•çš„å…·ä½“åœ°å€
- æ‰§è¡Œæ–¹æ³•çš„å­—èŠ‚ç 

#### å¼‚å¸¸å¤„ç†

##### try-catch

```
public class Demo1 {
	public static void main(String[] args) {
		int i = 0;
		try {
			i = 10;
		}catch (Exception e) {
			i = 20;
		}
	}
}Copy
```

å¯¹åº”å­—èŠ‚ç æŒ‡ä»¤

```
Code:
     stack=1, locals=3, args_size=1
        0: iconst_0
        1: istore_1
        2: bipush        10
        4: istore_1
        5: goto          12
        8: astore_2
        9: bipush        20
       11: istore_1
       12: return
     //å¤šå‡ºæ¥ä¸€ä¸ªå¼‚å¸¸è¡¨
     Exception table:
        from    to  target type
            2     5     8   Class java/lang/ExceptionCopy
```

- å¯ä»¥çœ‹åˆ°å¤šå‡ºæ¥ä¸€ä¸ª Exception table çš„ç»“æ„ï¼Œ[from, to) æ˜¯**å‰é—­åå¼€**ï¼ˆä¹Ÿå°±æ˜¯æ£€æµ‹2~4è¡Œï¼‰çš„æ£€æµ‹èŒƒå›´ï¼Œä¸€æ—¦è¿™ä¸ªèŒƒå›´å†…çš„å­—èŠ‚ç æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œåˆ™é€šè¿‡ type åŒ¹é…å¼‚å¸¸ç±»å‹ï¼Œå¦‚æœä¸€è‡´ï¼Œè¿›å…¥ target æ‰€æŒ‡ç¤ºè¡Œå·
- 8è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤ astore_2 æ˜¯å°†å¼‚å¸¸å¯¹è±¡å¼•ç”¨å­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„2å·ä½ç½®ï¼ˆä¸ºeï¼‰

##### å¤šä¸ªsingle-catch

```
public class Demo1 {
	public static void main(String[] args) {
		int i = 0;
		try {
			i = 10;
		}catch (ArithmeticException e) {
			i = 20;
		}catch (Exception e) {
			i = 30;
		}
	}
}Copy
```

å¯¹åº”çš„å­—èŠ‚ç 

```
Code:
     stack=1, locals=3, args_size=1
        0: iconst_0
        1: istore_1
        2: bipush        10
        4: istore_1
        5: goto          19
        8: astore_2
        9: bipush        20
       11: istore_1
       12: goto          19
       15: astore_2
       16: bipush        30
       18: istore_1
       19: return
     Exception table:
        from    to  target type
            2     5     8   Class java/lang/ArithmeticException
            2     5    15   Class java/lang/ExceptionCopy
```

- å› ä¸ºå¼‚å¸¸å‡ºç°æ—¶ï¼Œ**åªèƒ½è¿›å…¥** Exception table ä¸­**ä¸€ä¸ªåˆ†æ”¯**ï¼Œæ‰€ä»¥å±€éƒ¨å˜é‡è¡¨ slot 2 ä½ç½®**è¢«å…±ç”¨**

##### finally

```
public class Demo2 {
	public static void main(String[] args) {
		int i = 0;
		try {
			i = 10;
		} catch (Exception e) {
			i = 20;
		} finally {
			i = 30;
		}
	}
}Copy
```

å¯¹åº”å­—èŠ‚ç 

```
Code:
     stack=1, locals=4, args_size=1
        0: iconst_0
        1: istore_1
        //tryå—
        2: bipush        10
        4: istore_1
        //tryå—æ‰§è¡Œå®Œåï¼Œä¼šæ‰§è¡Œfinally    
        5: bipush        30
        7: istore_1
        8: goto          27
       //catchå—     
       11: astore_2 //å¼‚å¸¸ä¿¡æ¯æ”¾å…¥å±€éƒ¨å˜é‡è¡¨çš„2å·æ§½ä½
       12: bipush        20
       14: istore_1
       //catchå—æ‰§è¡Œå®Œåï¼Œä¼šæ‰§è¡Œfinally        
       15: bipush        30
       17: istore_1
       18: goto          27
       //å‡ºç°å¼‚å¸¸ï¼Œä½†æœªè¢«Exceptionæ•è·ï¼Œä¼šæŠ›å‡ºå…¶ä»–å¼‚å¸¸ï¼Œè¿™æ—¶ä¹Ÿéœ€è¦æ‰§è¡Œfinallyå—ä¸­çš„ä»£ç    
       21: astore_3
       22: bipush        30
       24: istore_1
       25: aload_3
       26: athrow  //æŠ›å‡ºå¼‚å¸¸
       27: return
     Exception table:
        from    to  target type
            2     5    11   Class java/lang/Exception
            2     5    21   any
           11    15    21   anyCopy
```

å¯ä»¥çœ‹åˆ° ï¬nally ä¸­çš„ä»£ç è¢«**å¤åˆ¶äº† 3 ä»½**ï¼Œåˆ†åˆ«æ”¾å…¥ try æµç¨‹ï¼Œcatch æµç¨‹ä»¥åŠ catchå‰©ä½™çš„å¼‚å¸¸ç±»å‹æµç¨‹

**æ³¨æ„**ï¼šè™½ç„¶ä»å­—èŠ‚ç æŒ‡ä»¤çœ‹æ¥ï¼Œæ¯ä¸ªå—ä¸­éƒ½æœ‰finallyå—ï¼Œä½†æ˜¯finallyå—ä¸­çš„ä»£ç **åªä¼šè¢«æ‰§è¡Œä¸€æ¬¡**

##### finallyä¸­çš„return

```
public class Demo3 {
	public static void main(String[] args) {
		int i = Demo3.test();
        //ç»“æœä¸º20
		System.out.println(i);
	}

	public static int test() {
		int i;
		try {
			i = 10;
			return i;
		} finally {
			i = 20;
			return i;
		}
	}
}Copy
```

å¯¹åº”å­—èŠ‚ç 

```
Code:
     stack=1, locals=3, args_size=0
        0: bipush        10
        2: istore_0
        3: iload_0
        4: istore_1  //æš‚å­˜è¿”å›å€¼
        5: bipush        20
        7: istore_0
        8: iload_0
        9: ireturn	//ireturnä¼šè¿”å›æ“ä½œæ•°æ ˆé¡¶çš„æ•´å‹å€¼20
       //å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œè¿˜æ˜¯ä¼šæ‰§è¡Œfinallyå—ä¸­çš„å†…å®¹ï¼Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸
       10: astore_2
       11: bipush        20
       13: istore_0
       14: iload_0
       15: ireturn	//è¿™é‡Œæ²¡æœ‰athrowäº†ï¼Œä¹Ÿå°±æ˜¯å¦‚æœåœ¨finallyå—ä¸­å¦‚æœæœ‰è¿”å›æ“ä½œçš„è¯ï¼Œä¸”tryå—ä¸­å‡ºç°å¼‚å¸¸ï¼Œä¼šåæ‰å¼‚å¸¸ï¼
     Exception table:
        from    to  target type
            0     5    10   anyCopy
```

- ç”±äº ï¬nally ä¸­çš„ **ireturn** è¢«æ’å…¥äº†æ‰€æœ‰å¯èƒ½çš„æµç¨‹ï¼Œå› æ­¤è¿”å›ç»“æœè‚¯å®šä»¥ï¬nallyçš„ä¸ºå‡†
- è‡³äºå­—èŠ‚ç ä¸­ç¬¬ 2 è¡Œï¼Œä¼¼ä¹æ²¡å•¥ç”¨ï¼Œä¸”ç•™ä¸ªä¼ç¬”ï¼Œçœ‹ä¸‹ä¸ªä¾‹å­
- è·Ÿä¸Šä¾‹ä¸­çš„ ï¬nally ç›¸æ¯”ï¼Œå‘ç°**æ²¡æœ‰ athrow äº†**ï¼Œè¿™å‘Šè¯‰æˆ‘ä»¬ï¼šå¦‚æœåœ¨ ï¬nally ä¸­å‡ºç°äº† returnï¼Œä¼š**åæ‰å¼‚å¸¸**
- æ‰€ä»¥**ä¸è¦åœ¨finallyä¸­è¿›è¡Œè¿”å›æ“ä½œ**

##### è¢«åæ‰çš„å¼‚å¸¸

```
public class Demo3 {
   public static void main(String[] args) {
      int i = Demo3.test();
      //æœ€ç»ˆç»“æœä¸º20
      System.out.println(i);
   }

   public static int test() {
      int i;
      try {
         i = 10;
         //è¿™é‡Œåº”è¯¥ä¼šæŠ›å‡ºå¼‚å¸¸
         i = i/0;
         return i;
      } finally {
         i = 20;
         return i;
      }
   }
}Copy
```

ä¼šå‘ç°æ‰“å°ç»“æœä¸º20ï¼Œå¹¶æœªæŠ›å‡ºå¼‚å¸¸

##### finallyä¸å¸¦return

```
public class Demo4 {
	public static void main(String[] args) {
		int i = Demo4.test();
		System.out.println(i);
	}

	public static int test() {
		int i = 10;
		try {
			return i;
		} finally {
			i = 20;
		}
	}
}Copy
```

å¯¹åº”å­—èŠ‚ç 

```
Code:
     stack=1, locals=3, args_size=0
        0: bipush        10
        2: istore_0 //èµ‹å€¼ç»™i 10
        3: iload_0	//åŠ è½½åˆ°æ“ä½œæ•°æ ˆé¡¶
        4: istore_1 //åŠ è½½åˆ°å±€éƒ¨å˜é‡è¡¨çš„1å·ä½ç½®
        5: bipush        20
        7: istore_0 //èµ‹å€¼ç»™i 20
        8: iload_1 //åŠ è½½å±€éƒ¨å˜é‡è¡¨1å·ä½ç½®çš„æ•°10åˆ°æ“ä½œæ•°æ ˆ
        9: ireturn //è¿”å›æ“ä½œæ•°æ ˆé¡¶å…ƒç´  10
       10: astore_2
       11: bipush        20
       13: istore_0
       14: aload_2 //åŠ è½½å¼‚å¸¸
       15: athrow //æŠ›å‡ºå¼‚å¸¸
     Exception table:
        from    to  target type
            3     5    10   anyCopy
```

#### Synchronized

```
public class Demo5 {
	public static void main(String[] args) {
		int i = 10;
		Lock lock = new Lock();
		synchronized (lock) {
			System.out.println(i);
		}
	}
}

class Lock{}Copy
```

å¯¹åº”å­—èŠ‚ç 

```
Code:
     stack=2, locals=5, args_size=1
        0: bipush        10
        2: istore_1
        3: new           #2                  // class com/nyima/JVM/day06/Lock
        6: dup //å¤åˆ¶ä¸€ä»½ï¼Œæ”¾åˆ°æ“ä½œæ•°æ ˆé¡¶ï¼Œç”¨äºæ„é€ å‡½æ•°æ¶ˆè€—
        7: invokespecial #3                  // Method com/nyima/JVM/day06/Lock."<init>":()V
       10: astore_2 //å‰©ä¸‹çš„ä¸€ä»½æ”¾åˆ°å±€éƒ¨å˜é‡è¡¨çš„2å·ä½ç½®
       11: aload_2 //åŠ è½½åˆ°æ“ä½œæ•°æ ˆ
       12: dup //å¤åˆ¶ä¸€ä»½ï¼Œæ”¾åˆ°æ“ä½œæ•°æ ˆï¼Œç”¨äºåŠ é”æ—¶æ¶ˆè€—
       13: astore_3 //å°†æ“ä½œæ•°æ ˆé¡¶å…ƒç´ å¼¹å‡ºï¼Œæš‚å­˜åˆ°å±€éƒ¨å˜é‡è¡¨çš„ä¸‰å·æ§½ä½ã€‚è¿™æ—¶æ“ä½œæ•°æ ˆä¸­æœ‰ä¸€ä»½å¯¹è±¡çš„å¼•ç”¨
       14: monitorenter //åŠ é”
       //é”ä½åä»£ç å—ä¸­çš„æ“ä½œ    
       15: getstatic     #4                  // Field java/lang/System.out:Ljava/io/PrintStream;
       18: iload_1
       19: invokevirtual #5                  // Method java/io/PrintStream.println:(I)V
       //åŠ è½½å±€éƒ¨å˜é‡è¡¨ä¸­ä¸‰å·æ§½ä½å¯¹è±¡çš„å¼•ç”¨ï¼Œç”¨äºè§£é”    
       22: aload_3    
       23: monitorexit //è§£é”
       24: goto          34
       //å¼‚å¸¸æ“ä½œ    
       27: astore        4
       29: aload_3
       30: monitorexit //è§£é”
       31: aload         4
       33: athrow
       34: return
     //å¯ä»¥çœ‹å‡ºï¼Œæ— è®ºä½•æ—¶å‡ºç°å¼‚å¸¸ï¼Œéƒ½ä¼šè·³è½¬åˆ°27è¡Œï¼Œå°†å¼‚å¸¸æ”¾å…¥å±€éƒ¨å˜é‡ä¸­ï¼Œå¹¶è¿›è¡Œè§£é”æ“ä½œï¼Œç„¶ååŠ è½½å¼‚å¸¸å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚      
     Exception table:
        from    to  target type
           15    24    27   any
           27    31    27   anyCopy
```

### 3ã€ç¼–è¯‘æœŸå¤„ç†

æ‰€è°“çš„ **è¯­æ³•ç³–** ï¼Œå…¶å®å°±æ˜¯æŒ‡ java ç¼–è¯‘å™¨æŠŠ *.java æºç ç¼–è¯‘ä¸º \*.class å­—èŠ‚ç çš„è¿‡ç¨‹ä¸­ï¼Œ**è‡ªåŠ¨ç”Ÿæˆ**å’Œ**è½¬æ¢**çš„ä¸€äº›ä»£ç ï¼Œä¸»è¦æ˜¯ä¸ºäº†å‡è½»ç¨‹åºå‘˜çš„è´Ÿæ‹…ï¼Œç®—æ˜¯ java ç¼–è¯‘å™¨ç»™æˆ‘ä»¬çš„ä¸€ä¸ªé¢å¤–ç¦åˆ©

**æ³¨æ„**ï¼Œä»¥ä¸‹ä»£ç çš„åˆ†æï¼Œå€ŸåŠ©äº† javap å·¥å…·ï¼Œidea çš„åç¼–è¯‘åŠŸèƒ½ï¼Œidea æ’ä»¶ jclasslib ç­‰å·¥å…·ã€‚å¦å¤–ï¼Œ ç¼–è¯‘å™¨è½¬æ¢çš„**ç»“æœç›´æ¥å°±æ˜¯ class å­—èŠ‚ç **ï¼Œåªæ˜¯ä¸ºäº†ä¾¿äºé˜…è¯»ï¼Œç»™å‡ºäº† å‡ ä¹ç­‰ä»· çš„ java æºç æ–¹å¼ï¼Œå¹¶ä¸æ˜¯ç¼–è¯‘å™¨è¿˜ä¼šè½¬æ¢å‡ºä¸­é—´çš„ java æºç ï¼Œåˆ‡è®°ã€‚

#### é»˜è®¤æ„é€ å‡½æ•°

```
public class Candy1 {

}Copy
```

ç»è¿‡ç¼–è¯‘æœŸä¼˜åŒ–å

```
public class Candy1 {
   //è¿™ä¸ªæ— å‚æ„é€ å™¨æ˜¯javaç¼–è¯‘å™¨å¸®æˆ‘ä»¬åŠ ä¸Šçš„
   public Candy1() {
      //å³è°ƒç”¨çˆ¶ç±» Object çš„æ— å‚æ„é€ æ–¹æ³•ï¼Œå³è°ƒç”¨ java/lang/Object." <init>":()V
      super();
   }
}Copy
```

#### è‡ªåŠ¨æ‹†è£…ç®±

åŸºæœ¬ç±»å‹å’Œå…¶åŒ…è£…ç±»å‹çš„ç›¸äº’è½¬æ¢è¿‡ç¨‹ï¼Œç§°ä¸ºæ‹†è£…ç®±

åœ¨JDK 5ä»¥åï¼Œå®ƒä»¬çš„è½¬æ¢å¯ä»¥åœ¨ç¼–è¯‘æœŸè‡ªåŠ¨å®Œæˆ

```
public class Demo2 {
   public static void main(String[] args) {
      Integer x = 1;
      int y = x;
   }
}Copy
```

è½¬æ¢è¿‡ç¨‹å¦‚ä¸‹

```
public class Demo2 {
   public static void main(String[] args) {
      //åŸºæœ¬ç±»å‹èµ‹å€¼ç»™åŒ…è£…ç±»å‹ï¼Œç§°ä¸ºè£…ç®±
      Integer x = Integer.valueOf(1);
      //åŒ…è£…ç±»å‹èµ‹å€¼ç»™åŸºæœ¬ç±»å‹ï¼Œç§°è°“æ‹†ç®±
      int y = x.intValue();
   }
}Copy
```

#### æ³›å‹é›†åˆå–å€¼

æ³›å‹ä¹Ÿæ˜¯åœ¨ JDK 5 å¼€å§‹åŠ å…¥çš„ç‰¹æ€§ï¼Œä½† java åœ¨**ç¼–è¯‘æ³›å‹ä»£ç å**ä¼šæ‰§è¡Œ **æ³›å‹æ“¦é™¤** çš„åŠ¨ä½œï¼Œå³æ³›å‹ä¿¡æ¯åœ¨ç¼–è¯‘ä¸ºå­—èŠ‚ç ä¹‹åå°±**ä¸¢å¤±**äº†ï¼Œå®é™…çš„ç±»å‹éƒ½å½“åšäº† **Object** ç±»å‹æ¥å¤„ç†ï¼š

```
public class Demo3 {
   public static void main(String[] args) {
      List<Integer> list = new ArrayList<>();
      list.add(10);
      Integer x = list.get(0);
   }
}Copy
```

å¯¹åº”å­—èŠ‚ç 

```
Code:
    stack=2, locals=3, args_size=1
       0: new           #2                  // class java/util/ArrayList
       3: dup
       4: invokespecial #3                  // Method java/util/ArrayList."<init>":()V
       7: astore_1
       8: aload_1
       9: bipush        10
      11: invokestatic  #4                  // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;
      //è¿™é‡Œè¿›è¡Œäº†æ³›å‹æ“¦é™¤ï¼Œå®é™…è°ƒç”¨çš„æ˜¯add(Objcet o)
      14: invokeinterface #5,  2            // InterfaceMethod java/util/List.add:(Ljava/lang/Object;)Z

      19: pop
      20: aload_1
      21: iconst_0
      //è¿™é‡Œä¹Ÿè¿›è¡Œäº†æ³›å‹æ“¦é™¤ï¼Œå®é™…è°ƒç”¨çš„æ˜¯get(Object o)   
      22: invokeinterface #6,  2            // InterfaceMethod java/util/List.get:(I)Ljava/lang/Object;
//è¿™é‡Œè¿›è¡Œäº†ç±»å‹è½¬æ¢ï¼Œå°†Objectè½¬æ¢æˆäº†Integer
      27: checkcast     #7                  // class java/lang/Integer
      30: astore_2
      31: returnCopy
```

æ‰€ä»¥è°ƒç”¨getå‡½æ•°å–å€¼æ—¶ï¼Œæœ‰ä¸€ä¸ªç±»å‹è½¬æ¢çš„æ“ä½œ

```
Integer x = (Integer) list.get(0);Copy
```

å¦‚æœè¦å°†è¿”å›ç»“æœèµ‹å€¼ç»™ä¸€ä¸ªintç±»å‹çš„å˜é‡ï¼Œåˆ™è¿˜æœ‰**è‡ªåŠ¨æ‹†ç®±**çš„æ“ä½œ

```
int x = (Integer) list.get(0).intValue();Copy
```

#### å¯å˜å‚æ•°

```
public class Demo4 {
   public static void foo(String... args) {
      //å°†argsèµ‹å€¼ç»™arrï¼Œå¯ä»¥çœ‹å‡ºString...å®é™…å°±æ˜¯String[] 
      String[] arr = args;
      System.out.println(arr.length);
   }

   public static void main(String[] args) {
      foo("hello", "world");
   }
}Copy
```

å¯å˜å‚æ•° **Stringâ€¦** args å…¶å®æ˜¯ä¸€ä¸ª **String[]** args ï¼Œä»ä»£ç ä¸­çš„èµ‹å€¼è¯­å¥ä¸­å°±å¯ä»¥çœ‹å‡ºæ¥ã€‚ åŒ æ · java ç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æœŸé—´å°†ä¸Šè¿°ä»£ç å˜æ¢ä¸ºï¼š

```
public class Demo4 {
   public Demo4 {}

    
   public static void foo(String[] args) {
      String[] arr = args;
      System.out.println(arr.length);
   }

   public static void main(String[] args) {
      foo(new String[]{"hello", "world"});
   }
}Copy
```

æ³¨æ„ï¼Œå¦‚æœè°ƒç”¨çš„æ˜¯foo()ï¼Œå³æœªä¼ é€’å‚æ•°æ—¶ï¼Œç­‰ä»·ä»£ç ä¸ºfoo(new String[]{})ï¼Œ**åˆ›å»ºäº†ä¸€ä¸ªç©ºæ•°ç»„**ï¼Œè€Œä¸æ˜¯ç›´æ¥ä¼ é€’çš„null

#### foreach

```
public class Demo5 {
	public static void main(String[] args) {
        //æ•°ç»„èµ‹åˆå€¼çš„ç®€åŒ–å†™æ³•ä¹Ÿæ˜¯ä¸€ç§è¯­æ³•ç³–ã€‚
		int[] arr = {1, 2, 3, 4, 5};
		for(int x : arr) {
			System.out.println(x);
		}
	}
}Copy
```

ç¼–è¯‘å™¨ä¼šå¸®æˆ‘ä»¬è½¬æ¢ä¸º

```
public class Demo5 {
    public Demo5 {}

	public static void main(String[] args) {
		int[] arr = new int[]{1, 2, 3, 4, 5};
		for(int i=0; i<arr.length; ++i) {
			int x = arr[i];
			System.out.println(x);
		}
	}
}Copy
```

**å¦‚æœæ˜¯é›†åˆä½¿ç”¨foreach**

```
public class Demo5 {
   public static void main(String[] args) {
      List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
      for (Integer x : list) {
         System.out.println(x);
      }
   }
}Copy
```

é›†åˆè¦ä½¿ç”¨foreachï¼Œéœ€è¦è¯¥é›†åˆç±»å®ç°äº†**Iterableæ¥å£**ï¼Œå› ä¸ºé›†åˆçš„éå†éœ€è¦ç”¨åˆ°**è¿­ä»£å™¨Iterator**

```
public class Demo5 {
    public Demo5 {}
    
   public static void main(String[] args) {
      List<Integer> list = Arrays.asList(1, 2, 3, 4, 5);
      //è·å¾—è¯¥é›†åˆçš„è¿­ä»£å™¨
      Iterator<Integer> iterator = list.iterator();
      while(iterator.hasNext()) {
         Integer x = iterator.next();
         System.out.println(x);
      }
   }
}Copy
```

#### switchå­—ç¬¦ä¸²

```
public class Demo6 {
   public static void main(String[] args) {
      String str = "hello";
      switch (str) {
         case "hello" :
            System.out.println("h");
            break;
         case "world" :
            System.out.println("w");
            break;
         default:
            break;
      }
   }
}Copy
```

åœ¨ç¼–è¯‘å™¨ä¸­æ‰§è¡Œçš„æ“ä½œ

```
public class Demo6 {
   public Demo6() {
      
   }
   public static void main(String[] args) {
      String str = "hello";
      int x = -1;
      //é€šè¿‡å­—ç¬¦ä¸²çš„hashCode+valueæ¥åˆ¤æ–­æ˜¯å¦åŒ¹é…
      switch (str.hashCode()) {
         //helloçš„hashCode
         case 99162322 :
            //å†æ¬¡æ¯”è¾ƒï¼Œå› ä¸ºå­—ç¬¦ä¸²çš„hashCodeæœ‰å¯èƒ½ç›¸ç­‰
            if(str.equals("hello")) {
               x = 0;
            }
            break;
         //worldçš„hashCode
         case 11331880 :
            if(str.equals("world")) {
               x = 1;
            }
            break;
         default:
            break;
      }

      //ç”¨ç¬¬äºŒä¸ªswitchåœ¨è¿›è¡Œè¾“å‡ºåˆ¤æ–­
      switch (x) {
         case 0:
            System.out.println("h");
            break;
         case 1:
            System.out.println("w");
            break;
         default:
            break;
      }
   }
}Copy
```

è¿‡ç¨‹è¯´æ˜ï¼š

- åœ¨ç¼–è¯‘æœŸé—´ï¼Œå•ä¸ªçš„switchè¢«åˆ†ä¸ºäº†ä¸¤ä¸ª
  - ç¬¬ä¸€ä¸ªç”¨æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œå¹¶ç»™xèµ‹å€¼
    - å­—ç¬¦ä¸²çš„åŒ¹é…ç”¨åˆ°äº†å­—ç¬¦ä¸²çš„hashCodeï¼Œè¿˜ç”¨åˆ°äº†equalsæ–¹æ³•
    - ä½¿ç”¨hashCodeæ˜¯ä¸ºäº†æé«˜æ¯”è¾ƒæ•ˆç‡ï¼Œä½¿ç”¨equalsæ˜¯é˜²æ­¢æœ‰hashCodeå†²çªï¼ˆå¦‚BMå’ŒC.ï¼‰
  - ç¬¬äºŒä¸ªç”¨æ¥æ ¹æ®xçš„å€¼æ¥å†³å®šè¾“å‡ºè¯­å¥

#### switchæšä¸¾

```
public class Demo7 {
   public static void main(String[] args) {
      SEX sex = SEX.MALE;
      switch (sex) {
         case MALE:
            System.out.println("man");
            break;
         case FEMALE:
            System.out.println("woman");
            break;
         default:
            break;
      }
   }
}

enum SEX {
   MALE, FEMALE;
}Copy
```

ç¼–è¯‘å™¨ä¸­æ‰§è¡Œçš„ä»£ç å¦‚ä¸‹

```
public class Demo7 {
   /**     
    * å®šä¹‰ä¸€ä¸ªåˆæˆç±»ï¼ˆä»… jvm ä½¿ç”¨ï¼Œå¯¹æˆ‘ä»¬ä¸å¯è§ï¼‰     
    * ç”¨æ¥æ˜ å°„æšä¸¾çš„ ordinal ä¸æ•°ç»„å…ƒç´ çš„å…³ç³»     
    * æšä¸¾çš„ ordinal è¡¨ç¤ºæšä¸¾å¯¹è±¡çš„åºå·ï¼Œä» 0 å¼€å§‹     
    * å³ MALE çš„ ordinal()=0ï¼ŒFEMALE çš„ ordinal()=1     
    */ 
   static class $MAP {
      //æ•°ç»„å¤§å°å³ä¸ºæšä¸¾å…ƒç´ ä¸ªæ•°ï¼Œé‡Œé¢å­˜æ”¾äº†caseç”¨äºæ¯”è¾ƒçš„æ•°å­—
      static int[] map = new int[2];
      static {
         //ordinalå³æšä¸¾å…ƒç´ å¯¹åº”æ‰€åœ¨çš„ä½ç½®ï¼ŒMALEä¸º0ï¼ŒFEMALEä¸º1
         map[SEX.MALE.ordinal()] = 1;
         map[SEX.FEMALE.ordinal()] = 2;
      }
   }

   public static void main(String[] args) {
      SEX sex = SEX.MALE;
      //å°†å¯¹åº”ä½ç½®æšä¸¾å…ƒç´ çš„å€¼èµ‹ç»™xï¼Œç”¨äºcaseæ“ä½œ
      int x = $MAP.map[sex.ordinal()];
      switch (x) {
         case 1:
            System.out.println("man");
            break;
         case 2:
            System.out.println("woman");
            break;
         default:
            break;
      }
   }
}

enum SEX {
   MALE, FEMALE;
}Copy
```

#### æšä¸¾ç±»

```
enum SEX {
   MALE, FEMALE;
}Copy
```

è½¬æ¢åçš„ä»£ç 

```
public final class Sex extends Enum<Sex> {   
   //å¯¹åº”æšä¸¾ç±»ä¸­çš„å…ƒç´ 
   public static final Sex MALE;    
   public static final Sex FEMALE;    
   private static final Sex[] $VALUES;
   
    static {       
    	//è°ƒç”¨æ„é€ å‡½æ•°ï¼Œä¼ å…¥æšä¸¾å…ƒç´ çš„å€¼åŠordinal
    	MALE = new Sex("MALE", 0);    
        FEMALE = new Sex("FEMALE", 1);   
        $VALUES = new Sex[]{MALE, FEMALE}; 
   }
 	
   //è°ƒç”¨çˆ¶ç±»ä¸­çš„æ–¹æ³•
    private Sex(String name, int ordinal) {     
        super(name, ordinal);    
    }
   
    public static Sex[] values() {  
        return $VALUES.clone();  
    }
    public static Sex valueOf(String name) { 
        return Enum.valueOf(Sex.class, name);  
    } 
   
}Copy
```

#### åŒ¿åå†…éƒ¨ç±»

```
public class Demo8 {
   public static void main(String[] args) {
      Runnable runnable = new Runnable() {
         @Override
         public void run() {
            System.out.println("running...");
         }
      };
   }
}Copy
```

è½¬æ¢åçš„ä»£ç 

```
public class Demo8 {
   public static void main(String[] args) {
      //ç”¨é¢å¤–åˆ›å»ºçš„ç±»æ¥åˆ›å»ºåŒ¿åå†…éƒ¨ç±»å¯¹è±¡
      Runnable runnable = new Demo8$1();
   }
}

//åˆ›å»ºäº†ä¸€ä¸ªé¢å¤–çš„ç±»ï¼Œå®ç°äº†Runnableæ¥å£
final class Demo8$1 implements Runnable {
   public Demo8$1() {}

   @Override
   public void run() {
      System.out.println("running...");
   }
}Copy
```

å¦‚æœåŒ¿åå†…éƒ¨ç±»ä¸­å¼•ç”¨äº†**å±€éƒ¨å˜é‡**

```
public class Demo8 {
   public static void main(String[] args) {
      int x = 1;
      Runnable runnable = new Runnable() {
         @Override
         public void run() {
            System.out.println(x);
         }
      };
   }
}Copy
```

è½¬åŒ–åä»£ç 

```
public class Demo8 {
   public static void main(String[] args) {
      int x = 1;
      Runnable runnable = new Runnable() {
         @Override
         public void run() {
            System.out.println(x);
         }
      };
   }
}

final class Demo8$1 implements Runnable {
   //å¤šåˆ›å»ºäº†ä¸€ä¸ªå˜é‡
   int val$x;
   //å˜ä¸ºäº†æœ‰å‚æ„é€ å™¨
   public Demo8$1(int x) {
      this.val$x = x;
   }

   @Override
   public void run() {
      System.out.println(val$x);
   }
}Copy
```

### 4ã€ç±»åŠ è½½é˜¶æ®µ

#### åŠ è½½

- å°†ç±»çš„å­—èŠ‚ç è½½å…¥

  æ–¹æ³•åŒº

  ï¼ˆ1.8åä¸ºå…ƒç©ºé—´ï¼Œåœ¨æœ¬åœ°å†…å­˜ä¸­ï¼‰ä¸­ï¼Œå†…éƒ¨é‡‡ç”¨ C++ çš„ instanceKlass æè¿° java ç±»ï¼Œå®ƒçš„é‡è¦ ï¬eld æœ‰ï¼š

  - _java_mirror å³ java çš„ç±»é•œåƒï¼Œä¾‹å¦‚å¯¹ String æ¥è¯´ï¼Œå®ƒçš„é•œåƒç±»å°±æ˜¯ String.classï¼Œä½œç”¨æ˜¯æŠŠ klass æš´éœ²ç»™ java ä½¿ç”¨
  - _super å³çˆ¶ç±»
  - _ï¬elds å³æˆå‘˜å˜é‡
  - _methods å³æ–¹æ³•
  - _constants å³å¸¸é‡æ± 
  - _class_loader å³ç±»åŠ è½½å™¨
  - _vtable è™šæ–¹æ³•è¡¨
  - _itable æ¥å£æ–¹æ³•

- å¦‚æœè¿™ä¸ªç±»è¿˜æœ‰çˆ¶ç±»æ²¡æœ‰åŠ è½½ï¼Œ**å…ˆåŠ è½½çˆ¶ç±»**

- åŠ è½½å’Œé“¾æ¥å¯èƒ½æ˜¯**äº¤æ›¿è¿è¡Œ**çš„

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611205050.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611205050.png)

- instanceKlassä¿å­˜åœ¨**æ–¹æ³•åŒº**ã€‚JDK 8ä»¥åï¼Œæ–¹æ³•åŒºä½äºå…ƒç©ºé—´ä¸­ï¼Œè€Œå…ƒç©ºé—´åˆä½äºæœ¬åœ°å†…å­˜ä¸­
- _java_mirroråˆ™æ˜¯ä¿å­˜åœ¨**å †å†…å­˜**ä¸­
- InstanceKlasså’Œ*.class(JAVAé•œåƒç±»)äº’ç›¸ä¿å­˜äº†å¯¹æ–¹çš„åœ°å€
- ç±»çš„å¯¹è±¡åœ¨å¯¹è±¡å¤´ä¸­ä¿å­˜äº†*.classçš„åœ°å€ã€‚è®©å¯¹è±¡å¯ä»¥é€šè¿‡å…¶æ‰¾åˆ°æ–¹æ³•åŒºä¸­çš„instanceKlassï¼Œä»è€Œè·å–ç±»çš„å„ç§ä¿¡æ¯

#### é“¾æ¥

##### éªŒè¯

éªŒè¯ç±»æ˜¯å¦ç¬¦åˆ JVMè§„èŒƒï¼Œå®‰å…¨æ€§æ£€æŸ¥

##### å‡†å¤‡

ä¸º static å˜é‡åˆ†é…ç©ºé—´ï¼Œè®¾ç½®é»˜è®¤å€¼

- staticå˜é‡åœ¨JDK 7ä»¥å‰æ˜¯å­˜å‚¨ä¸instanceKlassæœ«å°¾ã€‚ä½†åœ¨JDK 7ä»¥åå°±å­˜å‚¨åœ¨_java_mirroræœ«å°¾äº†
- staticå˜é‡åœ¨åˆ†é…ç©ºé—´å’Œèµ‹å€¼æ˜¯åœ¨ä¸¤ä¸ªé˜¶æ®µå®Œæˆçš„ã€‚åˆ†é…ç©ºé—´åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆï¼Œèµ‹å€¼åœ¨åˆå§‹åŒ–é˜¶æ®µå®Œæˆ
- å¦‚æœ static å˜é‡æ˜¯ ï¬nal çš„**åŸºæœ¬ç±»å‹**ï¼Œä»¥åŠ**å­—ç¬¦ä¸²å¸¸é‡**ï¼Œé‚£ä¹ˆç¼–è¯‘é˜¶æ®µå€¼å°±ç¡®å®šäº†ï¼Œ**èµ‹å€¼åœ¨å‡†å¤‡é˜¶æ®µå®Œæˆ**
- å¦‚æœ static å˜é‡æ˜¯ ï¬nal çš„ï¼Œä½†å±äº**å¼•ç”¨ç±»å‹**ï¼Œé‚£ä¹ˆèµ‹å€¼ä¹Ÿä¼šåœ¨**åˆå§‹åŒ–é˜¶æ®µå®Œæˆ**

##### è§£æ

**HSDBçš„ä½¿ç”¨**

- å…ˆè·å¾—è¦æŸ¥çœ‹çš„è¿›ç¨‹ID

```
jpsCopy
```

- æ‰“å¼€HSDB

```
java -cp F:\JAVA\JDK8.0\lib\sa-jdi.jar sun.jvm.hotspot.HSDBCopy
```

- è¿è¡Œæ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œæ˜¯å› ä¸º**ç¼ºå°‘ä¸€ä¸ª.dllçš„æ–‡ä»¶**ï¼Œæˆ‘ä»¬åœ¨JDKçš„å®‰è£…ç›®å½•ä¸­æ‰¾åˆ°è¯¥æ–‡ä»¶ï¼Œå¤åˆ¶åˆ°ç¼ºå¤±çš„æ–‡ä»¶ä¸‹å³å¯

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611221703.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221703.png)

- å®šä½éœ€è¦çš„è¿›ç¨‹

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611221857.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611221857.png)

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611222029.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611222029.png)

**è§£æçš„å«ä¹‰**

å°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨

- æœªè§£ææ—¶ï¼Œå¸¸é‡æ± ä¸­çš„çœ‹åˆ°çš„å¯¹è±¡ä»…æ˜¯ç¬¦å·ï¼ŒæœªçœŸæ­£çš„å­˜åœ¨äºå†…å­˜ä¸­

```
public class Demo1 {
   public static void main(String[] args) throws IOException, ClassNotFoundException {
      ClassLoader loader = Demo1.class.getClassLoader();
      //åªåŠ è½½ä¸è§£æ
      Class<?> c = loader.loadClass("com.nyima.JVM.day8.C");
      //ç”¨äºé˜»å¡ä¸»çº¿ç¨‹
      System.in.read();
   }
}

class C {
   D d = new D();
}

class D {

}Copy
```

- æ‰“å¼€HSDB
  - å¯ä»¥çœ‹åˆ°æ­¤æ—¶åªåŠ è½½äº†ç±»C

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611223153.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223153.png)

æŸ¥çœ‹ç±»Cçš„å¸¸é‡æ± ï¼Œå¯ä»¥çœ‹åˆ°ç±»D**æœªè¢«è§£æ**ï¼Œåªæ˜¯å­˜åœ¨äºå¸¸é‡æ± ä¸­çš„ç¬¦å·

[![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611230658.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611230658.png)

- è§£æä»¥åï¼Œä¼šå°†å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨è§£æä¸ºç›´æ¥å¼•ç”¨

  - å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶å·²åŠ è½½å¹¶è§£æäº†ç±»Cå’Œç±»D

  [![img](https://gitee.com/tsuiraku/typora/raw/master/img/20200611223441.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200611223441.png)

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200613104723.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200613104723.png)

#### åˆå§‹åŒ–

åˆå§‹åŒ–é˜¶æ®µå°±æ˜¯**æ‰§è¡Œç±»æ„é€ å™¨clinit()æ–¹æ³•çš„è¿‡ç¨‹**ï¼Œè™šæ‹Ÿæœºä¼šä¿è¯è¿™ä¸ªç±»çš„ã€æ„é€ æ–¹æ³•ã€çš„çº¿ç¨‹å®‰å…¨

- clinit()æ–¹æ³•æ˜¯ç”±ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†ç±»ä¸­çš„æ‰€æœ‰ç±»å˜é‡çš„**èµ‹å€¼åŠ¨ä½œå’Œé™æ€è¯­å¥å—**ï¼ˆstatic{}å—ï¼‰ä¸­çš„è¯­å¥åˆå¹¶äº§ç”Ÿçš„

**æ³¨æ„**

ç¼–è¯‘å™¨æ”¶é›†çš„é¡ºåºæ˜¯ç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­**å‡ºç°çš„é¡ºåºå†³å®š**çš„ï¼Œé™æ€è¯­å¥å—ä¸­åªèƒ½è®¿é—®åˆ°å®šä¹‰åœ¨é™æ€è¯­å¥å—ä¹‹å‰çš„å˜é‡ï¼Œå®šä¹‰åœ¨å®ƒ**ä¹‹å**çš„å˜é‡ï¼Œåœ¨å‰é¢çš„é™æ€è¯­å¥å—**å¯ä»¥èµ‹å€¼ï¼Œä½†æ˜¯ä¸èƒ½è®¿é—®**ï¼Œå¦‚

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201118204542.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20201118204542.png)

##### å‘ç”Ÿæ—¶æœº

**ç±»çš„åˆå§‹åŒ–çš„æ‡’æƒ°çš„**ï¼Œä»¥ä¸‹æƒ…å†µä¼šåˆå§‹åŒ–

- main æ–¹æ³•æ‰€åœ¨çš„ç±»ï¼Œæ€»ä¼šè¢«é¦–å…ˆåˆå§‹åŒ–
- é¦–æ¬¡è®¿é—®è¿™ä¸ªç±»çš„é™æ€å˜é‡æˆ–é™æ€æ–¹æ³•æ—¶
- å­ç±»åˆå§‹åŒ–ï¼Œå¦‚æœçˆ¶ç±»è¿˜æ²¡åˆå§‹åŒ–ï¼Œä¼šå¼•å‘
- å­ç±»è®¿é—®çˆ¶ç±»çš„é™æ€å˜é‡ï¼Œåªä¼šè§¦å‘çˆ¶ç±»çš„åˆå§‹åŒ–
- Class.forName
- new ä¼šå¯¼è‡´åˆå§‹åŒ–

ä»¥ä¸‹æƒ…å†µä¸ä¼šåˆå§‹åŒ–

- è®¿é—®ç±»çš„ static ï¬nal é™æ€å¸¸é‡ï¼ˆåŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ï¼‰
- ç±»å¯¹è±¡.class ä¸ä¼šè§¦å‘åˆå§‹åŒ–
- åˆ›å»ºè¯¥ç±»å¯¹è±¡çš„æ•°ç»„
- ç±»åŠ è½½å™¨çš„.loadClassæ–¹æ³•
- Class.forNamedçš„å‚æ•°2ä¸ºfalseæ—¶

**éªŒè¯ç±»æ˜¯å¦è¢«åˆå§‹åŒ–ï¼Œå¯ä»¥çœ‹æ”¹ç±»çš„é™æ€ä»£ç å—æ˜¯å¦è¢«æ‰§è¡Œ**

### 5ã€ç±»åŠ è½½å™¨

Javaè™šæ‹Ÿæœºè®¾è®¡å›¢é˜Ÿæœ‰æ„æŠŠç±»åŠ è½½é˜¶æ®µä¸­çš„**â€œé€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°è¯¥ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµâ€**è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°Javaè™šæ‹Ÿæœºå¤–éƒ¨å»å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€çš„ç±»ã€‚å®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç è¢«ç§°ä¸º**â€œç±»åŠ è½½å™¨â€**ï¼ˆClassLoaderï¼‰

#### ç±»ä¸ç±»åŠ è½½å™¨

ç±»åŠ è½½å™¨è™½ç„¶åªç”¨äºå®ç°ç±»çš„åŠ è½½åŠ¨ä½œï¼Œä½†å®ƒåœ¨Javaç¨‹åºä¸­èµ·åˆ°çš„ä½œç”¨å´è¿œè¶…ç±»åŠ è½½é˜¶æ®µ

å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½å¿…é¡»ç”±åŠ è½½å®ƒçš„**ç±»åŠ è½½å™¨**å’Œè¿™ä¸ª**ç±»æœ¬èº«**ä¸€èµ·å…±åŒç¡®ç«‹å…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»åç§°ç©ºé—´ã€‚è¿™å¥è¯å¯ä»¥è¡¨è¾¾å¾—æ›´é€šä¿—ä¸€äº›ï¼š**æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦â€œç›¸ç­‰â€ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰**ï¼Œå¦åˆ™ï¼Œå³ä½¿è¿™ä¸¤ä¸ªç±»æ¥æºäºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªJavaè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£è¿™ä¸¤ä¸ªç±»å°±å¿…å®šä¸ç›¸ç­‰

ä»¥JDK 8ä¸ºä¾‹

| åç§°                                      | åŠ è½½çš„ç±»              | è¯´æ˜                            |
| ----------------------------------------- | --------------------- | ------------------------------- |
| Bootstrap ClassLoaderï¼ˆå¯åŠ¨ç±»åŠ è½½å™¨ï¼‰     | JAVA_HOME/jre/lib     | æ— æ³•ç›´æ¥è®¿é—®                    |
| Extension ClassLoader(æ‹“å±•ç±»åŠ è½½å™¨)       | JAVA_HOME/jre/lib/ext | ä¸Šçº§ä¸ºBootstrapï¼Œ**æ˜¾ç¤ºä¸ºnull** |
| Application ClassLoader(åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨) | classpath             | ä¸Šçº§ä¸ºExtension                 |
| è‡ªå®šä¹‰ç±»åŠ è½½å™¨                            | è‡ªå®šä¹‰                | ä¸Šçº§ä¸ºApplication               |

#### å¯åŠ¨ç±»åŠ è½½å™¨

å¯é€šè¿‡åœ¨æ§åˆ¶å°è¾“å…¥æŒ‡ä»¤ï¼Œä½¿å¾—ç±»è¢«å¯åŠ¨ç±»åŠ å™¨åŠ è½½

#### æ‹“å±•ç±»åŠ è½½å™¨

å¦‚æœclasspathå’ŒJAVA_HOME/jre/lib/ext ä¸‹æœ‰åŒåç±»ï¼ŒåŠ è½½æ—¶ä¼šä½¿ç”¨**æ‹“å±•ç±»åŠ è½½å™¨**åŠ è½½ã€‚å½“åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å‘ç°æ‹“å±•ç±»åŠ è½½å™¨å·²å°†è¯¥åŒåç±»åŠ è½½è¿‡äº†ï¼Œåˆ™ä¸ä¼šå†æ¬¡åŠ è½½

#### åŒäº²å§”æ´¾æ¨¡å¼

åŒäº²å§”æ´¾æ¨¡å¼ï¼Œå³è°ƒç”¨ç±»åŠ è½½å™¨ClassLoader çš„ loadClass æ–¹æ³•æ—¶ï¼ŒæŸ¥æ‰¾ç±»çš„è§„åˆ™

loadClassæºç 

```
protected Class<?> loadClass(String name, boolean resolve)
    throws ClassNotFoundException
{
    synchronized (getClassLoadingLock(name)) {
        // é¦–å…ˆæŸ¥æ‰¾è¯¥ç±»æ˜¯å¦å·²ç»è¢«è¯¥ç±»åŠ è½½å™¨åŠ è½½è¿‡äº†
        Class<?> c = findLoadedClass(name);
        //å¦‚æœæ²¡æœ‰è¢«åŠ è½½è¿‡
        if (c == null) {
            long t0 = System.nanoTime();
            try {
                //çœ‹æ˜¯å¦è¢«å®ƒçš„ä¸Šçº§åŠ è½½å™¨åŠ è½½è¿‡äº† Extensionçš„ä¸Šçº§æ˜¯Bootstarpï¼Œä½†å®ƒæ˜¾ç¤ºä¸ºnull
                if (parent != null) {
                    c = parent.loadClass(name, false);
                } else {
                    //çœ‹æ˜¯å¦è¢«å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½è¿‡
                    c = findBootstrapClassOrNull(name);
                }
            } catch (ClassNotFoundException e) {
                // ClassNotFoundException thrown if class not found
                // from the non-null parent class loader
                //æ•è·å¼‚å¸¸ï¼Œä½†ä¸åšä»»ä½•å¤„ç†
            }

            if (c == null) {
                //å¦‚æœè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œå…ˆè®©æ‹“å±•ç±»åŠ è½½å™¨è°ƒç”¨findClassæ–¹æ³•å»æ‰¾åˆ°è¯¥ç±»ï¼Œå¦‚æœè¿˜æ˜¯æ²¡æ‰¾åˆ°ï¼Œå°±æŠ›å‡ºå¼‚å¸¸
                //ç„¶åè®©åº”ç”¨ç±»åŠ è½½å™¨å»æ‰¾classpathä¸‹æ‰¾è¯¥ç±»
                long t1 = System.nanoTime();
                c = findClass(name);

                // è®°å½•æ—¶é—´
                sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0);
                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);
                sun.misc.PerfCounter.getFindClasses().increment();
            }
        }
        if (resolve) {
            resolveClass(c);
        }
        return c;
    }
}Copy
```

#### è‡ªå®šä¹‰ç±»åŠ è½½å™¨

##### ä½¿ç”¨åœºæ™¯

- æƒ³åŠ è½½é classpath éšæ„è·¯å¾„ä¸­çš„ç±»æ–‡ä»¶
- é€šè¿‡æ¥å£æ¥ä½¿ç”¨å®ç°ï¼Œå¸Œæœ›è§£è€¦æ—¶ï¼Œå¸¸ç”¨åœ¨æ¡†æ¶è®¾è®¡
- è¿™äº›ç±»å¸Œæœ›äºˆä»¥éš”ç¦»ï¼Œä¸åŒåº”ç”¨çš„åŒåç±»éƒ½å¯ä»¥åŠ è½½ï¼Œä¸å†²çªï¼Œå¸¸è§äº tomcat å®¹å™¨

##### æ­¥éª¤

- ç»§æ‰¿ClassLoaderçˆ¶ç±»
- è¦éµä»åŒäº²å§”æ´¾æœºåˆ¶ï¼Œé‡å†™ ï¬ndClass æ–¹æ³•
  - ä¸æ˜¯é‡å†™loadClassæ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šèµ°åŒäº²å§”æ´¾æœºåˆ¶
- è¯»å–ç±»æ–‡ä»¶çš„å­—èŠ‚ç 
- è°ƒç”¨çˆ¶ç±»çš„ deï¬neClass æ–¹æ³•æ¥åŠ è½½ç±»
- ä½¿ç”¨è€…è°ƒç”¨è¯¥ç±»åŠ è½½å™¨çš„ loadClass æ–¹æ³•

#### ç ´ååŒäº²å§”æ´¾æ¨¡å¼

- åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸€æ¬¡â€œè¢«ç ´åâ€å…¶å®å‘ç”Ÿåœ¨åŒäº²å§”æ´¾æ¨¡å‹å‡ºç°ä¹‹å‰â€”â€”å³JDK1.2é¢ä¸–ä»¥å‰çš„â€œè¿œå¤â€æ—¶ä»£
  - å»ºè®®ç”¨æˆ·é‡å†™findClass()æ–¹æ³•ï¼Œåœ¨ç±»åŠ è½½å™¨ä¸­çš„loadClass()æ–¹æ³•ä¸­ä¹Ÿä¼šè°ƒç”¨è¯¥æ–¹æ³•
- åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬äºŒæ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±è¿™ä¸ªæ¨¡å‹è‡ªèº«çš„ç¼ºé™·å¯¼è‡´çš„
  - å¦‚æœæœ‰åŸºç¡€ç±»å‹åˆè¦è°ƒç”¨å›ç”¨æˆ·çš„ä»£ç ï¼Œæ­¤æ—¶ä¹Ÿä¼šç ´ååŒäº²å§”æ´¾æ¨¡å¼
- åŒäº²å§”æ´¾æ¨¡å‹çš„ç¬¬ä¸‰æ¬¡â€œè¢«ç ´åâ€æ˜¯ç”±äºç”¨æˆ·å¯¹ç¨‹åºåŠ¨æ€æ€§çš„è¿½æ±‚è€Œå¯¼è‡´çš„
  - è¿™é‡Œæ‰€è¯´çš„â€œåŠ¨æ€æ€§â€æŒ‡çš„æ˜¯ä¸€äº›éå¸¸â€œçƒ­â€é—¨çš„åè¯ï¼šä»£ç çƒ­æ›¿æ¢ï¼ˆHot Swapï¼‰ã€æ¨¡å—çƒ­éƒ¨ç½²ï¼ˆHot Deploymentï¼‰ç­‰

### 6ã€è¿è¡ŒæœŸä¼˜åŒ–

#### åˆ†å±‚ç¼–è¯‘

JVM å°†æ‰§è¡ŒçŠ¶æ€åˆ†æˆäº† 5 ä¸ªå±‚æ¬¡ï¼š

- 0å±‚ï¼šè§£é‡Šæ‰§è¡Œï¼Œç”¨è§£é‡Šå™¨å°†å­—èŠ‚ç ç¿»è¯‘ä¸ºæœºå™¨ç 
- 1å±‚ï¼šä½¿ç”¨ C1 **å³æ—¶ç¼–è¯‘å™¨**ç¼–è¯‘æ‰§è¡Œï¼ˆä¸å¸¦ proï¬lingï¼‰
- 2å±‚ï¼šä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦åŸºæœ¬çš„profilingï¼‰
- 3å±‚ï¼šä½¿ç”¨ C1 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œï¼ˆå¸¦å®Œå…¨çš„profilingï¼‰
- 4å±‚ï¼šä½¿ç”¨ C2 å³æ—¶ç¼–è¯‘å™¨ç¼–è¯‘æ‰§è¡Œ

proï¬ling æ˜¯æŒ‡åœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ”¶é›†ä¸€äº›ç¨‹åºæ‰§è¡ŒçŠ¶æ€çš„æ•°æ®ï¼Œä¾‹å¦‚ã€æ–¹æ³•çš„è°ƒç”¨æ¬¡æ•°ã€‘ï¼Œã€å¾ªç¯çš„ å›è¾¹æ¬¡æ•°ã€‘ç­‰

##### å³æ—¶ç¼–è¯‘å™¨ï¼ˆJITï¼‰ä¸è§£é‡Šå™¨çš„åŒºåˆ«

- è§£é‡Šå™¨
  - å°†å­—èŠ‚ç **è§£é‡Š**ä¸ºæœºå™¨ç ï¼Œä¸‹æ¬¡å³ä½¿é‡åˆ°ç›¸åŒçš„å­—èŠ‚ç ï¼Œä»ä¼šæ‰§è¡Œé‡å¤çš„è§£é‡Š
  - æ˜¯å°†å­—èŠ‚ç è§£é‡Šä¸ºé’ˆå¯¹æ‰€æœ‰å¹³å°éƒ½é€šç”¨çš„æœºå™¨ç 
- å³æ—¶ç¼–è¯‘å™¨
  - å°†ä¸€äº›å­—èŠ‚ç **ç¼–è¯‘**ä¸ºæœºå™¨ç ï¼Œ**å¹¶å­˜å…¥ Code Cache**ï¼Œä¸‹æ¬¡é‡åˆ°ç›¸åŒçš„ä»£ç ï¼Œç›´æ¥æ‰§è¡Œï¼Œæ— éœ€å†ç¼–è¯‘
  - æ ¹æ®å¹³å°ç±»å‹ï¼Œç”Ÿæˆå¹³å°ç‰¹å®šçš„æœºå™¨ç 

å¯¹äºå¤§éƒ¨åˆ†çš„ä¸å¸¸ç”¨çš„ä»£ç ï¼Œæˆ‘ä»¬æ— éœ€è€—è´¹æ—¶é—´å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œè€Œæ˜¯é‡‡å–è§£é‡Šæ‰§è¡Œçš„æ–¹å¼è¿è¡Œï¼›å¦ä¸€æ–¹é¢ï¼Œå¯¹äºä»…å æ®å°éƒ¨åˆ†çš„çƒ­ç‚¹ä»£ç ï¼Œæˆ‘ä»¬åˆ™å¯ä»¥å°†å…¶ç¼–è¯‘æˆæœºå™¨ç ï¼Œä»¥è¾¾åˆ°ç†æƒ³çš„è¿è¡Œé€Ÿåº¦ã€‚ æ‰§è¡Œæ•ˆç‡ä¸Šç®€å•æ¯”è¾ƒä¸€ä¸‹ Interpreter < C1 < C2ï¼Œæ€»çš„ç›®æ ‡æ˜¯å‘ç°çƒ­ç‚¹ä»£ç ï¼ˆhotspotåç§°çš„ç”± æ¥ï¼‰ï¼Œå¹¶ä¼˜åŒ–è¿™äº›çƒ­ç‚¹ä»£ç 

##### é€ƒé€¸åˆ†æ

é€ƒé€¸åˆ†æï¼ˆEscape Analysisï¼‰ç®€å•æ¥è®²å°±æ˜¯ï¼ŒJava Hotspot è™šæ‹Ÿæœºå¯ä»¥åˆ†ææ–°åˆ›å»ºå¯¹è±¡çš„ä½¿ç”¨èŒƒå›´ï¼Œå¹¶å†³å®šæ˜¯å¦åœ¨ Java å †ä¸Šåˆ†é…å†…å­˜çš„ä¸€é¡¹æŠ€æœ¯

é€ƒé€¸åˆ†æçš„ JVM å‚æ•°å¦‚ä¸‹ï¼š

- å¼€å¯é€ƒé€¸åˆ†æï¼š-XX:+DoEscapeAnalysis
- å…³é—­é€ƒé€¸åˆ†æï¼š-XX:-DoEscapeAnalysis
- æ˜¾ç¤ºåˆ†æç»“æœï¼š-XX:+PrintEscapeAnalysis

é€ƒé€¸åˆ†ææŠ€æœ¯åœ¨ Java SE 6u23+ å¼€å§‹æ”¯æŒï¼Œå¹¶é»˜è®¤è®¾ç½®ä¸ºå¯ç”¨çŠ¶æ€ï¼Œå¯ä»¥ä¸ç”¨é¢å¤–åŠ è¿™ä¸ªå‚æ•°

**å¯¹è±¡é€ƒé€¸çŠ¶æ€**

**å…¨å±€é€ƒé€¸ï¼ˆGlobalEscapeï¼‰**

- å³ä¸€ä¸ªå¯¹è±¡çš„ä½œç”¨èŒƒå›´é€ƒå‡ºäº†å½“å‰æ–¹æ³•æˆ–è€…å½“å‰çº¿ç¨‹ï¼Œæœ‰ä»¥ä¸‹å‡ ç§åœºæ™¯ï¼š
  - å¯¹è±¡æ˜¯ä¸€ä¸ªé™æ€å˜é‡
  - å¯¹è±¡æ˜¯ä¸€ä¸ªå·²ç»å‘ç”Ÿé€ƒé€¸çš„å¯¹è±¡
  - å¯¹è±¡ä½œä¸ºå½“å‰æ–¹æ³•çš„è¿”å›å€¼

**å‚æ•°é€ƒé€¸ï¼ˆArgEscapeï¼‰**

- å³ä¸€ä¸ªå¯¹è±¡è¢«ä½œä¸ºæ–¹æ³•å‚æ•°ä¼ é€’æˆ–è€…è¢«å‚æ•°å¼•ç”¨ï¼Œä½†åœ¨è°ƒç”¨è¿‡ç¨‹ä¸­ä¸ä¼šå‘ç”Ÿå…¨å±€é€ƒé€¸ï¼Œè¿™ä¸ªçŠ¶æ€æ˜¯é€šè¿‡è¢«è°ƒæ–¹æ³•çš„å­—èŠ‚ç ç¡®å®šçš„

**æ²¡æœ‰é€ƒé€¸**

- å³æ–¹æ³•ä¸­çš„å¯¹è±¡æ²¡æœ‰å‘ç”Ÿé€ƒé€¸

**é€ƒé€¸åˆ†æä¼˜åŒ–**

é’ˆå¯¹ä¸Šé¢ç¬¬ä¸‰ç‚¹ï¼Œå½“ä¸€ä¸ªå¯¹è±¡**æ²¡æœ‰é€ƒé€¸**æ—¶ï¼Œå¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ ä¸ªè™šæ‹Ÿæœºçš„ä¼˜åŒ–

**é”æ¶ˆé™¤**

æˆ‘ä»¬çŸ¥é“çº¿ç¨‹åŒæ­¥é”æ˜¯éå¸¸ç‰ºç‰²æ€§èƒ½çš„ï¼Œå½“ç¼–è¯‘å™¨ç¡®å®šå½“å‰å¯¹è±¡åªæœ‰å½“å‰çº¿ç¨‹ä½¿ç”¨ï¼Œé‚£ä¹ˆå°±ä¼šç§»é™¤è¯¥å¯¹è±¡çš„åŒæ­¥é”

ä¾‹å¦‚ï¼ŒStringBuffer å’Œ Vector éƒ½æ˜¯ç”¨ synchronized ä¿®é¥°çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œå®ƒä»¬éƒ½åªæ˜¯åœ¨å½“å‰çº¿ç¨‹ä¸­ç”¨åˆ°ï¼Œè¿™æ ·ç¼–è¯‘å™¨å°±ä¼šä¼˜åŒ–ç§»é™¤æ‰è¿™äº›é”æ“ä½œ

é”æ¶ˆé™¤çš„ JVM å‚æ•°å¦‚ä¸‹ï¼š

- å¼€å¯é”æ¶ˆé™¤ï¼š-XX:+EliminateLocks
- å…³é—­é”æ¶ˆé™¤ï¼š-XX:-EliminateLocks

é”æ¶ˆé™¤åœ¨ JDK8 ä¸­éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¹¶ä¸”é”æ¶ˆé™¤éƒ½è¦å»ºç«‹åœ¨é€ƒé€¸åˆ†æçš„åŸºç¡€ä¸Š

**æ ‡é‡æ›¿æ¢**

é¦–å…ˆè¦æ˜ç™½æ ‡é‡å’Œèšåˆé‡ï¼Œ**åŸºç¡€ç±»å‹**å’Œ**å¯¹è±¡çš„å¼•ç”¨**å¯ä»¥ç†è§£ä¸º**æ ‡é‡**ï¼Œå®ƒä»¬ä¸èƒ½è¢«è¿›ä¸€æ­¥åˆ†è§£ã€‚è€Œèƒ½è¢«è¿›ä¸€æ­¥åˆ†è§£çš„é‡å°±æ˜¯èšåˆé‡ï¼Œæ¯”å¦‚ï¼šå¯¹è±¡

å¯¹è±¡æ˜¯èšåˆé‡ï¼Œå®ƒåˆå¯ä»¥è¢«è¿›ä¸€æ­¥åˆ†è§£æˆæ ‡é‡ï¼Œå°†å…¶æˆå‘˜å˜é‡åˆ†è§£ä¸ºåˆ†æ•£çš„å˜é‡ï¼Œè¿™å°±å«åš**æ ‡é‡æ›¿æ¢**ã€‚

è¿™æ ·ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡æ²¡æœ‰å‘ç”Ÿé€ƒé€¸ï¼Œé‚£å‹æ ¹å°±ä¸ç”¨åˆ›å»ºå®ƒï¼Œåªä¼šåœ¨æ ˆæˆ–è€…å¯„å­˜å™¨ä¸Šåˆ›å»ºå®ƒç”¨åˆ°çš„æˆå‘˜æ ‡é‡ï¼ŒèŠ‚çœäº†å†…å­˜ç©ºé—´ï¼Œä¹Ÿæå‡äº†åº”ç”¨ç¨‹åºæ€§èƒ½

æ ‡é‡æ›¿æ¢çš„ JVM å‚æ•°å¦‚ä¸‹ï¼š

- å¼€å¯æ ‡é‡æ›¿æ¢ï¼š-XX:+EliminateAllocations
- å…³é—­æ ‡é‡æ›¿æ¢ï¼š-XX:-EliminateAllocations
- æ˜¾ç¤ºæ ‡é‡æ›¿æ¢è¯¦æƒ…ï¼š-XX:+PrintEliminateAllocations

æ ‡é‡æ›¿æ¢åŒæ ·åœ¨ JDK8 ä¸­éƒ½æ˜¯é»˜è®¤å¼€å¯çš„ï¼Œå¹¶ä¸”éƒ½è¦å»ºç«‹åœ¨é€ƒé€¸åˆ†æçš„åŸºç¡€ä¸Š

**æ ˆä¸Šåˆ†é…**

å½“å¯¹è±¡æ²¡æœ‰å‘ç”Ÿé€ƒé€¸æ—¶ï¼Œè¯¥**å¯¹è±¡**å°±å¯ä»¥é€šè¿‡æ ‡é‡æ›¿æ¢åˆ†è§£æˆæˆå‘˜æ ‡é‡åˆ†é…åœ¨**æ ˆå†…å­˜**ä¸­ï¼Œå’Œæ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸä¸€è‡´ï¼Œéšç€æ ˆå¸§å‡ºæ ˆæ—¶é”€æ¯ï¼Œå‡å°‘äº† GC å‹åŠ›ï¼Œæé«˜äº†åº”ç”¨ç¨‹åºæ€§èƒ½

#### æ–¹æ³•å†…è”

##### **å†…è”å‡½æ•°**

å†…è”å‡½æ•°å°±æ˜¯åœ¨ç¨‹åºç¼–è¯‘æ—¶ï¼Œç¼–è¯‘å™¨å°†ç¨‹åºä¸­å‡ºç°çš„å†…è”å‡½æ•°çš„è°ƒç”¨è¡¨è¾¾å¼ç”¨å†…è”å‡½æ•°çš„å‡½æ•°ä½“æ¥ç›´æ¥è¿›è¡Œæ›¿æ¢

##### **JVMå†…è”å‡½æ•°**

C++æ˜¯å¦ä¸ºå†…è”å‡½æ•°ç”±è‡ªå·±å†³å®šï¼ŒJavaç”±**ç¼–è¯‘å™¨å†³å®š**ã€‚Javaä¸æ”¯æŒç›´æ¥å£°æ˜ä¸ºå†…è”å‡½æ•°çš„ï¼Œå¦‚æœæƒ³è®©ä»–å†…è”ï¼Œä½ åªèƒ½å¤Ÿå‘ç¼–è¯‘å™¨æå‡ºè¯·æ±‚: å…³é”®å­—**finalä¿®é¥°** ç”¨æ¥æŒ‡æ˜é‚£ä¸ªå‡½æ•°æ˜¯å¸Œæœ›è¢«JVMå†…è”çš„ï¼Œå¦‚

```
public final void doSomething() {  
        // to do something  
}Copy
```

æ€»çš„æ¥è¯´ï¼Œä¸€èˆ¬çš„å‡½æ•°éƒ½ä¸ä¼šè¢«å½“åšå†…è”å‡½æ•°ï¼Œåªæœ‰å£°æ˜äº†finalåï¼Œç¼–è¯‘å™¨æ‰ä¼šè€ƒè™‘æ˜¯ä¸æ˜¯è¦æŠŠä½ çš„å‡½æ•°å˜æˆå†…è”å‡½æ•°

JVMå†…å»ºæœ‰è®¸å¤šè¿è¡Œæ—¶ä¼˜åŒ–ã€‚é¦–å…ˆ**çŸ­æ–¹æ³•**æ›´åˆ©äºJVMæ¨æ–­ã€‚æµç¨‹æ›´æ˜æ˜¾ï¼Œä½œç”¨åŸŸæ›´çŸ­ï¼Œå‰¯ä½œç”¨ä¹Ÿæ›´æ˜æ˜¾ã€‚å¦‚æœæ˜¯é•¿æ–¹æ³•JVMå¯èƒ½ç›´æ¥å°±è·ªäº†ã€‚

ç¬¬äºŒä¸ªåŸå› åˆ™æ›´é‡è¦ï¼š**æ–¹æ³•å†…è”**

å¦‚æœJVMç›‘æµ‹åˆ°ä¸€äº›**å°æ–¹æ³•è¢«é¢‘ç¹çš„æ‰§è¡Œ**ï¼Œå®ƒä¼šæŠŠæ–¹æ³•çš„è°ƒç”¨æ›¿æ¢æˆæ–¹æ³•ä½“æœ¬èº«ï¼Œå¦‚ï¼š

```
private int add4(int x1, int x2, int x3, int x4) { 
		//è¿™é‡Œè°ƒç”¨äº†add2æ–¹æ³•
        return add2(x1, x2) + add2(x3, x4);  
    }  

    private int add2(int x1, int x2) {  
        return x1 + x2;  
    }Copy
```

æ–¹æ³•è°ƒç”¨è¢«æ›¿æ¢å

```
private int add4(int x1, int x2, int x3, int x4) {  
    	//è¢«æ›¿æ¢ä¸ºäº†æ–¹æ³•æœ¬èº«
        return x1 + x2 + x3 + x4;  
    }Copy
```

#### åå°„ä¼˜åŒ–

```
public class Reflect1 {
   public static void foo() {
      System.out.println("foo...");
   }

   public static void main(String[] args) throws NoSuchMethodException, InvocationTargetException, IllegalAccessException {
      Method foo = Demo3.class.getMethod("foo");
      for(int i = 0; i<=16; i++) {
         foo.invoke(null);
      }
   }
}Copy
```

foo.invoke å‰é¢ 0 ~ 15 æ¬¡è°ƒç”¨ä½¿ç”¨çš„æ˜¯ MethodAccessor çš„ NativeMethodAccessorImpl å®ç°

invokeæ–¹æ³•æºç 

```
@CallerSensitive
public Object invoke(Object obj, Object... args)
    throws IllegalAccessException, IllegalArgumentException,
       InvocationTargetException
{
    if (!override) {
        if (!Reflection.quickCheckMemberAccess(clazz, modifiers)) {
            Class<?> caller = Reflection.getCallerClass();
            checkAccess(caller, clazz, obj, modifiers);
        }
    }
    //MethodAccessoræ˜¯ä¸€ä¸ªæ¥å£ï¼Œæœ‰3ä¸ªå®ç°ç±»ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯æŠ½è±¡ç±»
    MethodAccessor ma = methodAccessor;             // read volatile
    if (ma == null) {
        ma = acquireMethodAccessor();
    }
    return ma.invoke(obj, args);
}Copy
```

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614133554.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614133554.png)

ä¼šç”±DelegatingMehodAccessorImplå»è°ƒç”¨NativeMethodAccessorImpl

NativeMethodAccessorImplæºç 

```
class NativeMethodAccessorImpl extends MethodAccessorImpl {
    private final Method method;
    private DelegatingMethodAccessorImpl parent;
    private int numInvocations;

    NativeMethodAccessorImpl(Method var1) {
        this.method = var1;
    }
	
	//æ¯æ¬¡è¿›è¡Œåå°„è°ƒç”¨ï¼Œä¼šè®©numInvocationä¸ReflectionFactory.inflationThresholdçš„å€¼ï¼ˆ15ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œå¹¶ä½¿ä½¿å¾—numInvocationçš„å€¼åŠ ä¸€
	//å¦‚æœnumInvocation>ReflectionFactory.inflationThresholdï¼Œåˆ™ä¼šè°ƒç”¨æœ¬åœ°æ–¹æ³•invoke0æ–¹æ³•
    public Object invoke(Object var1, Object[] var2) throws IllegalArgumentException, InvocationTargetException {
        if (++this.numInvocations > ReflectionFactory.inflationThreshold() && !ReflectUtil.isVMAnonymousClass(this.method.getDeclaringClass())) {
            MethodAccessorImpl var3 = (MethodAccessorImpl)(new MethodAccessorGenerator()).generateMethod(this.method.getDeclaringClass(), this.method.getName(), this.method.getParameterTypes(), this.method.getReturnType(), this.method.getExceptionTypes(), this.method.getModifiers());
            this.parent.setDelegate(var3);
        }

        return invoke0(this.method, var1, var2);
    }

    void setParent(DelegatingMethodAccessorImpl var1) {
        this.parent = var1;
    }

    private static native Object invoke0(Method var0, Object var1, Object[] var2);
}Copy
//ReflectionFactory.inflationThreshold()æ–¹æ³•çš„è¿”å›å€¼
private static int inflationThreshold = 15;Copy
```

- ä¸€å¼€å§‹ifæ¡ä»¶ä¸æ»¡è¶³ï¼Œå°±ä¼šè°ƒç”¨æœ¬åœ°æ–¹æ³•invoke0
- éšç€numInvocationçš„å¢å¤§ï¼Œå½“å®ƒå¤§äºReflectionFactory.inflationThresholdçš„å€¼16æ—¶ï¼Œå°±ä¼šæœ¬åœ°æ–¹æ³•è®¿é—®å™¨æ›¿æ¢ä¸ºä¸€ä¸ªè¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„è®¿é—®å™¨ï¼Œæ¥æé«˜æ•ˆç‡
  - è¿™æ—¶ä¼šä»åå°„è°ƒç”¨å˜ä¸º**æ­£å¸¸è°ƒç”¨**ï¼Œå³ç›´æ¥è°ƒç”¨ Reflect1.foo()

[![img](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614135011.png)](https://nyimapicture.oss-cn-beijing.aliyuncs.com/img/20200614135011.png)