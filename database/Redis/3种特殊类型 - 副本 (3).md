# ğŸŒ… Redis - 3ç§ç‰¹æ®Šç±»å‹

---

## HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰

> Redis 2.8.9 ç‰ˆæœ¬æ›´æ–°äº† Hyperloglog æ•°æ®ç»“æ„

### èƒŒæ™¯

åœ¨å·¥ä½œå½“ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°ä¸ç»Ÿè®¡ç›¸å…³çš„åŠŸèƒ½éœ€æ±‚ï¼Œæ¯”å¦‚ç»Ÿè®¡ç½‘ç«™ PVï¼ˆPageView é¡µé¢è®¿é—®é‡ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ Redis çš„ incrã€incrby è½»æ¾å®ç°ã€‚ä½†åƒ UVï¼ˆUniqueVisitor ç‹¬ç«‹è®¿å®¢ï¼‰ã€ç‹¬ç«‹ IP æ•°ã€æœç´¢è®°å½•æ•°ç­‰éœ€è¦å»é‡å’Œè®¡æ•°çš„é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿè¿™ç§æ±‚é›†åˆä¸­ä¸é‡å¤å…ƒç´ ä¸ªæ•°çš„é—®é¢˜ç§°ä¸º`åŸºæ•°é—®é¢˜`ã€‚

**ä»€ä¹ˆæ˜¯åŸºæ•°ï¼Ÿ**

> æ¯”å¦‚æ•°æ®é›† {1, 3, 5, 7, 5, 7, 8}ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®é›†çš„åŸºæ•°é›†ä¸º {1, 3, 5 ,7, 8}ï¼ŒåŸºæ•° (ä¸é‡å¤å…ƒç´ ) ä¸º 5ã€‚ åŸºæ•°ä¼°è®¡å°±æ˜¯åœ¨è¯¯å·®å¯æ¥å—çš„èŒƒå›´å†…ï¼Œå¿«é€Ÿè®¡ç®—åŸºæ•°ã€‚

**è§£å†³åŸºæ•°é—®é¢˜æœ‰å¾ˆå¤šç§æ–¹æ¡ˆï¼š**

- æ•°æ®å­˜å‚¨åœ¨ MySQL è¡¨ä¸­ï¼Œä½¿ç”¨ distinct count è®¡ç®—ä¸é‡å¤ä¸ªæ•°ã€‚
- ä½¿ç”¨ Redis æä¾›çš„ hashã€setã€bitmaps ç­‰æ•°æ®ç»“æ„æ¥å¤„ç†ã€‚

ä»¥ä¸Šçš„æ–¹æ¡ˆç»“æœç²¾ç¡®ï¼Œä½†éšç€æ•°æ®ä¸æ–­å¢åŠ ï¼Œå¯¼è‡´å ç”¨ç©ºé—´è¶Šæ¥è¶Šå¤§ï¼Œå¯¹äºéå¸¸å¤§çš„æ•°æ®é›†æ˜¯ä¸åˆ‡å®é™…çš„ã€‚èƒ½å¦èƒ½å¤Ÿé™ä½ä¸€å®šçš„ç²¾åº¦æ¥å¹³è¡¡å­˜å‚¨ç©ºé—´ï¼ŸRedis æ¨å‡ºäº† HyperLogLogã€‚

- Redis HyperLogLog æ˜¯ç”¨æ¥åšåŸºæ•°ç»Ÿè®¡çš„ç®—æ³•ï¼ŒHyperLogLog çš„ä¼˜ç‚¹æ˜¯ï¼š**åœ¨è¾“å…¥å…ƒç´ çš„æ•°é‡æˆ–è€…ä½“ç§¯éå¸¸éå¸¸å¤§æ—¶ï¼Œè®¡ç®—åŸºæ•°æ‰€éœ€çš„ç©ºé—´æ€»æ˜¯å›ºå®šçš„ã€å¹¶ä¸”æ˜¯å¾ˆå°çš„**ã€‚
- åœ¨ Redis é‡Œé¢ï¼Œæ¯ä¸ª HyperLogLog é”®åªéœ€è¦èŠ±è´¹ 12 KB å†…å­˜ï¼Œå°±å¯ä»¥è®¡ç®—æ¥è¿‘ 2^64 ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°ã€‚è¿™å’Œè®¡ç®—åŸºæ•°æ—¶ï¼Œå…ƒç´ è¶Šå¤šè€—è´¹å†…å­˜å°±è¶Šå¤šçš„é›†åˆå½¢æˆé²œæ˜å¯¹æ¯”ã€‚
- ä½†æ˜¯ï¼Œå› ä¸º HyperLogLog åªä¼šæ ¹æ®è¾“å…¥å…ƒç´ æ¥è®¡ç®—åŸºæ•°ï¼Œè€Œä¸ä¼šå‚¨å­˜è¾“å…¥å…ƒç´ æœ¬èº«ï¼Œæ‰€ä»¥ HyperLogLog ä¸èƒ½åƒé›†åˆé‚£æ ·ï¼Œè¿”å›è¾“å…¥çš„å„ä¸ªå…ƒç´ ã€‚

### å®ƒçš„ä¼˜åŠ¿ä½“ç°åœ¨å“ª?

ä¸€ä¸ªå¤§å‹çš„ç½‘ç«™ï¼Œæ¯å¤© IP æ¯”å¦‚æœ‰ 100 ä¸‡ï¼Œç²—ç®—ä¸€ä¸ª IP æ¶ˆè€— 15 å­—èŠ‚ï¼Œé‚£ä¹ˆ 100 ä¸‡ä¸ª IP å°±æ˜¯ 15Mã€‚è€Œ HyperLogLog åœ¨ Redis ä¸­æ¯ä¸ªé”®å ç”¨çš„å†…å®¹éƒ½æ˜¯ 12Kï¼Œç†è®ºå­˜å‚¨è¿‘ä¼¼æ¥è¿‘ 2^64 ä¸ªå€¼ï¼Œä¸ç®¡å­˜å‚¨çš„å†…å®¹æ˜¯ä»€ä¹ˆï¼Œå®ƒä¸€ä¸ªåŸºäºåŸºæ•°ä¼°ç®—çš„ç®—æ³•ï¼Œåªèƒ½æ¯”è¾ƒå‡†ç¡®çš„ä¼°ç®—å‡ºåŸºæ•°ï¼Œå¯ä»¥ä½¿ç”¨å°‘é‡å›ºå®šçš„å†…å­˜å»å­˜å‚¨å¹¶è¯†åˆ«é›†åˆä¸­çš„å”¯ä¸€å…ƒç´ ã€‚è€Œä¸”è¿™ä¸ªä¼°ç®—çš„åŸºæ•°å¹¶ä¸ä¸€å®šå‡†ç¡®ï¼Œæ˜¯ä¸€ä¸ªå¸¦æœ‰ 0.81% æ ‡å‡†é”™è¯¯çš„è¿‘ä¼¼å€¼ï¼ˆå¯¹äºå¯ä»¥æ¥å—ä¸€å®šå®¹é”™çš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚IPæ•°ç»Ÿè®¡ï¼ŒUVç­‰ï¼Œæ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ï¼‰ã€‚

### ç›¸å…³å‘½ä»¤ä½¿ç”¨

```bash
127.0.0.1:6379> pfadd key1 a b c d e f g h i	# åˆ›å»ºç¬¬ä¸€ç»„å…ƒç´ 
(integer) 1
127.0.0.1:6379> pfcount key1				   # ç»Ÿè®¡å…ƒç´ çš„åŸºæ•°æ•°é‡
(integer) 9
127.0.0.1:6379> pfadd key2 c j k l m e g a		# åˆ›å»ºç¬¬äºŒç»„å…ƒç´ 
(integer) 1
127.0.0.1:6379> pfcount key2
(integer) 8
127.0.0.1:6379> pfmerge key3 key1 key2			# åˆå¹¶ä¸¤ç»„ï¼škey1 key2 -> key3 å¹¶é›†
OK
127.0.0.1:6379> pfcount key3
(integer) 13
```



## Bitmaps ï¼ˆä½å­˜å‚¨ï¼‰

### æ¦‚å¿µ

> Bitmap å³ä½å›¾æ•°æ®ç»“æ„ï¼Œéƒ½æ˜¯æ“ä½œäºŒè¿›åˆ¶ä½æ¥è¿›è¡Œè®°å½•ï¼Œåªæœ‰0 å’Œ 1 ä¸¤ä¸ªçŠ¶æ€ã€‚

- Bitmaps æœ¬èº«ä¸æ˜¯ä¸€ç§æ•°æ®ç±»å‹ï¼Œ å®é™…ä¸Šå®ƒå°±æ˜¯**å­—ç¬¦ä¸²ï¼ˆkey-valueï¼‰** ï¼Œ ä½†æ˜¯å®ƒå¯ä»¥å¯¹å­—ç¬¦ä¸²çš„**ä½**è¿›è¡Œæ“ä½œã€‚
- Bitmaps å•ç‹¬æä¾›äº†ä¸€å¥—å‘½ä»¤ï¼Œ æ‰€ä»¥åœ¨ Redis ä¸­ä½¿ç”¨ Bitmaps å’Œä½¿ç”¨å­—ç¬¦ä¸²çš„æ–¹æ³•ä¸å¤ªç›¸åŒã€‚ å¯ä»¥æŠŠ Bitmaps æƒ³è±¡æˆä¸€ä¸ªä»¥ä½ä¸ºå•ä½çš„æ•°ç»„ï¼Œ æ•°ç»„çš„æ¯ä¸ªå•å…ƒåªèƒ½å­˜å‚¨ 0 å’Œ 1ï¼Œ æ•°ç»„çš„ä¸‹æ ‡åœ¨ Bitmaps ä¸­å«åšåç§»é‡ã€‚

### ç”¨æ¥è§£å†³ä»€ä¹ˆé—®é¢˜

æ¯”å¦‚ï¼šç»Ÿè®¡ç”¨æˆ·ä¿¡æ¯ï¼Œæ´»è·ƒï¼Œä¸æ´»è·ƒï¼ ç™»å½•ï¼Œæœªç™»å½•ï¼ æ‰“å¡ï¼Œä¸æ‰“å¡ï¼ **ä¸¤ä¸ªçŠ¶æ€çš„ï¼Œéƒ½å¯ä»¥ä½¿ç”¨ Bitmaps**ï¼

å¦‚æœå­˜å‚¨ä¸€å¹´çš„æ‰“å¡çŠ¶æ€éœ€è¦å¤šå°‘å†…å­˜å‘¢ï¼Ÿ 365 å¤© = 365 bit 1å­—èŠ‚ = 8bit 46 ä¸ªå­—èŠ‚å·¦å³ï¼

### Bitmapsç›¸æ¯”åŸºæœ¬æ•°æ®ç±»å‹çš„ä¼˜åŠ¿

å‡è®¾ç½‘ç«™æœ‰ 1 äº¿ç”¨æˆ·ï¼Œ æ¯å¤©ç‹¬ç«‹è®¿é—®çš„ç”¨æˆ·æœ‰ 5 åƒä¸‡ï¼Œ å¦‚æœæ¯å¤©ç”¨é›†åˆç±»å‹å’Œ Bitmaps åˆ†åˆ«å­˜å‚¨æ´»è·ƒç”¨æˆ·å¯ä»¥å¾—åˆ°è¡¨ï¼š

**set å’Œ Bitmaps å­˜å‚¨ä¸€å¤©æ´»è·ƒç”¨æˆ·å¯¹æ¯”**

| æ•°æ®ç±»å‹ | æ¯ä¸ªç”¨æˆ· id å ç”¨ç©ºé—´ | éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ | å…¨éƒ¨å†…å­˜é‡                |
| -------- | -------------------- | ---------------- | ------------------------- |
| é›†åˆ     | 64ä½                 | 50000000         | 64 ä½ * 50000000 = 400MB  |
| Bitmaps  | 1ä½                  | 100000000        | 1 ä½ * 100000000 = 12.5MB |

å¾ˆæ˜æ˜¾ï¼Œ è¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ Bitmaps èƒ½èŠ‚çœå¾ˆå¤šçš„å†…å­˜ç©ºé—´ï¼Œ å°¤å…¶æ˜¯éšç€æ—¶é—´æ¨ç§»èŠ‚çœçš„å†…å­˜è¿˜æ˜¯éå¸¸å¯è§‚çš„ã€‚

**set å’Œ Bitmaps å­˜å‚¨ç‹¬ç«‹ç”¨æˆ·ç©ºé—´å¯¹æ¯”**

| æ•°æ®ç±»å‹ | ä¸€å¤©   | ä¸€ä¸ªæœˆ | ä¸€å¹´  |
| -------- | ------ | ------ | ----- |
| é›†åˆ     | 400MB  | 12GB   | 144GB |
| Bitmaps  | 12.5MB | 375MB  | 4.5GB |

ä½† Bitmaps å¹¶ä¸æ˜¯ä¸‡é‡‘æ²¹ï¼Œ å‡å¦‚è¯¥ç½‘ç«™æ¯å¤©çš„ç‹¬ç«‹è®¿é—®ç”¨æˆ·å¾ˆå°‘ï¼Œ ä¾‹å¦‚åªæœ‰ 10 ä¸‡ï¼ˆå¤§é‡çš„åƒµå°¸ç”¨æˆ·ï¼‰ ï¼Œ é‚£ä¹ˆä¸¤è€…çš„å¯¹æ¯”å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼Œ å¾ˆæ˜¾ç„¶ï¼Œ è¿™æ—¶å€™ä½¿ç”¨ Bitmaps å°±ä¸å¤ªåˆé€‚äº†ï¼Œ å› ä¸ºåŸºæœ¬ä¸Šå¤§éƒ¨åˆ†ä½éƒ½æ˜¯ 0ã€‚

**set å’Œ Bitmaps å­˜å‚¨ä¸€å¤©æ´»è·ƒç”¨æˆ·å¯¹æ¯”ï¼ˆç”¨æˆ·æ¯”è¾ƒå°‘ï¼‰**

| æ•°æ®ç±»å‹ | æ¯ä¸ªç”¨æˆ· id å ç”¨ç©ºé—´ | éœ€è¦å­˜å‚¨çš„ç”¨æˆ·é‡ | å…¨éƒ¨å†…å­˜é‡                |
| -------- | -------------------- | ---------------- | ------------------------- |
| é›†åˆ     | 64ä½                 | 100000           | 64 ä½ * 100000 = 800KB    |
| Bitmaps  | 1ä½                  | 100000000        | 1 ä½ * 100000000 = 12.5MB |



### ç›¸å…³å‘½ä»¤ä½¿ç”¨

ä½¿ç”¨bitmap æ¥è®°å½• å‘¨ä¸€åˆ°å‘¨æ—¥çš„æ‰“å¡ï¼ å‘¨ä¸€ï¼š1 å‘¨äºŒï¼š0 å‘¨ä¸‰ï¼š0 å‘¨å››ï¼š1 ......

```bash
127.0.0.1:6379> setbit sign 0 1
(integer) 0
127.0.0.1:6379> setbit sign 1 1
(integer) 0
127.0.0.1:6379> setbit sign 2 0
(integer) 0
127.0.0.1:6379> setbit sign 3 1
(integer) 0
127.0.0.1:6379> setbit sign 4 0
(integer) 0
127.0.0.1:6379> setbit sign 5 0
(integer) 0
127.0.0.1:6379> setbit sign 6 1
(integer) 0
```

æŸ¥çœ‹æŸä¸€å¤©æ˜¯å¦æœ‰æ‰“å¡ï¼

```bash
127.0.0.1:6379> getbit sign 3
(integer) 1
127.0.0.1:6379> getbit sign 5
(integer) 0 
```

ç»Ÿè®¡æ“ä½œï¼Œç»Ÿè®¡ æ‰“å¡çš„å¤©æ•°ï¼

```bash
127.0.0.1:6379> bitcount sign # ç»Ÿè®¡è¿™å‘¨çš„æ‰“å¡è®°å½•ï¼Œå°±å¯ä»¥çœ‹åˆ°æ˜¯å¦æœ‰å…¨å‹¤ï¼
(integer) 3
```



##  geospatial (åœ°ç†ä½ç½®)

> Redis 3.2 ä¸­å¢åŠ äº†å¯¹ GEO ç±»å‹çš„æ”¯æŒã€‚GEOï¼ŒGeographicï¼Œåœ°ç†ä¿¡æ¯çš„ç¼©å†™ã€‚è¯¥ç±»å‹ï¼Œå°±æ˜¯å…ƒç´ çš„ 2 ç»´åæ ‡ï¼Œåœ¨åœ°å›¾ä¸Šå°±æ˜¯ç»çº¬åº¦ã€‚redis åŸºäºè¯¥ç±»å‹ï¼Œæä¾›äº†ç»çº¬åº¦è®¾ç½®ï¼ŒæŸ¥è¯¢ï¼ŒèŒƒå›´æŸ¥è¯¢ï¼Œè·ç¦»æŸ¥è¯¢ï¼Œç»çº¬åº¦ Hash ç­‰å¸¸è§æ“ä½œã€‚
>

### geoadd

> æ·»åŠ åœ°ç†ä½ç½®

```bash
127.0.0.1:6379> geoadd china:city 118.76 32.04 manjing 112.55 37.86 taiyuan 123.43 41.80 shenyang
(integer) 3
127.0.0.1:6379> geoadd china:city 144.05 22.52 shengzhen 120.16 30.24 hangzhou 108.96 34.26 xian
(integer) 3
```

**è§„åˆ™**

ä¸¤çº§æ— æ³•ç›´æ¥æ·»åŠ ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä¸‹è½½åŸå¸‚æ•°æ®(è¿™ä¸ªç½‘å€å¯ä»¥æŸ¥è¯¢ GEOï¼š http://www.jsons.cn/lngcode)ï¼

- æœ‰æ•ˆçš„ç»åº¦ä»-180åº¦åˆ°180åº¦ã€‚
- æœ‰æ•ˆçš„çº¬åº¦ä»-85.05112878åº¦åˆ°85.05112878åº¦ã€‚

```bash
# å½“åæ ‡ä½ç½®è¶…å‡ºä¸Šè¿°æŒ‡å®šèŒƒå›´æ—¶ï¼Œè¯¥å‘½ä»¤å°†ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ã€‚
127.0.0.1:6379> geoadd china:city 39.90 116.40 beijin
(error) ERR invalid longitude,latitude pair 39.900000,116.400000
```

### geopos

> è·å–æŒ‡å®šçš„æˆå‘˜çš„ç»åº¦å’Œçº¬åº¦

```bash
127.0.0.1:6379> geopos china:city taiyuan manjing
1) 1) "112.54999905824661255"
   1) "37.86000073876942196"
2) 1) "118.75999957323074341"
   1) "32.03999960287850968"
```

è·å¾—å½“å‰å®šä½, ä¸€å®šæ˜¯ä¸€ä¸ªåæ ‡å€¼!

### geodist

> å¦‚æœä¸å­˜åœ¨, è¿”å›ç©º

å•ä½å¦‚ä¸‹

- m
- km
- mi è‹±é‡Œ
- ft è‹±å°º

```bash
127.0.0.1:6379> geodist china:city taiyuan shenyang m
"1026439.1070"
127.0.0.1:6379> geodist china:city taiyuan shenyang km
"1026.4391"
```

### georadius

> é™„è¿‘çš„äºº ==> è·å¾—æ‰€æœ‰é™„è¿‘çš„äººçš„åœ°å€, å®šä½, é€šè¿‡åŠå¾„æ¥æŸ¥è¯¢

è·å¾—æŒ‡å®šæ•°é‡çš„äºº

```bash
127.0.0.1:6379> georadius china:city 110 30 1000 km			ä»¥ 100,30 è¿™ä¸ªåæ ‡ä¸ºä¸­å¿ƒ, å¯»æ‰¾åŠå¾„ä¸º1000kmçš„åŸå¸‚
1) "xian"
2) "hangzhou"
3) "manjing"
4) "taiyuan"
127.0.0.1:6379> georadius china:city 110 30 500 km
1) "xian"
127.0.0.1:6379> georadius china:city 110 30 500 km withdist
1) 1) "xian"
   2) "483.8340"
127.0.0.1:6379> georadius china:city 110 30 1000 km withcoord withdist count 2
1) 1) "xian"
   2) "483.8340"
   3) 1) "108.96000176668167114"
      2) "34.25999964418929977"
2) 1) "manjing"
   2) "864.9816"
   3) 1) "118.75999957323074341"
      2) "32.03999960287850968"
```

å‚æ•° key ç»åº¦ çº¬åº¦ åŠå¾„ å•ä½ [æ˜¾ç¤ºç»“æœçš„ç»åº¦å’Œçº¬åº¦] [æ˜¾ç¤ºç»“æœçš„è·ç¦»] [æ˜¾ç¤ºçš„ç»“æœçš„æ•°é‡]

### georadiusbymember

> æ˜¾ç¤ºä¸æŒ‡å®šæˆå‘˜ä¸€å®šåŠå¾„èŒƒå›´å†…çš„å…¶ä»–æˆå‘˜

```bash
127.0.0.1:6379> georadiusbymember china:city taiyuan 1000 km
1) "manjing"
2) "taiyuan"
3) "xian"
127.0.0.1:6379> georadiusbymember china:city taiyuan 1000 km withcoord withdist count 2
1) 1) "taiyuan"
   2) "0.0000"
   3) 1) "112.54999905824661255"
      2) "37.86000073876942196"
2) 1) "xian"
   2) "514.2264"
   3) 1) "108.96000176668167114"
      2) "34.25999964418929977"
```

å‚æ•°ä¸ georadius ä¸€æ ·

### geohash(è¾ƒå°‘ä½¿ç”¨)

> è¯¥å‘½ä»¤è¿”å›11ä¸ªå­—ç¬¦çš„hashå­—ç¬¦ä¸²

```bash
127.0.0.1:6379> geohash china:city taiyuan shenyang
1) "ww8p3hhqmp0"
2) "wxrvb9qyxk0" 
```

å°†äºŒç»´çš„ç»çº¬åº¦è½¬æ¢ä¸ºä¸€ç»´çš„å­—ç¬¦ä¸², å¦‚æœä¸¤ä¸ªå­—ç¬¦ä¸²è¶Šæ¥è¿‘, åˆ™è·ç¦»è¶Šè¿‘

### åº•å±‚

> geoåº•å±‚çš„å®ç°åŸç†å®é™…ä¸Šå°±æ˜¯Zset, æˆ‘ä»¬å¯ä»¥é€šè¿‡Zsetå‘½ä»¤æ¥æ“ä½œgeo

```bash
127.0.0.1:6379> type china:city
zset
```

æŸ¥çœ‹å…¨éƒ¨å…ƒç´  åˆ é™¤æŒ‡å®šçš„å…ƒç´ 

```bash
127.0.0.1:6379> zrange china:city 0 -1 withscores
 1) "xian"
 2) "4040115445396757"
 3) "hangzhou"
 4) "4054133997236782"
 5) "manjing"
 6) "4066006694128997"
 7) "taiyuan"
 8) "4068216047500484"
 9) "shenyang"
1)  "4072519231994779"
2)  "shengzhen"
3)  "4154606886655324"
127.0.0.1:6379> zrem china:city manjing
(integer) 1
127.0.0.1:6379> zrange china:city 0 -1
1) "xian"
2) "hangzhou"
3) "taiyuan"
4) "shenyang"
5) "shengzhen"
```



## å‚è€ƒæ–‡ç« 

- [Java å…¨æ ˆçŸ¥è¯†ä½“ç³»](https://www.pdai.tech/md/db/nosql-redis/db-redis-data-type-special.html)
- https://zhangc233.github.io/2021/05/02/Redis/#