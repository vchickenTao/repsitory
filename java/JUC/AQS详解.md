# ğŸº AQSè¯¦è§£

---

> [!NOTE]
>
> ç›¸ä¿¡åœ¨Javaå¹¶å‘è¿™ä¸€å—ï¼Œæˆ‘ä»¬ä¼šåœ¨å¾ˆå¤šåœ°æ–¹ä¸æ­¢ä¸€æ¬¡çš„çœ‹åˆ°`AQS`è¿™ä¸ªæ¦‚å¿µï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬å…ˆæ¥ç³»ç»Ÿçš„å­¦ä¹ ä¸€ä¸‹AQSï¼Œæœ¬æ–‡å¼€å§‹ä»¥Locké”ä¸ºåˆ‡å…¥ç‚¹ï¼Œå¦‚æœè¿˜æ²¡æœ‰å­¦ä¹ è¿™å—çš„åŒå­¦ï¼Œå¯ä»¥å…ˆè·³è¿‡è¿™éƒ¨åˆ†ï¼Œç›´æ¥è¿›å…¥ä¸‹é¢AQSçŸ¥è¯†éƒ¨åˆ†çš„å­¦ä¹ ï¼Œåé¢å†å›æ¥çœ‹çœ‹ï¼Œæ›´æœ‰å¿ƒå¾—ã€‚@vchicken



## ä»Lockä½œä¸ºåˆ‡å…¥ç‚¹

æˆ‘æƒ³ä»¥lockä½œä¸ºåˆ‡å…¥ç‚¹æ¥è®²è§£AQSï¼Œæ¯•ç«ŸåŒæ­¥é”æ˜¯è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„é€šç”¨æ‰‹æ®µï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å·¥ä½œä¸­ç”¨å¾—æ¯”è¾ƒå¤šçš„æ–¹å¼ã€‚

### Lock API

Lockæ˜¯ä¸€ä¸ªæ¥å£ï¼Œæ–¹æ³•å®šä¹‰å¦‚ä¸‹

```java
void lock() // å¦‚æœé”å¯ç”¨å°±è·å¾—é”ï¼Œå¦‚æœé”ä¸å¯ç”¨å°±é˜»å¡ç›´åˆ°é”é‡Šæ”¾
void lockInterruptibly() // å’Œ lock()æ–¹æ³•ç›¸ä¼¼, ä½†é˜»å¡çš„çº¿ç¨‹å¯ä¸­æ–­ï¼ŒæŠ›å‡º java.lang.InterruptedExceptionå¼‚å¸¸
boolean tryLock() // éé˜»å¡è·å–é”;å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸè¿”å›true
boolean tryLock(long timeout, TimeUnit timeUnit) //å¸¦æœ‰è¶…æ—¶æ—¶é—´çš„è·å–é”æ–¹æ³•
void unlock() // é‡Šæ”¾é”
```

### Lockçš„å®ç°

å®ç°Lockæ¥å£çš„ç±»æœ‰å¾ˆå¤šï¼Œä»¥ä¸‹ä¸ºå‡ ä¸ªå¸¸è§çš„é”å®ç°

- ReentrantLockï¼šè¡¨ç¤ºé‡å…¥é”ï¼Œå®ƒæ˜¯å”¯ä¸€ä¸€ä¸ªå®ç°äº†Lockæ¥å£çš„ç±»ã€‚é‡å…¥é”æŒ‡çš„æ˜¯çº¿ç¨‹åœ¨è·å¾—é”ä¹‹åï¼Œå†æ¬¡è·å–è¯¥é”ä¸éœ€è¦é˜»å¡ï¼Œè€Œæ˜¯ç›´æ¥å…³è”ä¸€æ¬¡è®¡æ•°å™¨å¢åŠ é‡å…¥æ¬¡æ•°
- ReentrantReadWriteLockï¼šé‡å…¥è¯»å†™é”ï¼Œå®ƒå®ç°äº†ReadWriteLockæ¥å£ï¼Œåœ¨è¿™ä¸ªç±»ä¸­ç»´æŠ¤äº†ä¸¤ä¸ªé”ï¼Œä¸€ä¸ªæ˜¯ReadLockï¼Œä¸€ä¸ªæ˜¯WriteLockï¼Œä»–ä»¬éƒ½åˆ†åˆ«å®ç°äº†Lockæ¥å£ã€‚è¯»å†™é”æ˜¯ä¸€ç§é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜çš„å·¥å…·ï¼ŒåŸºæœ¬åŸåˆ™æ˜¯ï¼š`è¯»å’Œè¯»ä¸äº’æ–¥ã€è¯»å’Œå†™äº’æ–¥ã€å†™å’Œå†™äº’æ–¥`ã€‚ä¹Ÿå°±æ˜¯è¯´æ¶‰åŠåˆ°å½±å“æ•°æ®å˜åŒ–çš„æ“ä½œéƒ½ä¼šå­˜åœ¨äº’æ–¥ã€‚
- StampedLockï¼š stampedLockæ˜¯JDK8å¼•å…¥çš„æ–°çš„é”æœºåˆ¶ï¼Œå¯ä»¥ç®€å•è®¤ä¸ºæ˜¯è¯»å†™é”çš„ä¸€ä¸ªæ”¹è¿›ç‰ˆæœ¬ï¼Œè¯»å†™é”è™½ç„¶é€šè¿‡åˆ†ç¦»è¯»å’Œå†™çš„åŠŸèƒ½ä½¿å¾—è¯»å’Œè¯»ä¹‹é—´å¯ä»¥å®Œå…¨å¹¶å‘ï¼Œä½†æ˜¯è¯»å’Œå†™æ˜¯æœ‰å†²çªçš„ï¼Œå¦‚æœå¤§é‡çš„è¯»çº¿ç¨‹å­˜åœ¨ï¼Œå¯èƒ½ä¼šå¼•èµ·å†™çº¿ç¨‹çš„é¥¥é¥¿ã€‚stampedLockæ˜¯ä¸€ç§ä¹è§‚çš„è¯»ç­–ç•¥ï¼Œä½¿å¾—ä¹è§‚é”å®Œå…¨ä¸ä¼šé˜»å¡å†™çº¿ç¨‹

### ReentrantLockçš„ç®€å•å®ç”¨

å¦‚ä½•åœ¨å®é™…åº”ç”¨ä¸­ä½¿ç”¨ReentrantLockå‘¢ï¼Ÿæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„demoæ¥æ¼”ç¤ºä¸€ä¸‹

```java
public class Demo {
    private static int count=0;
    static Lock lock=new ReentrantLock();
    public static void inc(){
        lock.lock();
        try {
            Thread.sleep(1);
            count++;
        } catch (InterruptedException e) {
            e.printStackTrace();
        }finally{
            lock.unlock();
        }
    }
```

è¿™æ®µä»£ç ä¸»è¦åšä¸€ä»¶äº‹ï¼Œå°±æ˜¯é€šè¿‡ä¸€ä¸ªé™æ€çš„`incr()`æ–¹æ³•å¯¹å…±äº«å˜é‡`count`åšè¿ç»­é€’å¢ï¼Œåœ¨æ²¡æœ‰åŠ åŒæ­¥é”çš„æƒ…å†µä¸‹å¤šçº¿ç¨‹è®¿é—®è¿™ä¸ªæ–¹æ³•ä¸€å®šä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚æ‰€ä»¥ç”¨åˆ°äº†`ReentrantLock`æ¥å®ç°åŒæ­¥é”ï¼Œå¹¶ä¸”åœ¨finallyè¯­å¥å—ä¸­é‡Šæ”¾é”ã€‚
**é‚£ä¹ˆæˆ‘æ¥å¼•å‡ºä¸€ä¸ªé—®é¢˜ï¼Œå¤§å®¶æ€è€ƒä¸€ä¸‹**

> å¤šä¸ªçº¿ç¨‹é€šè¿‡lockç«äº‰é”æ—¶ï¼Œå½“ç«äº‰å¤±è´¥çš„é”æ˜¯å¦‚ä½•å®ç°ç­‰å¾…ä»¥åŠè¢«å”¤é†’çš„å‘¢?

## ä»€ä¹ˆæ˜¯AQS

AQSå…¨ç§°ä¸º`AbstractQueuedSynchronizer`ï¼Œå­—é¢æ„æ€æ˜¯`æŠ½è±¡é˜Ÿåˆ—åŒæ­¥å™¨`ï¼Œä½¿ç”¨ä¸€ä¸ª`voliate`ä¿®é¥°çš„`intç±»å‹`çš„`åŒæ­¥çŠ¶æ€`ï¼Œé€šè¿‡ä¸€ä¸ª`FIFOé˜Ÿåˆ—`å®Œæˆèµ„æºè·å–çš„æ’é˜Ÿå·¥ä½œï¼ŒæŠŠæ¯ä¸ªå‚ä¸èµ„æºç«äº‰çš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª`NodeèŠ‚ç‚¹`æ¥å®ç°é”çš„åˆ†é…ã€‚å®ƒå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªç”¨æ¥å®ç°åŒæ­¥é”ä»¥åŠå…¶ä»–æ¶‰åŠåˆ°åŒæ­¥åŠŸèƒ½çš„æ ¸å¿ƒç»„ä»¶ï¼Œå¸¸è§çš„æœ‰:ReentrantLockã€CountDownLatchç­‰ã€‚
AQSæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦æ˜¯é€šè¿‡ç»§æ‰¿çš„æ–¹å¼æ¥ä½¿ç”¨ï¼Œå®ƒæœ¬èº«æ²¡æœ‰å®ç°ä»»ä½•çš„åŒæ­¥æ¥å£ï¼Œä»…ä»…æ˜¯å®šä¹‰äº†åŒæ­¥çŠ¶æ€çš„è·å–ä»¥åŠé‡Šæ”¾çš„æ–¹æ³•æ¥æä¾›è‡ªå®šä¹‰çš„åŒæ­¥ç»„ä»¶ã€‚
å¯ä»¥è¿™ä¹ˆè¯´ï¼Œåªè¦ææ‡‚äº†AQSï¼Œé‚£ä¹ˆJ.U.Cä¸­ç»å¤§éƒ¨åˆ†çš„apiéƒ½èƒ½è½»æ¾æŒæ¡ã€‚

### AQSçš„ä¸¤ç§åŠŸèƒ½

ä»ä½¿ç”¨å±‚é¢æ¥è¯´ï¼ŒAQSçš„åŠŸèƒ½åˆ†ä¸ºä¸¤ç§ï¼š`ç‹¬å `å’Œ`å…±äº«`

- ç‹¬å é”ï¼Œæ¯æ¬¡åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æŒæœ‰é”ï¼Œæ¯”å¦‚å‰é¢ç»™å¤§å®¶æ¼”ç¤ºçš„ReentrantLockå°±æ˜¯ä»¥ç‹¬å æ–¹å¼å®ç°çš„äº’æ–¥é”

- å…±äº«é”ï¼Œå…è®¸å¤šä¸ªçº¿ç¨‹åŒæ—¶è·å–é”ï¼Œå¹¶å‘è®¿é—®å…±äº«èµ„æºï¼Œæ¯”å¦‚ReentrantReadWriteLock

  ### ReentrantLockçš„ç±»å›¾

  ä»ç„¶ä»¥ReentrantLockä¸ºä¾‹ï¼Œæ¥åˆ†æAQSåœ¨é‡å…¥é”ä¸­çš„ä½¿ç”¨ã€‚æ¯•ç«Ÿå•çº¯åˆ†æAQSæ²¡æœ‰å¤ªå¤šçš„å«ä¹‰ã€‚å…ˆç†è§£è¿™ä¸ªç±»å›¾ï¼Œå¯ä»¥æ–¹ä¾¿æˆ‘ä»¬ç†è§£AQSçš„åŸç†
  

![ReentrantLockçš„ç±»å›¾](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/2ee0d18c-ea98-45ef-8995-4df7e0f2fb11_juc-aqs-01.png)

### AQSçš„å†…éƒ¨å®ç°

  AQSçš„å®ç°ä¾èµ–å†…éƒ¨çš„åŒæ­¥é˜Ÿåˆ—,ä¹Ÿå°±æ˜¯FIFOçš„åŒå‘é˜Ÿåˆ—ï¼Œå¦‚æœå½“å‰çº¿ç¨‹ç«äº‰é”å¤±è´¥ï¼Œé‚£ä¹ˆAQSä¼šæŠŠå½“å‰çº¿ç¨‹ä»¥åŠç­‰å¾…çŠ¶æ€ä¿¡æ¯æ„é€ æˆä¸€ä¸ªNodeåŠ å…¥åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼ŒåŒæ—¶å†é˜»å¡è¯¥çº¿ç¨‹ã€‚å½“è·å–é”çš„çº¿ç¨‹é‡Šæ”¾é”ä»¥åï¼Œä¼šä»é˜Ÿåˆ—ä¸­å”¤é†’ä¸€ä¸ªé˜»å¡çš„èŠ‚ç‚¹(çº¿ç¨‹)ã€‚

  ![AQSåŒæ­¥é˜Ÿåˆ—](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/1af28424-baa2-4a66-8252-16947931d962_juc-aqs-06.png)

> AQSé˜Ÿåˆ—å†…éƒ¨ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªFIFOçš„åŒå‘é“¾è¡¨ï¼Œè¿™ç§ç»“æ„çš„ç‰¹ç‚¹æ˜¯æ¯ä¸ªæ•°æ®ç»“æ„éƒ½æœ‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘ç›´æ¥çš„åç»§èŠ‚ç‚¹å’Œç›´æ¥å‰é©±èŠ‚ç‚¹ã€‚æ‰€ä»¥åŒå‘é“¾è¡¨å¯ä»¥ä»ä»»æ„ä¸€ä¸ªèŠ‚ç‚¹å¼€å§‹å¾ˆæ–¹ä¾¿çš„è®¿é—®å‰é©±å’Œåç»§ã€‚æ¯ä¸ªNodeå…¶å®æ˜¯ç”±çº¿ç¨‹å°è£…ï¼Œå½“çº¿ç¨‹äº‰æŠ¢é”å¤±è´¥åä¼šå°è£…æˆNodeåŠ å…¥åˆ°ASQé˜Ÿåˆ—ä¸­å»

Nodeç±»çš„ç»„æˆå¦‚ä¸‹

```java
static final class Node {
        static final Node SHARED = new Node();
        static final Node EXCLUSIVE = null;
        static final int CANCELLED =  1;
        static final int SIGNAL    = -1;
        static final int CONDITION = -2;
        static final int PROPAGATE = -3;
        volatile int waitStatus;////å½“å‰èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­çš„çŠ¶æ€
        volatile Node prev; //å‰é©±èŠ‚ç‚¹
        volatile Node next; //åç»§èŠ‚ç‚¹
        volatile Thread thread;//å½“å‰çº¿ç¨‹
        Node nextWaiter; //å­˜å‚¨åœ¨conditioné˜Ÿåˆ—ä¸­çš„åç»§èŠ‚ç‚¹
        //æ˜¯å¦ä¸ºå…±äº«é”
        final boolean isShared() { 
            return nextWaiter == SHARED;
        }

        final Node predecessor() throws NullPointerException {
            Node p = prev;
            if (p == null)
                throw new NullPointerException();
            else
                return p;
        }

        Node() {    // Used to establish initial head or SHARED marker
        }
        //å°†çº¿ç¨‹æ„é€ æˆä¸€ä¸ªNodeï¼Œæ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—
        Node(Thread thread, Node mode) {     // Used by addWaiter
            this.nextWaiter = mode;
            this.thread = thread;
        }
        //è¿™ä¸ªæ–¹æ³•ä¼šåœ¨Conditioné˜Ÿåˆ—ä½¿ç”¨ï¼Œåç»­å•ç‹¬å†™ä¸€ç¯‡æ–‡ç« åˆ†æcondition
        Node(Thread thread, int waitStatus) { // Used by Condition
            this.waitStatus = waitStatus;
            this.thread = thread;
        }
    }
```

### Node.waitStatusçš„è¯´æ˜

| çŠ¶æ€å€¼       | æè¿°                         |
| ------------ | ---------------------------- |
| 0            | èŠ‚ç‚¹é»˜è®¤çš„åˆå§‹å€¼             |
| SIGNAL=-1    | çº¿ç¨‹å·²ç»å‡†å¤‡å¥½ï¼Œç­‰å¾…é‡Šæ”¾èµ„æº |
| CANCELLED=1  | è·å–é”çš„è¯·æ±‚çº¿ç¨‹è¢«å–æ¶ˆ       |
| CONDITION=-2 | èŠ‚ç‚¹åœ¨é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å”¤é†’       |

### stateä¸ºä»€ä¹ˆè¦ç”¨volatileä¿®é¥°ï¼Ÿ

1. å¯è§æ€§ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å˜é‡çš„ä¿®æ”¹å¯ä»¥ç«‹å³è¢«åˆ«çš„çº¿ç¨‹æ„ŸçŸ¥åˆ°
2. æœ‰åºæ€§ï¼Œç¦æ­¢æŒ‡ä»¤é‡æ’



### é‡Šæ”¾é”ä»¥åŠæ·»åŠ çº¿ç¨‹å¯¹äºé˜Ÿåˆ—çš„å˜åŒ–

**æœªæ“ä½œå‰AQSé˜Ÿåˆ—çš„å†…éƒ¨ç»“æ„å›¾**

![](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/65ef794d-1813-44ff-8919-9f6327dc2d4c_juc-aqs-02.png)

#### æ·»åŠ èŠ‚ç‚¹

å½“å‡ºç°é”ç«äº‰ä»¥åŠé‡Šæ”¾é”çš„æ—¶å€™ï¼ŒAQSåŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé¦–å…ˆçœ‹ä¸€ä¸‹æ·»åŠ èŠ‚ç‚¹çš„åœºæ™¯ã€‚

![èŠ‚ç‚¹æ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/3b2925b5-2902-4f42-8579-e13e49151b5f_juc-aqs-03.png)

è¿™é‡Œä¼šæ¶‰åŠåˆ°ä¸¤ä¸ªå˜åŒ–

- æ–°çš„çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹è¿½åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­ï¼Œè®¾ç½®prevèŠ‚ç‚¹ä»¥åŠä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„nextèŠ‚ç‚¹æŒ‡å‘è‡ªå·±
- é€šè¿‡CASå°†tailé‡æ–°æŒ‡å‘æ–°çš„å°¾éƒ¨èŠ‚ç‚¹

#### é‡Šæ”¾é”ç§»é™¤èŠ‚ç‚¹

headèŠ‚ç‚¹è¡¨ç¤ºè·å–é”æˆåŠŸçš„èŠ‚ç‚¹ï¼Œå½“å¤´ç»“ç‚¹åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼Œä¼šå”¤é†’åç»§èŠ‚ç‚¹ï¼Œå¦‚æœåç»§èŠ‚ç‚¹è·å¾—é”æˆåŠŸï¼Œä¼šæŠŠè‡ªå·±è®¾ç½®ä¸ºå¤´ç»“ç‚¹ï¼ŒèŠ‚ç‚¹çš„å˜åŒ–è¿‡ç¨‹å¦‚ä¸‹

![ç§»é™¤èŠ‚ç‚¹çš„å˜åŒ–](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/8fa3119b-f17c-47f4-8fc9-df5fc78e6518_juc-aqs-04.png)

è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯æ¶‰åŠåˆ°ä¸¤ä¸ªå˜åŒ–

- ä¿®æ”¹headèŠ‚ç‚¹æŒ‡å‘ä¸‹ä¸€ä¸ªè·å¾—é”çš„èŠ‚ç‚¹
- æ–°çš„è·å¾—é”çš„èŠ‚ç‚¹ï¼Œå°†prevçš„æŒ‡é’ˆæŒ‡å‘null

è¿™é‡Œæœ‰ä¸€ä¸ªå°çš„å˜åŒ–ï¼Œå°±æ˜¯è®¾ç½®headèŠ‚ç‚¹ä¸éœ€è¦ç”¨CASï¼ŒåŸå› æ˜¯è®¾ç½®headèŠ‚ç‚¹æ˜¯ç”±è·å¾—é”çš„çº¿ç¨‹æ¥å®Œæˆçš„ï¼Œè€ŒåŒæ­¥é”åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹è·å¾—ï¼Œæ‰€ä»¥ä¸éœ€è¦CASä¿è¯ï¼Œåªéœ€è¦æŠŠheadèŠ‚ç‚¹è®¾ç½®ä¸ºåŸé¦–èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ–­å¼€åŸheadèŠ‚ç‚¹çš„nextå¼•ç”¨å³å¯



## AQSçš„æºç åˆ†æ

æ¸…æ¥šäº†AQSçš„åŸºæœ¬æ¶æ„ä»¥åï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹AQSçš„æºç ï¼Œä»ç„¶ä»¥ReentrantLockä¸ºæ¨¡å‹ã€‚

### ReentrantLockçš„æ—¶åºå›¾

è°ƒç”¨ReentrantLockä¸­çš„lock()æ–¹æ³•ï¼Œæºç çš„è°ƒç”¨è¿‡ç¨‹æˆ‘ä½¿ç”¨äº†æ—¶åºå›¾æ¥å±•ç°

![ReentrantLockä¸­lockæ–¹æ³•çš„æ—¶åºå›¾](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/911023b6-6153-4c33-8aa1-30c0ec87bb0f_juc-aqs-05.png)

ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºæ¥ï¼Œå½“é”è·å–å¤±è´¥æ—¶ï¼Œä¼šè°ƒç”¨addWaiter()æ–¹æ³•å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeèŠ‚ç‚¹åŠ å…¥åˆ°AQSé˜Ÿåˆ—ï¼ŒåŸºäºè¿™ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬æ¥åˆ†æAQSçš„æºç å®ç°

### åˆ†ææºç 

#### ReentrantLock.lock()

```java
public void lock() {
    sync.lock();
}
```

è¿™ä¸ªæ˜¯è·å–é”çš„å…¥å£ï¼Œè°ƒç”¨syncè¿™ä¸ªç±»é‡Œé¢çš„æ–¹æ³•ï¼Œsyncæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ

```java
abstract static class Sync extends AbstractQueuedSynchronizer
```

![Sync](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/94ee5791-298c-447c-8abe-897a31916851_juc-aqs-07.png)

syncæ˜¯ReentrantLockçš„ä¸€ä¸ª`é™æ€å†…éƒ¨ç±»`ï¼Œå®ƒç»§æ‰¿äº†AQSè¿™ä¸ªæŠ½è±¡ç±»ï¼Œå‰é¢è¯´è¿‡AQSæ˜¯ä¸€ä¸ªåŒæ­¥å·¥å…·ï¼Œä¸»è¦ç”¨æ¥å®ç°**åŒæ­¥æ§åˆ¶**ã€‚æˆ‘ä»¬åœ¨åˆ©ç”¨è¿™ä¸ªå·¥å…·çš„æ—¶å€™ï¼Œä¼šç»§æ‰¿å®ƒæ¥å®ç°åŒæ­¥æ§åˆ¶åŠŸèƒ½ã€‚
é€šè¿‡è¿›ä¸€æ­¥åˆ†æï¼Œå‘ç°Syncè¿™ä¸ªç±»æœ‰ä¸¤ä¸ªå…·ä½“çš„å®ç°ï¼Œåˆ†åˆ«æ˜¯`NofairSync(éå…¬å¹³é”)`,`FailSync(å…¬å¹³é”)`.

![](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/c7bf694b-812d-42ea-824c-d7853f11d0df_juc-aqs-08.png)

- å…¬å¹³é” è¡¨ç¤ºæ‰€æœ‰çº¿ç¨‹ä¸¥æ ¼æŒ‰ç…§FIFOæ¥è·å–é”
- éå…¬å¹³é” è¡¨ç¤ºå¯ä»¥å­˜åœ¨æŠ¢å é”çš„åŠŸèƒ½(æ’é˜Ÿ)ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ç®¡å½“å‰é˜Ÿåˆ—ä¸Šæ˜¯å¦å­˜åœ¨å…¶ä»–çº¿ç¨‹ç­‰å¾…ï¼Œæ–°çº¿ç¨‹éƒ½æœ‰æœºä¼šæŠ¢å é”

å…¬å¹³é”å’Œéå…¬å¹³é”çš„å®ç°ä¸Šçš„å·®å¼‚ï¼Œæˆ‘ä¼šåœ¨æ–‡ç« åé¢åšä¸€ä¸ªè§£é‡Šï¼Œæ¥ä¸‹æ¥çš„åˆ†æä»ç„¶ä»¥`éå…¬å¹³é”`ä½œä¸ºä¸»è¦åˆ†æé€»è¾‘ã€‚

#### NonfairSync.lock

```java
final void lock() {
    if (compareAndSetState(0, 1)) //é€šè¿‡casæ“ä½œæ¥ä¿®æ”¹stateçŠ¶æ€ï¼Œè¡¨ç¤ºäº‰æŠ¢é”çš„æ“ä½œ
      setExclusiveOwnerThread(Thread.currentThread());//è®¾ç½®å½“å‰è·å¾—é”çŠ¶æ€çš„çº¿ç¨‹
    else
      acquire(1); //å°è¯•å»è·å–é”
}
```

è¿™æ®µä»£ç ç®€å•è§£é‡Šä¸€ä¸‹

- ç”±äºè¿™é‡Œæ˜¯éå…¬å¹³é”ï¼Œæ‰€ä»¥è°ƒç”¨lockæ–¹æ³•æ—¶ï¼Œå…ˆå»é€šè¿‡CASå»æŠ¢å é”
- å¦‚æœæŠ¢å é”æˆåŠŸï¼Œä¿å­˜è·å¾—é”æˆåŠŸçš„å½“å‰çº¿ç¨‹
- æŠ¢å é”å¤±è´¥ï¼Œè°ƒç”¨acquireæ¥èµ°é”ç«äº‰é€»è¾‘

> **compareAndSetState**
> compareAndSetStateçš„ä»£ç å®ç°é€»è¾‘å¦‚ä¸‹

```java
// See below for intrinsics setup to support this
return unsafe.compareAndSwapInt(this, stateOffset, expect, update);
```

> ```pf
> è¿™æ®µä»£ç å…¶å®é€»è¾‘å¾ˆç®€å•ï¼Œå°±æ˜¯é€šè¿‡casä¹è§‚é”çš„æ–¹å¼æ¥åšæ¯”è¾ƒå¹¶æ›¿æ¢ã€‚ä¸Šé¢è¿™æ®µä»£ç çš„æ„æ€æ˜¯ï¼Œå¦‚æœå½“å‰å†…å­˜ä¸­çš„stateçš„å€¼å’Œé¢„æœŸå€¼expectç›¸ç­‰ï¼Œåˆ™æ›¿æ¢ä¸ºupdateã€‚æ›´æ–°æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›false.
> è¿™ä¸ªæ“ä½œæ˜¯åŸå­çš„ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œè¿™é‡Œé¢æ¶‰åŠåˆ°Unsafeè¿™ä¸ªç±»çš„æ“ä½œï¼Œä¸€çº§æ¶‰åŠåˆ°stateè¿™ä¸ªå±æ€§çš„æ„ä¹‰ã€‚
> **state**
> ```

- å½“state=0æ—¶ï¼Œè¡¨ç¤ºæ— é”çŠ¶æ€

- å½“state>0æ—¶ï¼Œè¡¨ç¤ºå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”ï¼Œä¹Ÿå°±æ˜¯state=1ï¼Œä½†æ˜¯å› ä¸ºReentrantLockå…è®¸é‡å…¥ï¼Œæ‰€ä»¥åŒä¸€ä¸ªçº¿ç¨‹å¤šæ¬¡è·å¾—åŒæ­¥é”çš„æ—¶å€™ï¼Œstateä¼šé€’å¢ï¼Œæ¯”å¦‚é‡å…¥5æ¬¡ï¼Œé‚£ä¹ˆstate=5ã€‚ è€Œåœ¨é‡Šæ”¾é”çš„æ—¶å€™ï¼ŒåŒæ ·éœ€è¦é‡Šæ”¾5æ¬¡ç›´åˆ°state=0å…¶ä»–çº¿ç¨‹æ‰æœ‰èµ„æ ¼è·å¾—é”

  > ```java
  > private volatile int state;
  > ```
  >
  > éœ€è¦æ³¨æ„çš„æ˜¯ï¼šä¸åŒçš„AQSå®ç°ï¼Œstateæ‰€è¡¨è¾¾çš„å«ä¹‰æ˜¯ä¸ä¸€æ ·çš„ã€‚
  > **Unsafe**
  > Unsafeç±»æ˜¯åœ¨sun.miscåŒ…ä¸‹ï¼Œä¸å±äºJavaæ ‡å‡†ã€‚ä½†æ˜¯å¾ˆå¤šJavaçš„åŸºç¡€ç±»åº“ï¼ŒåŒ…æ‹¬ä¸€äº›è¢«å¹¿æ³›ä½¿ç”¨çš„é«˜æ€§èƒ½å¼€å‘åº“éƒ½æ˜¯åŸºäºUnsafeç±»å¼€å‘çš„ï¼Œæ¯”å¦‚Nettyã€Hadoopã€Kafkaç­‰ï¼›Unsafeå¯è®¤ä¸ºæ˜¯Javaä¸­ç•™ä¸‹çš„åé—¨ï¼Œæä¾›äº†ä¸€äº›ä½å±‚æ¬¡æ“ä½œï¼Œå¦‚ç›´æ¥å†…å­˜è®¿é—®ã€çº¿ç¨‹è°ƒåº¦ç­‰
  >
  > ```java
  > public final native boolean compareAndSwapInt(Object var1, long var2, int var4, int var5);
  > ```
  >
  > è¿™ä¸ªæ˜¯ä¸€ä¸ªnativeæ–¹æ³•ï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦æ”¹å˜çš„å¯¹è±¡ï¼Œç¬¬äºŒä¸ªä¸ºåç§»é‡(å³ä¹‹å‰æ±‚å‡ºæ¥çš„headOffsetçš„å€¼)ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ä¸ºæœŸå¾…çš„å€¼ï¼Œç¬¬å››ä¸ªä¸ºæ›´æ–°åçš„å€¼
  > æ•´ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å¦‚æœå½“å‰æ—¶åˆ»çš„å€¼ç­‰äºé¢„æœŸå€¼var4ç›¸ç­‰ï¼Œåˆ™æ›´æ–°ä¸ºæ–°çš„æœŸæœ›å€¼ var5ï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œåˆ™è¿”å›trueï¼Œå¦åˆ™è¿”å›falseï¼›

#### acquire

acquireæ˜¯AQSä¸­çš„æ–¹æ³•ï¼Œå¦‚æœCASæ“ä½œæœªèƒ½æˆåŠŸï¼Œè¯´æ˜stateå·²ç»ä¸ä¸º0ï¼Œæ­¤æ—¶ç»§ç»­acquire(1)æ“ä½œ,è¿™é‡Œå¤§å®¶æ€è€ƒä¸€ä¸‹ï¼Œacquireæ–¹æ³•ä¸­çš„1çš„å‚æ•°æ˜¯ç”¨æ¥åšä»€ä¹ˆå‘¢ï¼Ÿå¦‚æœæ²¡çŒœä¸­ï¼Œå¾€å‰é¢å›é¡¾ä¸€ä¸‹stateè¿™ä¸ªæ¦‚å¿µ

```java
    public final void acquire(int arg) {
        if (!tryAcquire(arg) &&
            acquireQueued(addWaiter(Node.EXCLUSIVE), arg))
            selfInterrupt();
    }
```

è¿™ä¸ªæ–¹æ³•çš„ä¸»è¦é€»è¾‘æ˜¯

- é€šè¿‡tryAcquireå°è¯•è·å–ç‹¬å é”ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œå¤±è´¥è¿”å›false
- å¦‚æœtryAcquireå¤±è´¥ï¼Œåˆ™ä¼šé€šè¿‡addWaiteræ–¹æ³•å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeæ·»åŠ åˆ°AQSé˜Ÿåˆ—å°¾éƒ¨
- acquireQueuedï¼Œå°†Nodeä½œä¸ºå‚æ•°ï¼Œé€šè¿‡è‡ªæ—‹å»å°è¯•è·å–é”ã€‚

> å¦‚æœå¤§å®¶çœ‹è¿‡æˆ‘å†™çš„[Synchronizedæºç åˆ†æ](https://link.segmentfault.com/?enc=5KkOQtgVmSD%2BxDr4f42RMg%3D%3D.of3O3TOW%2Fpp71DNbTJt4lfMVpD7M41XMGH6WejtnUTFL3dJdAckLJXIKfOKAxKMPr1VQk9uQgik4yqMDrQZNF1oF55FXK5sguTlA8P9zweloIiVZcznQC24paDi5bkDch22etFoERCk%2Bcr24c21l9Jcv0i9UEWy0lse3A9z3P4zEO3Pg2IB4VNyodJsX%2FE3QWGvW6QYLZZhBCROWlidFNlPC1VT6G%2BCHtceZMNh1vd9w1kkjEEpruNvs%2Bm7KpuXZkB%2BJLsW0bDpg2aDcSrVdqCjmeWHdis6vW8FRCekC8L3tU0EhSrrjmlyPOg0UqPFFqJeKWrgSYA%2FuEJBf%2BXP82A%3D%3D)çš„æ–‡ç« ï¼Œå°±åº”è¯¥èƒ½å¤Ÿæ˜ç™½è‡ªæ—‹å­˜åœ¨çš„æ„ä¹‰



#### tryAcquire

åœ¨`AQS`çš„æºç ä¸­`tryAcquire`æ˜¯ä¸€ç©ºå®ç°,éœ€è¦å®ƒçš„å­ç±»å»å®ç°è¿™ä¸ªç©ºæ–¹æ³•ã€‚å› ä¸ºåœ¨AQSä¸­è™½ç„¶`å…¬å¹³é”`å’Œ`éå…¬å¹³é”`çš„éƒ½æ˜¯åŸºäºä¸€ä¸ªCLHå»å®ç°ï¼Œä½†æ˜¯åœ¨è·å–é”çš„è¿‡ç¨‹ä¸­ç•¥æœ‰ä¸åŒã€‚è¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯å°è¯•è·å–é”ï¼Œå¦‚æœæˆåŠŸè¿”å›trueï¼Œä¸æˆåŠŸè¿”å›false,å®ƒæ˜¯é‡å†™AQSç±»ä¸­çš„tryAcquireæ–¹æ³•ï¼Œå¹¶ä¸”å¤§å®¶ä»”ç»†çœ‹ä¸€ä¸‹AQSä¸­tryAcquireæ–¹æ³•çš„å®šä¹‰ï¼Œå¹¶æ²¡æœ‰å®ç°ï¼Œè€Œæ˜¯æŠ›å‡ºå¼‚å¸¸ã€‚æŒ‰ç…§ä¸€èˆ¬çš„æ€ç»´æ¨¡å¼ï¼Œæ—¢ç„¶æ˜¯ä¸€ä¸ªä¸å®ç°çš„æ¨¡ç‰ˆæ–¹æ³•ï¼Œé‚£åº”è¯¥å®šä¹‰æˆabstractï¼Œè®©å­ç±»æ¥å®ç°å‘€ï¼Ÿå¤§å®¶æƒ³æƒ³ä¸ºä»€ä¹ˆä¸è¿™æ ·å‘¢?

```java
 protected final boolean tryAcquire(int acquires) {
            return nonfairTryAcquire(acquires);
 }
```

**å…¬å¹³é”FairSync#tryAcquire**

```java
protected final boolean tryAcquire(int acquires) {
            //è·å–å½“å‰çº¿ç¨‹
            final Thread current = Thread.currentThread();
            int c = getState();//è·å–åŒæ­¥å™¨çš„çŠ¶æ€
            if (c == 0) {//å½“å‰æ²¡æœ‰çº¿ç¨‹è·å–åˆ°é”
                //é¦–å…ˆåˆ¤æ–­ç¥–å®—èŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦å½“å‰çº¿ç¨‹ä¸€æ ·
                if (!hasQueuedPredecessors() &&
                    //æ›´æ”¹stateçš„çŠ¶æ€å€¼ä¸ºé0
                    compareAndSetState(0, acquires)) {
                    setExclusiveOwnerThread(current);
                    return true;
                }
            }
            //å¦‚æœé”æŒæœ‰è€…çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™å¯æ”¾è¡Œï¼Œé”çš„é‡å…¥
            else if (current == getExclusiveOwnerThread()) {
                int nextc = c + acquires;
                if (nextc < 0)
                    throw new Error("Maximum lock count exceeded");
                setState(nextc);
                return true;
            }
            return false;
        }
    }
/**
* åˆ¤æ–­ç¥–å®—èŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦å½“å‰çº¿ç¨‹ä¸€æ ·
* å‚€å„¡èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹
*/
public final boolean hasQueuedPredecessors() {
    Node t = tail;
    Node h = head;
    Node s;
    //å¤´èŠ‚ç‚¹çš„ä¸‹ä¸ªèŠ‚ç‚¹æ‰€æŒæœ‰çš„çº¿ç¨‹æ˜¯å¦ä¸å½“å‰çº¿ç¨‹ç›¸åŒ
    return h != t &&
        ((s = h.next) == null || s.thread != Thread.currentThread());
}
```

**éå…¬å¹³é”NonfairSync#tryAcquire**

```java
protected final boolean tryAcquire(int acquires) {
    return nonfairTryAcquire(acquires);
}
final boolean nonfairTryAcquire(int acquires) {
      //è·å¾—å½“å‰æ‰§è¡Œçš„çº¿ç¨‹
    final Thread current = Thread.currentThread();
    int c = getState(); //è·å¾—stateçš„å€¼
    if (c == 0) { //state=0è¯´æ˜å½“å‰æ˜¯æ— é”çŠ¶æ€
        //é€šè¿‡casæ“ä½œæ¥æ›¿æ¢stateçš„å€¼æ”¹ä¸º1ï¼Œå¤§å®¶æƒ³æƒ³ä¸ºä»€ä¹ˆè¦ç”¨caså‘¢ï¼Ÿ
        //ç†ç”±æ˜¯ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œç›´æ¥ä¿®æ”¹state=1ä¼šå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œä½ çŒœåˆ°äº†å—ï¼Ÿ
        if (compareAndSetState(0, acquires)) {
             //ä¿å­˜å½“å‰è·å¾—é”çš„çº¿ç¨‹
            setExclusiveOwnerThread(current);
            return true;
        }
    }
    //è¿™æ®µé€»è¾‘å°±å¾ˆç®€å•äº†ã€‚å¦‚æœæ˜¯åŒä¸€ä¸ªçº¿ç¨‹æ¥è·å¾—é”ï¼Œåˆ™ç›´æ¥å¢åŠ é‡å…¥æ¬¡æ•°
    else if (current == getExclusiveOwnerThread()) {
        int nextc = c + acquires; //å¢åŠ é‡å…¥æ¬¡æ•°
        if (nextc < 0) // overflow
            throw new Error("Maximum lock count exceeded");
        setState(nextc);
        return true;
    }
    return false;
} 
```

- è·å–å½“å‰çº¿ç¨‹ï¼Œåˆ¤æ–­å½“å‰çš„é”çš„çŠ¶æ€
- å¦‚æœstate=0è¡¨ç¤ºå½“å‰æ˜¯æ— é”çŠ¶æ€ï¼Œé€šè¿‡casæ›´æ–°stateçŠ¶æ€çš„å€¼
- å¦‚æœå½“å‰çº¿ç¨‹æ˜¯å±äºé‡å…¥ï¼Œåˆ™å¢åŠ é‡å…¥æ¬¡æ•°

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/4c2251dc-672a-4692-8275-7fe444c31a73_juc-aqs-09.png)

å¯¹æ¯”åå‘ç°ï¼Œå…¬å¹³é”å…ˆåˆ¤æ–­æ˜¯å¦æœ‰è€ç¥–å®—èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰åˆ™è¿”å›`false`ï¼›å¦‚æœå½“å‰çº¿ç¨‹å¯¹åº”çš„nodeå°±æ˜¯è€ç¥–å®—èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥å»ä¿®æ”¹stateçŠ¶æ€ï¼ŒæŠŠstateæ”¹ä¸ºé0ã€‚



#### addWaiter

å½“tryAcquireæ–¹æ³•è·å–é”å¤±è´¥ä»¥åï¼Œåˆ™ä¼šå…ˆè°ƒç”¨addWaiterå°†å½“å‰çº¿ç¨‹å°è£…æˆNodeï¼Œç„¶åæ·»åŠ åˆ°AQSé˜Ÿåˆ—

```java
private Node addWaiter(Node mode) { //mode=Node.EXCLUSIVE
        //å°†å½“å‰çº¿ç¨‹å°è£…æˆNodeï¼Œå¹¶ä¸”modeä¸ºç‹¬å é”
        Node node = new Node(Thread.currentThread(), mode); 
        // Try the fast path of enq; backup to full enq on failure
        // tailæ˜¯AQSçš„ä¸­è¡¨ç¤ºåŒæ­¥é˜Ÿåˆ—é˜Ÿå°¾çš„å±æ€§ï¼Œåˆšå¼€å§‹ä¸ºnullï¼Œæ‰€ä»¥è¿›è¡Œenq(node)æ–¹æ³•
        Node pred = tail;
        if (pred != null) { //tailä¸ä¸ºç©ºçš„æƒ…å†µï¼Œè¯´æ˜é˜Ÿåˆ—ä¸­å­˜åœ¨èŠ‚ç‚¹æ•°æ®
            node.prev = pred;  //è®²å½“å‰çº¿ç¨‹çš„Nodeçš„prevèŠ‚ç‚¹æŒ‡å‘tail
            if (compareAndSetTail(pred, node)) {//é€šè¿‡casè®²nodeæ·»åŠ åˆ°AQSé˜Ÿåˆ—
                pred.next = node;//casæˆåŠŸï¼ŒæŠŠæ—§çš„tailçš„nextæŒ‡é’ˆæŒ‡å‘æ–°çš„tail
                return node;
            }
        }
        enq(node); //tail=nullï¼Œå°†nodeæ·»åŠ åˆ°åŒæ­¥é˜Ÿåˆ—ä¸­
        return node;
    }
```

- å°†å½“å‰çº¿ç¨‹å°è£…æˆNode
- åˆ¤æ–­å½“å‰é“¾è¡¨ä¸­çš„tailèŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ä¸ºç©ºï¼Œåˆ™é€šè¿‡casæ“ä½œæŠŠå½“å‰çº¿ç¨‹çš„nodeæ·»åŠ åˆ°AQSé˜Ÿåˆ—
- å¦‚æœä¸ºç©ºæˆ–è€…caså¤±è´¥ï¼Œè°ƒç”¨enqå°†èŠ‚ç‚¹æ·»åŠ åˆ°AQSé˜Ÿåˆ—

#### enq

enqå°±æ˜¯é€šè¿‡è‡ªæ—‹æ“ä½œæŠŠå½“å‰èŠ‚ç‚¹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­

```java
private Node enq(final Node node) {
        //è‡ªæ—‹ï¼Œä¸åšè¿‡å¤šè§£é‡Šï¼Œä¸æ¸…æ¥šçš„å…³æ³¨å…¬ä¼—å·[æ¶æ„å¸ˆä¿®ç‚¼å®å…¸]
        for (;;) {
            Node t = tail; //å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ·»åŠ åˆ°é˜Ÿåˆ—ï¼Œé‚£ä¹ˆtail=null
            if (t == null) { // Must initialize
                //CASçš„æ–¹å¼åˆ›å»ºä¸€ä¸ªç©ºçš„Nodeä½œä¸ºå¤´ç»“ç‚¹
                if (compareAndSetHead(new Node()))
                   //æ­¤æ—¶é˜Ÿåˆ—ä¸­åªä¸€ä¸ªå¤´ç»“ç‚¹ï¼Œæ‰€ä»¥tailä¹ŸæŒ‡å‘å®ƒ
                    tail = head;
            } else {
//è¿›è¡Œç¬¬äºŒæ¬¡å¾ªç¯æ—¶ï¼Œtailä¸ä¸ºnullï¼Œè¿›å…¥elseåŒºåŸŸã€‚å°†å½“å‰çº¿ç¨‹çš„Nodeç»“ç‚¹çš„prevæŒ‡å‘tailï¼Œç„¶åä½¿ç”¨CASå°†tailæŒ‡å‘Node
                node.prev = t;
                if (compareAndSetTail(t, node)) {
//tæ­¤æ—¶æŒ‡å‘tail,æ‰€ä»¥å¯ä»¥CASæˆåŠŸï¼Œå°†tailé‡æ–°æŒ‡å‘Nodeã€‚æ­¤æ—¶tä¸ºæ›´æ–°å‰çš„tailçš„å€¼ï¼Œå³æŒ‡å‘ç©ºçš„å¤´ç»“ç‚¹ï¼Œt.next=nodeï¼Œå°±å°†å¤´ç»“ç‚¹çš„åç»­ç»“ç‚¹æŒ‡å‘Nodeï¼Œè¿”å›å¤´ç»“ç‚¹
                    t.next = node;
                    return t;
                }
            }
        }
    }
```

å‡å¦‚æœ‰ä¸¤ä¸ªçº¿ç¨‹t1,t2åŒæ—¶è¿›å…¥enqæ–¹æ³•ï¼Œt==nullè¡¨ç¤ºé˜Ÿåˆ—æ˜¯é¦–æ¬¡ä½¿ç”¨ï¼Œéœ€è¦å…ˆåˆå§‹åŒ–
å¦å¤–ä¸€ä¸ªçº¿ç¨‹caså¤±è´¥ï¼Œåˆ™è¿›å…¥ä¸‹æ¬¡å¾ªç¯ï¼Œé€šè¿‡casæ“ä½œå°†nodeæ·»åŠ åˆ°é˜Ÿå°¾

> åˆ°ç›®å‰ä¸ºæ­¢ï¼Œé€šè¿‡addwaiteræ–¹æ³•æ„é€ äº†ä¸€ä¸ªAQSé˜Ÿåˆ—ï¼Œå¹¶ä¸”å°†çº¿ç¨‹æ·»åŠ åˆ°äº†é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¸­

#### acquireQueued

å°†æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­çš„Nodeä½œä¸ºå‚æ•°ä¼ å…¥acquireQueuedæ–¹æ³•ï¼Œè¿™é‡Œé¢ä¼šåšæŠ¢å é”çš„æ“ä½œ

```java
final boolean acquireQueued(final Node node, int arg) {
    boolean failed = true;
    try {
        boolean interrupted = false;
        for (;;) {
            final Node p = node.predecessor();// è·å–prevèŠ‚ç‚¹,è‹¥ä¸ºnullå³åˆ»æŠ›å‡ºNullPointException
            if (p == head && tryAcquire(arg)) {// å¦‚æœå‰é©±ä¸ºheadæ‰æœ‰èµ„æ ¼è¿›è¡Œé”çš„æŠ¢å¤º
                setHead(node); // è·å–é”æˆåŠŸåå°±ä¸éœ€è¦å†è¿›è¡ŒåŒæ­¥æ“ä½œäº†,è·å–é”æˆåŠŸçš„çº¿ç¨‹ä½œä¸ºæ–°çš„headèŠ‚ç‚¹
//å‡¡æ˜¯headèŠ‚ç‚¹,head.threadä¸head.prevæ°¸è¿œä¸ºnull, ä½†æ˜¯head.nextä¸ä¸ºnull
                p.next = null; // help GC
                failed = false; //è·å–é”æˆåŠŸ
                return interrupted;
            }
//å¦‚æœè·å–é”å¤±è´¥ï¼Œåˆ™æ ¹æ®èŠ‚ç‚¹çš„waitStatuså†³å®šæ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹
            if (shouldParkAfterFailedAcquire(p, node) &&
                parkAndCheckInterrupt())// è‹¥å‰é¢ä¸ºtrue,åˆ™æ‰§è¡ŒæŒ‚èµ·,å¾…ä¸‹æ¬¡å”¤é†’çš„æ—¶å€™æ£€æµ‹ä¸­æ–­çš„æ ‡å¿—
                interrupted = true;
        }
    } finally {
        if (failed) // å¦‚æœæŠ›å‡ºå¼‚å¸¸åˆ™å–æ¶ˆé”çš„è·å–,è¿›è¡Œå‡ºé˜Ÿ(sync queue)æ“ä½œ
            cancelAcquire(node);
    }
}
```

- è·å–å½“å‰èŠ‚ç‚¹çš„prevèŠ‚ç‚¹
- å¦‚æœprevèŠ‚ç‚¹ä¸ºheadèŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒå°±æœ‰èµ„æ ¼å»äº‰æŠ¢é”ï¼Œè°ƒç”¨tryAcquireæŠ¢å é”
- æŠ¢å é”æˆåŠŸä»¥åï¼ŒæŠŠè·å¾—é”çš„èŠ‚ç‚¹è®¾ç½®ä¸ºheadï¼Œå¹¶ä¸”ç§»é™¤åŸæ¥çš„åˆå§‹åŒ–headèŠ‚ç‚¹
- å¦‚æœè·å¾—é”å¤±è´¥ï¼Œåˆ™æ ¹æ®waitStatuså†³å®šæ˜¯å¦éœ€è¦æŒ‚èµ·çº¿ç¨‹
- æœ€åï¼Œé€šè¿‡cancelAcquireå–æ¶ˆè·å¾—é”çš„æ“ä½œ

![](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-10-12/8f736d2e-dd61-409d-8b6b-c432bbab9379_juc-aqs-10.png)

å‰é¢çš„é€»è¾‘éƒ½å¾ˆå¥½ç†è§£ï¼Œä¸»è¦çœ‹ä¸€ä¸‹shouldParkAfterFailedAcquireè¿™ä¸ªæ–¹æ³•å’ŒparkAndCheckInterruptçš„ä½œç”¨

#### shouldParkAfterFailedAcquire

ä»ä¸Šé¢çš„åˆ†æå¯ä»¥çœ‹å‡ºï¼Œåªæœ‰é˜Ÿåˆ—çš„ç¬¬äºŒä¸ªèŠ‚ç‚¹å¯ä»¥æœ‰æœºä¼šäº‰ç”¨é”ï¼Œå¦‚æœæˆåŠŸè·å–é”ï¼Œåˆ™æ­¤èŠ‚ç‚¹æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ã€‚å¯¹äºç¬¬ä¸‰ä¸ªåŠä»¥åçš„èŠ‚ç‚¹ï¼Œif (p == head)æ¡ä»¶ä¸æˆç«‹ï¼Œé¦–å…ˆè¿›è¡ŒshouldParkAfterFailedAcquire(p, node)æ“ä½œ
shouldParkAfterFailedAcquireæ–¹æ³•æ˜¯**åˆ¤æ–­ä¸€ä¸ªäº‰ç”¨é”çš„çº¿ç¨‹æ˜¯å¦åº”è¯¥è¢«é˜»å¡**ã€‚å®ƒé¦–å…ˆåˆ¤æ–­ä¸€ä¸ªèŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯å¦ä¸ºNode.SIGNALï¼Œå¦‚æœæ˜¯ï¼Œæ˜¯è¯´æ˜æ­¤èŠ‚ç‚¹å·²ç»å°†çŠ¶æ€è®¾ç½®-å¦‚æœé”é‡Šæ”¾ï¼Œåˆ™åº”å½“é€šçŸ¥å®ƒï¼Œæ‰€ä»¥å®ƒå¯ä»¥å®‰å…¨çš„é˜»å¡äº†ï¼Œè¿”å›trueã€‚

```java
 /** waitStatus value to indicate successor's thread needs unparking */
        static final int SIGNAL    = -1;//çº¿ç¨‹å·²ç»å‡†å¤‡å¥½ï¼Œç­‰å¾…é‡Šæ”¾èµ„æº


private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) {
    int ws = pred.waitStatus; //å‰ç»§èŠ‚ç‚¹çš„çŠ¶æ€
    if (ws == Node.SIGNAL)//å¦‚æœæ˜¯SIGNALçŠ¶æ€ï¼Œæ„å‘³ç€å½“å‰çº¿ç¨‹éœ€è¦è¢«unparkå”¤é†’
               return true;
//å¦‚æœå‰èŠ‚ç‚¹çš„çŠ¶æ€å¤§äº0ï¼Œå³ä¸ºCANCELLEDçŠ¶æ€æ—¶ï¼Œåˆ™ä¼šä»å‰èŠ‚ç‚¹å¼€å§‹é€æ­¥å¾ªç¯æ‰¾åˆ°ä¸€ä¸ªæ²¡æœ‰è¢«â€œCANCELLEDâ€èŠ‚ç‚¹è®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„å‰èŠ‚ç‚¹ï¼Œè¿”å›falseã€‚åœ¨ä¸‹æ¬¡å¾ªç¯æ‰§è¡ŒshouldParkAfterFailedAcquireæ—¶ï¼Œè¿”å›trueã€‚è¿™ä¸ªæ“ä½œå®é™…æ˜¯æŠŠé˜Ÿåˆ—ä¸­CANCELLEDçš„èŠ‚ç‚¹å‰”é™¤æ‰ã€‚
    if (ws > 0) {// å¦‚æœå‰ç»§èŠ‚ç‚¹æ˜¯â€œå–æ¶ˆâ€çŠ¶æ€ï¼Œåˆ™è®¾ç½® â€œå½“å‰èŠ‚ç‚¹â€çš„ â€œå½“å‰å‰ç»§èŠ‚ç‚¹â€ ä¸º â€œâ€˜åŸå‰ç»§èŠ‚ç‚¹'çš„å‰ç»§èŠ‚ç‚¹â€ã€‚
       
        do {
            node.prev = pred = pred.prev;
        } while (pred.waitStatus > 0);
        pred.next = node;
    } else { // å¦‚æœå‰ç»§èŠ‚ç‚¹ä¸ºâ€œ0â€æˆ–è€…â€œå…±äº«é”â€çŠ¶æ€ï¼Œåˆ™è®¾ç½®å‰ç»§èŠ‚ç‚¹ä¸ºSIGNALçŠ¶æ€ã€‚
        /*
         * waitStatus must be 0 or PROPAGATE.  Indicate that we
         * need a signal, but don't park yet.  Caller will need to
         * retry to make sure it cannot acquire before parking.
         */
        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);
    }
    return false;
}
```

#### parkAndCheckInterrupt

å¦‚æœshouldParkAfterFailedAcquireè¿”å›äº†trueï¼Œåˆ™ä¼šæ‰§è¡Œï¼š`parkAndCheckInterrupt()`æ–¹æ³•ï¼Œå®ƒæ˜¯é€šè¿‡LockSupport.park(this)å°†å½“å‰çº¿ç¨‹æŒ‚èµ·åˆ°WATINGçŠ¶æ€ï¼Œå®ƒéœ€è¦ç­‰å¾…ä¸€ä¸ªä¸­æ–­ã€unparkæ–¹æ³•æ¥å”¤é†’å®ƒï¼Œé€šè¿‡è¿™æ ·ä¸€ç§FIFOçš„æœºåˆ¶çš„ç­‰å¾…ï¼Œæ¥å®ç°äº†Lockçš„æ“ä½œã€‚

```java
private final boolean parkAndCheckInterrupt() {
        LockSupport.park(this);
        return Thread.interrupted();
}
```

> **LockSupport**
> LockSupportç±»æ˜¯Java6å¼•å…¥çš„ä¸€ä¸ªç±»ï¼Œæä¾›äº†åŸºæœ¬çš„çº¿ç¨‹åŒæ­¥åŸè¯­ã€‚LockSupportå®é™…ä¸Šæ˜¯è°ƒç”¨äº†Unsafeç±»é‡Œçš„å‡½æ•°ï¼Œå½’ç»“åˆ°Unsafeé‡Œï¼Œåªæœ‰ä¸¤ä¸ªå‡½æ•°ï¼š
>
> ```java
> public native void unpark(Thread jthread);  
> public native void park(boolean isAbsolute, long time);  
> ```
>
> unparkå‡½æ•°ä¸ºçº¿ç¨‹æä¾›â€œè®¸å¯(permit)â€ï¼Œçº¿ç¨‹è°ƒç”¨parkå‡½æ•°åˆ™ç­‰å¾…â€œè®¸å¯â€ã€‚è¿™ä¸ªæœ‰ç‚¹åƒä¿¡å·é‡ï¼Œä½†æ˜¯è¿™ä¸ªâ€œè®¸å¯â€æ˜¯ä¸èƒ½å åŠ çš„ï¼Œâ€œè®¸å¯â€æ˜¯ä¸€æ¬¡æ€§çš„ã€‚
> permitç›¸å½“äº0/1çš„å¼€å…³ï¼Œé»˜è®¤æ˜¯0ï¼Œè°ƒç”¨ä¸€æ¬¡unparkå°±åŠ 1å˜æˆäº†1.è°ƒç”¨ä¸€æ¬¡parkä¼šæ¶ˆè´¹permitï¼Œåˆä¼šå˜æˆ0ã€‚ å¦‚æœå†è°ƒç”¨ä¸€æ¬¡parkä¼šé˜»å¡ï¼Œå› ä¸ºpermitå·²ç»æ˜¯0äº†ã€‚ç›´åˆ°permitå˜æˆ1.è¿™æ—¶è°ƒç”¨unparkä¼šæŠŠpermitè®¾ç½®ä¸º1.æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç›¸å…³çš„permitï¼Œpermitæœ€å¤šåªæœ‰ä¸€ä¸ªï¼Œé‡å¤è°ƒç”¨unparkä¸ä¼šç´¯ç§¯

## é”çš„é‡Šæ”¾

### ReentrantLock.unlock

åŠ é”çš„è¿‡ç¨‹åˆ†æå®Œä»¥åï¼Œå†æ¥åˆ†æä¸€ä¸‹é‡Šæ”¾é”çš„è¿‡ç¨‹ï¼Œè°ƒç”¨releaseæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢åšä¸¤ä»¶äº‹ï¼Œ1ï¼Œé‡Šæ”¾é” ï¼›2ï¼Œå”¤é†’parkçš„çº¿ç¨‹

```java
public final boolean release(int arg) {
    if (tryRelease(arg)) {
        Node h = head;
        if (h != null && h.waitStatus != 0)
            unparkSuccessor(h);
        return true;
    }
    return false;
}
```

### tryRelease

è¿™ä¸ªåŠ¨ä½œå¯ä»¥è®¤ä¸ºå°±æ˜¯ä¸€ä¸ªè®¾ç½®é”çŠ¶æ€çš„æ“ä½œï¼Œè€Œä¸”æ˜¯å°†çŠ¶æ€å‡æ‰ä¼ å…¥çš„å‚æ•°å€¼ï¼ˆå‚æ•°æ˜¯1ï¼‰ï¼Œå¦‚æœç»“æœçŠ¶æ€ä¸º0ï¼Œå°±å°†æ’å®ƒé”çš„Ownerè®¾ç½®ä¸ºnullï¼Œä»¥ä½¿å¾—å…¶å®ƒçš„çº¿ç¨‹æœ‰æœºä¼šè¿›è¡Œæ‰§è¡Œã€‚
åœ¨æ’å®ƒé”ä¸­ï¼ŒåŠ é”çš„æ—¶å€™çŠ¶æ€ä¼šå¢åŠ 1ï¼ˆå½“ç„¶å¯ä»¥è‡ªå·±ä¿®æ”¹è¿™ä¸ªå€¼ï¼‰ï¼Œåœ¨è§£é”çš„æ—¶å€™å‡æ‰1ï¼ŒåŒä¸€ä¸ªé”ï¼Œåœ¨å¯ä»¥é‡å…¥åï¼Œå¯èƒ½ä¼šè¢«å åŠ ä¸º2ã€3ã€4è¿™äº›å€¼ï¼Œåªæœ‰unlock()çš„æ¬¡æ•°ä¸lock()çš„æ¬¡æ•°å¯¹åº”æ‰ä¼šå°†Ownerçº¿ç¨‹è®¾ç½®ä¸ºç©ºï¼Œè€Œä¸”ä¹Ÿåªæœ‰è¿™ç§æƒ…å†µä¸‹æ‰ä¼šè¿”å›trueã€‚

```java
protected final boolean tryRelease(int releases) {
    int c = getState() - releases; // è¿™é‡Œæ˜¯å°†é”çš„æ•°é‡å‡1
    if (Thread.currentThread() != getExclusiveOwnerThread())// å¦‚æœé‡Šæ”¾çš„çº¿ç¨‹å’Œè·å–é”çš„çº¿ç¨‹ä¸æ˜¯åŒä¸€ä¸ªï¼ŒæŠ›å‡ºéæ³•ç›‘è§†å™¨çŠ¶æ€å¼‚å¸¸
        throw new IllegalMonitorStateException();
    boolean free = false;
    if (c == 0) { 
	// ç”±äºé‡å…¥çš„å…³ç³»ï¼Œä¸æ˜¯æ¯æ¬¡é‡Šæ”¾é”céƒ½ç­‰äº0ï¼Œ
    // ç›´åˆ°æœ€åä¸€æ¬¡é‡Šæ”¾é”æ—¶ï¼Œæ‰ä¼šæŠŠå½“å‰çº¿ç¨‹é‡Šæ”¾
        free = true;
        setExclusiveOwnerThread(null);
    }
    setState(c);
    return free;
}
```

### unparkSuccessor

åœ¨æ–¹æ³•unparkSuccessor(Node)ä¸­ï¼Œå°±æ„å‘³ç€çœŸæ­£è¦é‡Šæ”¾é”äº†ï¼Œå®ƒä¼ å…¥çš„æ˜¯headèŠ‚ç‚¹ï¼ˆheadèŠ‚ç‚¹æ˜¯å ç”¨é”çš„èŠ‚ç‚¹ï¼‰ï¼Œå½“å‰çº¿ç¨‹è¢«é‡Šæ”¾ä¹‹åï¼Œéœ€è¦å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹

```java
private void unparkSuccessor(Node node) {
    int ws = node.waitStatus;
    if (ws < 0)
        compareAndSetWaitStatus(node, ws, 0);
    Node s = node.next;
    if (s == null || s.waitStatus > 0) {//åˆ¤æ–­åç»§èŠ‚ç‚¹æ˜¯å¦ä¸ºç©ºæˆ–è€…æ˜¯å¦æ˜¯å–æ¶ˆçŠ¶æ€,
        s = null;
        for (Node t = tail; t != null && t != node; t = t.prev)
            if (t.waitStatus <= 0) //ç„¶åä»é˜Ÿåˆ—å°¾éƒ¨å‘å‰éå†æ‰¾åˆ°æœ€å‰é¢çš„ä¸€ä¸ªwaitStatuså°äº0çš„èŠ‚ç‚¹, è‡³äºä¸ºä»€ä¹ˆä»å°¾éƒ¨å¼€å§‹å‘å‰éå†ï¼Œå› ä¸ºåœ¨doAcquireInterruptibly.cancelAcquireæ–¹æ³•çš„å¤„ç†è¿‡ç¨‹ä¸­åªè®¾ç½®äº†nextçš„å˜åŒ–ï¼Œæ²¡æœ‰è®¾ç½®prevçš„å˜åŒ–ï¼Œåœ¨æœ€åæœ‰è¿™æ ·ä¸€è¡Œä»£ç ï¼šnode.next = nodeï¼Œå¦‚æœè¿™æ—¶æ‰§è¡Œäº†unparkSuccessoræ–¹æ³•ï¼Œå¹¶ä¸”å‘åéå†çš„è¯ï¼Œå°±æˆäº†æ­»å¾ªç¯äº†ï¼Œæ‰€ä»¥è¿™æ—¶åªæœ‰prevæ˜¯ç¨³å®šçš„
                s = t;
    }
//å†…éƒ¨é¦–å…ˆä¼šå‘ç”Ÿçš„åŠ¨ä½œæ˜¯è·å–headèŠ‚ç‚¹çš„nextèŠ‚ç‚¹ï¼Œå¦‚æœè·å–åˆ°çš„èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥é€šè¿‡ï¼šâ€œLockSupport.unpark()â€æ–¹æ³•æ¥é‡Šæ”¾å¯¹åº”çš„è¢«æŒ‚èµ·çš„çº¿ç¨‹ï¼Œè¿™æ ·ä¸€æ¥å°†ä¼šæœ‰ä¸€ä¸ªèŠ‚ç‚¹å”¤é†’åç»§ç»­è¿›å…¥å¾ªç¯è¿›ä¸€æ­¥å°è¯•tryAcquire()æ–¹æ³•æ¥è·å–é”
    if (s != null)
        LockSupport.unpark(s.thread); //é‡Šæ”¾è®¸å¯
}
```

## æ€»ç»“

é€šè¿‡è¿™ç¯‡æ–‡ç« åŸºæœ¬å°†AQSé˜Ÿåˆ—çš„å®ç°è¿‡ç¨‹åšäº†æ¯”è¾ƒæ¸…æ™°çš„åˆ†æï¼Œä¸»è¦æ˜¯åŸºäºéå…¬å¹³é”çš„ç‹¬å é”å®ç°ã€‚åœ¨è·å¾—åŒæ­¥é”æ—¶ï¼ŒåŒæ­¥å™¨ç»´æŠ¤ä¸€ä¸ªåŒæ­¥é˜Ÿåˆ—ï¼Œè·å–çŠ¶æ€å¤±è´¥çš„çº¿ç¨‹éƒ½ä¼šè¢«åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­å¹¶åœ¨é˜Ÿåˆ—ä¸­è¿›è¡Œè‡ªæ—‹ï¼›ç§»å‡ºé˜Ÿåˆ—ï¼ˆæˆ–åœæ­¢è‡ªæ—‹ï¼‰çš„æ¡ä»¶æ˜¯å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ä¸”æˆåŠŸè·å–äº†åŒæ­¥çŠ¶æ€ã€‚åœ¨é‡Šæ”¾åŒæ­¥çŠ¶æ€æ—¶ï¼ŒåŒæ­¥å™¨è°ƒç”¨tryRelease(int arg)æ–¹æ³•é‡Šæ”¾åŒæ­¥çŠ¶æ€ï¼Œç„¶åå”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚



## å‚è€ƒèµ„æ–™

- [æ·±å…¥åˆ†æAQSå®ç°åŸç†](https://segmentfault.com/a/1190000017372067)
- [ã€ä¸€çŸ¥åŠè§£ã€‘AQS ](https://www.cnblogs.com/hitechr/p/16474402.html)