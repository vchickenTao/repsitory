**<span style="font-size: 35px;">ğŸ™ Javaå¹¶å‘ å¹¶å‘ç†è®ºåŸºç¡€</span>**

---

### ä¸ºä»€ä¹ˆéœ€è¦å¤šçº¿ç¨‹

ä¼—æ‰€å‘¨çŸ¥ï¼Œ`CPU`ã€`å†…å­˜`ã€`I/O` è®¾å¤‡çš„é€Ÿåº¦æ˜¯æœ‰æå¤§å·®å¼‚çš„ï¼Œä¸ºäº†åˆç†åˆ©ç”¨ CPU çš„é«˜æ€§èƒ½ï¼Œå¹³è¡¡è¿™ä¸‰è€…çš„é€Ÿåº¦å·®å¼‚ï¼Œ`è®¡ç®—æœºä½“ç³»ç»“æ„`ã€`æ“ä½œç³»ç»Ÿ`ã€`ç¼–è¯‘ç¨‹åº`éƒ½åšå‡ºäº†è´¡çŒ®ï¼Œä¸»è¦ä½“ç°ä¸º:

- CPU å¢åŠ äº†ç¼“å­˜ï¼Œä»¥å‡è¡¡ä¸å†…å­˜çš„é€Ÿåº¦å·®å¼‚ï¼›å¯¼è‡´ `å¯è§æ€§`é—®é¢˜
- æ“ä½œç³»ç»Ÿå¢åŠ äº†è¿›ç¨‹ã€çº¿ç¨‹ï¼Œä»¥åˆ†æ—¶å¤ç”¨ CPUï¼Œè¿›è€Œå‡è¡¡ CPU ä¸ I/O è®¾å¤‡çš„é€Ÿåº¦å·®å¼‚ï¼›å¯¼è‡´ `åŸå­æ€§`é—®é¢˜
- ç¼–è¯‘ç¨‹åºä¼˜åŒ–æŒ‡ä»¤æ‰§è¡Œæ¬¡åºï¼Œä½¿å¾—ç¼“å­˜èƒ½å¤Ÿå¾—åˆ°æ›´åŠ åˆç†åœ°åˆ©ç”¨ã€‚å¯¼è‡´ `æœ‰åºæ€§`é—®é¢˜



### çº¿ç¨‹ä¸å®‰å…¨ç¤ºä¾‹

å¦‚æœå¤šä¸ªçº¿ç¨‹å¯¹åŒä¸€ä¸ªå…±äº«æ•°æ®è¿›è¡Œè®¿é—®è€Œä¸é‡‡å–åŒæ­¥æ“ä½œçš„è¯ï¼Œé‚£ä¹ˆæ“ä½œçš„ç»“æœæ˜¯ä¸ä¸€è‡´çš„ã€‚

ä»¥ä¸‹ä»£ç æ¼”ç¤ºäº† 1000 ä¸ªçº¿ç¨‹åŒæ—¶å¯¹ cnt æ‰§è¡Œè‡ªå¢æ“ä½œï¼Œæ“ä½œç»“æŸä¹‹åå®ƒçš„å€¼æœ‰å¯èƒ½å°äº 1000ã€‚

```java
/**
 * @Description ThreadUnsafeExample
 * @Author vchicken
 * @Date 2022/9/2 15:48
 */
public class ThreadUnsafeExample {

    private int cnt = 0;

    public void add() {
        cnt++;
    }

    public int get() {
        return cnt;
    }

    public static void main(String[] args) throws InterruptedException {
        final int threadSize = 1000;
        ThreadUnsafeExample example = new ThreadUnsafeExample();
        final CountDownLatch countDownLatch = new CountDownLatch(threadSize);
        ExecutorService executorService = Executors.newCachedThreadPool();
        for (int i = 0; i < threadSize; i++) {
            executorService.execute(() -> {
                example.add();
                countDownLatch.countDown();
            });
        }
        countDownLatch.await();
        executorService.shutdown();
        System.out.println(example.get());
    }
}
```

```html
989 // ç»“æœæ€»æ˜¯å°äº1000
```



### å¹¶å‘å‡ºç°é—®é¢˜çš„æ ¹æº: å¹¶å‘ä¸‰è¦ç´ 

ä¸Šè¿°ä»£ç è¾“å‡ºä¸ºä»€ä¹ˆä¸æ˜¯1000? å¹¶å‘å‡ºç°é—®é¢˜çš„æ ¹æºæ˜¯ä»€ä¹ˆ?

#### å¯è§æ€§: CPUç¼“å­˜å¼•èµ·

å¯è§æ€§ï¼šä¸€ä¸ªçº¿ç¨‹å¯¹å…±äº«å˜é‡çš„ä¿®æ”¹ï¼Œå¦å¤–ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿç«‹åˆ»çœ‹åˆ°ã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
//çº¿ç¨‹1æ‰§è¡Œçš„ä»£ç 
int i = 0;
i = 10;
 
//çº¿ç¨‹2æ‰§è¡Œçš„ä»£ç 
j = i; 
```

å‡è‹¥æ‰§è¡Œçº¿ç¨‹1çš„æ˜¯CPU1ï¼Œæ‰§è¡Œçº¿ç¨‹2çš„æ˜¯CPU2ã€‚ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œå½“çº¿ç¨‹1æ‰§è¡Œ i =10è¿™å¥æ—¶ï¼Œä¼šå…ˆæŠŠiçš„åˆå§‹å€¼åŠ è½½åˆ°CPU1çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œç„¶åèµ‹å€¼ä¸º10ï¼Œé‚£ä¹ˆåœ¨CPU1çš„é«˜é€Ÿç¼“å­˜å½“ä¸­içš„å€¼å˜ä¸º10äº†ï¼Œå´æ²¡æœ‰ç«‹å³å†™å…¥åˆ°ä¸»å­˜å½“ä¸­ã€‚

æ­¤æ—¶çº¿ç¨‹2æ‰§è¡Œ j = iï¼Œå®ƒä¼šå…ˆå»ä¸»å­˜è¯»å–içš„å€¼å¹¶åŠ è½½åˆ°CPU2çš„ç¼“å­˜å½“ä¸­ï¼Œæ³¨æ„æ­¤æ—¶å†…å­˜å½“ä¸­içš„å€¼è¿˜æ˜¯0ï¼Œé‚£ä¹ˆå°±ä¼šä½¿å¾—jçš„å€¼ä¸º0ï¼Œè€Œä¸æ˜¯10.

è¿™å°±æ˜¯å¯è§æ€§é—®é¢˜ï¼Œçº¿ç¨‹1å¯¹å˜é‡iä¿®æ”¹äº†ä¹‹åï¼Œçº¿ç¨‹2æ²¡æœ‰ç«‹å³çœ‹åˆ°çº¿ç¨‹1ä¿®æ”¹çš„å€¼ã€‚

#### åŸå­æ€§: åˆ†æ—¶å¤ç”¨å¼•èµ·

åŸå­æ€§ï¼šå³ä¸€ä¸ªæ“ä½œæˆ–è€…å¤šä¸ªæ“ä½œ è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¹¶ä¸”æ‰§è¡Œçš„è¿‡ç¨‹ä¸ä¼šè¢«ä»»ä½•å› ç´ æ‰“æ–­ï¼Œè¦ä¹ˆå°±éƒ½ä¸æ‰§è¡Œã€‚

ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
int i = 1;

// çº¿ç¨‹1æ‰§è¡Œ
i += 1;

// çº¿ç¨‹2æ‰§è¡Œ
i += 1;
```

è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼š`i += 1`éœ€è¦ä¸‰æ¡ CPU æŒ‡ä»¤

1. å°†å˜é‡ i ä»å†…å­˜è¯»å–åˆ° CPUå¯„å­˜å™¨ï¼›
2. åœ¨CPUå¯„å­˜å™¨ä¸­æ‰§è¡Œ i + 1 æ“ä½œï¼›
3. å°†æœ€åçš„ç»“æœiå†™å…¥å†…å­˜ï¼ˆç¼“å­˜æœºåˆ¶å¯¼è‡´å¯èƒ½å†™å…¥çš„æ˜¯ CPU ç¼“å­˜è€Œä¸æ˜¯å†…å­˜ï¼‰ã€‚

ç”±äºCPUåˆ†æ—¶å¤ç”¨ï¼ˆçº¿ç¨‹åˆ‡æ¢ï¼‰çš„å­˜åœ¨ï¼Œçº¿ç¨‹1æ‰§è¡Œäº†ç¬¬ä¸€æ¡æŒ‡ä»¤åï¼Œå°±åˆ‡æ¢åˆ°çº¿ç¨‹2æ‰§è¡Œï¼Œå‡å¦‚çº¿ç¨‹2æ‰§è¡Œäº†è¿™ä¸‰æ¡æŒ‡ä»¤åï¼Œå†åˆ‡æ¢ä¼šçº¿ç¨‹1æ‰§è¡Œåç»­ä¸¤æ¡æŒ‡ä»¤ï¼Œå°†é€ æˆæœ€åå†™åˆ°å†…å­˜ä¸­çš„iå€¼æ˜¯2è€Œä¸æ˜¯3ã€‚

#### æœ‰åºæ€§: é‡æ’åºå¼•èµ·

æœ‰åºæ€§ï¼šå³ç¨‹åºæ‰§è¡Œçš„é¡ºåºæŒ‰ç…§ä»£ç çš„å…ˆåé¡ºåºæ‰§è¡Œã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œçœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š

```java
int i = 0;              
boolean flag = false;
i = 1;                //è¯­å¥1  
flag = true;          //è¯­å¥2
```

ä¸Šé¢ä»£ç å®šä¹‰äº†ä¸€ä¸ªintå‹å˜é‡ï¼Œå®šä¹‰äº†ä¸€ä¸ªbooleanç±»å‹å˜é‡ï¼Œç„¶ååˆ†åˆ«å¯¹ä¸¤ä¸ªå˜é‡è¿›è¡Œèµ‹å€¼æ“ä½œã€‚ä»ä»£ç é¡ºåºä¸Šçœ‹ï¼Œè¯­å¥1æ˜¯åœ¨è¯­å¥2å‰é¢çš„ï¼Œé‚£ä¹ˆJVMåœ¨çœŸæ­£æ‰§è¡Œè¿™æ®µä»£ç çš„æ—¶å€™ä¼šä¿è¯è¯­å¥1ä¸€å®šä¼šåœ¨è¯­å¥2å‰é¢æ‰§è¡Œå—? ä¸ä¸€å®šï¼Œä¸ºä»€ä¹ˆå‘¢? è¿™é‡Œå¯èƒ½ä¼šå‘ç”ŸæŒ‡ä»¤é‡æ’åºï¼ˆInstruction Reorderï¼‰ã€‚

åœ¨æ‰§è¡Œç¨‹åºæ—¶ä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¸¸å¸¸ä¼šå¯¹æŒ‡ä»¤åšé‡æ’åºã€‚é‡æ’åºåˆ†ä¸‰ç§ç±»å‹ï¼š

- ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’åºã€‚ç¼–è¯‘å™¨åœ¨ä¸æ”¹å˜å•çº¿ç¨‹ç¨‹åºè¯­ä¹‰çš„å‰æä¸‹ï¼Œå¯ä»¥é‡æ–°å®‰æ’è¯­å¥çš„æ‰§è¡Œé¡ºåºã€‚
- æŒ‡ä»¤çº§å¹¶è¡Œçš„é‡æ’åºã€‚ç°ä»£å¤„ç†å™¨é‡‡ç”¨äº†æŒ‡ä»¤çº§å¹¶è¡ŒæŠ€æœ¯ï¼ˆInstruction-Level Parallelismï¼Œ ILPï¼‰æ¥å°†å¤šæ¡æŒ‡ä»¤é‡å æ‰§è¡Œã€‚å¦‚æœä¸å­˜åœ¨æ•°æ®ä¾èµ–æ€§ï¼Œå¤„ç†å™¨å¯ä»¥æ”¹å˜è¯­å¥å¯¹åº”æœºå™¨æŒ‡ä»¤çš„æ‰§è¡Œé¡ºåºã€‚
- å†…å­˜ç³»ç»Ÿçš„é‡æ’åºã€‚ç”±äºå¤„ç†å™¨ä½¿ç”¨ç¼“å­˜å’Œè¯» / å†™ç¼“å†²åŒºï¼Œè¿™ä½¿å¾—åŠ è½½å’Œå­˜å‚¨æ“ä½œçœ‹ä¸Šå»å¯èƒ½æ˜¯åœ¨ä¹±åºæ‰§è¡Œã€‚

ä» java æºä»£ç åˆ°æœ€ç»ˆå®é™…æ‰§è¡Œçš„æŒ‡ä»¤åºåˆ—ï¼Œä¼šåˆ†åˆ«ç»å†ä¸‹é¢ä¸‰ç§é‡æ’åºï¼š

![æŒ‡ä»¤é‡æ’åº](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/1b2cd34f-a3c7-4901-a713-f657b14870ab.png)


ä¸Šè¿°çš„ 1 å±äº**ç¼–è¯‘å™¨é‡æ’åº**ï¼Œ2 å’Œ 3 å±äº**å¤„ç†å™¨é‡æ’åº**ã€‚è¿™äº›é‡æ’åºéƒ½å¯èƒ½ä¼šå¯¼è‡´å¤šçº¿ç¨‹ç¨‹åºå‡ºç°å†…å­˜å¯è§æ€§é—®é¢˜ã€‚

- å¯¹äºç¼–è¯‘å™¨é‡æ’åºï¼ŒJMM çš„ç¼–è¯‘å™¨é‡æ’åºè§„åˆ™ä¼šç¦æ­¢ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„ç¼–è¯‘å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚
- å¯¹äºå¤„ç†å™¨é‡æ’åºï¼ŒJMM çš„å¤„ç†å™¨é‡æ’åºè§„åˆ™ä¼šè¦æ±‚ java ç¼–è¯‘å™¨åœ¨ç”ŸæˆæŒ‡ä»¤åºåˆ—æ—¶ï¼Œæ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœï¼ˆmemory barriersï¼Œintel ç§°ä¹‹ä¸º memory fenceï¼‰æŒ‡ä»¤ï¼Œé€šè¿‡å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºï¼ˆä¸æ˜¯æ‰€æœ‰çš„å¤„ç†å™¨é‡æ’åºéƒ½è¦ç¦æ­¢ï¼‰ã€‚

å…·ä½“å¯ä»¥å‚çœ‹ï¼š[Java å†…å­˜æ¨¡å‹è¯¦è§£](java/JVM/Javaå†…å­˜æ¨¡å‹è¯¦è§£?id=é‡æ’åº-1)çš„é‡æ’åºç« èŠ‚ã€‚

### JAVAæ˜¯æ€ä¹ˆè§£å†³å¹¶å‘é—®é¢˜çš„: JMM(Javaå†…å­˜æ¨¡å‹)

Java å†…å­˜æ¨¡å‹æ˜¯ä¸ªå¾ˆå¤æ‚çš„è§„èŒƒï¼Œå¼ºçƒˆæ¨èä½ çœ‹åç»­ï¼ˆåº”è¯¥æ˜¯ç½‘ä¸Šèƒ½æ‰¾åˆ°æœ€å¥½çš„ææ–™ä¹‹ä¸€äº†ï¼‰ï¼š[Java å†…å­˜æ¨¡å‹è¯¦è§£]()ã€‚

**ç†è§£çš„ç¬¬ä¸€ä¸ªç»´åº¦ï¼šæ ¸å¿ƒçŸ¥è¯†ç‚¹**

JMMæœ¬è´¨ä¸Šå¯ä»¥ç†è§£ä¸ºï¼ŒJava å†…å­˜æ¨¡å‹è§„èŒƒäº† JVM å¦‚ä½•æä¾›æŒ‰éœ€ç¦ç”¨ç¼“å­˜å’Œç¼–è¯‘ä¼˜åŒ–çš„æ–¹æ³•ã€‚å…·ä½“æ¥è¯´ï¼Œè¿™äº›æ–¹æ³•åŒ…æ‹¬ï¼š

- volatileã€synchronized å’Œ final ä¸‰ä¸ªå…³é”®å­—
- Happens-Before è§„åˆ™

**ç†è§£çš„ç¬¬äºŒä¸ªç»´åº¦ï¼šå¯è§æ€§ï¼Œæœ‰åºæ€§ï¼ŒåŸå­æ€§**

- åŸå­æ€§

åœ¨Javaä¸­ï¼Œå¯¹åŸºæœ¬æ•°æ®ç±»å‹çš„å˜é‡çš„è¯»å–å’Œèµ‹å€¼æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼Œå³è¿™äº›æ“ä½œæ˜¯ä¸å¯è¢«ä¸­æ–­çš„ï¼Œè¦ä¹ˆæ‰§è¡Œï¼Œè¦ä¹ˆä¸æ‰§è¡Œã€‚ è¯·åˆ†æä»¥ä¸‹å“ªäº›æ“ä½œæ˜¯åŸå­æ€§æ“ä½œï¼š

```java
x = 10;        //è¯­å¥1: ç›´æ¥å°†æ•°å€¼10èµ‹å€¼ç»™xï¼Œä¹Ÿå°±æ˜¯è¯´çº¿ç¨‹æ‰§è¡Œè¿™ä¸ªè¯­å¥çš„ä¼šç›´æ¥å°†æ•°å€¼10å†™å…¥åˆ°å·¥ä½œå†…å­˜ä¸­
y = x;         //è¯­å¥2: åŒ…å«2ä¸ªæ“ä½œï¼Œå®ƒå…ˆè¦å»è¯»å–xçš„å€¼ï¼Œå†å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ï¼Œè™½ç„¶è¯»å–xçš„å€¼ä»¥åŠ å°†xçš„å€¼å†™å…¥å·¥ä½œå†…å­˜ è¿™2ä¸ªæ“ä½œéƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä½†æ˜¯åˆèµ·æ¥å°±ä¸æ˜¯åŸå­æ€§æ“ä½œäº†ã€‚
x++;           //è¯­å¥3ï¼š x++åŒ…æ‹¬3ä¸ªæ“ä½œï¼šè¯»å–xçš„å€¼ï¼Œè¿›è¡ŒåŠ 1æ“ä½œï¼Œå†™å…¥æ–°çš„å€¼ã€‚
x = x + 1;     //è¯­å¥4ï¼š åŒè¯­å¥3
```

ä¸Šé¢4ä¸ªè¯­å¥åªæœ‰è¯­å¥1çš„æ“ä½œå…·å¤‡åŸå­æ€§ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œåªæœ‰ç®€å•çš„è¯»å–ã€èµ‹å€¼ï¼ˆè€Œä¸”å¿…é¡»æ˜¯å°†æ•°å­—èµ‹å€¼ç»™æŸä¸ªå˜é‡ï¼Œå˜é‡ä¹‹é—´çš„ç›¸äº’èµ‹å€¼ä¸æ˜¯åŸå­æ“ä½œï¼‰æ‰æ˜¯åŸå­æ“ä½œã€‚

> ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼ŒJavaå†…å­˜æ¨¡å‹åªä¿è¯äº†åŸºæœ¬è¯»å–å’Œèµ‹å€¼æ˜¯åŸå­æ€§æ“ä½œï¼Œå¦‚æœè¦å®ç°æ›´å¤§èŒƒå›´æ“ä½œçš„åŸå­æ€§ï¼Œå¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥å®ç°ã€‚ç”±äºsynchronizedå’ŒLockèƒ½å¤Ÿä¿è¯ä»»ä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œè¯¥ä»£ç å—ï¼Œé‚£ä¹ˆè‡ªç„¶å°±ä¸å­˜åœ¨åŸå­æ€§é—®é¢˜äº†ï¼Œä»è€Œä¿è¯äº†åŸå­æ€§ã€‚

- å¯è§æ€§

Javaæä¾›äº†volatileå…³é”®å­—æ¥ä¿è¯å¯è§æ€§ã€‚

å½“ä¸€ä¸ªå…±äº«å˜é‡è¢«volatileä¿®é¥°æ—¶ï¼Œå®ƒä¼šä¿è¯ä¿®æ”¹çš„å€¼ä¼šç«‹å³è¢«æ›´æ–°åˆ°ä¸»å­˜ï¼Œå½“æœ‰å…¶ä»–çº¿ç¨‹éœ€è¦è¯»å–æ—¶ï¼Œå®ƒä¼šå»å†…å­˜ä¸­è¯»å–æ–°å€¼ã€‚

è€Œæ™®é€šçš„å…±äº«å˜é‡ä¸èƒ½ä¿è¯å¯è§æ€§ï¼Œå› ä¸ºæ™®é€šå…±äº«å˜é‡è¢«ä¿®æ”¹ä¹‹åï¼Œä»€ä¹ˆæ—¶å€™è¢«å†™å…¥ä¸»å­˜æ˜¯ä¸ç¡®å®šçš„ï¼Œå½“å…¶ä»–çº¿ç¨‹å»è¯»å–æ—¶ï¼Œæ­¤æ—¶å†…å­˜ä¸­å¯èƒ½è¿˜æ˜¯åŸæ¥çš„æ—§å€¼ï¼Œå› æ­¤æ— æ³•ä¿è¯å¯è§æ€§ã€‚

> å¦å¤–ï¼Œé€šè¿‡synchronizedå’ŒLockä¹Ÿèƒ½å¤Ÿä¿è¯å¯è§æ€§ï¼Œsynchronizedå’ŒLockèƒ½ä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹è·å–é”ç„¶åæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œå¹¶ä¸”åœ¨é‡Šæ”¾é”ä¹‹å‰ä¼šå°†å¯¹å˜é‡çš„ä¿®æ”¹åˆ·æ–°åˆ°ä¸»å­˜å½“ä¸­ã€‚å› æ­¤å¯ä»¥ä¿è¯å¯è§æ€§ã€‚

- æœ‰åºæ€§

åœ¨Javaé‡Œé¢ï¼Œå¯ä»¥é€šè¿‡volatileå…³é”®å­—æ¥ä¿è¯ä¸€å®šçš„â€œæœ‰åºæ€§â€ï¼ˆå…·ä½“åŸç†åœ¨ä¸‹ä¸€èŠ‚è®²è¿°ï¼‰ã€‚å¦å¤–å¯ä»¥é€šè¿‡synchronizedå’ŒLockæ¥ä¿è¯æœ‰åºæ€§ï¼Œå¾ˆæ˜¾ç„¶ï¼Œsynchronizedå’ŒLockä¿è¯æ¯ä¸ªæ—¶åˆ»æ˜¯æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œç›¸å½“äºæ˜¯è®©çº¿ç¨‹é¡ºåºæ‰§è¡ŒåŒæ­¥ä»£ç ï¼Œè‡ªç„¶å°±ä¿è¯äº†æœ‰åºæ€§ã€‚å½“ç„¶JMMæ˜¯é€šè¿‡Happens-Before è§„åˆ™æ¥ä¿è¯æœ‰åºæ€§çš„ã€‚

å…³é”®å­—: volatileã€synchronized å’Œ final

ä»¥ä¸‹ä¸‰ç¯‡æ–‡ç« è¯¦ç»†åˆ†æäº†è¿™ä¸‰ä¸ªå…³é”®å­—ï¼š

- [å…³é”®å­—: synchronizedè¯¦è§£](java/JUC/synchronizedè¯¦è§£)
- [å…³é”®å­—: volatileè¯¦è§£](java/JUC/volatileè¯¦è§£)
- [å…³é”®å­—: finalè¯¦è§£](java/JUC/finalè¯¦è§£)

Happens-Before è§„åˆ™

ä¸Šé¢æåˆ°äº†å¯ä»¥ç”¨ volatile å’Œ synchronized æ¥ä¿è¯æœ‰åºæ€§ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒJVM è¿˜è§„å®šäº†å…ˆè¡Œå‘ç”ŸåŸåˆ™ï¼Œè®©ä¸€ä¸ªæ“ä½œæ— éœ€æ§åˆ¶å°±èƒ½å…ˆäºå¦ä¸€ä¸ªæ“ä½œå®Œæˆã€‚

1. å•ä¸€çº¿ç¨‹åŸåˆ™

> Single Thread rule

åœ¨ä¸€ä¸ªçº¿ç¨‹å†…ï¼Œåœ¨ç¨‹åºå‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢çš„æ“ä½œã€‚

![Single Thread rule](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/ef7fe59b-6690-4640-92f1-219b8a3644e3.png)

2. ç®¡ç¨‹é”å®šè§„åˆ™

> Monitor Lock Rule

ä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œã€‚

![Monitor Lock Rule](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/a980f786-0186-45de-8524-bf9b1c49384c.png)

3. volatile å˜é‡è§„åˆ™

> Volatile Variable Rule

å¯¹ä¸€ä¸ª volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»æ“ä½œã€‚

![Volatile Variable Rule](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/4181b180-ff34-48f5-907b-accacbf5b6d7.png)

4. çº¿ç¨‹å¯åŠ¨è§„åˆ™

> Thread Start Rule

Thread å¯¹è±¡çš„ start() æ–¹æ³•è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹çš„æ¯ä¸€ä¸ªåŠ¨ä½œã€‚

![image](https://pdai.tech/_images/pics/thread-start-rule.png)

5. çº¿ç¨‹åŠ å…¥è§„åˆ™

> Thread Join Rule

Thread å¯¹è±¡çš„ç»“æŸå…ˆè¡Œå‘ç”Ÿäº join() æ–¹æ³•è¿”å›ã€‚

![Thread Join Rule](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/b2da3f51-c944-4602-8f39-697ac2fe4069.png)

6. çº¿ç¨‹ä¸­æ–­è§„åˆ™

> Thread Interruption Rule

å¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿï¼Œå¯ä»¥é€šè¿‡ interrupted() æ–¹æ³•æ£€æµ‹åˆ°æ˜¯å¦æœ‰ä¸­æ–­å‘ç”Ÿã€‚

7. å¯¹è±¡ç»ˆç»“è§„åˆ™

> Finalizer Rule

ä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆ(æ„é€ å‡½æ•°æ‰§è¡Œç»“æŸ)å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹ã€‚

8. ä¼ é€’æ€§

> Transitivity

å¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œæ“ä½œ B å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œé‚£ä¹ˆæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cã€‚

### çº¿ç¨‹å®‰å…¨: ä¸æ˜¯ä¸€ä¸ªéçœŸå³å‡çš„å‘½é¢˜

ä¸€ä¸ªç±»åœ¨å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å®‰å…¨è°ƒç”¨æ—¶å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

çº¿ç¨‹å®‰å…¨ä¸æ˜¯ä¸€ä¸ªéçœŸå³å‡çš„å‘½é¢˜ï¼Œå¯ä»¥å°†å…±äº«æ•°æ®æŒ‰ç…§å®‰å…¨ç¨‹åº¦çš„å¼ºå¼±é¡ºåºåˆ†æˆä»¥ä¸‹äº”ç±»: ä¸å¯å˜ã€ç»å¯¹çº¿ç¨‹å®‰å…¨ã€ç›¸å¯¹çº¿ç¨‹å®‰å…¨ã€çº¿ç¨‹å…¼å®¹å’Œçº¿ç¨‹å¯¹ç«‹ã€‚

#### 1. ä¸å¯å˜

ä¸å¯å˜(Immutable)çš„å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸éœ€è¦å†é‡‡å–ä»»ä½•çš„çº¿ç¨‹å®‰å…¨ä¿éšœæªæ–½ã€‚åªè¦ä¸€ä¸ªä¸å¯å˜çš„å¯¹è±¡è¢«æ­£ç¡®åœ°æ„å»ºå‡ºæ¥ï¼Œæ°¸è¿œä¹Ÿä¸ä¼šçœ‹åˆ°å®ƒåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹ä¸­å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚

å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ï¼Œåº”å½“å°½é‡ä½¿å¯¹è±¡æˆä¸ºä¸å¯å˜ï¼Œæ¥æ»¡è¶³çº¿ç¨‹å®‰å…¨ã€‚

ä¸å¯å˜çš„ç±»å‹:

- final å…³é”®å­—ä¿®é¥°çš„åŸºæœ¬æ•°æ®ç±»å‹
- String
- æšä¸¾ç±»å‹
- Number éƒ¨åˆ†å­ç±»ï¼Œå¦‚ Long å’Œ Double ç­‰æ•°å€¼åŒ…è£…ç±»å‹ï¼ŒBigInteger å’Œ BigDecimal ç­‰å¤§æ•°æ®ç±»å‹ã€‚ä½†åŒä¸º Number çš„åŸå­ç±» AtomicInteger å’Œ AtomicLong åˆ™æ˜¯å¯å˜çš„ã€‚

å¯¹äºé›†åˆç±»å‹ï¼Œå¯ä»¥ä½¿ç”¨ Collections.unmodifiableXXX() æ–¹æ³•æ¥è·å–ä¸€ä¸ªä¸å¯å˜çš„é›†åˆã€‚

```java
public class ImmutableExample {
    public static void main(String[] args) {
        Map<String, Integer> map = new HashMap<>();
        Map<String, Integer> unmodifiableMap = Collections.unmodifiableMap(map);
        unmodifiableMap.put("a", 1);
    }
} 
```

```html
Exception in thread "main" java.lang.UnsupportedOperationException
    at java.util.Collections$UnmodifiableMap.put(Collections.java:1457)
    at ImmutableExample.main(ImmutableExample.java:9)
```

Collections.unmodifiableXXX() å…ˆå¯¹åŸå§‹çš„é›†åˆè¿›è¡Œæ‹·è´ï¼Œéœ€è¦å¯¹é›†åˆè¿›è¡Œä¿®æ”¹çš„æ–¹æ³•éƒ½ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚

```java
public V put(K key, V value) {
    throw new UnsupportedOperationException();
}
```

#### 2. ç»å¯¹çº¿ç¨‹å®‰å…¨

ä¸ç®¡è¿è¡Œæ—¶ç¯å¢ƒå¦‚ä½•ï¼Œè°ƒç”¨è€…éƒ½ä¸éœ€è¦ä»»ä½•é¢å¤–çš„åŒæ­¥æªæ–½ã€‚

#### 3. ç›¸å¯¹çº¿ç¨‹å®‰å…¨

ç›¸å¯¹çº¿ç¨‹å®‰å…¨éœ€è¦ä¿è¯å¯¹è¿™ä¸ªå¯¹è±¡å•ç‹¬çš„æ“ä½œæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œåœ¨è°ƒç”¨çš„æ—¶å€™ä¸éœ€è¦åšé¢å¤–çš„ä¿éšœæªæ–½ã€‚ä½†æ˜¯å¯¹äºä¸€äº›ç‰¹å®šé¡ºåºçš„è¿ç»­è°ƒç”¨ï¼Œå°±å¯èƒ½éœ€è¦åœ¨è°ƒç”¨ç«¯ä½¿ç”¨é¢å¤–çš„åŒæ­¥æ‰‹æ®µæ¥ä¿è¯è°ƒç”¨çš„æ­£ç¡®æ€§ã€‚

åœ¨ Java è¯­è¨€ä¸­ï¼Œå¤§éƒ¨åˆ†çš„çº¿ç¨‹å®‰å…¨ç±»éƒ½å±äºè¿™ç§ç±»å‹ï¼Œä¾‹å¦‚ Vectorã€HashTableã€Collections çš„ synchronizedCollection() æ–¹æ³•åŒ…è£…çš„é›†åˆç­‰ã€‚

å¯¹äºä¸‹é¢çš„ä»£ç ï¼Œå¦‚æœåˆ é™¤å…ƒç´ çš„çº¿ç¨‹åˆ é™¤äº† Vector çš„ä¸€ä¸ªå…ƒç´ ï¼Œè€Œè·å–å…ƒç´ çš„çº¿ç¨‹è¯•å›¾è®¿é—®ä¸€ä¸ªå·²ç»è¢«åˆ é™¤çš„å…ƒç´ ï¼Œé‚£ä¹ˆå°±ä¼šæŠ›å‡º ArrayIndexOutOfBoundsExceptionã€‚

```java
public class VectorUnsafeExample {
    private static Vector<Integer> vector = new Vector<>();

    public static void main(String[] args) {
        while (true) {
            for (int i = 0; i < 100; i++) {
                vector.add(i);
            }
            ExecutorService executorService = Executors.newCachedThreadPool();
            executorService.execute(() -> {
                for (int i = 0; i < vector.size(); i++) {
                    vector.remove(i);
                }
            });
            executorService.execute(() -> {
                for (int i = 0; i < vector.size(); i++) {
                    vector.get(i);
                }
            });
            executorService.shutdown();
        }
    }
} 
```

```html
Exception in thread "Thread-159738" java.lang.ArrayIndexOutOfBoundsException: Array index out of range: 3
    at java.util.Vector.remove(Vector.java:831)
    at VectorUnsafeExample.lambda$main$0(VectorUnsafeExample.java:14)
    at VectorUnsafeExample$$Lambda$1/713338599.run(Unknown Source)
    at java.lang.Thread.run(Thread.java:745)
```

å¦‚æœè¦ä¿è¯ä¸Šé¢çš„ä»£ç èƒ½æ­£ç¡®æ‰§è¡Œä¸‹å»ï¼Œå°±éœ€è¦å¯¹åˆ é™¤å…ƒç´ å’Œè·å–å…ƒç´ çš„ä»£ç è¿›è¡ŒåŒæ­¥ã€‚

```java
executorService.execute(() -> {
    synchronized (vector) {
        for (int i = 0; i < vector.size(); i++) {
            vector.remove(i);
        }
    }
});
executorService.execute(() -> {
    synchronized (vector) {
        for (int i = 0; i < vector.size(); i++) {
            vector.get(i);
        }
    }
}); 
```

#### 4. çº¿ç¨‹å…¼å®¹

çº¿ç¨‹å…¼å®¹æ˜¯æŒ‡å¯¹è±¡æœ¬èº«å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡åœ¨è°ƒç”¨ç«¯æ­£ç¡®åœ°ä½¿ç”¨åŒæ­¥æ‰‹æ®µæ¥ä¿è¯å¯¹è±¡åœ¨å¹¶å‘ç¯å¢ƒä¸­å¯ä»¥å®‰å…¨åœ°ä½¿ç”¨ï¼Œæˆ‘ä»¬å¹³å¸¸è¯´ä¸€ä¸ªç±»ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œç»å¤§å¤šæ•°æ—¶å€™æŒ‡çš„æ˜¯è¿™ä¸€ç§æƒ…å†µã€‚Java API ä¸­å¤§éƒ¨åˆ†çš„ç±»éƒ½æ˜¯å±äºçº¿ç¨‹å…¼å®¹çš„ï¼Œå¦‚ä¸å‰é¢çš„ Vector å’Œ HashTable ç›¸å¯¹åº”çš„é›†åˆç±» ArrayList å’Œ HashMap ç­‰ã€‚

#### 5. çº¿ç¨‹å¯¹ç«‹

çº¿ç¨‹å¯¹ç«‹æ˜¯æŒ‡æ— è®ºè°ƒç”¨ç«¯æ˜¯å¦é‡‡å–äº†åŒæ­¥æªæ–½ï¼Œéƒ½æ— æ³•åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­å¹¶å‘ä½¿ç”¨çš„ä»£ç ã€‚ç”±äº Java è¯­è¨€å¤©ç”Ÿå°±å…·å¤‡å¤šçº¿ç¨‹ç‰¹æ€§ï¼Œçº¿ç¨‹å¯¹ç«‹è¿™ç§æ’æ–¥å¤šçº¿ç¨‹çš„ä»£ç æ˜¯å¾ˆå°‘å‡ºç°çš„ï¼Œè€Œä¸”é€šå¸¸éƒ½æ˜¯æœ‰å®³çš„ï¼Œåº”å½“å°½é‡é¿å…ã€‚

### çº¿ç¨‹å®‰å…¨çš„å®ç°æ–¹æ³•

####  1. äº’æ–¥åŒæ­¥

synchronized å’Œ ReentrantLockã€‚

è¯¦ç»†åˆ†æè¯·çœ‹ï¼š

- [å…³é”®å­—: Synchronizedè¯¦è§£](java/JUC/synchronizedè¯¦è§£)
- [JUCé”: ReentrantLockè¯¦è§£](java/JUC/JUCé”è¯¦è§£?id=jucé”-reentrantlockè¯¦è§£)

#### 2. éé˜»å¡åŒæ­¥

äº’æ–¥åŒæ­¥æœ€ä¸»è¦çš„é—®é¢˜å°±æ˜¯çº¿ç¨‹é˜»å¡å’Œå”¤é†’æ‰€å¸¦æ¥çš„æ€§èƒ½é—®é¢˜ï¼Œå› æ­¤è¿™ç§åŒæ­¥ä¹Ÿç§°ä¸ºé˜»å¡åŒæ­¥ã€‚

äº’æ–¥åŒæ­¥å±äºä¸€ç§æ‚²è§‚çš„å¹¶å‘ç­–ç•¥ï¼Œæ€»æ˜¯è®¤ä¸ºåªè¦ä¸å»åšæ­£ç¡®çš„åŒæ­¥æªæ–½ï¼Œé‚£å°±è‚¯å®šä¼šå‡ºç°é—®é¢˜ã€‚æ— è®ºå…±äº«æ•°æ®æ˜¯å¦çœŸçš„ä¼šå‡ºç°ç«äº‰ï¼Œå®ƒéƒ½è¦è¿›è¡ŒåŠ é”(è¿™é‡Œè®¨è®ºçš„æ˜¯æ¦‚å¿µæ¨¡å‹ï¼Œå®é™…ä¸Šè™šæ‹Ÿæœºä¼šä¼˜åŒ–æ‰å¾ˆå¤§ä¸€éƒ¨åˆ†ä¸å¿…è¦çš„åŠ é”)ã€ç”¨æˆ·æ€æ ¸å¿ƒæ€è½¬æ¢ã€ç»´æŠ¤é”è®¡æ•°å™¨å’Œæ£€æŸ¥æ˜¯å¦æœ‰è¢«é˜»å¡çš„çº¿ç¨‹éœ€è¦å”¤é†’ç­‰æ“ä½œã€‚

**(ä¸€)CAS**

éšç€ç¡¬ä»¶æŒ‡ä»¤é›†çš„å‘å±•ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŸºäºå†²çªæ£€æµ‹çš„ä¹è§‚å¹¶å‘ç­–ç•¥: å…ˆè¿›è¡Œæ“ä½œï¼Œå¦‚æœæ²¡æœ‰å…¶å®ƒçº¿ç¨‹äº‰ç”¨å…±äº«æ•°æ®ï¼Œé‚£æ“ä½œå°±æˆåŠŸäº†ï¼Œå¦åˆ™é‡‡å–è¡¥å¿æªæ–½(ä¸æ–­åœ°é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢)ã€‚è¿™ç§ä¹è§‚çš„å¹¶å‘ç­–ç•¥çš„è®¸å¤šå®ç°éƒ½ä¸éœ€è¦å°†çº¿ç¨‹é˜»å¡ï¼Œå› æ­¤è¿™ç§åŒæ­¥æ“ä½œç§°ä¸ºéé˜»å¡åŒæ­¥ã€‚

ä¹è§‚é”éœ€è¦æ“ä½œå’Œå†²çªæ£€æµ‹è¿™ä¸¤ä¸ªæ­¥éª¤å…·å¤‡åŸå­æ€§ï¼Œè¿™é‡Œå°±ä¸èƒ½å†ä½¿ç”¨äº’æ–¥åŒæ­¥æ¥ä¿è¯äº†ï¼Œåªèƒ½é ç¡¬ä»¶æ¥å®Œæˆã€‚ç¡¬ä»¶æ”¯æŒçš„åŸå­æ€§æ“ä½œæœ€å…¸å‹çš„æ˜¯: æ¯”è¾ƒå¹¶äº¤æ¢(Compare-and-Swapï¼ŒCAS)ã€‚CAS æŒ‡ä»¤éœ€è¦æœ‰ 3 ä¸ªæ“ä½œæ•°ï¼Œåˆ†åˆ«æ˜¯å†…å­˜åœ°å€ Vã€æ—§çš„é¢„æœŸå€¼ A å’Œæ–°å€¼ Bã€‚å½“æ‰§è¡Œæ“ä½œæ—¶ï¼Œåªæœ‰å½“ V çš„å€¼ç­‰äº Aï¼Œæ‰å°† V çš„å€¼æ›´æ–°ä¸º Bã€‚

**(äºŒ)AtomicInteger**

J.U.C åŒ…é‡Œé¢çš„æ•´æ•°åŸå­ç±» AtomicIntegerï¼Œå…¶ä¸­çš„ compareAndSet() å’Œ getAndIncrement() ç­‰æ–¹æ³•éƒ½ä½¿ç”¨äº† Unsafe ç±»çš„ CAS æ“ä½œã€‚

ä»¥ä¸‹ä»£ç ä½¿ç”¨äº† AtomicInteger æ‰§è¡Œäº†è‡ªå¢çš„æ“ä½œã€‚

```java
private AtomicInteger cnt = new AtomicInteger();

public void add() {
    cnt.incrementAndGet();
}    
```

ä»¥ä¸‹ä»£ç æ˜¯ incrementAndGet() çš„æºç ï¼Œå®ƒè°ƒç”¨äº† unsafe çš„ getAndAddInt() ã€‚

```java
public final int incrementAndGet() {
    return unsafe.getAndAddInt(this, valueOffset, 1) + 1;
} 
```

ä»¥ä¸‹ä»£ç æ˜¯ getAndAddInt() æºç ï¼Œvar1 æŒ‡ç¤ºå¯¹è±¡å†…å­˜åœ°å€ï¼Œvar2 æŒ‡ç¤ºè¯¥å­—æ®µç›¸å¯¹å¯¹è±¡å†…å­˜åœ°å€çš„åç§»ï¼Œvar4 æŒ‡ç¤ºæ“ä½œéœ€è¦åŠ çš„æ•°å€¼ï¼Œè¿™é‡Œä¸º 1ã€‚é€šè¿‡ getIntVolatile(var1, var2) å¾—åˆ°æ—§çš„é¢„æœŸå€¼ï¼Œé€šè¿‡è°ƒç”¨ compareAndSwapInt() æ¥è¿›è¡Œ CAS æ¯”è¾ƒï¼Œå¦‚æœè¯¥å­—æ®µå†…å­˜åœ°å€ä¸­çš„å€¼ç­‰äº var5ï¼Œé‚£ä¹ˆå°±æ›´æ–°å†…å­˜åœ°å€ä¸º var1+var2 çš„å˜é‡ä¸º var5+var4ã€‚

å¯ä»¥çœ‹åˆ° getAndAddInt() åœ¨ä¸€ä¸ªå¾ªç¯ä¸­è¿›è¡Œï¼Œå‘ç”Ÿå†²çªçš„åšæ³•æ˜¯ä¸æ–­çš„è¿›è¡Œé‡è¯•ã€‚

```java
public final int getAndAddInt(Object var1, long var2, int var4) {
    int var5;
    do {
        var5 = this.getIntVolatile(var1, var2);
    } while(!this.compareAndSwapInt(var1, var2, var5, var5 + var4));

    return var5;
} 
```

**(ä¸‰)ABA**

å¦‚æœä¸€ä¸ªå˜é‡åˆæ¬¡è¯»å–çš„æ—¶å€™æ˜¯ A å€¼ï¼Œå®ƒçš„å€¼è¢«æ”¹æˆäº† Bï¼Œåæ¥åˆè¢«æ”¹å›ä¸º Aï¼Œé‚£ CAS æ“ä½œå°±ä¼šè¯¯è®¤ä¸ºå®ƒä»æ¥æ²¡æœ‰è¢«æ”¹å˜è¿‡ã€‚

J.U.C åŒ…æä¾›äº†ä¸€ä¸ªå¸¦æœ‰æ ‡è®°çš„åŸå­å¼•ç”¨ç±» AtomicStampedReference æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒå¯ä»¥é€šè¿‡æ§åˆ¶å˜é‡å€¼çš„ç‰ˆæœ¬æ¥ä¿è¯ CAS çš„æ­£ç¡®æ€§ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹ ABA é—®é¢˜ä¸ä¼šå½±å“ç¨‹åºå¹¶å‘çš„æ­£ç¡®æ€§ï¼Œå¦‚æœéœ€è¦è§£å†³ ABA é—®é¢˜ï¼Œæ”¹ç”¨ä¼ ç»Ÿçš„äº’æ–¥åŒæ­¥å¯èƒ½ä¼šæ¯”åŸå­ç±»æ›´é«˜æ•ˆã€‚

CAS, Unsafeå’ŒåŸå­ç±»è¯¦ç»†åˆ†æè¯·çœ‹ï¼š

- [JUCåŸå­ç±»: CAS, Unsafeå’ŒåŸå­ç±»è¯¦è§£](java/JUC/CAS,Unsafeå’ŒåŸå­ç±»è¯¦è§£)

#### 3. æ— åŒæ­¥æ–¹æ¡ˆ

è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¹¶ä¸æ˜¯ä¸€å®šå°±è¦è¿›è¡ŒåŒæ­¥ã€‚å¦‚æœä¸€ä¸ªæ–¹æ³•æœ¬æ¥å°±ä¸æ¶‰åŠå…±äº«æ•°æ®ï¼Œé‚£å®ƒè‡ªç„¶å°±æ— é¡»ä»»ä½•åŒæ­¥æªæ–½å»ä¿è¯æ­£ç¡®æ€§ã€‚

**(ä¸€)æ ˆå°é—­**

å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªæ–¹æ³•çš„å±€éƒ¨å˜é‡æ—¶ï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå› ä¸ºå±€éƒ¨å˜é‡å­˜å‚¨åœ¨è™šæ‹Ÿæœºæ ˆä¸­ï¼Œå±äºçº¿ç¨‹ç§æœ‰çš„ã€‚

```java
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

public class StackClosedExample {
    public void add100() {
        int cnt = 0;
        for (int i = 0; i < 100; i++) {
            cnt++;
        }
        System.out.println(cnt);
    }
}  
```

```java
public static void main(String[] args) {
    StackClosedExample example = new StackClosedExample();
    ExecutorService executorService = Executors.newCachedThreadPool();
    executorService.execute(() -> example.add100());
    executorService.execute(() -> example.add100());
    executorService.shutdown();
}
```

```html
100
100
```

æ›´è¯¦ç»†çš„åˆ†æè¯·çœ‹J.U.Cä¸­çº¿ç¨‹æ± ç›¸å…³å†…å®¹è¯¦è§£ï¼š

- [JUCçº¿ç¨‹æ± : FutureTaskè¯¦è§£](java/JUC/JUCçº¿ç¨‹æ± è¯¦è§£?id=jucçº¿ç¨‹æ± -futuretaskè¯¦è§£)
- [JUCçº¿ç¨‹æ± : ThreadPoolExecutorè¯¦è§£](java/JUC/JUCçº¿ç¨‹æ± è¯¦è§£?id=jucçº¿ç¨‹æ± -threadpoolexecutorè¯¦è§£)
- [JUCçº¿ç¨‹æ± : ScheduledThreadPoolè¯¦è§£](java/JUC/JUCçº¿ç¨‹æ± è¯¦è§£?id=jucçº¿ç¨‹æ± -scheduledthreadpoolexecutorè¯¦è§£)
- [JUCçº¿ç¨‹æ± : Fork/Joinæ¡†æ¶è¯¦è§£](java/JUC/JUCçº¿ç¨‹æ± è¯¦è§£?id=jucçº¿ç¨‹æ± -forkjoinæ¡†æ¶è¯¦è§£)

**(äºŒ)çº¿ç¨‹æœ¬åœ°å­˜å‚¨(Thread Local Storage)**

å¦‚æœä¸€æ®µä»£ç ä¸­æ‰€éœ€è¦çš„æ•°æ®å¿…é¡»ä¸å…¶ä»–ä»£ç å…±äº«ï¼Œé‚£å°±çœ‹çœ‹è¿™äº›å…±äº«æ•°æ®çš„ä»£ç æ˜¯å¦èƒ½ä¿è¯åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚å¦‚æœèƒ½ä¿è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠå…±äº«æ•°æ®çš„å¯è§èŒƒå›´é™åˆ¶åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¹‹å†…ï¼Œè¿™æ ·ï¼Œæ— é¡»åŒæ­¥ä¹Ÿèƒ½ä¿è¯çº¿ç¨‹ä¹‹é—´ä¸å‡ºç°æ•°æ®äº‰ç”¨çš„é—®é¢˜ã€‚

ç¬¦åˆè¿™ç§ç‰¹ç‚¹çš„åº”ç”¨å¹¶ä¸å°‘è§ï¼Œå¤§éƒ¨åˆ†ä½¿ç”¨æ¶ˆè´¹é˜Ÿåˆ—çš„æ¶æ„æ¨¡å¼(å¦‚â€œç”Ÿäº§è€…-æ¶ˆè´¹è€…â€æ¨¡å¼)éƒ½ä¼šå°†äº§å“çš„æ¶ˆè´¹è¿‡ç¨‹å°½é‡åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­æ¶ˆè´¹å®Œã€‚å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªåº”ç”¨å®ä¾‹å°±æ˜¯ç»å…¸ Web äº¤äº’æ¨¡å‹ä¸­çš„â€œä¸€ä¸ªè¯·æ±‚å¯¹åº”ä¸€ä¸ªæœåŠ¡å™¨çº¿ç¨‹â€(Thread-per-Request)çš„å¤„ç†æ–¹å¼ï¼Œè¿™ç§å¤„ç†æ–¹å¼çš„å¹¿æ³›åº”ç”¨ä½¿å¾—å¾ˆå¤š Web æœåŠ¡ç«¯åº”ç”¨éƒ½å¯ä»¥ä½¿ç”¨çº¿ç¨‹æœ¬åœ°å­˜å‚¨æ¥è§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ã€‚

å¯ä»¥ä½¿ç”¨ java.lang.ThreadLocal ç±»æ¥å®ç°çº¿ç¨‹æœ¬åœ°å­˜å‚¨åŠŸèƒ½ã€‚

å¯¹äºä»¥ä¸‹ä»£ç ï¼Œthread1 ä¸­è®¾ç½® threadLocal ä¸º 1ï¼Œè€Œ thread2 è®¾ç½® threadLocal ä¸º 2ã€‚è¿‡äº†ä¸€æ®µæ—¶é—´ä¹‹åï¼Œthread1 è¯»å– threadLocal ä¾ç„¶æ˜¯ 1ï¼Œä¸å— thread2 çš„å½±å“ã€‚

```java
public class ThreadLocalExample {
    public static void main(String[] args) {
        ThreadLocal threadLocal = new ThreadLocal();
        Thread thread1 = new Thread(() -> {
            threadLocal.set(1);
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {
                e.printStackTrace();
            }
            System.out.println(threadLocal.get());
            threadLocal.remove();
        });
        Thread thread2 = new Thread(() -> {
            threadLocal.set(2);
            threadLocal.remove();
        });
        thread1.start();
        thread2.start();
    }
}  
```

è¾“å‡ºç»“æœ

```html
1
```

ä¸ºäº†ç†è§£ ThreadLocalï¼Œå…ˆçœ‹ä»¥ä¸‹ä»£ç :

```java
public class ThreadLocalExample1 {
    public static void main(String[] args) {
        ThreadLocal threadLocal1 = new ThreadLocal();
        ThreadLocal threadLocal2 = new ThreadLocal();
        Thread thread1 = new Thread(() -> {
            threadLocal1.set(1);
            threadLocal2.set(1);
        });
        Thread thread2 = new Thread(() -> {
            threadLocal1.set(2);
            threadLocal2.set(2);
        });
        thread1.start();
        thread2.start();
    }
}  
```

å®ƒæ‰€å¯¹åº”çš„åº•å±‚ç»“æ„å›¾ä¸º:

![ThreadLocalåº•å±‚ç»“æ„å›¾](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-02/1fd4f6d2-60b2-4f1c-bcf2-3f93c1b7501a.png)

æ¯ä¸ª Thread éƒ½æœ‰ä¸€ä¸ª ThreadLocal.ThreadLocalMap å¯¹è±¡ï¼ŒThread ç±»ä¸­å°±å®šä¹‰äº† ThreadLocal.ThreadLocalMap æˆå‘˜ã€‚

```java
/* ThreadLocal values pertaining to this thread. This map is maintained
 * by the ThreadLocal class. */
ThreadLocal.ThreadLocalMap threadLocals = null;    
```

å½“è°ƒç”¨ä¸€ä¸ª ThreadLocal çš„ set(T value) æ–¹æ³•æ—¶ï¼Œå…ˆå¾—åˆ°å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åå°† ThreadLocal->value é”®å€¼å¯¹æ’å…¥åˆ°è¯¥ Map ä¸­ã€‚

```java
public void set(T value) {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null)
        map.set(this, value);
    else
        createMap(t, value);
}
```

get() æ–¹æ³•ç±»ä¼¼ã€‚

```java
public T get() {
    Thread t = Thread.currentThread();
    ThreadLocalMap map = getMap(t);
    if (map != null) {
        ThreadLocalMap.Entry e = map.getEntry(this);
        if (e != null) {
            @SuppressWarnings("unchecked")
            T result = (T)e.value;
            return result;
        }
    }
    return setInitialValue();
}
```

ThreadLocal ä»ç†è®ºä¸Šè®²å¹¶ä¸æ˜¯ç”¨æ¥è§£å†³å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜çš„ï¼Œå› ä¸ºæ ¹æœ¬ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ã€‚

åœ¨ä¸€äº›åœºæ™¯ (å°¤å…¶æ˜¯ä½¿ç”¨çº¿ç¨‹æ± ) ä¸‹ï¼Œç”±äº ThreadLocal.ThreadLocalMap çš„åº•å±‚æ•°æ®ç»“æ„å¯¼è‡´ ThreadLocal æœ‰å†…å­˜æ³„æ¼çš„æƒ…å†µï¼Œåº”è¯¥å°½å¯èƒ½åœ¨æ¯æ¬¡ä½¿ç”¨ ThreadLocal åæ‰‹åŠ¨è°ƒç”¨ remove()ï¼Œä»¥é¿å…å‡ºç° ThreadLocal ç»å…¸çš„å†…å­˜æ³„æ¼ç”šè‡³æ˜¯é€ æˆè‡ªèº«ä¸šåŠ¡æ··ä¹±çš„é£é™©ã€‚

æ›´è¯¦ç»†çš„åˆ†æçœ‹ï¼š[Java å¹¶å‘ - ThreadLocalè¯¦è§£](java/JUC/ThreadLocalè¯¦è§£)

**(ä¸‰)å¯é‡å…¥ä»£ç (Reentrant Code)**

è¿™ç§ä»£ç ä¹Ÿå«åšçº¯ä»£ç (Pure Code)ï¼Œå¯ä»¥åœ¨ä»£ç æ‰§è¡Œçš„ä»»ä½•æ—¶åˆ»ä¸­æ–­å®ƒï¼Œè½¬è€Œå»æ‰§è¡Œå¦å¤–ä¸€æ®µä»£ç (åŒ…æ‹¬é€’å½’è°ƒç”¨å®ƒæœ¬èº«)ï¼Œè€Œåœ¨æ§åˆ¶æƒè¿”å›åï¼ŒåŸæ¥çš„ç¨‹åºä¸ä¼šå‡ºç°ä»»ä½•é”™è¯¯ã€‚

å¯é‡å…¥ä»£ç æœ‰ä¸€äº›å…±åŒçš„ç‰¹å¾ï¼Œä¾‹å¦‚ä¸ä¾èµ–å­˜å‚¨åœ¨å †ä¸Šçš„æ•°æ®å’Œå…¬ç”¨çš„ç³»ç»Ÿèµ„æºã€ç”¨åˆ°çš„çŠ¶æ€é‡éƒ½ç”±å‚æ•°ä¸­ä¼ å…¥ã€ä¸è°ƒç”¨éå¯é‡å…¥çš„æ–¹æ³•ç­‰ã€‚