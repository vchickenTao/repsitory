**<span style="font-size: 35px;">ğŸ‡ Java IO è®¾è®¡æ¨¡å¼</span>**

---

## è£…é¥°è€…æ¨¡å¼

Java I/O ä½¿ç”¨äº†è£…é¥°è€…æ¨¡å¼æ¥å®ç°ã€‚ä»¥ InputStream ä¸ºä¾‹ï¼Œ

- InputStream æ˜¯æŠ½è±¡ç»„ä»¶ï¼›
- FileInputStream æ˜¯ InputStream çš„å­ç±»ï¼Œå±äºå…·ä½“ç»„ä»¶ï¼Œæä¾›äº†å­—èŠ‚æµçš„è¾“å…¥æ“ä½œï¼›
- FilterInputStream å±äºæŠ½è±¡è£…é¥°è€…ï¼Œè£…é¥°è€…ç”¨äºè£…é¥°ç»„ä»¶ï¼Œä¸ºç»„ä»¶æä¾›é¢å¤–çš„åŠŸèƒ½ã€‚ä¾‹å¦‚ BufferedInputStream ä¸º FileInputStream æä¾›ç¼“å­˜çš„åŠŸèƒ½ã€‚

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-05/2934c1be-5b8e-49c1-80d7-f3eb9e534eb6_DP-Decorator-java.io.png)



å®ä¾‹åŒ–ä¸€ä¸ªå…·æœ‰ç¼“å­˜åŠŸèƒ½çš„å­—èŠ‚æµå¯¹è±¡æ—¶ï¼Œåªéœ€è¦åœ¨ FileInputStream å¯¹è±¡ä¸Šå†å¥—ä¸€å±‚ BufferedInputStream å¯¹è±¡å³å¯ã€‚

```java
FileInputStream fileInputStream = new FileInputStream(filePath);
BufferedInputStream bufferedInputStream = new BufferedInputStream(fileInputStream);
```

DataInputStream è£…é¥°è€…æä¾›äº†å¯¹æ›´å¤šæ•°æ®ç±»å‹è¿›è¡Œè¾“å…¥çš„æ“ä½œï¼Œæ¯”å¦‚ intã€double ç­‰åŸºæœ¬ç±»å‹ã€‚



## é€‚é…å™¨æ¨¡å¼

**é€‚é…å™¨ï¼ˆAdapter Patternï¼‰æ¨¡å¼** ä¸»è¦ç”¨äºæ¥å£äº’ä¸å…¼å®¹çš„ç±»çš„åè°ƒå·¥ä½œï¼Œä½ å¯ä»¥å°†å…¶è”æƒ³åˆ°æˆ‘ä»¬æ—¥å¸¸ç»å¸¸ä½¿ç”¨çš„ç”µæºé€‚é…å™¨ã€‚

é€‚é…å™¨æ¨¡å¼ä¸­å­˜åœ¨è¢«é€‚é…çš„å¯¹è±¡æˆ–è€…ç±»ç§°ä¸º **é€‚é…è€…(Adaptee)** ï¼Œä½œç”¨äºé€‚é…è€…çš„å¯¹è±¡æˆ–è€…ç±»ç§°ä¸º**é€‚é…å™¨(Adapter)** ã€‚é€‚é…å™¨åˆ†ä¸ºå¯¹è±¡é€‚é…å™¨å’Œç±»é€‚é…å™¨ã€‚ç±»é€‚é…å™¨ä½¿ç”¨ç»§æ‰¿å…³ç³»æ¥å®ç°ï¼Œå¯¹è±¡é€‚é…å™¨ä½¿ç”¨ç»„åˆå…³ç³»æ¥å®ç°ã€‚

IO æµä¸­çš„å­—ç¬¦æµå’Œå­—èŠ‚æµçš„æ¥å£ä¸åŒï¼Œå®ƒä»¬ä¹‹é—´å¯ä»¥åè°ƒå·¥ä½œå°±æ˜¯åŸºäºé€‚é…å™¨æ¨¡å¼æ¥åšçš„ï¼Œæ›´å‡†ç¡®ç‚¹æ¥è¯´æ˜¯å¯¹è±¡é€‚é…å™¨ã€‚é€šè¿‡é€‚é…å™¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å­—èŠ‚æµå¯¹è±¡é€‚é…æˆä¸€ä¸ªå­—ç¬¦æµå¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å­—èŠ‚æµå¯¹è±¡æ¥è¯»å–æˆ–è€…å†™å…¥å­—ç¬¦æ•°æ®ã€‚

`InputStreamReader` å’Œ `OutputStreamWriter` å°±æ˜¯ä¸¤ä¸ªé€‚é…å™¨(Adapter)ï¼Œ åŒæ—¶ï¼Œå®ƒä»¬ä¸¤ä¸ªä¹Ÿæ˜¯å­—èŠ‚æµå’Œå­—ç¬¦æµä¹‹é—´çš„æ¡¥æ¢ã€‚`InputStreamReader` ä½¿ç”¨ `StreamDecoder` ï¼ˆæµè§£ç å™¨ï¼‰å¯¹å­—èŠ‚è¿›è¡Œè§£ç ï¼Œ**å®ç°å­—èŠ‚æµåˆ°å­—ç¬¦æµçš„è½¬æ¢ï¼Œ** `OutputStreamWriter` ä½¿ç”¨`StreamEncoder`ï¼ˆæµç¼–ç å™¨ï¼‰å¯¹å­—ç¬¦è¿›è¡Œç¼–ç ï¼Œå®ç°å­—ç¬¦æµåˆ°å­—èŠ‚æµçš„è½¬æ¢ã€‚

`InputStream` å’Œ `OutputStream` çš„å­ç±»æ˜¯è¢«é€‚é…è€…ï¼Œ `InputStreamReader` å’Œ `OutputStreamWriter`æ˜¯é€‚é…å™¨ã€‚

```java
// InputStreamReader æ˜¯é€‚é…å™¨ï¼ŒFileInputStream æ˜¯è¢«é€‚é…çš„ç±»
InputStreamReader isr = new InputStreamReader(new FileInputStream(fileName), "UTF-8");
// BufferedReader å¢å¼º InputStreamReader çš„åŠŸèƒ½ï¼ˆè£…é¥°å™¨æ¨¡å¼ï¼‰
BufferedReader bufferedReader = new BufferedReader(isr);
```

`java.io.InputStreamReader` éƒ¨åˆ†æºç ï¼š

```java
public class InputStreamReader extends Reader {
	//ç”¨äºè§£ç çš„å¯¹è±¡
	private final StreamDecoder sd;
    public InputStreamReader(InputStream in) {
        super(in);
        try {
            // è·å– StreamDecoder å¯¹è±¡
            sd = StreamDecoder.forInputStreamReader(in, this, (String)null);
        } catch (UnsupportedEncodingException e) {
            throw new Error(e);
        }
    }
    // ä½¿ç”¨ StreamDecoder å¯¹è±¡åšå…·ä½“çš„è¯»å–å·¥ä½œ
	public int read() throws IOException {
        return sd.read();
    }
}
```

`java.io.OutputStreamWriter` éƒ¨åˆ†æºç ï¼š

```java
public class OutputStreamWriter extends Writer {
    // ç”¨äºç¼–ç çš„å¯¹è±¡
    private final StreamEncoder se;
    public OutputStreamWriter(OutputStream out) {
        super(out);
        try {
           // è·å– StreamEncoder å¯¹è±¡
            se = StreamEncoder.forOutputStreamWriter(out, this, (String)null);
        } catch (UnsupportedEncodingException e) {
            throw new Error(e);
        }
    }
    // ä½¿ç”¨ StreamEncoder å¯¹è±¡åšå…·ä½“çš„å†™å…¥å·¥ä½œ
    public void write(int c) throws IOException {
        se.write(c);
    }
}
```

**é€‚é…å™¨æ¨¡å¼å’Œè£…é¥°å™¨æ¨¡å¼æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿ**

**è£…é¥°å™¨æ¨¡å¼** æ›´ä¾§é‡äºåŠ¨æ€åœ°å¢å¼ºåŸå§‹ç±»çš„åŠŸèƒ½ï¼Œè£…é¥°å™¨ç±»éœ€è¦è·ŸåŸå§‹ç±»ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»æˆ–è€…å®ç°ç›¸åŒçš„æ¥å£ã€‚å¹¶ä¸”ï¼Œè£…é¥°å™¨æ¨¡å¼æ”¯æŒå¯¹åŸå§‹ç±»åµŒå¥—ä½¿ç”¨å¤šä¸ªè£…é¥°å™¨ã€‚

**é€‚é…å™¨æ¨¡å¼** æ›´ä¾§é‡äºè®©æ¥å£ä¸å…¼å®¹è€Œä¸èƒ½äº¤äº’çš„ç±»å¯ä»¥ä¸€èµ·å·¥ä½œï¼Œå½“æˆ‘ä»¬è°ƒç”¨é€‚é…å™¨å¯¹åº”çš„æ–¹æ³•æ—¶ï¼Œé€‚é…å™¨å†…éƒ¨ä¼šè°ƒç”¨é€‚é…è€…ç±»æˆ–è€…å’Œé€‚é…ç±»ç›¸å…³çš„ç±»çš„æ–¹æ³•ï¼Œè¿™ä¸ªè¿‡ç¨‹é€æ˜çš„ã€‚å°±æ¯”å¦‚è¯´ `StreamDecoder` ï¼ˆæµè§£ç å™¨ï¼‰å’Œ`StreamEncoder`ï¼ˆæµç¼–ç å™¨ï¼‰å°±æ˜¯åˆ†åˆ«åŸºäº `InputStream` å’Œ `OutputStream` æ¥è·å– `FileChannel`å¯¹è±¡å¹¶è°ƒç”¨å¯¹åº”çš„ `read` æ–¹æ³•å’Œ `write` æ–¹æ³•è¿›è¡Œå­—èŠ‚æ•°æ®çš„è¯»å–å’Œå†™å…¥ã€‚

```java
StreamDecoder(InputStream in, Object lock, CharsetDecoder dec) {
    // çœç•¥å¤§éƒ¨åˆ†ä»£ç 
    // æ ¹æ® InputStream å¯¹è±¡è·å– FileChannel å¯¹è±¡
    ch = getChannel((FileInputStream)in);
}
```

é€‚é…å™¨å’Œé€‚é…è€…ä¸¤è€…ä¸éœ€è¦ç»§æ‰¿ç›¸åŒçš„æŠ½è±¡ç±»æˆ–è€…å®ç°ç›¸åŒçš„æ¥å£ã€‚

å¦å¤–ï¼Œ`FutrueTask` ç±»ä½¿ç”¨äº†é€‚é…å™¨æ¨¡å¼ï¼Œ`Executors` çš„å†…éƒ¨ç±» `RunnableAdapter` å®ç°å±äºé€‚é…å™¨ï¼Œç”¨äºå°† `Runnable` é€‚é…æˆ `Callable`ã€‚

`FutureTask`å‚æ•°åŒ…å« `Runnable` çš„ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼š

```java
public FutureTask(Runnable runnable, V result) {
    // è°ƒç”¨ Executors ç±»çš„ callable æ–¹æ³•
    this.callable = Executors.callable(runnable, result);
    this.state = NEW;
}
```

`Executors`ä¸­å¯¹åº”çš„æ–¹æ³•å’Œé€‚é…å™¨ï¼š

```java
// å®é™…è°ƒç”¨çš„æ˜¯ Executors çš„å†…éƒ¨ç±» RunnableAdapter çš„æ„é€ æ–¹æ³•
public static <T> Callable<T> callable(Runnable task, T result) {
    if (task == null)
        throw new NullPointerException();
    return new RunnableAdapter<T>(task, result);
}
// é€‚é…å™¨
static final class RunnableAdapter<T> implements Callable<T> {
    final Runnable task;
    final T result;
    RunnableAdapter(Runnable task, T result) {
        this.task = task;
        this.result = result;
    }
    public T call() {
        task.run();
        return result;
    }
}
```

## å·¥å‚æ¨¡å¼

å·¥å‚æ¨¡å¼ç”¨äºåˆ›å»ºå¯¹è±¡ï¼ŒNIO ä¸­å¤§é‡ç”¨åˆ°äº†å·¥å‚æ¨¡å¼ï¼Œæ¯”å¦‚ `Files` ç±»çš„ `newInputStream` æ–¹æ³•ç”¨äºåˆ›å»º `InputStream` å¯¹è±¡ï¼ˆé™æ€å·¥å‚ï¼‰ã€ `Paths` ç±»çš„ `get` æ–¹æ³•åˆ›å»º `Path` å¯¹è±¡ï¼ˆé™æ€å·¥å‚ï¼‰ã€`ZipFileSystem` ç±»ï¼ˆ`sun.nio`åŒ…ä¸‹çš„ç±»ï¼Œå±äº `java.nio` ç›¸å…³çš„ä¸€äº›å†…éƒ¨å®ç°ï¼‰çš„ `getPath` çš„æ–¹æ³•åˆ›å»º `Path` å¯¹è±¡ï¼ˆç®€å•å·¥å‚ï¼‰ã€‚

```java
InputStream is Files.newInputStream(Paths.get(generatorLogoPath))
```

## è§‚å¯Ÿè€…æ¨¡å¼

NIO ä¸­çš„æ–‡ä»¶ç›®å½•ç›‘å¬æœåŠ¡ä½¿ç”¨åˆ°äº†è§‚å¯Ÿè€…æ¨¡å¼ã€‚

NIO ä¸­çš„æ–‡ä»¶ç›®å½•ç›‘å¬æœåŠ¡åŸºäº `WatchService` æ¥å£å’Œ `Watchable` æ¥å£ã€‚`WatchService` å±äºè§‚å¯Ÿè€…ï¼Œ`Watchable` å±äºè¢«è§‚å¯Ÿè€…ã€‚

`Watchable` æ¥å£å®šä¹‰äº†ä¸€ä¸ªç”¨äºå°†å¯¹è±¡æ³¨å†Œåˆ° `WatchService`ï¼ˆç›‘æ§æœåŠ¡ï¼‰ å¹¶ç»‘å®šç›‘å¬äº‹ä»¶çš„æ–¹æ³• `register` ã€‚

```java
public interface Path
    extends Comparable<Path>, Iterable<Path>, Watchable{
}

public interface Watchable {
    WatchKey register(WatchService watcher,
                      WatchEvent.Kind<?>[] events,
                      WatchEvent.Modifier... modifiers)
        throws IOException;
}
```

`WatchService` ç”¨äºç›‘å¬æ–‡ä»¶ç›®å½•çš„å˜åŒ–ï¼ŒåŒä¸€ä¸ª `WatchService` å¯¹è±¡èƒ½å¤Ÿç›‘å¬å¤šä¸ªæ–‡ä»¶ç›®å½•ã€‚

```java
// åˆ›å»º WatchService å¯¹è±¡
WatchService watchService = FileSystems.getDefault().newWatchService();

// åˆå§‹åŒ–ä¸€ä¸ªè¢«ç›‘æ§æ–‡ä»¶å¤¹çš„ Path ç±»:
Path path = Paths.get("workingDirectory");
// å°†è¿™ä¸ª path å¯¹è±¡æ³¨å†Œåˆ° WatchServiceï¼ˆç›‘æ§æœåŠ¡ï¼‰ ä¸­å»
WatchKey watchKey = path.register(
watchService, StandardWatchEventKinds...);
```

`Path` ç±» `register` æ–¹æ³•çš„ç¬¬äºŒä¸ªå‚æ•° `events` ï¼ˆéœ€è¦ç›‘å¬çš„äº‹ä»¶ï¼‰ä¸ºå¯å˜é•¿å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬å¯ä»¥åŒæ—¶ç›‘å¬å¤šç§äº‹ä»¶ã€‚

```java
WatchKey register(WatchService watcher,
                  WatchEvent.Kind<?>... events)
    throws IOException;
```

å¸¸ç”¨çš„ç›‘å¬äº‹ä»¶æœ‰ 3 ç§ï¼š

- `StandardWatchEventKinds.ENTRY_CREATE` ï¼šæ–‡ä»¶åˆ›å»ºã€‚
- `StandardWatchEventKinds.ENTRY_DELETE` : æ–‡ä»¶åˆ é™¤ã€‚
- `StandardWatchEventKinds.ENTRY_MODIFY` : æ–‡ä»¶ä¿®æ”¹ã€‚

`register` æ–¹æ³•è¿”å› `WatchKey` å¯¹è±¡ï¼Œé€šè¿‡`WatchKey` å¯¹è±¡å¯ä»¥è·å–äº‹ä»¶çš„å…·ä½“ä¿¡æ¯æ¯”å¦‚æ–‡ä»¶ç›®å½•ä¸‹æ˜¯åˆ›å»ºã€åˆ é™¤è¿˜æ˜¯ä¿®æ”¹äº†æ–‡ä»¶ã€åˆ›å»ºã€åˆ é™¤æˆ–è€…ä¿®æ”¹çš„æ–‡ä»¶çš„å…·ä½“åç§°æ˜¯ä»€ä¹ˆã€‚

```java
WatchKey key;
while ((key = watchService.take()) != null) {
    for (WatchEvent<?> event : key.pollEvents()) {
      // å¯ä»¥è°ƒç”¨ WatchEvent å¯¹è±¡çš„æ–¹æ³•åšä¸€äº›äº‹æƒ…æ¯”å¦‚è¾“å‡ºäº‹ä»¶çš„å…·ä½“ä¸Šä¸‹æ–‡ä¿¡æ¯
    }
    key.reset();
}
```

`WatchService` å†…éƒ¨æ˜¯é€šè¿‡ä¸€ä¸ª daemon threadï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰é‡‡ç”¨å®šæœŸè½®è¯¢çš„æ–¹å¼æ¥æ£€æµ‹æ–‡ä»¶çš„å˜åŒ–ï¼Œç®€åŒ–åçš„æºç å¦‚ä¸‹æ‰€ç¤ºã€‚

```java
class PollingWatchService
    extends AbstractWatchService
{
    // å®šä¹‰ä¸€ä¸ª daemon threadï¼ˆå®ˆæŠ¤çº¿ç¨‹ï¼‰è½®è¯¢æ£€æµ‹æ–‡ä»¶å˜åŒ–
    private final ScheduledExecutorService scheduledExecutor;

    PollingWatchService() {
        scheduledExecutor = Executors
            .newSingleThreadScheduledExecutor(new ThreadFactory() {
                 @Override
                 public Thread newThread(Runnable r) {
                     Thread t = new Thread(r);
                     t.setDaemon(true);
                     return t;
                 }});
    }

  void enable(Set<? extends WatchEvent.Kind<?>> events, long period) {
    synchronized (this) {
      // æ›´æ–°ç›‘å¬äº‹ä»¶
      this.events = events;

        // å¼€å¯å®šæœŸè½®è¯¢
      Runnable thunk = new Runnable() { public void run() { poll(); }};
      this.poller = scheduledExecutor
        .scheduleAtFixedRate(thunk, period, period, TimeUnit.SECONDS);
    }
  }
}
```



## å‚è€ƒæ–‡ç« 

- [Java å…¨æ ˆçŸ¥è¯†ä½“ç³»](https://www.pdai.tech/md/java/io/java-io-basic-design-pattern.html)
- [JavaGuide](https://javaguide.cn/java/io/io-design-patterns.html)