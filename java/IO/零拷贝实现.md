**<span style="font-size: 35px;">ğŸ’ Java IO é›¶æ‹·è´å®ç°</span>**

---

## å‰è¨€

é›¶æ‹·è´ï¼ˆZero-copyï¼‰æŠ€æœ¯æŒ‡åœ¨è®¡ç®—æœºæ‰§è¡Œæ“ä½œæ—¶ï¼ŒCPU ä¸éœ€è¦å…ˆå°†æ•°æ®ä»ä¸€ä¸ªå†…å­˜åŒºåŸŸå¤åˆ¶åˆ°å¦ä¸€ä¸ªå†…å­˜åŒºåŸŸï¼Œä»è€Œå¯ä»¥å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ä»¥åŠ CPU çš„æ‹·è´æ—¶é—´ã€‚å®ƒçš„ä½œç”¨æ˜¯åœ¨æ•°æ®æŠ¥ä»ç½‘ç»œè®¾å¤‡åˆ°ç”¨æˆ·ç¨‹åºç©ºé—´ä¼ é€’çš„è¿‡ç¨‹ä¸­ï¼Œå‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ï¼Œå‡å°‘ç³»ç»Ÿè°ƒç”¨ï¼Œå®ç° CPU çš„é›¶å‚ä¸ï¼Œå½»åº•æ¶ˆé™¤ CPU åœ¨è¿™æ–¹é¢çš„è´Ÿè½½ã€‚å®ç°é›¶æ‹·è´ç”¨åˆ°çš„æœ€ä¸»è¦æŠ€æœ¯æ˜¯ DMA æ•°æ®ä¼ è¾“æŠ€æœ¯å’Œå†…å­˜åŒºåŸŸæ˜ å°„æŠ€æœ¯ã€‚

- é›¶æ‹·è´æœºåˆ¶å¯ä»¥å‡å°‘æ•°æ®åœ¨å†…æ ¸ç¼“å†²åŒºå’Œç”¨æˆ·è¿›ç¨‹ç¼“å†²åŒºä¹‹é—´åå¤çš„ I/O æ‹·è´æ“ä½œã€‚
- é›¶æ‹·è´æœºåˆ¶å¯ä»¥å‡å°‘ç”¨æˆ·è¿›ç¨‹åœ°å€ç©ºé—´å’Œå†…æ ¸åœ°å€ç©ºé—´ä¹‹é—´å› ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢è€Œå¸¦æ¥çš„ CPU å¼€é”€ã€‚

## æ­£æ–‡

### 1. ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜

ç”±äºæ“ä½œç³»ç»Ÿçš„è¿›ç¨‹ä¸è¿›ç¨‹ä¹‹é—´æ˜¯å…±äº« CPU å’Œå†…å­˜èµ„æºçš„ï¼Œå› æ­¤éœ€è¦ä¸€å¥—å®Œå–„çš„å†…å­˜ç®¡ç†æœºåˆ¶é˜²æ­¢è¿›ç¨‹ä¹‹é—´å†…å­˜æ³„æ¼çš„é—®é¢˜ã€‚ä¸ºäº†æ›´åŠ æœ‰æ•ˆåœ°ç®¡ç†å†…å­˜å¹¶å‡å°‘å‡ºé”™ï¼Œç°ä»£æ“ä½œç³»ç»Ÿæä¾›äº†ä¸€ç§å¯¹ä¸»å­˜çš„æŠ½è±¡æ¦‚å¿µï¼Œå³æ˜¯è™šæ‹Ÿå†…å­˜ï¼ˆVirtual Memoryï¼‰ã€‚è™šæ‹Ÿå†…å­˜ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªä¸€è‡´çš„ã€ç§æœ‰çš„åœ°å€ç©ºé—´ï¼Œå®ƒè®©æ¯ä¸ªè¿›ç¨‹äº§ç”Ÿäº†ä¸€ç§è‡ªå·±åœ¨ç‹¬äº«ä¸»å­˜çš„é”™è§‰ï¼ˆæ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰ä¸€ç‰‡è¿ç»­å®Œæ•´çš„å†…å­˜ç©ºé—´ï¼‰ã€‚

### 1.1. ç‰©ç†å†…å­˜

ç‰©ç†å†…å­˜ï¼ˆPhysical memoryï¼‰æ˜¯ç›¸å¯¹äºè™šæ‹Ÿå†…å­˜ï¼ˆVirtual Memoryï¼‰è€Œè¨€çš„ã€‚ç‰©ç†å†…å­˜æŒ‡é€šè¿‡ç‰©ç†å†…å­˜æ¡è€Œè·å¾—çš„å†…å­˜ç©ºé—´ï¼Œè€Œè™šæ‹Ÿå†…å­˜åˆ™æ˜¯æŒ‡å°†ç¡¬ç›˜çš„ä¸€å—åŒºåŸŸåˆ’åˆ†æ¥ä½œä¸ºå†…å­˜ã€‚å†…å­˜ä¸»è¦ä½œç”¨æ˜¯åœ¨è®¡ç®—æœºè¿è¡Œæ—¶ä¸ºæ“ä½œç³»ç»Ÿå’Œå„ç§ç¨‹åºæä¾›ä¸´æ—¶å‚¨å­˜ã€‚åœ¨åº”ç”¨ä¸­ï¼Œè‡ªç„¶æ˜¯é¡¾åæ€ä¹‰ï¼Œç‰©ç†ä¸Šï¼ŒçœŸå®å­˜åœ¨çš„æ’åœ¨ä¸»æ¿å†…å­˜æ§½ä¸Šçš„å†…å­˜æ¡çš„å®¹é‡çš„å¤§å°ã€‚

### 1.2. è™šæ‹Ÿå†…å­˜

è™šæ‹Ÿå†…å­˜æ˜¯è®¡ç®—æœºç³»ç»Ÿå†…å­˜ç®¡ç†çš„ä¸€ç§æŠ€æœ¯ã€‚ å®ƒä½¿å¾—åº”ç”¨ç¨‹åºè®¤ä¸ºå®ƒæ‹¥æœ‰è¿ç»­çš„å¯ç”¨çš„å†…å­˜ï¼ˆä¸€ä¸ªè¿ç»­å®Œæ•´çš„åœ°å€ç©ºé—´ï¼‰ã€‚è€Œå®é™…ä¸Šï¼Œè™šæ‹Ÿå†…å­˜é€šå¸¸æ˜¯è¢«åˆ†éš”æˆå¤šä¸ªç‰©ç†å†…å­˜ç¢ç‰‡ï¼Œè¿˜æœ‰éƒ¨åˆ†æš‚æ—¶å­˜å‚¨åœ¨å¤–éƒ¨ç£ç›˜å­˜å‚¨å™¨ä¸Šï¼Œåœ¨éœ€è¦æ—¶è¿›è¡Œæ•°æ®äº¤æ¢ï¼ŒåŠ è½½åˆ°ç‰©ç†å†…å­˜ä¸­æ¥ã€‚ ç›®å‰ï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿéƒ½ä½¿ç”¨äº†è™šæ‹Ÿå†…å­˜ï¼Œå¦‚ Windows ç³»ç»Ÿçš„è™šæ‹Ÿå†…å­˜ã€Linux ç³»ç»Ÿçš„äº¤æ¢ç©ºé—´ç­‰ç­‰ã€‚

è™šæ‹Ÿå†…å­˜åœ°å€å’Œç”¨æˆ·è¿›ç¨‹ç´§å¯†ç›¸å…³ï¼Œä¸€èˆ¬æ¥è¯´ä¸åŒè¿›ç¨‹é‡Œçš„åŒä¸€ä¸ªè™šæ‹Ÿåœ°å€æŒ‡å‘çš„ç‰©ç†åœ°å€æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥ç¦»å¼€è¿›ç¨‹è°ˆè™šæ‹Ÿå†…å­˜æ²¡æœ‰ä»»ä½•æ„ä¹‰ã€‚æ¯ä¸ªè¿›ç¨‹æ‰€èƒ½ä½¿ç”¨çš„è™šæ‹Ÿåœ°å€å¤§å°å’Œ CPU ä½æ•°æœ‰å…³ã€‚åœ¨ 32 ä½çš„ç³»ç»Ÿä¸Šï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´å¤§å°æ˜¯ 2 ^ 32 = 4Gï¼Œåœ¨ 64ä½ç³»ç»Ÿä¸Šï¼Œè™šæ‹Ÿåœ°å€ç©ºé—´å¤§å°æ˜¯ 2 ^ 64= 2 ^ 34Gï¼Œè€Œå®é™…çš„ç‰©ç†å†…å­˜å¯èƒ½è¿œè¿œå°äºè™šæ‹Ÿå†…å­˜çš„å¤§å°ã€‚æ¯ä¸ªç”¨æˆ·è¿›ç¨‹ç»´æŠ¤äº†ä¸€ä¸ªå•ç‹¬çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œè™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜å°±æ˜¯é€šè¿‡è¿™ä¸ªé¡µè¡¨å®ç°åœ°å€ç©ºé—´çš„æ˜ å°„çš„ã€‚ä¸‹é¢ç»™å‡ºä¸¤ä¸ªè¿›ç¨‹ Aã€B å„è‡ªçš„è™šæ‹Ÿå†…å­˜ç©ºé—´ä»¥åŠå¯¹åº”çš„ç‰©ç†å†…å­˜ä¹‹é—´çš„åœ°å€æ˜ å°„ç¤ºæ„å›¾ï¼š

![img](https://pic2.zhimg.com/80/v2-592088b9b4f2f172d526df017a589d09_720w.jpg)

å½“è¿›ç¨‹æ‰§è¡Œä¸€ä¸ªç¨‹åºæ—¶ï¼Œéœ€è¦å…ˆä»å…ˆå†…å­˜ä¸­è¯»å–è¯¥è¿›ç¨‹çš„æŒ‡ä»¤ï¼Œç„¶åæ‰§è¡Œï¼Œè·å–æŒ‡ä»¤æ—¶ç”¨åˆ°çš„å°±æ˜¯è™šæ‹Ÿåœ°å€ã€‚è¿™ä¸ªè™šæ‹Ÿåœ°å€æ˜¯ç¨‹åºé“¾æ¥æ—¶ç¡®å®šçš„ï¼ˆå†…æ ¸åŠ è½½å¹¶åˆå§‹åŒ–è¿›ç¨‹æ—¶ä¼šè°ƒæ•´åŠ¨æ€åº“çš„åœ°å€èŒƒå›´ï¼‰ã€‚ä¸ºäº†è·å–åˆ°å®é™…çš„æ•°æ®ï¼ŒCPU éœ€è¦å°†è™šæ‹Ÿåœ°å€è½¬æ¢æˆç‰©ç†åœ°å€ï¼ŒCPU è½¬æ¢åœ°å€æ—¶éœ€è¦ç”¨åˆ°è¿›ç¨‹çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œè€Œé¡µè¡¨ï¼ˆPage Tableï¼‰é‡Œé¢çš„æ•°æ®ç”±æ“ä½œç³»ç»Ÿç»´æŠ¤ã€‚

å…¶ä¸­é¡µè¡¨ï¼ˆPage Tableï¼‰å¯ä»¥ç®€å•çš„ç†è§£ä¸ºå•ä¸ªå†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰çš„é“¾è¡¨ï¼ˆå½“ç„¶å®é™…ç»“æ„å¾ˆå¤æ‚ï¼‰ï¼Œé‡Œé¢çš„æ¯ä¸ªå†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰éƒ½å°†ä¸€å—è™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ä¸€ä¸ªç‰¹å®šçš„åœ°å€ç©ºé—´ï¼ˆç‰©ç†å†…å­˜æˆ–è€…ç£ç›˜å­˜å‚¨ç©ºé—´ï¼‰ã€‚æ¯ä¸ªè¿›ç¨‹æ‹¥æœ‰è‡ªå·±çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ï¼Œå’Œå…¶å®ƒè¿›ç¨‹çš„é¡µè¡¨ï¼ˆPage Tableï¼‰æ²¡æœ‰å…³ç³»ã€‚

é€šè¿‡ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•çš„å°†ç”¨æˆ·è¿›ç¨‹ç”³è¯·å¹¶è®¿é—®ç‰©ç†å†…å­˜ï¼ˆæˆ–ç£ç›˜å­˜å‚¨ç©ºé—´ï¼‰çš„è¿‡ç¨‹æ€»ç»“å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹å‘æ“ä½œç³»ç»Ÿå‘å‡ºå†…å­˜ç”³è¯·è¯·æ±‚
2. ç³»ç»Ÿä¼šæ£€æŸ¥è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯å¦è¢«ç”¨å®Œï¼Œå¦‚æœæœ‰å‰©ä½™ï¼Œç»™è¿›ç¨‹åˆ†é…è™šæ‹Ÿåœ°å€
3. ç³»ç»Ÿä¸ºè¿™å—è™šæ‹Ÿåœ°å€åˆ›å»ºçš„å†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰ï¼Œå¹¶å°†å®ƒæ”¾è¿›è¯¥è¿›ç¨‹çš„é¡µè¡¨ï¼ˆPage Tableï¼‰
4. ç³»ç»Ÿè¿”å›è™šæ‹Ÿåœ°å€ç»™ç”¨æˆ·è¿›ç¨‹ï¼Œç”¨æˆ·è¿›ç¨‹å¼€å§‹è®¿é—®è¯¥è™šæ‹Ÿåœ°å€
5. CPU æ ¹æ®è™šæ‹Ÿåœ°å€åœ¨æ­¤è¿›ç¨‹çš„é¡µè¡¨ï¼ˆPage Tableï¼‰ä¸­æ‰¾åˆ°äº†ç›¸åº”çš„å†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªå†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰æ²¡æœ‰å’Œç‰©ç†å†…å­˜å…³è”ï¼Œäºæ˜¯äº§ç”Ÿç¼ºé¡µä¸­æ–­
6. æ“ä½œç³»ç»Ÿæ”¶åˆ°ç¼ºé¡µä¸­æ–­åï¼Œåˆ†é…çœŸæ­£çš„ç‰©ç†å†…å­˜å¹¶å°†å®ƒå…³è”åˆ°é¡µè¡¨ç›¸åº”çš„å†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰ã€‚ä¸­æ–­å¤„ç†å®Œæˆå CPU å°±å¯ä»¥è®¿é—®å†…å­˜äº†
7. å½“ç„¶ç¼ºé¡µä¸­æ–­ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šå‘ç”Ÿï¼Œåªæœ‰ç³»ç»Ÿè§‰å¾—æœ‰å¿…è¦å»¶è¿Ÿåˆ†é…å†…å­˜çš„æ—¶å€™æ‰ç”¨çš„ç€ï¼Œä¹Ÿå³å¾ˆå¤šæ—¶å€™åœ¨ä¸Šé¢çš„ç¬¬ 3 æ­¥ç³»ç»Ÿä¼šåˆ†é…çœŸæ­£çš„ç‰©ç†å†…å­˜å¹¶å’Œå†…å­˜æ˜ å°„ï¼ˆMemory Mappingï¼‰è¿›è¡Œå…³è”ã€‚

åœ¨ç”¨æˆ·è¿›ç¨‹å’Œç‰©ç†å†…å­˜ï¼ˆç£ç›˜å­˜å‚¨å™¨ï¼‰ä¹‹é—´å¼•å…¥è™šæ‹Ÿå†…å­˜ä¸»è¦æœ‰ä»¥ä¸‹çš„ä¼˜ç‚¹ï¼š

- åœ°å€ç©ºé—´ï¼šæä¾›æ›´å¤§çš„åœ°å€ç©ºé—´ï¼Œå¹¶ä¸”åœ°å€ç©ºé—´æ˜¯è¿ç»­çš„ï¼Œä½¿å¾—ç¨‹åºç¼–å†™ã€é“¾æ¥æ›´åŠ ç®€å•
- è¿›ç¨‹éš”ç¦»ï¼šä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ä¹‹é—´æ²¡æœ‰å…³ç³»ï¼Œæ‰€ä»¥ä¸€ä¸ªè¿›ç¨‹çš„æ“ä½œä¸ä¼šå¯¹å…¶å®ƒè¿›ç¨‹é€ æˆå½±å“
- æ•°æ®ä¿æŠ¤ï¼šæ¯å—è™šæ‹Ÿå†…å­˜éƒ½æœ‰ç›¸åº”çš„è¯»å†™å±æ€§ï¼Œè¿™æ ·å°±èƒ½ä¿æŠ¤ç¨‹åºçš„ä»£ç æ®µä¸è¢«ä¿®æ”¹ï¼Œæ•°æ®å—ä¸èƒ½è¢«æ‰§è¡Œç­‰ï¼Œå¢åŠ äº†ç³»ç»Ÿçš„å®‰å…¨æ€§
- å†…å­˜æ˜ å°„ï¼šæœ‰äº†è™šæ‹Ÿå†…å­˜ä¹‹åï¼Œå¯ä»¥ç›´æ¥æ˜ å°„ç£ç›˜ä¸Šçš„æ–‡ä»¶ï¼ˆå¯æ‰§è¡Œæ–‡ä»¶æˆ–åŠ¨æ€åº“ï¼‰åˆ°è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚è¿™æ ·å¯ä»¥åšåˆ°ç‰©ç†å†…å­˜å»¶æ—¶åˆ†é…ï¼Œåªæœ‰åœ¨éœ€è¦è¯»ç›¸åº”çš„æ–‡ä»¶çš„æ—¶å€™ï¼Œæ‰å°†å®ƒçœŸæ­£çš„ä»ç£ç›˜ä¸ŠåŠ è½½åˆ°å†…å­˜ä¸­æ¥ï¼Œè€Œåœ¨å†…å­˜åƒç´§çš„æ—¶å€™åˆå¯ä»¥å°†è¿™éƒ¨åˆ†å†…å­˜æ¸…ç©ºæ‰ï¼Œæé«˜ç‰©ç†å†…å­˜åˆ©ç”¨æ•ˆç‡ï¼Œå¹¶ä¸”æ‰€æœ‰è¿™äº›å¯¹åº”ç”¨ç¨‹åºæ˜¯éƒ½é€æ˜çš„
- å…±äº«å†…å­˜ï¼šæ¯”å¦‚åŠ¨æ€åº“åªéœ€è¦åœ¨å†…å­˜ä¸­å­˜å‚¨ä¸€ä»½ï¼Œç„¶åå°†å®ƒæ˜ å°„åˆ°ä¸åŒè¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸­ï¼Œè®©è¿›ç¨‹è§‰å¾—è‡ªå·±ç‹¬å äº†è¿™ä¸ªæ–‡ä»¶ã€‚è¿›ç¨‹é—´çš„å†…å­˜å…±äº«ä¹Ÿå¯ä»¥é€šè¿‡æ˜ å°„åŒä¸€å—ç‰©ç†å†…å­˜åˆ°è¿›ç¨‹çš„ä¸åŒè™šæ‹Ÿåœ°å€ç©ºé—´æ¥å®ç°å…±äº«
- ç‰©ç†å†…å­˜ç®¡ç†ï¼šç‰©ç†åœ°å€ç©ºé—´å…¨éƒ¨ç”±æ“ä½œç³»ç»Ÿç®¡ç†ï¼Œè¿›ç¨‹æ— æ³•ç›´æ¥åˆ†é…å’Œå›æ”¶ï¼Œä»è€Œç³»ç»Ÿå¯ä»¥æ›´å¥½çš„åˆ©ç”¨å†…å­˜ï¼Œå¹³è¡¡è¿›ç¨‹é—´å¯¹å†…å­˜çš„éœ€æ±‚

### 2. å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´

æ“ä½œç³»ç»Ÿçš„æ ¸å¿ƒæ˜¯å†…æ ¸ï¼Œç‹¬ç«‹äºæ™®é€šçš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´ï¼Œä¹Ÿæœ‰è®¿é—®åº•å±‚ç¡¬ä»¶è®¾å¤‡çš„æƒé™ã€‚ä¸ºäº†é¿å…ç”¨æˆ·è¿›ç¨‹ç›´æ¥æ“ä½œå†…æ ¸ï¼Œä¿è¯å†…æ ¸å®‰å…¨ï¼Œæ“ä½œç³»ç»Ÿå°†è™šæ‹Ÿå†…å­˜åˆ’åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯å†…æ ¸ç©ºé—´ï¼ˆKernel-spaceï¼‰ï¼Œä¸€éƒ¨åˆ†æ˜¯ç”¨æˆ·ç©ºé—´ï¼ˆUser-spaceï¼‰ã€‚ åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œå†…æ ¸æ¨¡å—è¿è¡Œåœ¨å†…æ ¸ç©ºé—´ï¼Œå¯¹åº”çš„è¿›ç¨‹å¤„äºå†…æ ¸æ€ï¼›è€Œç”¨æˆ·ç¨‹åºè¿è¡Œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå¯¹åº”çš„è¿›ç¨‹å¤„äºç”¨æˆ·æ€ã€‚

å†…æ ¸è¿›ç¨‹å’Œç”¨æˆ·è¿›ç¨‹æ‰€å çš„è™šæ‹Ÿå†…å­˜æ¯”ä¾‹æ˜¯ 1:3ï¼Œè€Œ Linux x86_32 ç³»ç»Ÿçš„å¯»å€ç©ºé—´ï¼ˆè™šæ‹Ÿå­˜å‚¨ç©ºé—´ï¼‰ä¸º 4Gï¼ˆ2çš„32æ¬¡æ–¹ï¼‰ï¼Œå°†æœ€é«˜çš„ 1G çš„å­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€ 0xC0000000 åˆ° 0xFFFFFFFFï¼‰ä¾›å†…æ ¸è¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºå†…æ ¸ç©ºé—´ï¼›è€Œè¾ƒä½çš„ 3G çš„å­—èŠ‚ï¼ˆä»è™šæ‹Ÿåœ°å€ 0x00000000 åˆ° 0xBFFFFFFFï¼‰ï¼Œä¾›å„ä¸ªç”¨æˆ·è¿›ç¨‹ä½¿ç”¨ï¼Œç§°ä¸ºç”¨æˆ·ç©ºé—´ã€‚ä¸‹å›¾æ˜¯ä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„å†…å­˜å¸ƒå±€ï¼š

![img](https://pic3.zhimg.com/80/v2-9a158fa2659d5baaea50be32c20e6dba_720w.jpg)

### 2.1. å†…æ ¸ç©ºé—´

å†…æ ¸ç©ºé—´æ€»æ˜¯é©»ç•™åœ¨å†…å­˜ä¸­ï¼Œå®ƒæ˜¯ä¸ºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ä¿ç•™çš„ã€‚åº”ç”¨ç¨‹åºæ˜¯ä¸å…è®¸ç›´æ¥åœ¨è¯¥åŒºåŸŸè¿›è¡Œè¯»å†™æˆ–ç›´æ¥è°ƒç”¨å†…æ ¸ä»£ç å®šä¹‰çš„å‡½æ•°çš„ã€‚ä¸Šå›¾å·¦ä¾§åŒºåŸŸä¸ºå†…æ ¸è¿›ç¨‹å¯¹åº”çš„è™šæ‹Ÿå†…å­˜ï¼ŒæŒ‰è®¿é—®æƒé™å¯ä»¥åˆ†ä¸ºè¿›ç¨‹ç§æœ‰å’Œè¿›ç¨‹å…±äº«ä¸¤å—åŒºåŸŸã€‚

- è¿›ç¨‹ç§æœ‰çš„è™šæ‹Ÿå†…å­˜ï¼šæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰å•ç‹¬çš„å†…æ ¸æ ˆã€é¡µè¡¨ã€task ç»“æ„ä»¥åŠ mem_map ç»“æ„ç­‰ã€‚
- è¿›ç¨‹å…±äº«çš„è™šæ‹Ÿå†…å­˜ï¼šå±äºæ‰€æœ‰è¿›ç¨‹å…±äº«çš„å†…å­˜åŒºåŸŸï¼ŒåŒ…æ‹¬ç‰©ç†å­˜å‚¨å™¨ã€å†…æ ¸æ•°æ®å’Œå†…æ ¸ä»£ç åŒºåŸŸã€‚

### 2.2. ç”¨æˆ·ç©ºé—´

æ¯ä¸ªæ™®é€šçš„ç”¨æˆ·è¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªå•ç‹¬çš„ç”¨æˆ·ç©ºé—´ï¼Œå¤„äºç”¨æˆ·æ€çš„è¿›ç¨‹ä¸èƒ½è®¿é—®å†…æ ¸ç©ºé—´ä¸­çš„æ•°æ®ï¼Œä¹Ÿä¸èƒ½ç›´æ¥è°ƒç”¨å†…æ ¸å‡½æ•°çš„ ï¼Œå› æ­¤è¦è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„æ—¶å€™ï¼Œå°±è¦å°†è¿›ç¨‹åˆ‡æ¢åˆ°å†…æ ¸æ€æ‰è¡Œã€‚ç”¨æˆ·ç©ºé—´åŒ…æ‹¬ä»¥ä¸‹å‡ ä¸ªå†…å­˜åŒºåŸŸï¼š

- è¿è¡Œæ—¶æ ˆï¼šç”±ç¼–è¯‘å™¨è‡ªåŠ¨é‡Šæ”¾ï¼Œå­˜æ”¾å‡½æ•°çš„å‚æ•°å€¼ï¼Œå±€éƒ¨å˜é‡å’Œæ–¹æ³•è¿”å›å€¼ç­‰ã€‚æ¯å½“ä¸€ä¸ªå‡½æ•°è¢«è°ƒç”¨æ—¶ï¼Œè¯¥å‡½æ•°çš„è¿”å›ç±»å‹å’Œä¸€äº›è°ƒç”¨çš„ä¿¡æ¯è¢«å­˜å‚¨åˆ°æ ˆé¡¶ï¼Œè°ƒç”¨ç»“æŸåè°ƒç”¨ä¿¡æ¯ä¼šè¢«å¼¹å‡ºå¼¹å‡ºå¹¶é‡Šæ”¾æ‰å†…å­˜ã€‚æ ˆåŒºæ˜¯ä»é«˜åœ°å€ä½å‘ä½åœ°å€ä½å¢é•¿çš„ï¼Œæ˜¯ä¸€å—è¿ç»­çš„å†…åœ¨åŒºåŸŸï¼Œæœ€å¤§å®¹é‡æ˜¯ç”±ç³»ç»Ÿé¢„å…ˆå®šä¹‰å¥½çš„ï¼Œç”³è¯·çš„æ ˆç©ºé—´è¶…è¿‡è¿™ä¸ªç•Œé™æ—¶ä¼šæç¤ºæº¢å‡ºï¼Œç”¨æˆ·èƒ½ä»æ ˆä¸­è·å–çš„ç©ºé—´è¾ƒå°ã€‚
- è¿è¡Œæ—¶å †ï¼šç”¨äºå­˜æ”¾è¿›ç¨‹è¿è¡Œä¸­è¢«åŠ¨æ€åˆ†é…çš„å†…å­˜æ®µï¼Œä½äº BSS å’Œæ ˆä¸­é—´çš„åœ°å€ä½ã€‚ç”±å¡å‘äººå‘˜ç”³è¯·åˆ†é…ï¼ˆmallocï¼‰å’Œé‡Šæ”¾ï¼ˆfreeï¼‰ã€‚å †æ˜¯ä»ä½åœ°å€ä½å‘é«˜åœ°å€ä½å¢é•¿ï¼Œé‡‡ç”¨é“¾å¼å­˜å‚¨ç»“æ„ã€‚é¢‘ç¹åœ° malloc/free é€ æˆå†…å­˜ç©ºé—´çš„ä¸è¿ç»­ï¼Œäº§ç”Ÿå¤§é‡ç¢ç‰‡ã€‚å½“ç”³è¯·å †ç©ºé—´æ—¶ï¼Œåº“å‡½æ•°æŒ‰ç…§ä¸€å®šçš„ç®—æ³•æœç´¢å¯ç”¨çš„è¶³å¤Ÿå¤§çš„ç©ºé—´ã€‚å› æ­¤å †çš„æ•ˆç‡æ¯”æ ˆè¦ä½çš„å¤šã€‚
- ä»£ç æ®µï¼šå­˜æ”¾ CPU å¯ä»¥æ‰§è¡Œçš„æœºå™¨æŒ‡ä»¤ï¼Œè¯¥éƒ¨åˆ†å†…å­˜åªèƒ½è¯»ä¸èƒ½å†™ã€‚é€šå¸¸ä»£ç åŒºæ˜¯å…±äº«çš„ï¼Œå³å…¶å®ƒæ‰§è¡Œç¨‹åºå¯è°ƒç”¨å®ƒã€‚å‡å¦‚æœºå™¨ä¸­æœ‰æ•°ä¸ªè¿›ç¨‹è¿è¡Œç›¸åŒçš„ä¸€ä¸ªç¨‹åºï¼Œé‚£ä¹ˆå®ƒä»¬å°±å¯ä»¥ä½¿ç”¨åŒä¸€ä¸ªä»£ç æ®µã€‚
- æœªåˆå§‹åŒ–çš„æ•°æ®æ®µï¼šå­˜æ”¾æœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒBSS çš„æ•°æ®åœ¨ç¨‹åºå¼€å§‹æ‰§è¡Œä¹‹å‰è¢«åˆå§‹åŒ–ä¸º 0 æˆ– NULLã€‚
- å·²åˆå§‹åŒ–çš„æ•°æ®æ®µï¼šå­˜æ”¾å·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ï¼ŒåŒ…æ‹¬é™æ€å…¨å±€å˜é‡ã€é™æ€å±€éƒ¨å˜é‡ä»¥åŠå¸¸é‡ã€‚
- å†…å­˜æ˜ å°„åŒºåŸŸï¼šä¾‹å¦‚å°†åŠ¨æ€åº“ï¼Œå…±äº«å†…å­˜ç­‰è™šæ‹Ÿç©ºé—´çš„å†…å­˜æ˜ å°„åˆ°ç‰©ç†ç©ºé—´çš„å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ mmap å‡½æ•°æ‰€åˆ†é…çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ã€‚

### 3. Linuxçš„å†…éƒ¨å±‚çº§ç»“æ„

å†…æ ¸æ€å¯ä»¥æ‰§è¡Œä»»æ„å‘½ä»¤ï¼Œè°ƒç”¨ç³»ç»Ÿçš„ä¸€åˆ‡èµ„æºï¼Œè€Œç”¨æˆ·æ€åªèƒ½æ‰§è¡Œç®€å•çš„è¿ç®—ï¼Œä¸èƒ½ç›´æ¥è°ƒç”¨ç³»ç»Ÿèµ„æºã€‚ç”¨æˆ·æ€å¿…é¡»é€šè¿‡ç³»ç»Ÿæ¥å£ï¼ˆSystem Callï¼‰ï¼Œæ‰èƒ½å‘å†…æ ¸å‘å‡ºæŒ‡ä»¤ã€‚æ¯”å¦‚ï¼Œå½“ç”¨æˆ·è¿›ç¨‹å¯åŠ¨ä¸€ä¸ª bash æ—¶ï¼Œå®ƒä¼šé€šè¿‡ getpid() å¯¹å†…æ ¸çš„ pid æœåŠ¡å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œè·å–å½“å‰ç”¨æˆ·è¿›ç¨‹çš„ IDï¼›å½“ç”¨æˆ·è¿›ç¨‹é€šè¿‡ cat å‘½ä»¤æŸ¥çœ‹ä¸»æœºé…ç½®æ—¶ï¼Œå®ƒä¼šå¯¹å†…æ ¸çš„æ–‡ä»¶å­ç³»ç»Ÿå‘èµ·ç³»ç»Ÿè°ƒç”¨ã€‚

![img](https://pic1.zhimg.com/80/v2-dc2c96fd298e9057b5a562fd19b291cc_720w.jpg)

- å†…æ ¸ç©ºé—´å¯ä»¥è®¿é—®æ‰€æœ‰çš„ CPU æŒ‡ä»¤å’Œæ‰€æœ‰çš„å†…å­˜ç©ºé—´ã€I/O ç©ºé—´å’Œç¡¬ä»¶è®¾å¤‡ã€‚
- ç”¨æˆ·ç©ºé—´åªèƒ½è®¿é—®å—é™çš„èµ„æºï¼Œå¦‚æœéœ€è¦ç‰¹æ®Šæƒé™ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿè°ƒç”¨è·å–ç›¸åº”çš„èµ„æºã€‚
- ç”¨æˆ·ç©ºé—´å…è®¸é¡µé¢ä¸­æ–­ï¼Œè€Œå†…æ ¸ç©ºé—´åˆ™ä¸å…è®¸ã€‚
- å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´æ˜¯é’ˆå¯¹çº¿æ€§åœ°å€ç©ºé—´çš„ã€‚
- x86 CPUä¸­ç”¨æˆ·ç©ºé—´æ˜¯ 0 - 3G çš„åœ°å€èŒƒå›´ï¼Œå†…æ ¸ç©ºé—´æ˜¯ 3G - 4G çš„åœ°å€èŒƒå›´ã€‚x86_64 CPU ç”¨æˆ·ç©ºé—´åœ°å€èŒƒå›´ä¸º0x0000000000000000 â€“ 0x00007fffffffffffï¼Œå†…æ ¸åœ°å€ç©ºé—´ä¸º 0xffff880000000000 - æœ€å¤§åœ°å€ã€‚
- æ‰€æœ‰å†…æ ¸è¿›ç¨‹ï¼ˆçº¿ç¨‹ï¼‰å…±ç”¨ä¸€ä¸ªåœ°å€ç©ºé—´ï¼Œè€Œç”¨æˆ·è¿›ç¨‹éƒ½æœ‰å„è‡ªçš„åœ°å€ç©ºé—´ã€‚

æœ‰äº†ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„åˆ’åˆ†åï¼ŒLinux å†…éƒ¨å±‚çº§ç»“æ„å¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œä»æœ€åº•å±‚åˆ°æœ€ä¸Šå±‚ä¾æ¬¡æ˜¯ç¡¬ä»¶ã€å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://pic1.zhimg.com/80/v2-b10efde815cca738ced49359c5bd0dec_720w.jpg)

### 4. Linux I/Oè¯»å†™æ–¹å¼

Linux æä¾›äº†è½®è¯¢ã€I/O ä¸­æ–­ä»¥åŠ DMA ä¼ è¾“è¿™ 3 ç§ç£ç›˜ä¸ä¸»å­˜ä¹‹é—´çš„æ•°æ®ä¼ è¾“æœºåˆ¶ã€‚å…¶ä¸­è½®è¯¢æ–¹å¼æ˜¯åŸºäºæ­»å¾ªç¯å¯¹ I/O ç«¯å£è¿›è¡Œä¸æ–­æ£€æµ‹ã€‚I/O ä¸­æ–­æ–¹å¼æ˜¯æŒ‡å½“æ•°æ®åˆ°è¾¾æ—¶ï¼Œç£ç›˜ä¸»åŠ¨å‘ CPU å‘èµ·ä¸­æ–­è¯·æ±‚ï¼Œç”± CPU è‡ªèº«è´Ÿè´£æ•°æ®çš„ä¼ è¾“è¿‡ç¨‹ã€‚ DMA ä¼ è¾“åˆ™åœ¨ I/O ä¸­æ–­çš„åŸºç¡€ä¸Šå¼•å…¥äº† DMA ç£ç›˜æ§åˆ¶å™¨ï¼Œç”± DMA ç£ç›˜æ§åˆ¶å™¨è´Ÿè´£æ•°æ®çš„ä¼ è¾“ï¼Œé™ä½äº† I/O ä¸­æ–­æ“ä½œå¯¹ CPU èµ„æºçš„å¤§é‡æ¶ˆè€—ã€‚

### 4.1. I/Oä¸­æ–­åŸç†

åœ¨ DMA æŠ€æœ¯å‡ºç°ä¹‹å‰ï¼Œåº”ç”¨ç¨‹åºä¸ç£ç›˜ä¹‹é—´çš„ I/O æ“ä½œéƒ½æ˜¯é€šè¿‡ CPU çš„ä¸­æ–­å®Œæˆçš„ã€‚æ¯æ¬¡ç”¨æˆ·è¿›ç¨‹è¯»å–ç£ç›˜æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦ CPU ä¸­æ–­ï¼Œç„¶åå‘èµ· I/O è¯·æ±‚ç­‰å¾…æ•°æ®è¯»å–å’Œæ‹·è´å®Œæˆï¼Œæ¯æ¬¡çš„ I/O ä¸­æ–­éƒ½å¯¼è‡´ CPU çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚

![img](https://pic3.zhimg.com/80/v2-0b46e37f599e0855925a39201add483a_720w.jpg)

1. ç”¨æˆ·è¿›ç¨‹å‘ CPU å‘èµ· read ç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®ï¼Œç”±ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼Œç„¶åä¸€ç›´é˜»å¡ç­‰å¾…æ•°æ®çš„è¿”å›ã€‚
2. CPU åœ¨æ¥æ”¶åˆ°æŒ‡ä»¤ä»¥åå¯¹ç£ç›˜å‘èµ· I/O è¯·æ±‚ï¼Œå°†ç£ç›˜æ•°æ®å…ˆæ”¾å…¥ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºã€‚
3. æ•°æ®å‡†å¤‡å®Œæˆä»¥åï¼Œç£ç›˜å‘ CPU å‘èµ· I/O ä¸­æ–­ã€‚
4. CPU æ”¶åˆ° I/O ä¸­æ–­ä»¥åå°†ç£ç›˜ç¼“å†²åŒºä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åå†ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºã€‚
5. ç”¨æˆ·è¿›ç¨‹ç”±å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œè§£é™¤é˜»å¡çŠ¶æ€ï¼Œç„¶åç­‰å¾… CPU çš„ä¸‹ä¸€ä¸ªæ‰§è¡Œæ—¶é—´é’Ÿã€‚

### 4.2. DMAä¼ è¾“åŸç†

DMA çš„å…¨ç§°å«ç›´æ¥å†…å­˜å­˜å–ï¼ˆDirect Memory Accessï¼‰ï¼Œæ˜¯ä¸€ç§å…è®¸å¤–å›´è®¾å¤‡ï¼ˆç¡¬ä»¶å­ç³»ç»Ÿï¼‰ç›´æ¥è®¿é—®ç³»ç»Ÿä¸»å†…å­˜çš„æœºåˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒåŸºäº DMA è®¿é—®æ–¹å¼ï¼Œç³»ç»Ÿä¸»å†…å­˜äºç¡¬ç›˜æˆ–ç½‘å¡ä¹‹é—´çš„æ•°æ®ä¼ è¾“å¯ä»¥ç»•å¼€ CPU çš„å…¨ç¨‹è°ƒåº¦ã€‚ç›®å‰å¤§å¤šæ•°çš„ç¡¬ä»¶è®¾å¤‡ï¼ŒåŒ…æ‹¬ç£ç›˜æ§åˆ¶å™¨ã€ç½‘å¡ã€æ˜¾å¡ä»¥åŠå£°å¡ç­‰éƒ½æ”¯æŒ DMA æŠ€æœ¯ã€‚

![img](https://pic2.zhimg.com/80/v2-fe93324d8dc895963e00b16466e56a55_720w.jpg)

æ•´ä¸ªæ•°æ®ä¼ è¾“æ“ä½œåœ¨ä¸€ä¸ª DMA æ§åˆ¶å™¨çš„æ§åˆ¶ä¸‹è¿›è¡Œçš„ã€‚CPU é™¤äº†åœ¨æ•°æ®ä¼ è¾“å¼€å§‹å’Œç»“æŸæ—¶åšä¸€ç‚¹å¤„ç†å¤–ï¼ˆå¼€å§‹å’Œç»“æŸæ—¶å€™è¦åšä¸­æ–­å¤„ç†ï¼‰ï¼Œåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ CPU å¯ä»¥ç»§ç»­è¿›è¡Œå…¶ä»–çš„å·¥ä½œã€‚è¿™æ ·åœ¨å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼ŒCPU è®¡ç®—å’Œ I/O æ“ä½œéƒ½å¤„äºå¹¶è¡Œæ“ä½œï¼Œä½¿æ•´ä¸ªè®¡ç®—æœºç³»ç»Ÿçš„æ•ˆç‡å¤§å¤§æé«˜ã€‚

![img](https://pic4.zhimg.com/80/v2-8894982f1c09259e2959acddc9f095e7_720w.jpg)

æœ‰äº† DMA ç£ç›˜æ§åˆ¶å™¨æ¥ç®¡æ•°æ®è¯»å†™è¯·æ±‚ä»¥åï¼ŒCPU ä»ç¹é‡çš„ I/O æ“ä½œä¸­è§£è„±ï¼Œæ•°æ®è¯»å–æ“ä½œçš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹å‘ CPU å‘èµ· read ç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®ï¼Œç”±ç”¨æˆ·æ€åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼Œç„¶åä¸€ç›´é˜»å¡ç­‰å¾…æ•°æ®çš„è¿”å›ã€‚
2. CPU åœ¨æ¥æ”¶åˆ°æŒ‡ä»¤ä»¥åå¯¹ DMA ç£ç›˜æ§åˆ¶å™¨å‘èµ·è°ƒåº¦æŒ‡ä»¤ã€‚
3. DMA ç£ç›˜æ§åˆ¶å™¨å¯¹ç£ç›˜å‘èµ· I/O è¯·æ±‚ï¼Œå°†ç£ç›˜æ•°æ®å…ˆæ”¾å…¥ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºï¼ŒCPU å…¨ç¨‹ä¸å‚ä¸æ­¤è¿‡ç¨‹ã€‚
4. æ•°æ®è¯»å–å®Œæˆåï¼ŒDMA ç£ç›˜æ§åˆ¶å™¨ä¼šæ¥å—åˆ°ç£ç›˜çš„é€šçŸ¥ï¼Œå°†æ•°æ®ä»ç£ç›˜æ§åˆ¶å™¨ç¼“å†²åŒºæ‹·è´åˆ°å†…æ ¸ç¼“å†²åŒºã€‚
5. DMA ç£ç›˜æ§åˆ¶å™¨å‘ CPU å‘å‡ºæ•°æ®è¯»å®Œçš„ä¿¡å·ï¼Œç”± CPU è´Ÿè´£å°†æ•°æ®ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºã€‚
6. ç”¨æˆ·è¿›ç¨‹ç”±å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ï¼Œè§£é™¤é˜»å¡çŠ¶æ€ï¼Œç„¶åç­‰å¾… CPU çš„ä¸‹ä¸€ä¸ªæ‰§è¡Œæ—¶é—´é’Ÿã€‚

### 5. ä¼ ç»ŸI/Oæ–¹å¼

ä¸ºäº†æ›´å¥½çš„ç†è§£é›¶æ‹·è´è§£å†³çš„é—®é¢˜ï¼Œæˆ‘ä»¬é¦–å…ˆäº†è§£ä¸€ä¸‹ä¼ ç»Ÿ I/O æ–¹å¼å­˜åœ¨çš„é—®é¢˜ã€‚åœ¨ Linux ç³»ç»Ÿä¸­ï¼Œä¼ ç»Ÿçš„è®¿é—®æ–¹å¼æ˜¯é€šè¿‡ write() å’Œ read() ä¸¤ä¸ªç³»ç»Ÿè°ƒç”¨å®ç°çš„ï¼Œé€šè¿‡ read() å‡½æ•°è¯»å–æ–‡ä»¶åˆ°åˆ°ç¼“å­˜åŒºä¸­ï¼Œç„¶åé€šè¿‡ write() æ–¹æ³•æŠŠç¼“å­˜ä¸­çš„æ•°æ®è¾“å‡ºåˆ°ç½‘ç»œç«¯å£ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
read(file_fd, tmp_buf, len);
write(socket_fd, tmp_buf, len);
```

ä¸‹å›¾åˆ†åˆ«å¯¹åº”ä¼ ç»Ÿ I/O æ“ä½œçš„æ•°æ®è¯»å†™æµç¨‹ï¼Œæ•´ä¸ªè¿‡ç¨‹æ¶‰åŠ 2 æ¬¡ CPU æ‹·è´ã€2 æ¬¡ DMA æ‹·è´æ€»å…± 4 æ¬¡æ‹·è´ï¼Œä»¥åŠ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä¸‹é¢ç®€å•åœ°é˜è¿°ä¸€ä¸‹ç›¸å…³çš„æ¦‚å¿µã€‚

![img](https://pic1.zhimg.com/80/v2-18e66cbb4e06d1f13e4335898c7b8e8c_720w.jpg)

- ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“ç”¨æˆ·ç¨‹åºå‘å†…æ ¸å‘èµ·ç³»ç»Ÿè°ƒç”¨æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ï¼›å½“ç³»ç»Ÿè°ƒç”¨è¿”å›æ—¶ï¼ŒCPU å°†ç”¨æˆ·è¿›ç¨‹ä»å†…æ ¸æ€åˆ‡æ¢å›ç”¨æˆ·æ€ã€‚
- CPUæ‹·è´ï¼šç”± CPU ç›´æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®æ‹·è´æ—¶ä¼šä¸€ç›´å ç”¨ CPU çš„èµ„æºã€‚
- DMAæ‹·è´ï¼šç”± CPU å‘DMAç£ç›˜æ§åˆ¶å™¨ä¸‹è¾¾æŒ‡ä»¤ï¼Œè®© DMA æ§åˆ¶å™¨æ¥å¤„ç†æ•°æ®çš„ä¼ é€ï¼Œæ•°æ®ä¼ é€å®Œæ¯•å†æŠŠä¿¡æ¯åé¦ˆç»™ CPUï¼Œä»è€Œå‡è½»äº† CPU èµ„æºçš„å æœ‰ç‡ã€‚

### 5.1. ä¼ ç»Ÿè¯»æ“ä½œ

å½“åº”ç”¨ç¨‹åºæ‰§è¡Œ read ç³»ç»Ÿè°ƒç”¨è¯»å–ä¸€å—æ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™å—æ•°æ®å·²ç»å­˜åœ¨äºç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ï¼Œå°±ç›´æ¥ä»å†…å­˜ä¸­è¯»å–æ•°æ®ï¼›å¦‚æœæ•°æ®ä¸å­˜åœ¨ï¼Œåˆ™å…ˆå°†æ•°æ®ä»ç£ç›˜åŠ è½½æ•°æ®åˆ°å†…æ ¸ç©ºé—´çš„è¯»ç¼“å­˜ï¼ˆread bufferï¼‰ä¸­ï¼Œå†ä»è¯»ç¼“å­˜æ‹·è´åˆ°ç”¨æˆ·è¿›ç¨‹çš„é¡µå†…å­˜ä¸­ã€‚

```cpp
read(file_fd, tmp_buf, len);
```

åŸºäºä¼ ç»Ÿçš„ I/O è¯»å–æ–¹å¼ï¼Œread ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ DMA æ‹·è´å’Œ 1 æ¬¡ CPU æ‹·è´ï¼Œå‘èµ·æ•°æ®è¯»å–çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ read() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. CPUåˆ©ç”¨DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚
3. CPUå°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰çš„ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ã€‚
4. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œread è°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

### 5.2. ä¼ ç»Ÿå†™æ“ä½œ

å½“åº”ç”¨ç¨‹åºå‡†å¤‡å¥½æ•°æ®ï¼Œæ‰§è¡Œ write ç³»ç»Ÿè°ƒç”¨å‘é€ç½‘ç»œæ•°æ®æ—¶ï¼Œå…ˆå°†æ•°æ®ä»ç”¨æˆ·ç©ºé—´çš„é¡µç¼“å­˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¸­ï¼Œç„¶åå†å°†å†™ç¼“å­˜ä¸­çš„æ•°æ®æ‹·è´åˆ°ç½‘å¡è®¾å¤‡å®Œæˆæ•°æ®å‘é€ã€‚

```cpp
write(socket_fd, tmp_buf, len);
```

åŸºäºä¼ ç»Ÿçš„ I/O å†™å…¥æ–¹å¼ï¼Œwrite() ç³»ç»Ÿè°ƒç”¨ä¼šè§¦å‘ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 1 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºå‘é€ç½‘ç»œæ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ write() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. CPU å°†ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚
3. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
4. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œwrite ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

### 6. é›¶æ‹·è´æ–¹å¼

åœ¨ Linux ä¸­é›¶æ‹·è´æŠ€æœ¯ä¸»è¦æœ‰ 3 ä¸ªå®ç°æ€è·¯ï¼šç”¨æˆ·æ€ç›´æ¥ I/Oã€å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ä»¥åŠå†™æ—¶å¤åˆ¶æŠ€æœ¯ã€‚

- ç”¨æˆ·æ€ç›´æ¥ I/Oï¼šåº”ç”¨ç¨‹åºå¯ä»¥ç›´æ¥è®¿é—®ç¡¬ä»¶å­˜å‚¨ï¼Œæ“ä½œç³»ç»Ÿå†…æ ¸åªæ˜¯è¾…åŠ©æ•°æ®ä¼ è¾“ã€‚è¿™ç§æ–¹å¼ä¾æ—§å­˜åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç¡¬ä»¶ä¸Šçš„æ•°æ®ç›´æ¥æ‹·è´è‡³äº†ç”¨æˆ·ç©ºé—´ï¼Œä¸ç»è¿‡å†…æ ¸ç©ºé—´ã€‚å› æ­¤ï¼Œç›´æ¥ I/O ä¸å­˜åœ¨å†…æ ¸ç©ºé—´ç¼“å†²åŒºå’Œç”¨æˆ·ç©ºé—´ç¼“å†²åŒºä¹‹é—´çš„æ•°æ®æ‹·è´ã€‚
- å‡å°‘æ•°æ®æ‹·è´æ¬¡æ•°ï¼šåœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­ï¼Œé¿å…æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºå’Œç³»ç»Ÿå†…æ ¸ç©ºé—´ç¼“å†²åŒºä¹‹é—´çš„CPUæ‹·è´ï¼Œä»¥åŠæ•°æ®åœ¨ç³»ç»Ÿå†…æ ¸ç©ºé—´å†…çš„CPUæ‹·è´ï¼Œè¿™ä¹Ÿæ˜¯å½“å‰ä¸»æµé›¶æ‹·è´æŠ€æœ¯çš„å®ç°æ€è·¯ã€‚
- å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼šå†™æ—¶å¤åˆ¶æŒ‡çš„æ˜¯å½“å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—æ•°æ®æ—¶ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªè¿›ç¨‹éœ€è¦å¯¹è¿™ä»½æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå°†å…¶æ‹·è´åˆ°è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ï¼Œå¦‚æœåªæ˜¯æ•°æ®è¯»å–æ“ä½œåˆ™ä¸éœ€è¦è¿›è¡Œæ‹·è´æ“ä½œã€‚

### 6.1. ç”¨æˆ·æ€ç›´æ¥I/O

ç”¨æˆ·æ€ç›´æ¥ I/O ä½¿å¾—åº”ç”¨è¿›ç¨‹æˆ–è¿è¡Œåœ¨ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ä¸‹çš„åº“å‡½æ•°ç›´æ¥è®¿é—®ç¡¬ä»¶è®¾å¤‡ï¼Œæ•°æ®ç›´æ¥è·¨è¿‡å†…æ ¸è¿›è¡Œä¼ è¾“ï¼Œå†…æ ¸åœ¨æ•°æ®ä¼ è¾“è¿‡ç¨‹é™¤äº†è¿›è¡Œå¿…è¦çš„è™šæ‹Ÿå­˜å‚¨é…ç½®å·¥ä½œä¹‹å¤–ï¼Œä¸å‚ä¸ä»»ä½•å…¶ä»–å·¥ä½œï¼Œè¿™ç§æ–¹å¼èƒ½å¤Ÿç›´æ¥ç»•è¿‡å†…æ ¸ï¼Œæå¤§æé«˜äº†æ€§èƒ½ã€‚

![img](https://pic1.zhimg.com/80/v2-4cb0f465ebeb7ff0f5e31e8d3f790c80_720w.jpg)

ç”¨æˆ·æ€ç›´æ¥ I/O åªèƒ½é€‚ç”¨äºä¸éœ€è¦å†…æ ¸ç¼“å†²åŒºå¤„ç†çš„åº”ç”¨ç¨‹åºï¼Œè¿™äº›åº”ç”¨ç¨‹åºé€šå¸¸åœ¨è¿›ç¨‹åœ°å€ç©ºé—´æœ‰è‡ªå·±çš„æ•°æ®ç¼“å­˜æœºåˆ¶ï¼Œç§°ä¸ºè‡ªç¼“å­˜åº”ç”¨ç¨‹åºï¼Œå¦‚æ•°æ®åº“ç®¡ç†ç³»ç»Ÿå°±æ˜¯ä¸€ä¸ªä»£è¡¨ã€‚å…¶æ¬¡ï¼Œè¿™ç§é›¶æ‹·è´æœºåˆ¶ä¼šç›´æ¥æ“ä½œç£ç›˜ I/Oï¼Œç”±äº CPU å’Œç£ç›˜ I/O ä¹‹é—´çš„æ‰§è¡Œæ—¶é—´å·®è·ï¼Œä¼šé€ æˆå¤§é‡èµ„æºçš„æµªè´¹ï¼Œè§£å†³æ–¹æ¡ˆæ˜¯é…åˆå¼‚æ­¥ I/O ä½¿ç”¨ã€‚

### 6.2. mmap + write

ä¸€ç§é›¶æ‹·è´æ–¹å¼æ˜¯ä½¿ç”¨ mmap + write ä»£æ›¿åŸæ¥çš„ read + write æ–¹å¼ï¼Œå‡å°‘äº† 1 æ¬¡ CPU æ‹·è´æ“ä½œã€‚mmap æ˜¯ Linux æä¾›çš„ä¸€ç§å†…å­˜æ˜ å°„æ–‡ä»¶æ–¹æ³•ï¼Œå³å°†ä¸€ä¸ªè¿›ç¨‹çš„åœ°å€ç©ºé—´ä¸­çš„ä¸€æ®µè™šæ‹Ÿåœ°å€æ˜ å°„åˆ°ç£ç›˜æ–‡ä»¶åœ°å€ï¼Œmmap + write çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
tmp_buf = mmap(file_fd, len);
write(socket_fd, tmp_buf, len);
```

ä½¿ç”¨ mmap çš„ç›®çš„æ˜¯å°†å†…æ ¸ä¸­è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰çš„åœ°å€ä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å†²åŒºï¼ˆuser bufferï¼‰è¿›è¡Œæ˜ å°„ï¼Œä»è€Œå®ç°å†…æ ¸ç¼“å†²åŒºä¸åº”ç”¨ç¨‹åºå†…å­˜çš„å…±äº«ï¼Œçœå»äº†å°†æ•°æ®ä»å†…æ ¸è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰çš„è¿‡ç¨‹ï¼Œç„¶è€Œå†…æ ¸è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä»éœ€å°†æ•°æ®åˆ°å†…æ ¸å†™ç¼“å†²åŒºï¼ˆsocket bufferï¼‰ï¼Œå¤§è‡´çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://pic2.zhimg.com/80/v2-28463616753963ac9f189ce23a485e2d_720w.jpg)

åŸºäº mmap + write ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 4 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ mmap() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. å°†ç”¨æˆ·è¿›ç¨‹çš„å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸ç”¨æˆ·ç©ºé—´çš„ç¼“å­˜åŒºï¼ˆuser bufferï¼‰è¿›è¡Œå†…å­˜åœ°å€æ˜ å°„ã€‚
3. CPUåˆ©ç”¨DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚
4. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œmmap ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚
5. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ write() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
6. CPUå°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚
7. CPUåˆ©ç”¨DMAæ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
8. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œwrite ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

mmap ä¸»è¦çš„ç”¨å¤„æ˜¯æé«˜ I/O æ€§èƒ½ï¼Œç‰¹åˆ«æ˜¯é’ˆå¯¹å¤§æ–‡ä»¶ã€‚å¯¹äºå°æ–‡ä»¶ï¼Œå†…å­˜æ˜ å°„æ–‡ä»¶åè€Œä¼šå¯¼è‡´ç¢ç‰‡ç©ºé—´çš„æµªè´¹ï¼Œå› ä¸ºå†…å­˜æ˜ å°„æ€»æ˜¯è¦å¯¹é½é¡µè¾¹ç•Œï¼Œæœ€å°å•ä½æ˜¯ 4 KBï¼Œä¸€ä¸ª 5 KB çš„æ–‡ä»¶å°†ä¼šæ˜ å°„å ç”¨ 8 KB å†…å­˜ï¼Œä¹Ÿå°±ä¼šæµªè´¹ 3 KB å†…å­˜ã€‚

mmap çš„æ‹·è´è™½ç„¶å‡å°‘äº† 1 æ¬¡æ‹·è´ï¼Œæå‡äº†æ•ˆç‡ï¼Œä½†ä¹Ÿå­˜åœ¨ä¸€äº›éšè—çš„é—®é¢˜ã€‚å½“ mmap ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶è¢«å¦ä¸€ä¸ªè¿›ç¨‹æ‰€æˆªè·ï¼Œé‚£ä¹ˆ write ç³»ç»Ÿè°ƒç”¨ä¼šå› ä¸ºè®¿é—®éæ³•åœ°å€è¢« SIGBUS ä¿¡å·ç»ˆæ­¢ï¼ŒSIGBUS é»˜è®¤ä¼šæ€æ­»è¿›ç¨‹å¹¶äº§ç”Ÿä¸€ä¸ª coredumpï¼ŒæœåŠ¡å™¨å¯èƒ½å› æ­¤è¢«ç»ˆæ­¢ã€‚

### 6.3. sendfile

sendfile ç³»ç»Ÿè°ƒç”¨åœ¨ Linux å†…æ ¸ç‰ˆæœ¬ 2.1 ä¸­è¢«å¼•å…¥ï¼Œç›®çš„æ˜¯ç®€åŒ–é€šè¿‡ç½‘ç»œåœ¨ä¸¤ä¸ªé€šé“ä¹‹é—´è¿›è¡Œçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚sendfile ç³»ç»Ÿè°ƒç”¨çš„å¼•å…¥ï¼Œä¸ä»…å‡å°‘äº† CPU æ‹·è´çš„æ¬¡æ•°ï¼Œè¿˜å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œå®ƒçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
sendfile(socket_fd, file_fd, len);
```

é€šè¿‡ sendfile ç³»ç»Ÿè°ƒç”¨ï¼Œæ•°æ®å¯ä»¥ç›´æ¥åœ¨å†…æ ¸ç©ºé—´å†…éƒ¨è¿›è¡Œ I/O ä¼ è¾“ï¼Œä»è€Œçœå»äº†æ•°æ®åœ¨ç”¨æˆ·ç©ºé—´å’Œå†…æ ¸ç©ºé—´ä¹‹é—´çš„æ¥å›æ‹·è´ã€‚ä¸ mmap å†…å­˜æ˜ å°„æ–¹å¼ä¸åŒçš„æ˜¯ï¼Œ sendfile è°ƒç”¨ä¸­ I/O æ•°æ®å¯¹ç”¨æˆ·ç©ºé—´æ˜¯å®Œå…¨ä¸å¯è§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™æ˜¯ä¸€æ¬¡å®Œå…¨æ„ä¹‰ä¸Šçš„æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚

![img](https://pic3.zhimg.com/80/v2-48132735369375701f3d8ac1d6029c2a_720w.jpg)

åŸºäº sendfile ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ1 æ¬¡ CPU æ‹·è´å’Œ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚
3. CPU å°†è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°çš„ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚
4. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
5. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

ç›¸æ¯”è¾ƒäº mmap å†…å­˜æ˜ å°„çš„æ–¹å¼ï¼Œsendfile å°‘äº† 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œä½†æ˜¯ä»ç„¶æœ‰ 1 æ¬¡ CPU æ‹·è´æ“ä½œã€‚sendfile å­˜åœ¨çš„é—®é¢˜æ˜¯ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œè€Œåªæ˜¯å•çº¯åœ°å®Œæˆäº†ä¸€æ¬¡æ•°æ®ä¼ è¾“è¿‡ç¨‹ã€‚

### 6.4. sendfile + DMA gather copy

Linux 2.4 ç‰ˆæœ¬çš„å†…æ ¸å¯¹ sendfile ç³»ç»Ÿè°ƒç”¨è¿›è¡Œä¿®æ”¹ï¼Œä¸º DMA æ‹·è´å¼•å…¥äº† gather æ“ä½œã€‚å®ƒå°†å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ä¸­å¯¹åº”çš„æ•°æ®æè¿°ä¿¡æ¯ï¼ˆå†…å­˜åœ°å€ã€åœ°å€åç§»é‡ï¼‰è®°å½•åˆ°ç›¸åº”çš„ç½‘ç»œç¼“å†²åŒºï¼ˆ socket bufferï¼‰ä¸­ï¼Œç”± DMA æ ¹æ®å†…å­˜åœ°å€ã€åœ°å€åç§»é‡å°†æ•°æ®æ‰¹é‡åœ°ä»è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è®¾å¤‡ä¸­ï¼Œè¿™æ ·å°±çœå»äº†å†…æ ¸ç©ºé—´ä¸­ä»…å‰©çš„ 1 æ¬¡ CPU æ‹·è´æ“ä½œï¼Œsendfile çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
sendfile(socket_fd, file_fd, len);
```

åœ¨ç¡¬ä»¶çš„æ”¯æŒä¸‹ï¼Œsendfile æ‹·è´æ–¹å¼ä¸å†ä»å†…æ ¸ç¼“å†²åŒºçš„æ•°æ®æ‹·è´åˆ° socket ç¼“å†²åŒºï¼Œå–è€Œä»£ä¹‹çš„ä»…ä»…æ˜¯ç¼“å†²åŒºæ–‡ä»¶æè¿°ç¬¦å’Œæ•°æ®é•¿åº¦çš„æ‹·è´ï¼Œè¿™æ · DMA å¼•æ“ç›´æ¥åˆ©ç”¨ gather æ“ä½œå°†é¡µç¼“å­˜ä¸­æ•°æ®æ‰“åŒ…å‘é€åˆ°ç½‘ç»œä¸­å³å¯ï¼Œæœ¬è´¨å°±æ˜¯å’Œè™šæ‹Ÿå†…å­˜æ˜ å°„çš„æ€è·¯ç±»ä¼¼ã€‚

![img](https://pic4.zhimg.com/80/v2-15edf2971101883e2a90253225a3b0d3_720w.jpg)

åŸºäº sendfile + DMA gather copy ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ã€0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ sendfile() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚
3. CPU æŠŠè¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦æ‹·è´åˆ°ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚
4. åŸºäºå·²æ‹·è´çš„æ–‡ä»¶æè¿°ç¬¦ï¼ˆfile descriptorï¼‰å’Œæ•°æ®é•¿åº¦ï¼ŒCPU åˆ©ç”¨ DMA æ§åˆ¶å™¨çš„ gather/scatter æ“ä½œç›´æ¥æ‰¹é‡åœ°å°†æ•°æ®ä»å†…æ ¸çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
5. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsendfile ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

sendfile + DMA gather copy æ‹·è´æ–¹å¼åŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ï¼Œè€Œä¸”æœ¬èº«éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œå®ƒåªé€‚ç”¨äºå°†æ•°æ®ä»æ–‡ä»¶æ‹·è´åˆ° socket å¥—æ¥å­—ä¸Šçš„ä¼ è¾“è¿‡ç¨‹ã€‚

### 6.5. splice

sendfile åªé€‚ç”¨äºå°†æ•°æ®ä»æ–‡ä»¶æ‹·è´åˆ° socket å¥—æ¥å­—ä¸Šï¼ŒåŒæ—¶éœ€è¦ç¡¬ä»¶çš„æ”¯æŒï¼Œè¿™ä¹Ÿé™å®šäº†å®ƒçš„ä½¿ç”¨èŒƒå›´ã€‚Linux åœ¨ 2.6.17 ç‰ˆæœ¬å¼•å…¥ splice ç³»ç»Ÿè°ƒç”¨ï¼Œä¸ä»…ä¸éœ€è¦ç¡¬ä»¶æ”¯æŒï¼Œè¿˜å®ç°äº†ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¹‹é—´çš„æ•°æ®é›¶æ‹·è´ã€‚splice çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š

```cpp
splice(fd_in, off_in, fd_out, off_out, len, flags);
```

splice ç³»ç»Ÿè°ƒç”¨å¯ä»¥åœ¨å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰å’Œç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¹‹é—´å»ºç«‹ç®¡é“ï¼ˆpipelineï¼‰ï¼Œä»è€Œé¿å…äº†ä¸¤è€…ä¹‹é—´çš„ CPU æ‹·è´æ“ä½œã€‚

![img](https://pic2.zhimg.com/80/v2-37cf7a8b129183c24c7b524d3fee1a29_720w.jpg)

åŸºäº splice ç³»ç»Ÿè°ƒç”¨çš„é›¶æ‹·è´æ–¹å¼ï¼Œæ•´ä¸ªæ‹·è´è¿‡ç¨‹ä¼šå‘ç”Ÿ 2 æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œ0 æ¬¡ CPU æ‹·è´ä»¥åŠ 2 æ¬¡ DMA æ‹·è´ï¼Œç”¨æˆ·ç¨‹åºè¯»å†™æ•°æ®çš„æµç¨‹å¦‚ä¸‹ï¼š

1. ç”¨æˆ·è¿›ç¨‹é€šè¿‡ splice() å‡½æ•°å‘å†…æ ¸ï¼ˆkernelï¼‰å‘èµ·ç³»ç»Ÿè°ƒç”¨ï¼Œä¸Šä¸‹æ–‡ä»ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰åˆ‡æ¢ä¸ºå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ã€‚
2. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ä¸»å­˜æˆ–ç¡¬ç›˜æ‹·è´åˆ°å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ã€‚
3. CPU åœ¨å†…æ ¸ç©ºé—´çš„è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰å’Œç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ä¹‹é—´å»ºç«‹ç®¡é“ï¼ˆpipelineï¼‰ã€‚
4. CPU åˆ©ç”¨ DMA æ§åˆ¶å™¨å°†æ•°æ®ä»ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰æ‹·è´åˆ°ç½‘å¡è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚
5. ä¸Šä¸‹æ–‡ä»å†…æ ¸æ€ï¼ˆkernel spaceï¼‰åˆ‡æ¢å›ç”¨æˆ·æ€ï¼ˆuser spaceï¼‰ï¼Œsplice ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œè¿”å›ã€‚

splice æ‹·è´æ–¹å¼ä¹ŸåŒæ ·å­˜åœ¨ç”¨æˆ·ç¨‹åºä¸èƒ½å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹çš„é—®é¢˜ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå®ƒä½¿ç”¨äº† Linux çš„ç®¡é“ç¼“å†²æœºåˆ¶ï¼Œå¯ä»¥ç”¨äºä»»æ„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­ä¼ è¾“æ•°æ®ï¼Œä½†æ˜¯å®ƒçš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦å‚æ•°ä¸­æœ‰ä¸€ä¸ªå¿…é¡»æ˜¯ç®¡é“è®¾å¤‡ã€‚

### 6.6. å†™æ—¶å¤åˆ¶

åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå†…æ ¸ç¼“å†²åŒºå¯èƒ½è¢«å¤šä¸ªè¿›ç¨‹æ‰€å…±äº«ï¼Œå¦‚æœæŸä¸ªè¿›ç¨‹æƒ³è¦è¿™ä¸ªå…±äº«åŒºè¿›è¡Œ write æ“ä½œï¼Œç”±äº write ä¸æä¾›ä»»ä½•çš„é”æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šå¯¹å…±äº«åŒºä¸­çš„æ•°æ®é€ æˆç ´åï¼Œå†™æ—¶å¤åˆ¶çš„å¼•å…¥å°±æ˜¯ Linux ç”¨æ¥ä¿æŠ¤æ•°æ®çš„ã€‚

å†™æ—¶å¤åˆ¶æŒ‡çš„æ˜¯å½“å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€å—æ•°æ®æ—¶ï¼Œå¦‚æœå…¶ä¸­ä¸€ä¸ªè¿›ç¨‹éœ€è¦å¯¹è¿™ä»½æ•°æ®è¿›è¡Œä¿®æ”¹ï¼Œé‚£ä¹ˆå°±éœ€è¦å°†å…¶æ‹·è´åˆ°è‡ªå·±çš„è¿›ç¨‹åœ°å€ç©ºé—´ä¸­ã€‚è¿™æ ·åšå¹¶ä¸å½±å“å…¶ä»–è¿›ç¨‹å¯¹è¿™å—æ•°æ®çš„æ“ä½œï¼Œæ¯ä¸ªè¿›ç¨‹è¦ä¿®æ”¹çš„æ—¶å€™æ‰ä¼šè¿›è¡Œæ‹·è´ï¼Œæ‰€ä»¥å«å†™æ—¶æ‹·è´ã€‚è¿™ç§æ–¹æ³•åœ¨æŸç§ç¨‹åº¦ä¸Šèƒ½å¤Ÿé™ä½ç³»ç»Ÿå¼€é”€ï¼Œå¦‚æœæŸä¸ªè¿›ç¨‹æ°¸è¿œä¸ä¼šå¯¹æ‰€è®¿é—®çš„æ•°æ®è¿›è¡Œæ›´æ”¹ï¼Œé‚£ä¹ˆä¹Ÿå°±æ°¸è¿œä¸éœ€è¦æ‹·è´ã€‚

### 6.7. ç¼“å†²åŒºå…±äº«

ç¼“å†²åŒºå…±äº«æ–¹å¼å®Œå…¨æ”¹å†™äº†ä¼ ç»Ÿçš„ I/O æ“ä½œï¼Œå› ä¸ºä¼ ç»Ÿ I/O æ¥å£éƒ½æ˜¯åŸºäºæ•°æ®æ‹·è´è¿›è¡Œçš„ï¼Œè¦é¿å…æ‹·è´å°±å¾—å»æ‰åŸå…ˆçš„é‚£å¥—æ¥å£å¹¶é‡æ–°æ”¹å†™ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ³•æ˜¯æ¯”è¾ƒå…¨é¢çš„é›¶æ‹·è´æŠ€æœ¯ï¼Œç›®å‰æ¯”è¾ƒæˆç†Ÿçš„ä¸€ä¸ªæ–¹æ¡ˆæ˜¯åœ¨ Solaris ä¸Šå®ç°çš„ fbufï¼ˆFast Bufferï¼Œå¿«é€Ÿç¼“å†²åŒºï¼‰ã€‚

fbuf çš„æ€æƒ³æ˜¯æ¯ä¸ªè¿›ç¨‹éƒ½ç»´æŠ¤ç€ä¸€ä¸ªç¼“å†²åŒºæ± ï¼Œè¿™ä¸ªç¼“å†²åŒºæ± èƒ½è¢«åŒæ—¶æ˜ å°„åˆ°ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰å’Œå†…æ ¸æ€ï¼ˆkernel spaceï¼‰ï¼Œå†…æ ¸å’Œç”¨æˆ·å…±äº«è¿™ä¸ªç¼“å†²åŒºæ± ï¼Œè¿™æ ·å°±é¿å…äº†ä¸€ç³»åˆ—çš„æ‹·è´æ“ä½œã€‚

![img](https://pic2.zhimg.com/80/v2-939270196a39a141cd89d0b3ca827275_720w.jpg)

ç¼“å†²åŒºå…±äº«çš„éš¾åº¦åœ¨äºç®¡ç†å…±äº«ç¼“å†²åŒºæ± éœ€è¦åº”ç”¨ç¨‹åºã€ç½‘ç»œè½¯ä»¶ä»¥åŠè®¾å¤‡é©±åŠ¨ç¨‹åºä¹‹é—´çš„ç´§å¯†åˆä½œï¼Œè€Œä¸”å¦‚ä½•æ”¹å†™ API ç›®å‰è¿˜å¤„äºè¯•éªŒé˜¶æ®µå¹¶ä¸æˆç†Ÿã€‚

### 7. Linuxé›¶æ‹·è´å¯¹æ¯”

æ— è®ºæ˜¯ä¼ ç»Ÿ I/O æ‹·è´æ–¹å¼è¿˜æ˜¯å¼•å…¥é›¶æ‹·è´çš„æ–¹å¼ï¼Œ2 æ¬¡ DMA Copy æ˜¯éƒ½å°‘ä¸äº†çš„ï¼Œå› ä¸ºä¸¤æ¬¡ DMA éƒ½æ˜¯ä¾èµ–ç¡¬ä»¶å®Œæˆçš„ã€‚ä¸‹é¢ä» CPU æ‹·è´æ¬¡æ•°ã€DMA æ‹·è´æ¬¡æ•°ä»¥åŠç³»ç»Ÿè°ƒç”¨å‡ ä¸ªæ–¹é¢æ€»ç»“ä¸€ä¸‹ä¸Šè¿°å‡ ç§ I/O æ‹·è´æ–¹å¼çš„å·®åˆ«ã€‚

![img](https://pic1.zhimg.com/80/v2-a728f1a35f62ba608c7eef7c43478edc_720w.jpg)

### 8. Java NIOé›¶æ‹·è´å®ç°

åœ¨ Java NIO ä¸­çš„é€šé“ï¼ˆChannelï¼‰å°±ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„å†…æ ¸ç©ºé—´ï¼ˆkernel spaceï¼‰çš„ç¼“å†²åŒºï¼Œè€Œç¼“å†²åŒºï¼ˆBufferï¼‰å¯¹åº”çš„ç›¸å½“äºæ“ä½œç³»ç»Ÿçš„ç”¨æˆ·ç©ºé—´ï¼ˆuser spaceï¼‰ä¸­çš„ç”¨æˆ·ç¼“å†²åŒºï¼ˆuser bufferï¼‰ã€‚

- é€šé“ï¼ˆChannelï¼‰æ˜¯å…¨åŒå·¥çš„ï¼ˆåŒå‘ä¼ è¾“ï¼‰ï¼Œå®ƒæ—¢å¯èƒ½æ˜¯è¯»ç¼“å†²åŒºï¼ˆread bufferï¼‰ï¼Œä¹Ÿå¯èƒ½æ˜¯ç½‘ç»œç¼“å†²åŒºï¼ˆsocket bufferï¼‰ã€‚
- ç¼“å†²åŒºï¼ˆBufferï¼‰åˆ†ä¸ºå †å†…å­˜ï¼ˆHeapBufferï¼‰å’Œå †å¤–å†…å­˜ï¼ˆDirectBufferï¼‰ï¼Œè¿™æ˜¯é€šè¿‡ malloc() åˆ†é…å‡ºæ¥çš„ç”¨æˆ·æ€å†…å­˜ã€‚

å †å¤–å†…å­˜ï¼ˆDirectBufferï¼‰åœ¨ä½¿ç”¨åéœ€è¦åº”ç”¨ç¨‹åºæ‰‹åŠ¨å›æ”¶ï¼Œè€Œå †å†…å­˜ï¼ˆHeapBufferï¼‰çš„æ•°æ®åœ¨ GC æ—¶å¯èƒ½ä¼šè¢«è‡ªåŠ¨å›æ”¶ã€‚å› æ­¤ï¼Œåœ¨ä½¿ç”¨ HeapBuffer è¯»å†™æ•°æ®æ—¶ï¼Œä¸ºäº†é¿å…ç¼“å†²åŒºæ•°æ®å› ä¸º GC è€Œä¸¢å¤±ï¼ŒNIO ä¼šå…ˆæŠŠ HeapBuffer å†…éƒ¨çš„æ•°æ®æ‹·è´åˆ°ä¸€ä¸ªä¸´æ—¶çš„ DirectBuffer ä¸­çš„æœ¬åœ°å†…å­˜ï¼ˆnative memoryï¼‰ï¼Œè¿™ä¸ªæ‹·è´æ¶‰åŠåˆ° sun.misc.Unsafe.copyMemory() çš„è°ƒç”¨ï¼ŒèƒŒåçš„å®ç°åŸç†ä¸ memcpy() ç±»ä¼¼ã€‚ æœ€åï¼Œå°†ä¸´æ—¶ç”Ÿæˆçš„ DirectBuffer å†…éƒ¨çš„æ•°æ®çš„å†…å­˜åœ°å€ä¼ ç»™ I/O è°ƒç”¨å‡½æ•°ï¼Œè¿™æ ·å°±é¿å…äº†å†å»è®¿é—® Java å¯¹è±¡å¤„ç† I/O è¯»å†™ã€‚

### 8.1. MappedByteBuffer

MappedByteBuffer æ˜¯ NIO åŸºäºå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰è¿™ç§é›¶æ‹·è´æ–¹å¼çš„æä¾›çš„ä¸€ç§å®ç°ï¼Œå®ƒç»§æ‰¿è‡ª ByteBufferã€‚FileChannel å®šä¹‰äº†ä¸€ä¸ª map() æ–¹æ³•ï¼Œå®ƒå¯ä»¥æŠŠä¸€ä¸ªæ–‡ä»¶ä» position ä½ç½®å¼€å§‹çš„ size å¤§å°çš„åŒºåŸŸæ˜ å°„ä¸ºå†…å­˜æ˜ åƒæ–‡ä»¶ã€‚æŠ½è±¡æ–¹æ³• map() æ–¹æ³•åœ¨ FileChannel ä¸­çš„å®šä¹‰å¦‚ä¸‹ï¼š

```java
public abstract MappedByteBuffer map(MapMode mode, long position, long size)
        throws IOException;
```

- modeï¼šé™å®šå†…å­˜æ˜ å°„åŒºåŸŸï¼ˆMappedByteBufferï¼‰å¯¹å†…å­˜æ˜ åƒæ–‡ä»¶çš„è®¿é—®æ¨¡å¼ï¼ŒåŒ…æ‹¬åªå¯è¯»ï¼ˆREAD_ONLYï¼‰ã€å¯è¯»å¯å†™ï¼ˆREAD_WRITEï¼‰å’Œå†™æ—¶æ‹·è´ï¼ˆPRIVATEï¼‰ä¸‰ç§æ¨¡å¼ã€‚
- positionï¼šæ–‡ä»¶æ˜ å°„çš„èµ·å§‹åœ°å€ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸï¼ˆMappedByteBufferï¼‰çš„é¦–åœ°å€ã€‚
- sizeï¼šæ–‡ä»¶æ˜ å°„çš„å­—èŠ‚é•¿åº¦ï¼Œä» position å¾€åçš„å­—èŠ‚æ•°ï¼Œå¯¹åº”å†…å­˜æ˜ å°„åŒºåŸŸï¼ˆMappedByteBufferï¼‰çš„å¤§å°ã€‚

MappedByteBuffer ç›¸æ¯” ByteBuffer æ–°å¢äº† fore()ã€load() å’Œ isLoad() ä¸‰ä¸ªé‡è¦çš„æ–¹æ³•ï¼š

- fore()ï¼šå¯¹äºå¤„äº READ_WRITE æ¨¡å¼ä¸‹çš„ç¼“å†²åŒºï¼ŒæŠŠå¯¹ç¼“å†²åŒºå†…å®¹çš„ä¿®æ”¹å¼ºåˆ¶åˆ·æ–°åˆ°æœ¬åœ°æ–‡ä»¶ã€‚
- load()ï¼šå°†ç¼“å†²åŒºçš„å†…å®¹è½½å…¥ç‰©ç†å†…å­˜ä¸­ï¼Œå¹¶è¿”å›è¿™ä¸ªç¼“å†²åŒºçš„å¼•ç”¨ã€‚
- isLoaded()ï¼šå¦‚æœç¼“å†²åŒºçš„å†…å®¹åœ¨ç‰©ç†å†…å­˜ä¸­ï¼Œåˆ™è¿”å› trueï¼Œå¦åˆ™è¿”å› falseã€‚

ä¸‹é¢ç»™å‡ºä¸€ä¸ªåˆ©ç”¨ MappedByteBuffer å¯¹æ–‡ä»¶è¿›è¡Œè¯»å†™çš„ä½¿ç”¨ç¤ºä¾‹ï¼š

```java
private final static String CONTENT = "Zero copy implemented by MappedByteBuffer";
private final static String FILE_NAME = "/mmap.txt";
private final static String CHARSET = "UTF-8";
```

- å†™æ–‡ä»¶æ•°æ®ï¼šæ‰“å¼€æ–‡ä»¶é€šé“ fileChannel å¹¶æä¾›è¯»æƒé™ã€å†™æƒé™å’Œæ•°æ®æ¸…ç©ºæƒé™ï¼Œé€šè¿‡ fileChannel æ˜ å°„åˆ°ä¸€ä¸ªå¯å†™çš„å†…å­˜ç¼“å†²åŒº mappedByteBufferï¼Œå°†ç›®æ ‡æ•°æ®å†™å…¥ mappedByteBufferï¼Œé€šè¿‡ force() æ–¹æ³•æŠŠç¼“å†²åŒºæ›´æ”¹çš„å†…å®¹å¼ºåˆ¶å†™å…¥æœ¬åœ°æ–‡ä»¶ã€‚

```java
@Test
public void writeToFileByMappedByteBuffer() {
    Path path = Paths.get(getClass().getResource(FILE_NAME).getPath());
    byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET));
    try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ,
            StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) {
        MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_WRITE, 0, bytes.length);
        if (mappedByteBuffer != null) {
            mappedByteBuffer.put(bytes);
            mappedByteBuffer.force();
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

- è¯»æ–‡ä»¶æ•°æ®ï¼šæ‰“å¼€æ–‡ä»¶é€šé“ fileChannel å¹¶æä¾›åªè¯»æƒé™ï¼Œé€šè¿‡ fileChannel æ˜ å°„åˆ°ä¸€ä¸ªåªå¯è¯»çš„å†…å­˜ç¼“å†²åŒº mappedByteBufferï¼Œè¯»å– mappedByteBuffer ä¸­çš„å­—èŠ‚æ•°ç»„å³å¯å¾—åˆ°æ–‡ä»¶æ•°æ®ã€‚

```java
@Test
public void readFromFileByMappedByteBuffer() {
    Path path = Paths.get(getClass().getResource(FILE_NAME).getPath());
    int length = CONTENT.getBytes(Charset.forName(CHARSET)).length;
    try (FileChannel fileChannel = FileChannel.open(path, StandardOpenOption.READ)) {
        MappedByteBuffer mappedByteBuffer = fileChannel.map(READ_ONLY, 0, length);
        if (mappedByteBuffer != null) {
            byte[] bytes = new byte[length];
            mappedByteBuffer.get(bytes);
            String content = new String(bytes, StandardCharsets.UTF_8);
            assertEquals(content, "Zero copy implemented by MappedByteBuffer");
        }
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

ä¸‹é¢ä»‹ç» map() æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ã€‚map() æ–¹æ³•æ˜¯ java.nio.channels.FileChannel çš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±» sun.nio.ch.FileChannelImpl.java å®ç°ï¼Œä¸‹é¢æ˜¯å’Œå†…å­˜æ˜ å°„ç›¸å…³çš„æ ¸å¿ƒä»£ç ï¼š

```java
public MappedByteBuffer map(MapMode mode, long position, long size) throws IOException {
    int pagePosition = (int)(position % allocationGranularity);
    long mapPosition = position - pagePosition;
    long mapSize = size + pagePosition;
    try {
        addr = map0(imode, mapPosition, mapSize);
    } catch (OutOfMemoryError x) {
        System.gc();
        try {
            Thread.sleep(100);
        } catch (InterruptedException y) {
            Thread.currentThread().interrupt();
        }
        try {
            addr = map0(imode, mapPosition, mapSize);
        } catch (OutOfMemoryError y) {
            throw new IOException("Map failed", y);
        }
    }

    int isize = (int)size;
    Unmapper um = new Unmapper(addr, mapSize, isize, mfd);
    if ((!writable) || (imode == MAP_RO)) {
        return Util.newMappedByteBufferR(isize, addr + pagePosition, mfd, um);
    } else {
        return Util.newMappedByteBuffer(isize, addr + pagePosition, mfd, um);
    }
}
```

map() æ–¹æ³•é€šè¿‡æœ¬åœ°æ–¹æ³• map0() ä¸ºæ–‡ä»¶åˆ†é…ä¸€å—è™šæ‹Ÿå†…å­˜ï¼Œä½œä¸ºå®ƒçš„å†…å­˜æ˜ å°„åŒºåŸŸï¼Œç„¶åè¿”å›è¿™å—å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ã€‚

1. æ–‡ä»¶æ˜ å°„éœ€è¦åœ¨ Java å †ä¸­åˆ›å»ºä¸€ä¸ª MappedByteBuffer çš„å®ä¾‹ã€‚å¦‚æœç¬¬ä¸€æ¬¡æ–‡ä»¶æ˜ å°„å¯¼è‡´ OOMï¼Œåˆ™æ‰‹åŠ¨è§¦å‘åƒåœ¾å›æ”¶ï¼Œä¼‘çœ  100ms åå†å°è¯•æ˜ å°„ï¼Œå¦‚æœå¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚
2. é€šè¿‡ Util çš„ newMappedByteBuffer ï¼ˆå¯è¯»å¯å†™ï¼‰æ–¹æ³•æˆ–è€… newMappedByteBufferRï¼ˆä»…è¯»ï¼‰ æ–¹æ³•æ–¹æ³•åå°„åˆ›å»ºä¸€ä¸ª DirectByteBuffer å®ä¾‹ï¼Œå…¶ä¸­ DirectByteBuffer æ˜¯ MappedByteBuffer çš„å­ç±»ã€‚

map() æ–¹æ³•è¿”å›çš„æ˜¯å†…å­˜æ˜ å°„åŒºåŸŸçš„èµ·å§‹åœ°å€ï¼Œé€šè¿‡ï¼ˆèµ·å§‹åœ°å€ + åç§»é‡ï¼‰å°±å¯ä»¥è·å–æŒ‡å®šå†…å­˜çš„æ•°æ®ã€‚è¿™æ ·ä¸€å®šç¨‹åº¦ä¸Šæ›¿ä»£äº† read() æˆ– write() æ–¹æ³•ï¼Œåº•å±‚ç›´æ¥é‡‡ç”¨ sun.misc.Unsafe ç±»çš„ getByte() å’Œ putByte() æ–¹æ³•å¯¹æ•°æ®è¿›è¡Œè¯»å†™ã€‚

```java
private native long map0(int prot, long position, long mapSize) throws IOException;
```

ä¸Šé¢æ˜¯æœ¬åœ°æ–¹æ³•ï¼ˆnative methodï¼‰map0 çš„å®šä¹‰ï¼Œå®ƒé€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰è°ƒç”¨åº•å±‚ C çš„å®ç°ï¼Œè¿™ä¸ª native å‡½æ•°ï¼ˆJava_sun_nio_ch_FileChannelImpl_map0ï¼‰çš„å®ç°ä½äº JDK æºç åŒ…ä¸‹çš„ native/sun/nio/ch/FileChannelImpl.c è¿™ä¸ªæºæ–‡ä»¶é‡Œé¢ã€‚

```c
JNIEXPORT jlong JNICALL
Java_sun_nio_ch_FileChannelImpl_map0(JNIEnv *env, jobject this,
                                     jint prot, jlong off, jlong len)
{
    void *mapAddress = 0;
    jobject fdo = (*env)->GetObjectField(env, this, chan_fd);
    jint fd = fdval(env, fdo);
    int protections = 0;
    int flags = 0;

    if (prot == sun_nio_ch_FileChannelImpl_MAP_RO) {
        protections = PROT_READ;
        flags = MAP_SHARED;
    } else if (prot == sun_nio_ch_FileChannelImpl_MAP_RW) {
        protections = PROT_WRITE | PROT_READ;
        flags = MAP_SHARED;
    } else if (prot == sun_nio_ch_FileChannelImpl_MAP_PV) {
        protections =  PROT_WRITE | PROT_READ;
        flags = MAP_PRIVATE;
    }

    mapAddress = mmap64(
        0,                    /* Let OS decide location */
        len,                  /* Number of bytes to map */
        protections,          /* File permissions */
        flags,                /* Changes are shared */
        fd,                   /* File descriptor of mapped file */
        off);                 /* Offset into file */

    if (mapAddress == MAP_FAILED) {
        if (errno == ENOMEM) {
            JNU_ThrowOutOfMemoryError(env, "Map failed");
            return IOS_THROWN;
        }
        return handle(env, -1, "Map failed");
    }

    return ((jlong) (unsigned long) mapAddress);
}
```

å¯ä»¥çœ‹å‡º map0() å‡½æ•°æœ€ç»ˆæ˜¯é€šè¿‡ mmap64() è¿™ä¸ªå‡½æ•°å¯¹ Linux åº•å±‚å†…æ ¸å‘å‡ºå†…å­˜æ˜ å°„çš„è°ƒç”¨ï¼Œ mmap64() å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c
#include <sys/mman.h>

void *mmap64(void *addr, size_t len, int prot, int flags, int fd, off64_t offset);
```

ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸€ä¸‹ mmap64() å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰ä»¥åŠå‚æ•°å¯é€‰å€¼ï¼š

- addrï¼šæ–‡ä»¶åœ¨ç”¨æˆ·è¿›ç¨‹ç©ºé—´çš„å†…å­˜æ˜ å°„åŒºä¸­çš„èµ·å§‹åœ°å€ï¼Œæ˜¯ä¸€ä¸ªå»ºè®®çš„å‚æ•°ï¼Œé€šå¸¸å¯è®¾ç½®ä¸º 0 æˆ– NULLï¼Œæ­¤æ—¶ç”±å†…æ ¸å»å†³å®šçœŸå®çš„èµ·å§‹åœ°å€ã€‚å½“ flags ä¸º MAP_FIXED æ—¶ï¼Œaddr å°±æ˜¯ä¸€ä¸ªå¿…é€‰çš„å‚æ•°ï¼Œå³éœ€è¦æä¾›ä¸€ä¸ªå­˜åœ¨çš„åœ°å€ã€‚
- lenï¼šæ–‡ä»¶éœ€è¦è¿›è¡Œå†…å­˜æ˜ å°„çš„å­—èŠ‚é•¿åº¦
- protï¼šæ§åˆ¶ç”¨æˆ·è¿›ç¨‹å¯¹å†…å­˜æ˜ å°„åŒºçš„è®¿é—®æƒé™
- PROT_READï¼šè¯»æƒé™
- PROT_WRITEï¼šå†™æƒé™
- PROT_EXECï¼šæ‰§è¡Œæƒé™
- PROT_NONEï¼šæ— æƒé™
- flagsï¼šæ§åˆ¶å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹æ˜¯å¦è¢«å¤šä¸ªè¿›ç¨‹å…±äº«
- MAP_PRIVATEï¼šå¯¹å†…å­˜æ˜ å°„åŒºæ•°æ®çš„ä¿®æ”¹ä¸ä¼šåæ˜ åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œæ•°æ®ä¿®æ”¹å‘ç”Ÿæ—¶é‡‡ç”¨å†™æ—¶å¤åˆ¶æœºåˆ¶
- MAP_SHAREDï¼šå¯¹å†…å­˜æ˜ å°„åŒºçš„ä¿®æ”¹ä¼šåŒæ­¥åˆ°çœŸæ­£çš„æ–‡ä»¶ï¼Œä¿®æ”¹å¯¹å…±äº«æ­¤å†…å­˜æ˜ å°„åŒºçš„è¿›ç¨‹æ˜¯å¯è§çš„
- MAP_FIXEDï¼šä¸å»ºè®®ä½¿ç”¨ï¼Œè¿™ç§æ¨¡å¼ä¸‹ addr å‚æ•°æŒ‡å®šçš„å¿…é¡»çš„æä¾›ä¸€ä¸ªå­˜åœ¨çš„ addr å‚æ•°
- fdï¼šæ–‡ä»¶æè¿°ç¬¦ã€‚æ¯æ¬¡ map æ“ä½œä¼šå¯¼è‡´æ–‡ä»¶çš„å¼•ç”¨è®¡æ•°åŠ  1ï¼Œæ¯æ¬¡ unmap æ“ä½œæˆ–è€…ç»“æŸè¿›ç¨‹ä¼šå¯¼è‡´å¼•ç”¨è®¡æ•°å‡ 1
- offsetï¼šæ–‡ä»¶åç§»é‡ã€‚è¿›è¡Œæ˜ å°„çš„æ–‡ä»¶ä½ç½®ï¼Œä»æ–‡ä»¶èµ·å§‹åœ°å€å‘åçš„ä½ç§»é‡

ä¸‹é¢æ€»ç»“ä¸€ä¸‹ MappedByteBuffer çš„ç‰¹ç‚¹å’Œä¸è¶³ä¹‹å¤„ï¼š

- MappedByteBuffer ä½¿ç”¨æ˜¯å †å¤–çš„è™šæ‹Ÿå†…å­˜ï¼Œå› æ­¤åˆ†é…ï¼ˆmapï¼‰çš„å†…å­˜å¤§å°ä¸å— JVM çš„ -Xmx å‚æ•°é™åˆ¶ï¼Œä½†æ˜¯ä¹Ÿæ˜¯æœ‰å¤§å°é™åˆ¶çš„ã€‚
- å¦‚æœå½“æ–‡ä»¶è¶…å‡º Integer.MAX_VALUE å­—èŠ‚é™åˆ¶æ—¶ï¼Œå¯ä»¥é€šè¿‡ position å‚æ•°é‡æ–° map æ–‡ä»¶åé¢çš„å†…å®¹ã€‚
- MappedByteBuffer åœ¨å¤„ç†å¤§æ–‡ä»¶æ—¶æ€§èƒ½çš„ç¡®å¾ˆé«˜ï¼Œä½†ä¹Ÿå­˜å†…å­˜å ç”¨ã€æ–‡ä»¶å…³é—­ä¸ç¡®å®šç­‰é—®é¢˜ï¼Œè¢«å…¶æ‰“å¼€çš„æ–‡ä»¶åªæœ‰åœ¨åƒåœ¾å›æ”¶çš„æ‰ä¼šè¢«å…³é—­ï¼Œè€Œä¸”è¿™ä¸ªæ—¶é—´ç‚¹æ˜¯ä¸ç¡®å®šçš„ã€‚
- MappedByteBuffer æä¾›äº†æ–‡ä»¶æ˜ å°„å†…å­˜çš„ mmap() æ–¹æ³•ï¼Œä¹Ÿæä¾›äº†é‡Šæ”¾æ˜ å°„å†…å­˜çš„ unmap() æ–¹æ³•ã€‚ç„¶è€Œ unmap() æ˜¯ FileChannelImpl ä¸­çš„ç§æœ‰æ–¹æ³•ï¼Œæ— æ³•ç›´æ¥æ˜¾ç¤ºè°ƒç”¨ã€‚å› æ­¤ï¼Œç”¨æˆ·ç¨‹åºéœ€è¦é€šè¿‡ Java åå°„çš„è°ƒç”¨ sun.misc.Cleaner ç±»çš„ clean() æ–¹æ³•æ‰‹åŠ¨é‡Šæ”¾æ˜ å°„å ç”¨çš„å†…å­˜åŒºåŸŸã€‚

```java
public static void clean(final Object buffer) throws Exception {
    AccessController.doPrivileged((PrivilegedAction<Void>) () -> {
        try {
            Method getCleanerMethod = buffer.getClass().getMethod("cleaner", new Class[0]);
            getCleanerMethod.setAccessible(true);
            Cleaner cleaner = (Cleaner) getCleanerMethod.invoke(buffer, new Object[0]);
            cleaner.clean();
        } catch(Exception e) {
            e.printStackTrace();
        }
    });
}
```

### 8.2. DirectByteBuffer

DirectByteBuffer çš„å¯¹è±¡å¼•ç”¨ä½äº Java å†…å­˜æ¨¡å‹çš„å †é‡Œé¢ï¼ŒJVM å¯ä»¥å¯¹ DirectByteBuffer çš„å¯¹è±¡è¿›è¡Œå†…å­˜åˆ†é…å’Œå›æ”¶ç®¡ç†ï¼Œä¸€èˆ¬ä½¿ç”¨ DirectByteBuffer çš„é™æ€æ–¹æ³• allocateDirect() åˆ›å»º DirectByteBuffer å®ä¾‹å¹¶åˆ†é…å†…å­˜ã€‚

```java
public static ByteBuffer allocateDirect(int capacity) {
    return new DirectByteBuffer(capacity);
}
```

DirectByteBuffer å†…éƒ¨çš„å­—èŠ‚ç¼“å†²åŒºä½åœ¨äºå †å¤–çš„ï¼ˆç”¨æˆ·æ€ï¼‰ç›´æ¥å†…å­˜ï¼Œå®ƒæ˜¯é€šè¿‡ Unsafe çš„æœ¬åœ°æ–¹æ³• allocateMemory() è¿›è¡Œå†…å­˜åˆ†é…ï¼Œåº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„ malloc() å‡½æ•°ã€‚

```java
DirectByteBuffer(int cap) {
    super(-1, 0, cap, cap);
    boolean pa = VM.isDirectMemoryPageAligned();
    int ps = Bits.pageSize();
    long size = Math.max(1L, (long)cap + (pa ? ps : 0));
    Bits.reserveMemory(size, cap);

    long base = 0;
    try {
        base = unsafe.allocateMemory(size);
    } catch (OutOfMemoryError x) {
        Bits.unreserveMemory(size, cap);
        throw x;
    }
    unsafe.setMemory(base, size, (byte) 0);
    if (pa && (base % ps != 0)) {
        address = base + ps - (base & (ps - 1));
    } else {
        address = base;
    }
    cleaner = Cleaner.create(this, new Deallocator(base, size, cap));
    att = null;
}
```

é™¤æ­¤ä¹‹å¤–ï¼Œåˆå§‹åŒ– DirectByteBuffer æ—¶è¿˜ä¼šåˆ›å»ºä¸€ä¸ª Deallocator çº¿ç¨‹ï¼Œå¹¶é€šè¿‡ Cleaner çš„ freeMemory() æ–¹æ³•æ¥å¯¹ç›´æ¥å†…å­˜è¿›è¡Œå›æ”¶æ“ä½œï¼ŒfreeMemory() åº•å±‚è°ƒç”¨çš„æ˜¯æ“ä½œç³»ç»Ÿçš„ free() å‡½æ•°ã€‚

```java
private static class Deallocator implements Runnable {
    private static Unsafe unsafe = Unsafe.getUnsafe();

    private long address;
    private long size;
    private int capacity;

    private Deallocator(long address, long size, int capacity) {
        assert (address != 0);
        this.address = address;
        this.size = size;
        this.capacity = capacity;
    }

    public void run() {
        if (address == 0) {
            return;
        }
        unsafe.freeMemory(address);
        address = 0;
        Bits.unreserveMemory(size, capacity);
    }
}
```

ç”±äºä½¿ç”¨ DirectByteBuffer åˆ†é…çš„æ˜¯ç³»ç»Ÿæœ¬åœ°çš„å†…å­˜ï¼Œä¸åœ¨ JVM çš„ç®¡æ§èŒƒå›´ä¹‹å†…ï¼Œå› æ­¤ç›´æ¥å†…å­˜çš„å›æ”¶å’Œå †å†…å­˜çš„å›æ”¶ä¸åŒï¼Œç›´æ¥å†…å­˜å¦‚æœä½¿ç”¨ä¸å½“ï¼Œå¾ˆå®¹æ˜“é€ æˆ OutOfMemoryErrorã€‚

è¯´äº†è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆ DirectByteBuffer å’Œé›¶æ‹·è´æœ‰ä»€ä¹ˆå…³ç³»ï¼Ÿå‰é¢æœ‰æåˆ°åœ¨ MappedByteBuffer è¿›è¡Œå†…å­˜æ˜ å°„æ—¶ï¼Œå®ƒçš„ map() æ–¹æ³•ä¼šé€šè¿‡ Util.newMappedByteBuffer() æ¥åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå®ä¾‹ï¼Œåˆå§‹åŒ–çš„ä»£ç å¦‚ä¸‹ï¼š

```java
static MappedByteBuffer newMappedByteBuffer(int size, long addr, FileDescriptor fd,
                                            Runnable unmapper) {
    MappedByteBuffer dbb;
    if (directByteBufferConstructor == null)
        initDBBConstructor();
    try {
        dbb = (MappedByteBuffer)directByteBufferConstructor.newInstance(
            new Object[] { new Integer(size), new Long(addr), fd, unmapper });
    } catch (InstantiationException | IllegalAccessException | InvocationTargetException e) {
        throw new InternalError(e);
    }
    return dbb;
}

private static void initDBBRConstructor() {
    AccessController.doPrivileged(new PrivilegedAction<Void>() {
        public Void run() {
            try {
                Class<?> cl = Class.forName("java.nio.DirectByteBufferR");
                Constructor<?> ctor = cl.getDeclaredConstructor(
                    new Class<?>[] { int.class, long.class, FileDescriptor.class,
                                    Runnable.class });
                ctor.setAccessible(true);
                directByteBufferRConstructor = ctor;
            } catch (ClassNotFoundException | NoSuchMethodException |
                     IllegalArgumentException | ClassCastException x) {
                throw new InternalError(x);
            }
            return null;
        }});
}
```

DirectByteBuffer æ˜¯ MappedByteBuffer çš„å…·ä½“å®ç°ç±»ã€‚å®é™…ä¸Šï¼ŒUtil.newMappedByteBuffer() æ–¹æ³•é€šè¿‡åå°„æœºåˆ¶è·å– DirectByteBuffer çš„æ„é€ å™¨ï¼Œç„¶ååˆ›å»ºä¸€ä¸ª DirectByteBuffer çš„å®ä¾‹ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ªå•ç‹¬ç”¨äºå†…å­˜æ˜ å°„çš„æ„é€ æ–¹æ³•ï¼š

```java
protected DirectByteBuffer(int cap, long addr, FileDescriptor fd, Runnable unmapper) {
    super(-1, 0, cap, cap, fd);
    address = addr;
    cleaner = Cleaner.create(this, unmapper);
    att = null;
}
```

å› æ­¤ï¼Œé™¤äº†å…è®¸åˆ†é…æ“ä½œç³»ç»Ÿçš„ç›´æ¥å†…å­˜ä»¥å¤–ï¼ŒDirectByteBuffer æœ¬èº«ä¹Ÿå…·æœ‰æ–‡ä»¶å†…å­˜æ˜ å°„çš„åŠŸèƒ½ï¼Œè¿™é‡Œä¸åšè¿‡å¤šè¯´æ˜ã€‚æˆ‘ä»¬éœ€è¦å…³æ³¨çš„æ˜¯ï¼ŒDirectByteBuffer åœ¨ MappedByteBuffer çš„åŸºç¡€ä¸Šæä¾›äº†å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å– get() å’Œå†™å…¥ write() çš„æ“ä½œã€‚

- å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»æ“ä½œ

```java
public byte get() {
    return ((unsafe.getByte(ix(nextGetIndex()))));
}

public byte get(int i) {
    return ((unsafe.getByte(ix(checkIndex(i)))));
}
```

- å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºå†™æ“ä½œ

```java
public ByteBuffer put(byte x) {
    unsafe.putByte(ix(nextPutIndex()), ((x)));
    return this;
}

public ByteBuffer put(int i, byte x) {
    unsafe.putByte(ix(checkIndex(i)), ((x)));
    return this;
}
```

å†…å­˜æ˜ åƒæ–‡ä»¶çš„éšæœºè¯»å†™éƒ½æ˜¯å€ŸåŠ© ix() æ–¹æ³•å®ç°å®šä½çš„ï¼Œ ix() æ–¹æ³•é€šè¿‡å†…å­˜æ˜ å°„ç©ºé—´çš„å†…å­˜é¦–åœ°å€ï¼ˆaddressï¼‰å’Œç»™å®šåç§»é‡ i è®¡ç®—å‡ºæŒ‡é’ˆåœ°å€ï¼Œç„¶åç”± unsafe ç±»çš„ get() å’Œ put() æ–¹æ³•å’Œå¯¹æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®è¿›è¡Œè¯»å–æˆ–å†™å…¥ã€‚

```java
private long ix(int i) {
    return address + ((long)i << 0);
}
```

### 8.3. FileChannel

FileChannel æ˜¯ä¸€ä¸ªç”¨äºæ–‡ä»¶è¯»å†™ã€æ˜ å°„å’Œæ“ä½œçš„é€šé“ï¼ŒåŒæ—¶å®ƒåœ¨å¹¶å‘ç¯å¢ƒä¸‹æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸºäº FileInputStreamã€FileOutputStream æˆ–è€… RandomAccessFile çš„ getChannel() æ–¹æ³•å¯ä»¥åˆ›å»ºå¹¶æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶é€šé“ã€‚FileChannel å®šä¹‰äº† transferFrom() å’Œ transferTo() ä¸¤ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå®ƒé€šè¿‡åœ¨é€šé“å’Œé€šé“ä¹‹é—´å»ºç«‹è¿æ¥å®ç°æ•°æ®ä¼ è¾“çš„ã€‚

- transferTo()ï¼šé€šè¿‡ FileChannel æŠŠæ–‡ä»¶é‡Œé¢çš„æºæ•°æ®å†™å…¥ä¸€ä¸ª WritableByteChannel çš„ç›®çš„é€šé“ã€‚

```java
public abstract long transferTo(long position, long count, WritableByteChannel target)
        throws IOException;
```

- transferFrom()ï¼šæŠŠä¸€ä¸ªæºé€šé“ ReadableByteChannel ä¸­çš„æ•°æ®è¯»å–åˆ°å½“å‰ FileChannel çš„æ–‡ä»¶é‡Œé¢ã€‚

```java
public abstract long transferFrom(ReadableByteChannel src, long position, long count)
        throws IOException;
```

ä¸‹é¢ç»™å‡º FileChannel åˆ©ç”¨ transferTo() å’Œ transferFrom() æ–¹æ³•è¿›è¡Œæ•°æ®ä¼ è¾“çš„ä½¿ç”¨ç¤ºä¾‹ï¼š

```java
private static final String CONTENT = "Zero copy implemented by FileChannel";
private static final String SOURCE_FILE = "/source.txt";
private static final String TARGET_FILE = "/target.txt";
private static final String CHARSET = "UTF-8";
```

é¦–å…ˆåœ¨ç±»åŠ è½½æ ¹è·¯å¾„ä¸‹åˆ›å»º source.txt å’Œ target.txt ä¸¤ä¸ªæ–‡ä»¶ï¼Œå¯¹æºæ–‡ä»¶ source.txt æ–‡ä»¶å†™å…¥åˆå§‹åŒ–æ•°æ®ã€‚

```java
@Before
public void setup() {
    Path source = Paths.get(getClassPath(SOURCE_FILE));
    byte[] bytes = CONTENT.getBytes(Charset.forName(CHARSET));
    try (FileChannel fromChannel = FileChannel.open(source, StandardOpenOption.READ,
            StandardOpenOption.WRITE, StandardOpenOption.TRUNCATE_EXISTING)) {
        fromChannel.write(ByteBuffer.wrap(bytes));
    } catch (IOException e) {
        e.printStackTrace();
    }
}
```

å¯¹äº transferTo() æ–¹æ³•è€Œè¨€ï¼Œç›®çš„é€šé“ toChannel å¯ä»¥æ˜¯ä»»æ„çš„å•å‘å­—èŠ‚å†™é€šé“ WritableByteChannelï¼›è€Œå¯¹äº transferFrom() æ–¹æ³•è€Œè¨€ï¼Œæºé€šé“ fromChannel å¯ä»¥æ˜¯ä»»æ„çš„å•å‘å­—èŠ‚è¯»é€šé“ ReadableByteChannelã€‚å…¶ä¸­ï¼ŒFileChannelã€SocketChannel å’Œ DatagramChannel ç­‰é€šé“å®ç°äº† WritableByteChannel å’Œ ReadableByteChannel æ¥å£ï¼Œéƒ½æ˜¯åŒæ—¶æ”¯æŒè¯»å†™çš„åŒå‘é€šé“ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œä¸‹é¢ç»™å‡ºåŸºäº FileChannel å®Œæˆ channel-to-channel çš„æ•°æ®ä¼ è¾“ç¤ºä¾‹ã€‚

- é€šè¿‡ transferTo() å°† fromChannel ä¸­çš„æ•°æ®æ‹·è´åˆ° toChannel

```java
@Test
public void transferTo() throws Exception {
    try (FileChannel fromChannel = new RandomAccessFile(
             getClassPath(SOURCE_FILE), "rw").getChannel();
         FileChannel toChannel = new RandomAccessFile(
             getClassPath(TARGET_FILE), "rw").getChannel()) {
        long position = 0L;
        long offset = fromChannel.size();
        fromChannel.transferTo(position, offset, toChannel);
    }
}
```

- é€šè¿‡ transferFrom() å°† fromChannel ä¸­çš„æ•°æ®æ‹·è´åˆ° toChannel

```java
@Test
public void transferFrom() throws Exception {
    try (FileChannel fromChannel = new RandomAccessFile(
             getClassPath(SOURCE_FILE), "rw").getChannel();
         FileChannel toChannel = new RandomAccessFile(
             getClassPath(TARGET_FILE), "rw").getChannel()) {
        long position = 0L;
        long offset = fromChannel.size();
        toChannel.transferFrom(fromChannel, position, offset);
    }
}
```

ä¸‹é¢ä»‹ç» transferTo() å’Œ transferFrom() æ–¹æ³•çš„åº•å±‚å®ç°åŸç†ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•ä¹Ÿæ˜¯ java.nio.channels.FileChannel çš„æŠ½è±¡æ–¹æ³•ï¼Œç”±å­ç±» sun.nio.ch.FileChannelImpl.java å®ç°ã€‚transferTo() å’Œ transferFrom() åº•å±‚éƒ½æ˜¯åŸºäº sendfile å®ç°æ•°æ®ä¼ è¾“çš„ï¼Œå…¶ä¸­ FileChannelImpl.java å®šä¹‰äº† 3 ä¸ªå¸¸é‡ï¼Œç”¨äºæ ‡ç¤ºå½“å‰æ“ä½œç³»ç»Ÿçš„å†…æ ¸æ˜¯å¦æ”¯æŒ sendfile ä»¥åŠ sendfile çš„ç›¸å…³ç‰¹æ€§ã€‚

```java
private static volatile boolean transferSupported = true;
private static volatile boolean pipeSupported = true;
private static volatile boolean fileSupported = true;
```

- transferSupportedï¼šç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒ sendfile() è°ƒç”¨ï¼Œé»˜è®¤ä¸º trueã€‚
- pipeSupportedï¼šç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰åŸºäºç®¡é“ï¼ˆpipeï¼‰çš„ sendfile() è°ƒç”¨ï¼Œé»˜è®¤ä¸º trueã€‚
- fileSupportedï¼šç”¨äºæ ‡è®°å½“å‰çš„ç³»ç»Ÿå†…æ ¸æ˜¯å¦æ”¯æŒæ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰åŸºäºæ–‡ä»¶ï¼ˆfileï¼‰çš„ sendfile() è°ƒç”¨ï¼Œé»˜è®¤ä¸º trueã€‚

ä¸‹é¢ä»¥ transferTo() çš„æºç å®ç°ä¸ºä¾‹ã€‚FileChannelImpl é¦–å…ˆæ‰§è¡Œ transferToDirectly() æ–¹æ³•ï¼Œä»¥ sendfile çš„é›¶æ‹·è´æ–¹å¼å°è¯•æ•°æ®æ‹·è´ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒ sendfileï¼Œè¿›ä¸€æ­¥æ‰§è¡Œ transferToTrustedChannel() æ–¹æ³•ï¼Œä»¥ mmap çš„é›¶æ‹·è´æ–¹å¼è¿›è¡Œå†…å­˜æ˜ å°„ï¼Œè¿™ç§æƒ…å†µä¸‹ç›®çš„é€šé“å¿…é¡»æ˜¯ FileChannelImpl æˆ–è€… SelChImpl ç±»å‹ã€‚å¦‚æœä»¥ä¸Šä¸¤æ­¥éƒ½å¤±è´¥äº†ï¼Œåˆ™æ‰§è¡Œ transferToArbitraryChannel() æ–¹æ³•ï¼ŒåŸºäºä¼ ç»Ÿçš„ I/O æ–¹å¼å®Œæˆè¯»å†™ï¼Œå…·ä½“æ­¥éª¤æ˜¯åˆå§‹åŒ–ä¸€ä¸ªä¸´æ—¶çš„ DirectBufferï¼Œå°†æºé€šé“ FileChannel çš„æ•°æ®è¯»å–åˆ° DirectBufferï¼Œå†å†™å…¥ç›®çš„é€šé“ WritableByteChannel é‡Œé¢ã€‚

```java
public long transferTo(long position, long count, WritableByteChannel target)
        throws IOException {
    // è®¡ç®—æ–‡ä»¶çš„å¤§å°
    long sz = size();
    // æ ¡éªŒèµ·å§‹ä½ç½®
    if (position > sz)
        return 0;
    int icount = (int)Math.min(count, Integer.MAX_VALUE);
    // æ ¡éªŒåç§»é‡
    if ((sz - position) < icount)
        icount = (int)(sz - position);

    long n;

    if ((n = transferToDirectly(position, icount, target)) >= 0)
        return n;

    if ((n = transferToTrustedChannel(position, icount, target)) >= 0)
        return n;

    return transferToArbitraryChannel(position, icount, target);
}
```

æ¥ä¸‹æ¥é‡ç‚¹åˆ†æä¸€ä¸‹ transferToDirectly() æ–¹æ³•çš„å®ç°ï¼Œä¹Ÿå°±æ˜¯ transferTo() é€šè¿‡ sendfile å®ç°é›¶æ‹·è´çš„ç²¾é«“æ‰€åœ¨ã€‚å¯ä»¥çœ‹åˆ°ï¼ŒtransferToDirectlyInternal() æ–¹æ³•å…ˆè·å–åˆ°ç›®çš„é€šé“ WritableByteChannel çš„æ–‡ä»¶æè¿°ç¬¦ targetFDï¼Œè·å–åŒæ­¥é”ç„¶åæ‰§è¡Œ transferToDirectlyInternal() æ–¹æ³•ã€‚

```java
private long transferToDirectly(long position, int icount, WritableByteChannel target)
        throws IOException {
    // çœç•¥ä»targetè·å–targetFDçš„è¿‡ç¨‹
    if (nd.transferToDirectlyNeedsPositionLock()) {
        synchronized (positionLock) {
            long pos = position();
            try {
                return transferToDirectlyInternal(position, icount,
                        target, targetFD);
            } finally {
                position(pos);
            }
        }
    } else {
        return transferToDirectlyInternal(position, icount, target, targetFD);
    }
}
```

æœ€ç»ˆç”± transferToDirectlyInternal() è°ƒç”¨æœ¬åœ°æ–¹æ³• transferTo0() ï¼Œå°è¯•ä»¥ sendfile çš„æ–¹å¼è¿›è¡Œæ•°æ®ä¼ è¾“ã€‚å¦‚æœç³»ç»Ÿå†…æ ¸å®Œå…¨ä¸æ”¯æŒ sendfileï¼Œæ¯”å¦‚ Windows æ“ä½œç³»ç»Ÿï¼Œåˆ™è¿”å› UNSUPPORTED å¹¶æŠŠ transferSupported æ ‡è¯†ä¸º falseã€‚å¦‚æœç³»ç»Ÿå†…æ ¸ä¸æ”¯æŒ sendfile çš„ä¸€äº›ç‰¹æ€§ï¼Œæ¯”å¦‚è¯´ä½ç‰ˆæœ¬çš„ Linux å†…æ ¸ä¸æ”¯æŒ DMA gather copy æ“ä½œï¼Œåˆ™è¿”å› UNSUPPORTED_CASE å¹¶æŠŠ pipeSupported æˆ–è€… fileSupported æ ‡è¯†ä¸º falseã€‚

```java
private long transferToDirectlyInternal(long position, int icount,
                                        WritableByteChannel target,
                                        FileDescriptor targetFD) throws IOException {
    assert !nd.transferToDirectlyNeedsPositionLock() ||
            Thread.holdsLock(positionLock);

    long n = -1;
    int ti = -1;
    try {
        begin();
        ti = threads.add();
        if (!isOpen())
            return -1;
        do {
            n = transferTo0(fd, position, icount, targetFD);
        } while ((n == IOStatus.INTERRUPTED) && isOpen());
        if (n == IOStatus.UNSUPPORTED_CASE) {
            if (target instanceof SinkChannelImpl)
                pipeSupported = false;
            if (target instanceof FileChannelImpl)
                fileSupported = false;
            return IOStatus.UNSUPPORTED_CASE;
        }
        if (n == IOStatus.UNSUPPORTED) {
            transferSupported = false;
            return IOStatus.UNSUPPORTED;
        }
        return IOStatus.normalize(n);
    } finally {
        threads.remove(ti);
        end (n > -1);
    }
}
```

æœ¬åœ°æ–¹æ³•ï¼ˆnative methodï¼‰transferTo0() é€šè¿‡ JNIï¼ˆJava Native Interfaceï¼‰è°ƒç”¨åº•å±‚ C çš„å‡½æ•°ï¼Œè¿™ä¸ª native å‡½æ•°ï¼ˆJava_sun_nio_ch_FileChannelImpl_transferTo0ï¼‰åŒæ ·ä½äº JDK æºç åŒ…ä¸‹çš„ native/sun/nio/ch/FileChannelImpl.c æºæ–‡ä»¶é‡Œé¢ã€‚JNI å‡½æ•° Java_sun_nio_ch_FileChannelImpl_transferTo0() åŸºäºæ¡ä»¶ç¼–è¯‘å¯¹ä¸åŒçš„ç³»ç»Ÿè¿›è¡Œé¢„ç¼–è¯‘ï¼Œä¸‹é¢æ˜¯ JDK åŸºäº Linux ç³»ç»Ÿå†…æ ¸å¯¹ transferTo() æä¾›çš„è°ƒç”¨å°è£…ã€‚

```java
#if defined(__linux__) || defined(__solaris__)
#include <sys/sendfile.h>
#elif defined(_AIX)
#include <sys/socket.h>
#elif defined(_ALLBSD_SOURCE)
#include <sys/types.h>
#include <sys/socket.h>
#include <sys/uio.h>

#define lseek64 lseek
#define mmap64 mmap
#endif

JNIEXPORT jlong JNICALL
Java_sun_nio_ch_FileChannelImpl_transferTo0(JNIEnv *env, jobject this,
                                            jobject srcFDO,
                                            jlong position, jlong count,
                                            jobject dstFDO)
{
    jint srcFD = fdval(env, srcFDO);
    jint dstFD = fdval(env, dstFDO);

#if defined(__linux__)
    off64_t offset = (off64_t)position;
    jlong n = sendfile64(dstFD, srcFD, &offset, (size_t)count);
    return n;
#elif defined(__solaris__)
    result = sendfilev64(dstFD, &sfv, 1, &numBytes);    
    return result;
#elif defined(__APPLE__)
    result = sendfile(srcFD, dstFD, position, &numBytes, NULL, 0);
    return result;
#endif
}
```

å¯¹ Linuxã€Solaris ä»¥åŠ Apple ç³»ç»Ÿè€Œè¨€ï¼ŒtransferTo0() å‡½æ•°åº•å±‚ä¼šæ‰§è¡Œ sendfile64 è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å®Œæˆé›¶æ‹·è´æ“ä½œï¼Œsendfile64() å‡½æ•°çš„åŸå‹å¦‚ä¸‹ï¼š

```c
#include <sys/sendfile.h>

ssize_t sendfile64(int out_fd, int in_fd, off_t *offset, size_t count);
```

ä¸‹é¢ç®€å•ä»‹ç»ä¸€ä¸‹ sendfile64() å‡½æ•°å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼š

- out_fdï¼šå¾…å†™å…¥çš„æ–‡ä»¶æè¿°ç¬¦
- in_fdï¼šå¾…è¯»å–çš„æ–‡ä»¶æè¿°ç¬¦
- offsetï¼šæŒ‡å®š in_fd å¯¹åº”æ–‡ä»¶æµçš„è¯»å–ä½ç½®ï¼Œå¦‚æœä¸ºç©ºï¼Œåˆ™é»˜è®¤ä»èµ·å§‹ä½ç½®å¼€å§‹
- countï¼šæŒ‡å®šåœ¨æ–‡ä»¶æè¿°ç¬¦ in_fd å’Œ out_fd ä¹‹é—´ä¼ è¾“çš„å­—èŠ‚æ•°

åœ¨ Linux 2.6.3 ä¹‹å‰ï¼Œout_fd å¿…é¡»æ˜¯ä¸€ä¸ª socketï¼Œè€Œä» Linux 2.6.3 ä»¥åï¼Œout_fd å¯ä»¥æ˜¯ä»»ä½•æ–‡ä»¶ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsendfile64() å‡½æ•°ä¸ä»…å¯ä»¥è¿›è¡Œç½‘ç»œæ–‡ä»¶ä¼ è¾“ï¼Œè¿˜å¯ä»¥å¯¹æœ¬åœ°æ–‡ä»¶å®ç°é›¶æ‹·è´æ“ä½œã€‚

### 9. å…¶å®ƒçš„é›¶æ‹·è´å®ç°

### 9.1. Nettyé›¶æ‹·è´

Netty ä¸­çš„é›¶æ‹·è´å’Œä¸Šé¢æåˆ°çš„æ“ä½œç³»ç»Ÿå±‚é¢ä¸Šçš„é›¶æ‹·è´ä¸å¤ªä¸€æ ·, æˆ‘ä»¬æ‰€è¯´çš„ Netty é›¶æ‹·è´å®Œå…¨æ˜¯åŸºäºï¼ˆJava å±‚é¢ï¼‰ç”¨æˆ·æ€çš„ï¼Œå®ƒçš„æ›´å¤šçš„æ˜¯åå‘äºæ•°æ®æ“ä½œä¼˜åŒ–è¿™æ ·çš„æ¦‚å¿µï¼Œå…·ä½“è¡¨ç°åœ¨ä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š

- Netty é€šè¿‡ DefaultFileRegion ç±»å¯¹ java.nio.channels.FileChannel çš„ tranferTo() æ–¹æ³•è¿›è¡ŒåŒ…è£…ï¼Œåœ¨æ–‡ä»¶ä¼ è¾“æ—¶å¯ä»¥å°†æ–‡ä»¶ç¼“å†²åŒºçš„æ•°æ®ç›´æ¥å‘é€åˆ°ç›®çš„é€šé“ï¼ˆChannelï¼‰
- ByteBuf å¯ä»¥é€šè¿‡ wrap æ“ä½œæŠŠå­—èŠ‚æ•°ç»„ã€ByteBufã€ByteBuffer åŒ…è£…æˆä¸€ä¸ª ByteBuf å¯¹è±¡, è¿›è€Œé¿å…äº†æ‹·è´æ“ä½œ
- ByteBuf æ”¯æŒ slice æ“ä½œ, å› æ­¤å¯ä»¥å°† ByteBuf åˆ†è§£ä¸ºå¤šä¸ªå…±äº«åŒä¸€ä¸ªå­˜å‚¨åŒºåŸŸçš„ ByteBufï¼Œé¿å…äº†å†…å­˜çš„æ‹·è´
- Netty æä¾›äº† CompositeByteBuf ç±»ï¼Œå®ƒå¯ä»¥å°†å¤šä¸ª ByteBuf åˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘ä¸Šçš„ ByteBufï¼Œé¿å…äº†å„ä¸ª ByteBuf ä¹‹é—´çš„æ‹·è´

å…¶ä¸­ç¬¬ 1 æ¡å±äºæ“ä½œç³»ç»Ÿå±‚é¢çš„é›¶æ‹·è´æ“ä½œï¼Œåé¢ 3 æ¡åªèƒ½ç®—ç”¨æˆ·å±‚é¢çš„æ•°æ®æ“ä½œä¼˜åŒ–ã€‚

### 9.2. RocketMQå’ŒKafkaå¯¹æ¯”

RocketMQ é€‰æ‹©äº† mmap + write è¿™ç§é›¶æ‹·è´æ–¹å¼ï¼Œé€‚ç”¨äºä¸šåŠ¡çº§æ¶ˆæ¯è¿™ç§å°å—æ–‡ä»¶çš„æ•°æ®æŒä¹…åŒ–å’Œä¼ è¾“ï¼›è€Œ Kafka é‡‡ç”¨çš„æ˜¯ sendfile è¿™ç§é›¶æ‹·è´æ–¹å¼ï¼Œé€‚ç”¨äºç³»ç»Ÿæ—¥å¿—æ¶ˆæ¯è¿™ç§é«˜ååé‡çš„å¤§å—æ–‡ä»¶çš„æ•°æ®æŒä¹…åŒ–å’Œä¼ è¾“ã€‚ä½†æ˜¯å€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼ŒKafka çš„ç´¢å¼•æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ mmap + write æ–¹å¼ï¼Œæ•°æ®æ–‡ä»¶ä½¿ç”¨çš„æ˜¯ sendfile æ–¹å¼ã€‚

![img](https://pic3.zhimg.com/80/v2-da99a5a5b027c7f374186b55919b0f0e_720w.jpg)

## å°ç»“

æœ¬æ–‡å¼€ç¯‡è¯¦è¿°äº† Linux æ“ä½œç³»ç»Ÿä¸­çš„ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜ï¼Œå†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´çš„æ¦‚å¿µä»¥åŠ Linux å†…éƒ¨çš„å±‚çº§ç»“æ„ã€‚åœ¨æ­¤åŸºç¡€ä¸Šï¼Œè¿›ä¸€æ­¥åˆ†æå’Œå¯¹æ¯”ä¼ ç»Ÿ I/O æ–¹å¼å’Œé›¶æ‹·è´æ–¹å¼çš„åŒºåˆ«ï¼Œç„¶åä»‹ç»äº† Linux å†…æ ¸æä¾›çš„å‡ ç§é›¶æ‹·è´å®ç°ï¼ŒåŒ…æ‹¬å†…å­˜æ˜ å°„ mmapã€sendfileã€sendfile + DMA gather copy ä»¥åŠ splice å‡ ç§æœºåˆ¶ï¼Œå¹¶ä»ç³»ç»Ÿè°ƒç”¨å’Œæ‹·è´æ¬¡æ•°å±‚é¢å¯¹å®ƒä»¬è¿›è¡Œäº†å¯¹æ¯”ã€‚æ¥ä¸‹æ¥ä»æºç ç€æ‰‹åˆ†æäº† Java NIO å¯¹é›¶æ‹·è´çš„å®ç°ï¼Œä¸»è¦åŒ…æ‹¬åŸºäºå†…å­˜æ˜ å°„ï¼ˆmmapï¼‰æ–¹å¼çš„ MappedByteBuffer ä»¥åŠåŸºäº sendfile æ–¹å¼çš„ FileChannelã€‚æœ€ååœ¨ç¯‡æœ«ç®€å•çš„é˜è¿°äº†ä¸€ä¸‹ Netty ä¸­çš„é›¶æ‹·è´æœºåˆ¶ï¼Œä»¥åŠ RocketMQ å’Œ Kafka ä¸¤ç§æ¶ˆæ¯é˜Ÿåˆ—åœ¨é›¶æ‹·è´å®ç°æ–¹å¼ä¸Šçš„åŒºåˆ«ã€‚



## å‚è€ƒæ–‡ç« 

- æœ¬æ–‡è½¬è½½è‡ª[é›¶å£¹æŠ€æœ¯æ ˆ](https://zhuanlan.zhihu.com/p/83398714)