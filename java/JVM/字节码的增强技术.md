**<span style="font-size: 35px;">ğŸ§ JVM åŸºç¡€Â  å­—èŠ‚ç çš„å¢å¼ºæŠ€æœ¯</span>**

---

## å­—èŠ‚ç å¢å¼ºæŠ€æœ¯

åœ¨ä¸Šæ–‡ä¸­ï¼Œç€é‡ä»‹ç»äº†å­—èŠ‚ç çš„ç»“æ„ï¼Œè¿™ä¸ºæˆ‘ä»¬äº†è§£å­—èŠ‚ç å¢å¼ºæŠ€æœ¯çš„å®ç°æ‰“ä¸‹äº†åŸºç¡€ã€‚å­—èŠ‚ç å¢å¼ºæŠ€æœ¯å°±æ˜¯ä¸€ç±»å¯¹ç°æœ‰å­—èŠ‚ç è¿›è¡Œä¿®æ”¹æˆ–è€…åŠ¨æ€ç”Ÿæˆå…¨æ–°å­—èŠ‚ç æ–‡ä»¶çš„æŠ€æœ¯ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†ä»æœ€ç›´æ¥æ“çºµå­—èŠ‚ç çš„å®ç°æ–¹å¼å¼€å§‹æ·±å…¥è¿›è¡Œå‰–æ

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/adc1c6ca-f735-472a-8e1e-7f8a131caf0b_java-class-enhancer-1.png)

### ASM

å¯¹äºéœ€è¦æ‰‹åŠ¨æ“çºµå­—èŠ‚ç çš„éœ€æ±‚ï¼Œå¯ä»¥ä½¿ç”¨ASMï¼Œå®ƒå¯ä»¥ç›´æ¥ç”Ÿäº§ .classå­—èŠ‚ç æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥åœ¨ç±»è¢«åŠ è½½å…¥JVMä¹‹å‰åŠ¨æ€ä¿®æ”¹ç±»è¡Œä¸ºï¼ˆå¦‚ä¸‹å›¾17æ‰€ç¤ºï¼‰ã€‚ASMçš„åº”ç”¨åœºæ™¯æœ‰AOPï¼ˆCglibå°±æ˜¯åŸºäºASMï¼‰ã€çƒ­éƒ¨ç½²ã€ä¿®æ”¹å…¶ä»–jaråŒ…ä¸­çš„ç±»ç­‰ã€‚å½“ç„¶ï¼Œæ¶‰åŠåˆ°å¦‚æ­¤åº•å±‚çš„æ­¥éª¤ï¼Œå®ç°èµ·æ¥ä¹Ÿæ¯”è¾ƒéº»çƒ¦ã€‚æ¥ä¸‹æ¥ï¼Œæœ¬æ–‡å°†ä»‹ç»ASMçš„ä¸¤ç§APIï¼Œå¹¶ç”¨ASMæ¥å®ç°ä¸€ä¸ªæ¯”è¾ƒç²—ç³™çš„AOPã€‚ä½†åœ¨æ­¤ä¹‹å‰ï¼Œä¸ºäº†è®©å¤§å®¶æ›´å¿«åœ°ç†è§£ASMçš„å¤„ç†æµç¨‹ï¼Œå¼ºçƒˆå»ºè®®è¯»è€…å…ˆå¯¹è®¿é—®è€…æ¨¡å¼è¿›è¡Œäº†è§£ã€‚ç®€å•æ¥è¯´ï¼Œè®¿é—®è€…æ¨¡å¼ä¸»è¦ç”¨äºä¿®æ”¹æˆ–æ“ä½œä¸€äº›æ•°æ®ç»“æ„æ¯”è¾ƒç¨³å®šçš„æ•°æ®ï¼Œè€Œé€šè¿‡ç¬¬ä¸€ç« ï¼Œæˆ‘ä»¬çŸ¥é“å­—èŠ‚ç æ–‡ä»¶çš„ç»“æ„æ˜¯ç”±JVMå›ºå®šçš„ï¼Œæ‰€ä»¥å¾ˆé€‚åˆåˆ©ç”¨è®¿é—®è€…æ¨¡å¼å¯¹å­—èŠ‚ç æ–‡ä»¶è¿›è¡Œä¿®æ”¹ã€‚

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/8e349f75-0027-451d-8d5f-8e19a9c64c7b_java-class-enhancer-2.png)

#### ASM API

##### æ ¸å¿ƒAPI

ASM Core APIå¯ä»¥ç±»æ¯”è§£æXMLæ–‡ä»¶ä¸­çš„SAXæ–¹å¼ï¼Œä¸éœ€è¦æŠŠè¿™ä¸ªç±»çš„æ•´ä¸ªç»“æ„è¯»å–è¿›æ¥ï¼Œå°±å¯ä»¥ç”¨æµå¼çš„æ–¹æ³•æ¥å¤„ç†å­—èŠ‚ç æ–‡ä»¶ã€‚å¥½å¤„æ˜¯éå¸¸èŠ‚çº¦å†…å­˜ï¼Œä½†æ˜¯ç¼–ç¨‹éš¾åº¦è¾ƒå¤§ã€‚ç„¶è€Œå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ç¼–ç¨‹éƒ½ä½¿ç”¨Core APIã€‚åœ¨Core APIä¸­æœ‰ä»¥ä¸‹å‡ ä¸ªå…³é”®ç±»ï¼š

- ClassReaderï¼šç”¨äºè¯»å–å·²ç»ç¼–è¯‘å¥½çš„.classæ–‡ä»¶ã€‚
- ClassWriterï¼šç”¨äºé‡æ–°æ„å»ºç¼–è¯‘åçš„ç±»ï¼Œå¦‚ä¿®æ”¹ç±»åã€å±æ€§ä»¥åŠæ–¹æ³•ï¼Œä¹Ÿå¯ä»¥ç”Ÿæˆæ–°çš„ç±»çš„å­—èŠ‚ç æ–‡ä»¶ã€‚
- å„ç§Visitorç±»ï¼šå¦‚ä¸Šæ‰€è¿°ï¼ŒCoreAPIæ ¹æ®å­—èŠ‚ç ä»ä¸Šåˆ°ä¸‹ä¾æ¬¡å¤„ç†ï¼Œå¯¹äºå­—èŠ‚ç æ–‡ä»¶ä¸­ä¸åŒçš„åŒºåŸŸæœ‰ä¸åŒçš„Visitorï¼Œæ¯”å¦‚ç”¨äºè®¿é—®æ–¹æ³•çš„MethodVisitorã€ç”¨äºè®¿é—®ç±»å˜é‡çš„FieldVisitorã€ç”¨äºè®¿é—®æ³¨è§£çš„AnnotationVisitorç­‰ã€‚ä¸ºäº†å®ç°AOPï¼Œé‡ç‚¹è¦ä½¿ç”¨çš„æ˜¯MethodVisitorã€‚

##### æ ‘å½¢API

ASM Tree APIå¯ä»¥ç±»æ¯”è§£æXMLæ–‡ä»¶ä¸­çš„DOMæ–¹å¼ï¼ŒæŠŠæ•´ä¸ªç±»çš„ç»“æ„è¯»å–åˆ°å†…å­˜ä¸­ï¼Œç¼ºç‚¹æ˜¯æ¶ˆè€—å†…å­˜å¤šï¼Œä½†æ˜¯ç¼–ç¨‹æ¯”è¾ƒç®€å•ã€‚TreeApiä¸åŒäºCoreAPIï¼ŒTreeAPIé€šè¿‡å„ç§Nodeç±»æ¥æ˜ å°„å­—èŠ‚ç çš„å„ä¸ªåŒºåŸŸï¼Œç±»æ¯”DOMèŠ‚ç‚¹ï¼Œå°±å¯ä»¥å¾ˆå¥½åœ°ç†è§£è¿™ç§ç¼–ç¨‹æ–¹å¼ã€‚

#### ç›´æ¥åˆ©ç”¨ASMå®ç°AOP

åˆ©ç”¨ASMçš„CoreAPIæ¥å¢å¼ºç±»ã€‚è¿™é‡Œä¸çº ç»“äºAOPçš„ä¸“ä¸šåè¯å¦‚åˆ‡ç‰‡ã€é€šçŸ¥ï¼Œåªå®ç°åœ¨æ–¹æ³•è°ƒç”¨å‰ã€åå¢åŠ é€»è¾‘ï¼Œé€šä¿—æ˜“æ‡‚ä¸”æ–¹ä¾¿ç†è§£ã€‚é¦–å…ˆå®šä¹‰éœ€è¦è¢«å¢å¼ºçš„Baseç±»ï¼šå…¶ä¸­åªåŒ…å«ä¸€ä¸ªprocess()æ–¹æ³•ï¼Œæ–¹æ³•å†…è¾“å‡ºä¸€è¡Œâ€œprocessâ€ã€‚å¢å¼ºåï¼Œæˆ‘ä»¬æœŸæœ›çš„æ˜¯ï¼Œæ–¹æ³•æ‰§è¡Œå‰è¾“å‡ºâ€œstartâ€ï¼Œä¹‹åè¾“å‡ºâ€endâ€ã€‚

```java
public class Base {
    public void process(){
        System.out.println("process");
    }
}
```

ä¸ºäº†åˆ©ç”¨ASMå®ç°AOPï¼Œéœ€è¦å®šä¹‰ä¸¤ä¸ªç±»ï¼šä¸€ä¸ªæ˜¯MyClassVisitorç±»ï¼Œç”¨äºå¯¹å­—èŠ‚ç çš„visitä»¥åŠä¿®æ”¹ï¼›å¦ä¸€ä¸ªæ˜¯Generatorç±»ï¼Œåœ¨è¿™ä¸ªç±»ä¸­å®šä¹‰ClassReaderå’ŒClassWriterï¼Œå…¶ä¸­çš„é€»è¾‘æ˜¯ï¼ŒclassReaderè¯»å–å­—èŠ‚ç ï¼Œç„¶åäº¤ç»™MyClassVisitorç±»å¤„ç†ï¼Œå¤„ç†å®Œæˆåç”±ClassWriterå†™å­—èŠ‚ç å¹¶å°†æ—§çš„å­—èŠ‚ç æ›¿æ¢æ‰ã€‚Generatorç±»è¾ƒç®€å•ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹å®ƒçš„å®ç°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œç„¶åé‡ç‚¹è§£é‡ŠMyClassVisitorç±»ã€‚

```java
import org.objectweb.asm.ClassReader;
import org.objectweb.asm.ClassVisitor;
import org.objectweb.asm.ClassWriter;

public class Generator {
    public static void main(String[] args) throws Exception {
		//è¯»å–
        ClassReader classReader = new ClassReader("meituan/bytecode/asm/Base");
        ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);
        //å¤„ç†
        ClassVisitor classVisitor = new MyClassVisitor(classWriter);
        classReader.accept(classVisitor, ClassReader.SKIP_DEBUG);
        byte[] data = classWriter.toByteArray();
        //è¾“å‡º
        File f = new File("operation-server/target/classes/meituan/bytecode/asm/Base.class");
        FileOutputStream fout = new FileOutputStream(f);
        fout.write(data);
        fout.close();
        System.out.println("now generator cc success!!!!!");
    }
}
```

MyClassVisitorç»§æ‰¿è‡ªClassVisitorï¼Œç”¨äºå¯¹å­—èŠ‚ç çš„è§‚å¯Ÿã€‚å®ƒè¿˜åŒ…å«ä¸€ä¸ªå†…éƒ¨ç±»MyMethodVisitorï¼Œç»§æ‰¿è‡ªMethodVisitorç”¨äºå¯¹ç±»å†…æ–¹æ³•çš„è§‚å¯Ÿï¼Œå®ƒçš„æ•´ä½“ä»£ç å¦‚ä¸‹ï¼š

```java
import org.objectweb.asm.ClassVisitor;
import org.objectweb.asm.MethodVisitor;
import org.objectweb.asm.Opcodes;

public class MyClassVisitor extends ClassVisitor implements Opcodes {
    public MyClassVisitor(ClassVisitor cv) {
        super(ASM5, cv);
    }
    @Override
    public void visit(int version, int access, String name, String signature,
                      String superName, String[] interfaces) {
        cv.visit(version, access, name, signature, superName, interfaces);
    }
    @Override
    public MethodVisitor visitMethod(int access, String name, String desc, String signature, String[] exceptions) {
        MethodVisitor mv = cv.visitMethod(access, name, desc, signature,
                exceptions);
        //Baseç±»ä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼šæ— å‚æ„é€ ä»¥åŠprocessæ–¹æ³•ï¼Œè¿™é‡Œä¸å¢å¼ºæ„é€ æ–¹æ³•
        if (!name.equals("<init>") && mv != null) {
            mv = new MyMethodVisitor(mv);
        }
        return mv;
    }
    class MyMethodVisitor extends MethodVisitor implements Opcodes {
        public MyMethodVisitor(MethodVisitor mv) {
            super(Opcodes.ASM5, mv);
        }

        @Override
        public void visitCode() {
            super.visitCode();
            mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
            mv.visitLdcInsn("start");
            mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);
        }
        @Override
        public void visitInsn(int opcode) {
            if ((opcode >= Opcodes.IRETURN && opcode <= Opcodes.RETURN)
                    || opcode == Opcodes.ATHROW) {
                //æ–¹æ³•åœ¨è¿”å›ä¹‹å‰ï¼Œæ‰“å°"end"
                mv.visitFieldInsn(GETSTATIC, "java/lang/System", "out", "Ljava/io/PrintStream;");
                mv.visitLdcInsn("end");
                mv.visitMethodInsn(INVOKEVIRTUAL, "java/io/PrintStream", "println", "(Ljava/lang/String;)V", false);
            }
            mv.visitInsn(opcode);
        }
    }
}
```

åˆ©ç”¨è¿™ä¸ªç±»å°±å¯ä»¥å®ç°å¯¹å­—èŠ‚ç çš„ä¿®æ”¹ã€‚è¯¦ç»†è§£è¯»å…¶ä¸­çš„ä»£ç ï¼Œå¯¹å­—èŠ‚ç åšä¿®æ”¹çš„æ­¥éª¤æ˜¯ï¼š

- é¦–å…ˆé€šè¿‡MyClassVisitorç±»ä¸­çš„visitMethodæ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰å­—èŠ‚ç è¯»åˆ°å“ªä¸€ä¸ªæ–¹æ³•äº†ã€‚è·³è¿‡æ„é€ æ–¹æ³• `<init>` åï¼Œå°†éœ€è¦è¢«å¢å¼ºçš„æ–¹æ³•äº¤ç»™å†…éƒ¨ç±»MyMethodVisitoræ¥è¿›è¡Œå¤„ç†ã€‚
- æ¥ä¸‹æ¥ï¼Œè¿›å…¥å†…éƒ¨ç±»MyMethodVisitorä¸­çš„visitCodeæ–¹æ³•ï¼Œå®ƒä¼šåœ¨ASMå¼€å§‹è®¿é—®æŸä¸€ä¸ªæ–¹æ³•çš„CodeåŒºæ—¶è¢«è°ƒç”¨ï¼Œé‡å†™visitCodeæ–¹æ³•ï¼Œå°†AOPä¸­çš„å‰ç½®é€»è¾‘å°±æ”¾åœ¨è¿™é‡Œã€‚ MyMethodVisitorç»§ç»­è¯»å–å­—èŠ‚ç æŒ‡ä»¤ï¼Œæ¯å½“ASMè®¿é—®åˆ°æ— å‚æ•°æŒ‡ä»¤æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨MyMethodVisitorä¸­çš„visitInsnæ–¹æ³•ã€‚æˆ‘ä»¬åˆ¤æ–­äº†å½“å‰æŒ‡ä»¤æ˜¯å¦ä¸ºæ— å‚æ•°çš„â€œreturnâ€æŒ‡ä»¤ï¼Œå¦‚æœæ˜¯å°±åœ¨å®ƒçš„å‰é¢æ·»åŠ ä¸€äº›æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯å°†AOPçš„åç½®é€»è¾‘æ”¾åœ¨è¯¥æ–¹æ³•ä¸­ã€‚
- ç»¼ä¸Šï¼Œé‡å†™MyMethodVisitorä¸­çš„ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±å¯ä»¥å®ç°AOPäº†ï¼Œè€Œé‡å†™æ–¹æ³•æ—¶å°±éœ€è¦ç”¨ASMçš„å†™æ³•ï¼Œæ‰‹åŠ¨å†™å…¥æˆ–è€…ä¿®æ”¹å­—èŠ‚ç ã€‚é€šè¿‡è°ƒç”¨methodVisitorçš„visitXXXXInsn()æ–¹æ³•å°±å¯ä»¥å®ç°å­—èŠ‚ç çš„æ’å…¥ï¼ŒXXXXå¯¹åº”ç›¸åº”çš„æ“ä½œç åŠ©è®°ç¬¦ç±»å‹ï¼Œæ¯”å¦‚mv.visitLdcInsn(â€œendâ€)å¯¹åº”çš„æ“ä½œç å°±æ˜¯ldc â€œendâ€ï¼Œå³å°†å­—ç¬¦ä¸²â€œendâ€å‹å…¥æ ˆã€‚ å®Œæˆè¿™ä¸¤ä¸ªvisitorç±»åï¼Œè¿è¡ŒGeneratorä¸­çš„mainæ–¹æ³•å®Œæˆå¯¹Baseç±»çš„å­—èŠ‚ç å¢å¼ºï¼Œå¢å¼ºåçš„ç»“æœå¯ä»¥åœ¨ç¼–è¯‘åçš„targetæ–‡ä»¶å¤¹ä¸­æ‰¾åˆ°Base.classæ–‡ä»¶è¿›è¡ŒæŸ¥çœ‹ï¼Œå¯ä»¥çœ‹åˆ°åç¼–è¯‘åçš„ä»£ç å·²ç»æ”¹å˜äº†ã€‚ç„¶åå†™ä¸€ä¸ªæµ‹è¯•ç±»MyTestï¼Œåœ¨å…¶ä¸­new Base()ï¼Œå¹¶è°ƒç”¨base.process()æ–¹æ³•ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹å›¾å³ä¾§æ‰€ç¤ºçš„AOPå®ç°æ•ˆæœï¼š

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/19068b4b-0304-4c77-8792-9075b52b5852_java-class-enhancer-3.png)

#### ASMå·¥å…·

åˆ©ç”¨ASMæ‰‹å†™å­—èŠ‚ç æ—¶ï¼Œéœ€è¦åˆ©ç”¨ä¸€ç³»åˆ—visitXXXXInsn()æ–¹æ³•æ¥å†™å¯¹åº”çš„åŠ©è®°ç¬¦ï¼Œæ‰€ä»¥éœ€è¦å…ˆå°†æ¯ä¸€è¡Œæºä»£ç è½¬åŒ–ä¸ºä¸€ä¸ªä¸ªçš„åŠ©è®°ç¬¦ï¼Œç„¶åé€šè¿‡ASMçš„è¯­æ³•è½¬æ¢ä¸ºvisitXXXXInsn()è¿™ç§å†™æ³•ã€‚ç¬¬ä¸€æ­¥å°†æºç è½¬åŒ–ä¸ºåŠ©è®°ç¬¦å°±å·²ç»å¤Ÿéº»çƒ¦äº†ï¼Œä¸ç†Ÿæ‚‰å­—èŠ‚ç æ“ä½œé›†åˆçš„è¯ï¼Œéœ€è¦æˆ‘ä»¬å°†ä»£ç ç¼–è¯‘åå†åç¼–è¯‘ï¼Œæ‰èƒ½å¾—åˆ°æºä»£ç å¯¹åº”çš„åŠ©è®°ç¬¦ã€‚ç¬¬äºŒæ­¥åˆ©ç”¨ASMå†™å­—èŠ‚ç æ—¶ï¼Œå¦‚ä½•ä¼ å‚ä¹Ÿå¾ˆä»¤äººå¤´ç–¼ã€‚ASMç¤¾åŒºä¹ŸçŸ¥é“è¿™ä¸¤ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æä¾›äº†å·¥å…·[ASM ByteCode Outline  (opens new window)](https://plugins.jetbrains.com/plugin/5918-asm-bytecode-outline)ã€‚

å®‰è£…åï¼Œå³é”®é€‰æ‹©â€œShow Bytecode Outlineâ€ï¼Œåœ¨æ–°æ ‡ç­¾é¡µä¸­é€‰æ‹©â€œASMifiedâ€è¿™ä¸ªtabï¼Œå¦‚å›¾19æ‰€ç¤ºï¼Œå°±å¯ä»¥çœ‹åˆ°è¿™ä¸ªç±»ä¸­çš„ä»£ç å¯¹åº”çš„ASMå†™æ³•äº†ã€‚å›¾ä¸­ä¸Šä¸‹ä¸¤ä¸ªçº¢æ¡†åˆ†åˆ«å¯¹åº”AOPä¸­çš„å‰ç½®é€»è¾‘äºåç½®é€»è¾‘ï¼Œå°†è¿™ä¸¤å—ç›´æ¥å¤åˆ¶åˆ°visitorä¸­çš„visitMethod()ä»¥åŠvisitInsn()æ–¹æ³•ä¸­ï¼Œå°±å¯ä»¥äº†ã€‚

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/d957d177-3f30-43f3-88e6-a0f0c8064542_java-class-enhancer-4.png)

### Javassist

ASMæ˜¯åœ¨æŒ‡ä»¤å±‚æ¬¡ä¸Šæ“ä½œå­—èŠ‚ç çš„ï¼Œé˜…è¯»ä¸Šæ–‡åï¼Œæˆ‘ä»¬çš„ç›´è§‚æ„Ÿå—æ˜¯åœ¨æŒ‡ä»¤å±‚æ¬¡ä¸Šæ“ä½œå­—èŠ‚ç çš„æ¡†æ¶å®ç°èµ·æ¥æ¯”è¾ƒæ™¦æ¶©ã€‚æ•…é™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬å†ç®€å•ä»‹ç»å¦å¤–ä¸€ç±»æ¡†æ¶ï¼šå¼ºè°ƒæºä»£ç å±‚æ¬¡æ“ä½œå­—èŠ‚ç çš„æ¡†æ¶Javassistã€‚

åˆ©ç”¨Javassistå®ç°å­—èŠ‚ç å¢å¼ºæ—¶ï¼Œå¯ä»¥æ— é¡»å…³æ³¨å­—èŠ‚ç åˆ»æ¿çš„ç»“æ„ï¼Œå…¶ä¼˜ç‚¹å°±åœ¨äºç¼–ç¨‹ç®€å•ã€‚ç›´æ¥ä½¿ç”¨javaç¼–ç çš„å½¢å¼ï¼Œè€Œä¸éœ€è¦äº†è§£è™šæ‹ŸæœºæŒ‡ä»¤ï¼Œå°±èƒ½åŠ¨æ€æ”¹å˜ç±»çš„ç»“æ„æˆ–è€…åŠ¨æ€ç”Ÿæˆç±»ã€‚å…¶ä¸­æœ€é‡è¦çš„æ˜¯ClassPoolã€CtClassã€CtMethodã€CtFieldè¿™å››ä¸ªç±»ï¼š

- CtClassï¼ˆcompile-time classï¼‰ï¼šç¼–è¯‘æ—¶ç±»ä¿¡æ¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªclassæ–‡ä»¶åœ¨ä»£ç ä¸­çš„æŠ½è±¡è¡¨ç°å½¢å¼ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–ä¸€ä¸ªCtClasså¯¹è±¡ï¼Œç”¨æ¥è¡¨ç¤ºè¿™ä¸ªç±»æ–‡ä»¶ã€‚
- ClassPoolï¼šä»å¼€å‘è§†è§’æ¥çœ‹ï¼ŒClassPoolæ˜¯ä¸€å¼ ä¿å­˜CtClassä¿¡æ¯çš„HashTableï¼Œkeyä¸ºç±»åï¼Œvalueä¸ºç±»åå¯¹åº”çš„CtClasså¯¹è±¡ã€‚å½“æˆ‘ä»¬éœ€è¦å¯¹æŸä¸ªç±»è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå°±æ˜¯é€šè¿‡pool.getCtClass(â€œclassNameâ€)æ–¹æ³•ä»poolä¸­è·å–åˆ°ç›¸åº”çš„CtClassã€‚
- CtMethodã€CtFieldï¼šè¿™ä¸¤ä¸ªæ¯”è¾ƒå¥½ç†è§£ï¼Œå¯¹åº”çš„æ˜¯ç±»ä¸­çš„æ–¹æ³•å’Œå±æ€§ã€‚

äº†è§£è¿™å››ä¸ªç±»åï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå°Demoæ¥å±•ç¤ºJavassistç®€å•ã€å¿«é€Ÿçš„ç‰¹ç‚¹ã€‚æˆ‘ä»¬ä¾ç„¶æ˜¯å¯¹Baseä¸­çš„process()æ–¹æ³•åšå¢å¼ºï¼Œåœ¨æ–¹æ³•è°ƒç”¨å‰ååˆ†åˆ«è¾“å‡ºâ€startâ€å’Œâ€endâ€ï¼Œå®ç°ä»£ç å¦‚ä¸‹ã€‚æˆ‘ä»¬éœ€è¦åšçš„å°±æ˜¯ä»poolä¸­è·å–åˆ°ç›¸åº”çš„CtClasså¯¹è±¡å’Œå…¶ä¸­çš„æ–¹æ³•ï¼Œç„¶åæ‰§è¡Œmethod.insertBeforeå’ŒinsertAfteræ–¹æ³•ï¼Œå‚æ•°ä¸ºè¦æ’å…¥çš„Javaä»£ç ï¼Œå†ä»¥å­—ç¬¦ä¸²çš„å½¢å¼ä¼ å…¥å³å¯ï¼Œå®ç°èµ·æ¥ä¹Ÿæä¸ºç®€å•ã€‚

```java
import com.meituan.mtrace.agent.javassist.*;

public class JavassistTest {
    public static void main(String[] args) throws NotFoundException, CannotCompileException, IllegalAccessException, InstantiationException, IOException {
        ClassPool cp = ClassPool.getDefault();
        CtClass cc = cp.get("meituan.bytecode.javassist.Base");
        CtMethod m = cc.getDeclaredMethod("process");
        m.insertBefore("{ System.out.println(\"start\"); }");
        m.insertAfter("{ System.out.println(\"end\"); }");
        Class c = cc.toClass();
        cc.writeFile("/Users/zen/projects");
        Base h = (Base)c.newInstance();
        h.process();
    }
}
```

## è¿è¡Œæ—¶ç±»çš„é‡è½½

### é—®é¢˜å¼•å‡º

ä¸Šä¸€ç« é‡ç‚¹ä»‹ç»äº†ä¸¤ç§ä¸åŒç±»å‹çš„å­—èŠ‚ç æ“ä½œæ¡†æ¶ï¼Œä¸”éƒ½åˆ©ç”¨å®ƒä»¬å®ç°äº†è¾ƒä¸ºç²—ç³™çš„AOPã€‚å…¶å®ï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ï¼Œåœ¨ä¸Šæ–‡ä¸­æˆ‘ä»¬é¿é‡å°±è½»å°†ASMå®ç°AOPçš„è¿‡ç¨‹åˆ†ä¸ºäº†ä¸¤ä¸ªmainæ–¹æ³•ï¼šç¬¬ä¸€ä¸ªæ˜¯åˆ©ç”¨MyClassVisitorå¯¹å·²ç¼–è¯‘å¥½çš„classæ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œç¬¬äºŒä¸ªæ˜¯newå¯¹è±¡å¹¶è°ƒç”¨ã€‚è¿™æœŸé—´å¹¶ä¸æ¶‰åŠåˆ°JVMè¿è¡Œæ—¶å¯¹ç±»çš„é‡åŠ è½½ï¼Œè€Œæ˜¯åœ¨ç¬¬ä¸€ä¸ªmainæ–¹æ³•ä¸­ï¼Œé€šè¿‡ASMå¯¹å·²ç¼–è¯‘ç±»çš„å­—èŠ‚ç è¿›è¡Œæ›¿æ¢ï¼Œåœ¨ç¬¬äºŒä¸ªmainæ–¹æ³•ä¸­ï¼Œç›´æ¥ä½¿ç”¨å·²æ›¿æ¢å¥½çš„æ–°ç±»ä¿¡æ¯ã€‚å¦å¤–åœ¨Javassistçš„å®ç°ä¸­ï¼Œæˆ‘ä»¬ä¹ŸåªåŠ è½½äº†ä¸€æ¬¡Baseç±»ï¼Œä¹Ÿä¸æ¶‰åŠåˆ°è¿è¡Œæ—¶é‡åŠ è½½ç±»ã€‚

å¦‚æœæˆ‘ä»¬åœ¨ä¸€ä¸ªJVMä¸­ï¼Œå…ˆåŠ è½½äº†ä¸€ä¸ªç±»ï¼Œç„¶ååˆå¯¹å…¶è¿›è¡Œå­—èŠ‚ç å¢å¼ºå¹¶é‡æ–°åŠ è½½ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿæ¨¡æ‹Ÿè¿™ç§æƒ…å†µï¼Œåªéœ€è¦æˆ‘ä»¬åœ¨ä¸Šæ–‡ä¸­Javassistçš„Demoä¸­main()æ–¹æ³•çš„ç¬¬ä¸€è¡Œæ·»åŠ Base b=new Base()ï¼Œå³åœ¨å¢å¼ºå‰å°±å…ˆè®©JVMåŠ è½½Baseç±»ï¼Œç„¶ååœ¨æ‰§è¡Œåˆ°c.toClass()æ–¹æ³•æ—¶ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¦‚ä¸‹å›¾20æ‰€ç¤ºã€‚è·Ÿè¿›c.toClass()æ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°å®ƒæ˜¯åœ¨æœ€åè°ƒç”¨äº†ClassLoaderçš„nativeæ–¹æ³•defineClass()æ—¶æŠ¥é”™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒJVMæ˜¯ä¸å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€é‡è½½ä¸€ä¸ªç±»çš„ã€‚

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/2fd40c93-6b9c-412c-83a0-601774b5376c_java-class-enhancer-5.png)

æ˜¾ç„¶ï¼Œå¦‚æœåªèƒ½åœ¨ç±»åŠ è½½å‰å¯¹ç±»è¿›è¡Œå¼ºåŒ–ï¼Œé‚£å­—èŠ‚ç å¢å¼ºæŠ€æœ¯çš„ä½¿ç”¨åœºæ™¯å°±å˜å¾—å¾ˆçª„äº†ã€‚æˆ‘ä»¬æœŸæœ›çš„æ•ˆæœæ˜¯ï¼šåœ¨ä¸€ä¸ªæŒç»­è¿è¡Œå¹¶å·²ç»åŠ è½½äº†æ‰€æœ‰ç±»çš„JVMä¸­ï¼Œè¿˜èƒ½åˆ©ç”¨å­—èŠ‚ç å¢å¼ºæŠ€æœ¯å¯¹å…¶ä¸­çš„ç±»è¡Œä¸ºåšæ›¿æ¢å¹¶é‡æ–°åŠ è½½ã€‚ä¸ºäº†æ¨¡æ‹Ÿè¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å°†Baseç±»åšæ”¹å†™ï¼Œåœ¨å…¶ä¸­ç¼–å†™mainæ–¹æ³•ï¼Œæ¯äº”ç§’è°ƒç”¨ä¸€æ¬¡process()æ–¹æ³•ï¼Œåœ¨process()æ–¹æ³•ä¸­è¾“å‡ºä¸€è¡Œâ€œprocessâ€ã€‚

æˆ‘ä»¬çš„ç›®çš„å°±æ˜¯ï¼Œåœ¨JVMè¿è¡Œä¸­çš„æ—¶å€™ï¼Œå°†process()æ–¹æ³•åšæ›¿æ¢ï¼Œåœ¨å…¶å‰ååˆ†åˆ«æ‰“å°â€œstartâ€å’Œâ€œendâ€ã€‚ä¹Ÿå°±æ˜¯åœ¨è¿è¡Œä¸­æ—¶ï¼Œæ¯äº”ç§’æ‰“å°çš„å†…å®¹ç”±â€processâ€å˜ä¸ºæ‰“å°â€start process endâ€ã€‚é‚£å¦‚ä½•è§£å†³JVMä¸å…è®¸è¿è¡Œæ—¶é‡åŠ è½½ç±»ä¿¡æ¯çš„é—®é¢˜å‘¢ï¼Ÿä¸ºäº†è¾¾åˆ°è¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥ä¸€ä¸€æ¥ä»‹ç»éœ€è¦å€ŸåŠ©çš„Javaç±»åº“ã€‚

```java
import java.lang.management.ManagementFactory;

public class Base {
    public static void main(String[] args) {
        String name = ManagementFactory.getRuntimeMXBean().getName();
        String s = name.split("@")[0];
        //æ‰“å°å½“å‰Pid
        System.out.println("pid:"+s);
        while (true) {
            try {
                Thread.sleep(5000L);
            } catch (Exception e) {
                break;
            }
            process();
        }
    }

    public static void process() {
        System.out.println("process");
    }
}
```

### Instrument

instrumentæ˜¯JVMæä¾›çš„ä¸€ä¸ªå¯ä»¥ä¿®æ”¹å·²åŠ è½½ç±»çš„ç±»åº“ï¼Œä¸“é—¨ä¸ºJavaè¯­è¨€ç¼–å†™çš„æ’æ¡©æœåŠ¡æä¾›æ”¯æŒã€‚å®ƒéœ€è¦ä¾èµ–JVMTIçš„Attach APIæœºåˆ¶å®ç°ï¼ŒJVMTIè¿™ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å°†åœ¨ä¸‹ä¸€å°èŠ‚è¿›è¡Œä»‹ç»ã€‚åœ¨JDK 1.6ä»¥å‰ï¼Œinstrumentåªèƒ½åœ¨JVMåˆšå¯åŠ¨å¼€å§‹åŠ è½½ç±»æ—¶ç”Ÿæ•ˆï¼Œè€Œåœ¨JDK 1.6ä¹‹åï¼Œinstrumentæ”¯æŒäº†åœ¨è¿è¡Œæ—¶å¯¹ç±»å®šä¹‰çš„ä¿®æ”¹ã€‚è¦ä½¿ç”¨instrumentçš„ç±»ä¿®æ”¹åŠŸèƒ½ï¼Œæˆ‘ä»¬éœ€è¦å®ç°å®ƒæä¾›çš„ClassFileTransformeræ¥å£ï¼Œå®šä¹‰ä¸€ä¸ªç±»æ–‡ä»¶è½¬æ¢å™¨ã€‚æ¥å£ä¸­çš„transform()æ–¹æ³•ä¼šåœ¨ç±»æ–‡ä»¶è¢«åŠ è½½æ—¶è°ƒç”¨ï¼Œè€Œåœ¨transformæ–¹æ³•é‡Œï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸Šæ–‡ä¸­çš„ASMæˆ–Javassistå¯¹ä¼ å…¥çš„å­—èŠ‚ç è¿›è¡Œæ”¹å†™æˆ–æ›¿æ¢ï¼Œç”Ÿæˆæ–°çš„å­—èŠ‚ç æ•°ç»„åè¿”å›ã€‚

æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå®ç°äº†ClassFileTransformeræ¥å£çš„ç±»TestTransformerï¼Œä¾ç„¶åœ¨å…¶ä¸­åˆ©ç”¨Javassistå¯¹Baseç±»ä¸­çš„process()æ–¹æ³•è¿›è¡Œå¢å¼ºï¼Œåœ¨å‰ååˆ†åˆ«æ‰“å°â€œstartâ€å’Œâ€œendâ€ï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
import java.lang.instrument.ClassFileTransformer;

public class TestTransformer implements ClassFileTransformer {
    @Override
    public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) {
        System.out.println("Transforming " + className);
        try {
            ClassPool cp = ClassPool.getDefault();
            CtClass cc = cp.get("meituan.bytecode.jvmti.Base");
            CtMethod m = cc.getDeclaredMethod("process");
            m.insertBefore("{ System.out.println(\"start\"); }");
            m.insertAfter("{ System.out.println(\"end\"); }");
            return cc.toBytecode();
        } catch (Exception e) {
            e.printStackTrace();
        }
        return null;
    }
}  
```

ç°åœ¨æœ‰äº†Transformerï¼Œé‚£ä¹ˆå®ƒè¦å¦‚ä½•æ³¨å…¥åˆ°æ­£åœ¨è¿è¡Œçš„JVMå‘¢ï¼Ÿè¿˜éœ€è¦å®šä¹‰ä¸€ä¸ªAgentï¼Œå€ŸåŠ©Agentçš„èƒ½åŠ›å°†Instrumentæ³¨å…¥åˆ°JVMä¸­ã€‚æˆ‘ä»¬å°†åœ¨ä¸‹ä¸€å°èŠ‚ä»‹ç»Agentï¼Œç°åœ¨è¦ä»‹ç»çš„æ˜¯Agentä¸­ç”¨åˆ°çš„å¦ä¸€ä¸ªç±»Instrumentationã€‚åœ¨JDK 1.6ä¹‹åï¼ŒInstrumentationå¯ä»¥åšå¯åŠ¨åçš„Instrumentã€æœ¬åœ°ä»£ç ï¼ˆNative Codeï¼‰çš„Instrumentï¼Œä»¥åŠåŠ¨æ€æ”¹å˜Classpathç­‰ç­‰ã€‚æˆ‘ä»¬å¯ä»¥å‘Instrumentationä¸­æ·»åŠ ä¸Šæ–‡ä¸­å®šä¹‰çš„Transformerï¼Œå¹¶æŒ‡å®šè¦è¢«é‡åŠ è½½çš„ç±»ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚è¿™æ ·ï¼Œå½“Agentè¢«Attachåˆ°ä¸€ä¸ªJVMä¸­æ—¶ï¼Œå°±ä¼šæ‰§è¡Œç±»å­—èŠ‚ç æ›¿æ¢å¹¶é‡è½½å…¥JVMçš„æ“ä½œã€‚

```java
import java.lang.instrument.Instrumentation;

public class TestAgent {
    public static void agentmain(String args, Instrumentation inst) {
        //æŒ‡å®šæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„Transformerï¼Œåœ¨å…¶ä¸­åˆ©ç”¨Javassiståšå­—èŠ‚ç æ›¿æ¢
        inst.addTransformer(new TestTransformer(), true);
        try {
            //é‡å®šä¹‰ç±»å¹¶è½½å…¥æ–°çš„å­—èŠ‚ç 
            inst.retransformClasses(Base.class);
            System.out.println("Agent Load Done.");
        } catch (Exception e) {
            System.out.println("agent load failed!");
        }
    }
}
```

### JVMTI & Agent & Attach API

ä¸Šä¸€å°èŠ‚ä¸­ï¼Œæˆ‘ä»¬ç»™å‡ºäº†Agentç±»çš„ä»£ç ï¼Œè¿½æ ¹æº¯æºéœ€è¦å…ˆä»‹ç»JPDAï¼ˆJava Platform Debugger Architectureï¼‰ã€‚å¦‚æœJVMå¯åŠ¨æ—¶å¼€å¯äº†JPDAï¼Œé‚£ä¹ˆç±»æ˜¯å…è®¸è¢«é‡æ–°åŠ è½½çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå·²è¢«åŠ è½½çš„æ—§ç‰ˆæœ¬ç±»ä¿¡æ¯å¯ä»¥è¢«å¸è½½ï¼Œç„¶åé‡æ–°åŠ è½½æ–°ç‰ˆæœ¬çš„ç±»ã€‚æ­£å¦‚JDPAåç§°ä¸­çš„Debuggerï¼ŒJDPAå…¶å®æ˜¯ä¸€å¥—ç”¨äºè°ƒè¯•Javaç¨‹åºçš„æ ‡å‡†ï¼Œä»»ä½•JDKéƒ½å¿…é¡»å®ç°è¯¥æ ‡å‡†ã€‚

JPDAå®šä¹‰äº†ä¸€æ•´å¥—å®Œæ•´çš„ä½“ç³»ï¼Œå®ƒå°†è°ƒè¯•ä½“ç³»åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå¹¶è§„å®šäº†ä¸‰è€…ä¹‹é—´çš„é€šä¿¡æ¥å£ã€‚ä¸‰éƒ¨åˆ†ç”±ä½åˆ°é«˜åˆ†åˆ«æ˜¯Java è™šæ‹Ÿæœºå·¥å…·æ¥å£ï¼ˆJVMTIï¼‰ï¼ŒJava è°ƒè¯•åè®®ï¼ˆJDWPï¼‰ä»¥åŠ Java è°ƒè¯•æ¥å£ï¼ˆJDIï¼‰ï¼Œä¸‰è€…ä¹‹é—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/d66bf13b-5cd3-4807-87e7-120ca97a8384_java-class-enhancer-6.png)

ç°åœ¨å›åˆ°æ­£é¢˜ï¼Œæˆ‘ä»¬å¯ä»¥å€ŸåŠ©JVMTIçš„ä¸€éƒ¨åˆ†èƒ½åŠ›ï¼Œå¸®åŠ©åŠ¨æ€é‡è½½ç±»ä¿¡æ¯ã€‚JVM TIï¼ˆJVM TOOL INTERFACEï¼ŒJVMå·¥å…·æ¥å£ï¼‰æ˜¯JVMæä¾›çš„ä¸€å¥—å¯¹JVMè¿›è¡Œæ“ä½œçš„å·¥å…·æ¥å£ã€‚é€šè¿‡JVMTIï¼Œå¯ä»¥å®ç°å¯¹JVMçš„å¤šç§æ“ä½œï¼Œå®ƒé€šè¿‡æ¥å£æ³¨å†Œå„ç§äº‹ä»¶å‹¾å­ï¼Œåœ¨JVMäº‹ä»¶è§¦å‘æ—¶ï¼ŒåŒæ—¶è§¦å‘é¢„å®šä¹‰çš„å‹¾å­ï¼Œä»¥å®ç°å¯¹å„ä¸ªJVMäº‹ä»¶çš„å“åº”ï¼Œäº‹ä»¶åŒ…æ‹¬ç±»æ–‡ä»¶åŠ è½½ã€å¼‚å¸¸äº§ç”Ÿä¸æ•è·ã€çº¿ç¨‹å¯åŠ¨å’Œç»“æŸã€è¿›å…¥å’Œé€€å‡ºä¸´ç•ŒåŒºã€æˆå‘˜å˜é‡ä¿®æ”¹ã€GCå¼€å§‹å’Œç»“æŸã€æ–¹æ³•è°ƒç”¨è¿›å…¥å’Œé€€å‡ºã€ä¸´ç•ŒåŒºç«äº‰ä¸ç­‰å¾…ã€VMå¯åŠ¨ä¸é€€å‡ºç­‰ç­‰ã€‚

è€ŒAgentå°±æ˜¯JVMTIçš„ä¸€ç§å®ç°ï¼ŒAgentæœ‰ä¸¤ç§å¯åŠ¨æ–¹å¼ï¼Œä¸€æ˜¯éšJavaè¿›ç¨‹å¯åŠ¨è€Œå¯åŠ¨ï¼Œç»å¸¸è§åˆ°çš„java -agentlibå°±æ˜¯è¿™ç§æ–¹å¼ï¼›äºŒæ˜¯è¿è¡Œæ—¶è½½å…¥ï¼Œé€šè¿‡attach APIï¼Œå°†æ¨¡å—ï¼ˆjaråŒ…ï¼‰åŠ¨æ€åœ°Attachåˆ°æŒ‡å®šè¿›ç¨‹idçš„Javaè¿›ç¨‹å†…ã€‚

Attach API çš„ä½œç”¨æ˜¯æä¾›JVMè¿›ç¨‹é—´é€šä¿¡çš„èƒ½åŠ›ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬ä¸ºäº†è®©å¦å¤–ä¸€ä¸ªJVMè¿›ç¨‹æŠŠçº¿ä¸ŠæœåŠ¡çš„çº¿ç¨‹Dumpå‡ºæ¥ï¼Œä¼šè¿è¡Œjstackæˆ–jmapçš„è¿›ç¨‹ï¼Œå¹¶ä¼ é€’pidçš„å‚æ•°ï¼Œå‘Šè¯‰å®ƒè¦å¯¹å“ªä¸ªè¿›ç¨‹è¿›è¡Œçº¿ç¨‹Dumpï¼Œè¿™å°±æ˜¯Attach APIåšçš„äº‹æƒ…ã€‚åœ¨ä¸‹é¢ï¼Œæˆ‘ä»¬å°†é€šè¿‡Attach APIçš„loadAgent()æ–¹æ³•ï¼Œå°†æ‰“åŒ…å¥½çš„Agent jaråŒ…åŠ¨æ€Attachåˆ°ç›®æ ‡JVMä¸Šã€‚å…·ä½“å®ç°èµ·æ¥çš„æ­¥éª¤å¦‚ä¸‹ï¼š

- å®šä¹‰Agentï¼Œå¹¶åœ¨å…¶ä¸­å®ç°AgentMainæ–¹æ³•ï¼Œå¦‚ä¸Šä¸€å°èŠ‚ä¸­å®šä¹‰çš„ä»£ç å—7ä¸­çš„TestAgentç±»ï¼›
- ç„¶åå°†TestAgentç±»æ‰“æˆä¸€ä¸ªåŒ…å«MANIFEST.MFçš„jaråŒ…ï¼Œå…¶ä¸­MANIFEST.MFæ–‡ä»¶ä¸­å°†Agent-Classå±æ€§æŒ‡å®šä¸ºTestAgentçš„å…¨é™å®šåï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼›

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/200e79c0-0586-4f92-81a2-d9482dc5b725_java-class-enhancer-7.png)

- æœ€ååˆ©ç”¨Attach APIï¼Œå°†æˆ‘ä»¬æ‰“åŒ…å¥½çš„jaråŒ…Attachåˆ°æŒ‡å®šçš„JVM pidä¸Šï¼Œä»£ç å¦‚ä¸‹ï¼š

```java
import com.sun.tools.attach.VirtualMachine;

public class Attacher {
    public static void main(String[] args) throws AttachNotSupportedException, IOException, AgentLoadException, AgentInitializationException {
        // ä¼ å…¥ç›®æ ‡ JVM pid
        VirtualMachine vm = VirtualMachine.attach("39333");
        vm.loadAgent("/Users/zen/operation_server_jar/operation-server.jar");
    }
}
```

- ç”±äºåœ¨MANIFEST.MFä¸­æŒ‡å®šäº†Agent-Classï¼Œæ‰€ä»¥åœ¨Attachåï¼Œç›®æ ‡JVMåœ¨è¿è¡Œæ—¶ä¼šèµ°åˆ°TestAgentç±»ä¸­å®šä¹‰çš„agentmain()æ–¹æ³•ï¼Œè€Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæˆ‘ä»¬åˆ©ç”¨Instrumentationï¼Œå°†æŒ‡å®šç±»çš„å­—èŠ‚ç é€šè¿‡å®šä¹‰çš„ç±»è½¬åŒ–å™¨TestTransformeråšäº†Baseç±»çš„å­—èŠ‚ç æ›¿æ¢ï¼ˆé€šè¿‡javassistï¼‰ï¼Œå¹¶å®Œæˆäº†ç±»çš„é‡æ–°åŠ è½½ã€‚ç”±æ­¤ï¼Œæˆ‘ä»¬è¾¾æˆäº†â€œåœ¨JVMè¿è¡Œæ—¶ï¼Œæ”¹å˜ç±»çš„å­—èŠ‚ç å¹¶é‡æ–°è½½å…¥ç±»ä¿¡æ¯â€çš„ç›®çš„ã€‚

ä»¥ä¸‹ä¸ºè¿è¡Œæ—¶é‡æ–°è½½å…¥ç±»çš„æ•ˆæœï¼šå…ˆè¿è¡ŒBaseä¸­çš„main()æ–¹æ³•ï¼Œå¯åŠ¨ä¸€ä¸ªJVMï¼Œå¯ä»¥åœ¨æ§åˆ¶å°çœ‹åˆ°æ¯éš”äº”ç§’è¾“å‡ºä¸€æ¬¡â€processâ€ã€‚æ¥ç€æ‰§è¡ŒAttacherä¸­çš„main()æ–¹æ³•ï¼Œå¹¶å°†ä¸Šä¸€ä¸ªJVMçš„pidä¼ å…¥ã€‚æ­¤æ—¶å›åˆ°ä¸Šä¸€ä¸ªmain()æ–¹æ³•çš„æ§åˆ¶å°ï¼Œå¯ä»¥çœ‹åˆ°ç°åœ¨æ¯éš”äº”ç§’è¾“å‡ºâ€processâ€å‰åä¼šåˆ†åˆ«è¾“å‡ºâ€startâ€å’Œâ€endâ€ï¼Œä¹Ÿå°±æ˜¯è¯´å®Œæˆäº†è¿è¡Œæ—¶çš„å­—èŠ‚ç å¢å¼ºï¼Œå¹¶é‡æ–°è½½å…¥äº†è¿™ä¸ªç±»ã€‚

![img](https://vue-admin-imgages.oss-cn-hangzhou.aliyuncs.com/2022-09-11/0b26c134-b474-4c75-8078-1a0fdc59f4fb_java-class-enhancer-8.png)

### ä½¿ç”¨åœºæ™¯

è‡³æ­¤ï¼Œå­—èŠ‚ç å¢å¼ºæŠ€æœ¯çš„å¯ä½¿ç”¨èŒƒå›´å°±ä¸å†å±€é™äºJVMåŠ è½½ç±»å‰äº†ã€‚é€šè¿‡ä¸Šè¿°å‡ ä¸ªç±»åº“ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¿è¡Œæ—¶å¯¹JVMä¸­çš„ç±»è¿›è¡Œä¿®æ”¹å¹¶é‡è½½äº†ã€‚é€šè¿‡è¿™ç§æ‰‹æ®µï¼Œå¯ä»¥åšçš„äº‹æƒ…å°±å˜å¾—å¾ˆå¤šäº†ï¼š

- çƒ­éƒ¨ç½²ï¼šä¸éƒ¨ç½²æœåŠ¡è€Œå¯¹çº¿ä¸ŠæœåŠ¡åšä¿®æ”¹ï¼Œå¯ä»¥åšæ‰“ç‚¹ã€å¢åŠ æ—¥å¿—ç­‰æ“ä½œã€‚
- Mockï¼šæµ‹è¯•æ—¶å€™å¯¹æŸäº›æœåŠ¡åšMockã€‚
- æ€§èƒ½è¯Šæ–­å·¥å…·ï¼šæ¯”å¦‚bTraceå°±æ˜¯åˆ©ç”¨Instrumentï¼Œå®ç°æ— ä¾µå…¥åœ°è·Ÿè¸ªä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„JVMï¼Œç›‘æ§åˆ°ç±»å’Œæ–¹æ³•çº§åˆ«çš„çŠ¶æ€ä¿¡æ¯ã€‚

## æ€»ç»“

å­—èŠ‚ç å¢å¼ºæŠ€æœ¯ç›¸å½“äºæ˜¯ä¸€æŠŠæ‰“å¼€è¿è¡Œæ—¶JVMçš„é’¥åŒ™ï¼Œåˆ©ç”¨å®ƒå¯ä»¥åŠ¨æ€åœ°å¯¹è¿è¡Œä¸­çš„ç¨‹åºåšä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥è·Ÿè¸ªJVMè¿è¡Œä¸­ç¨‹åºçš„çŠ¶æ€ã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬å¹³æ—¶ä½¿ç”¨çš„åŠ¨æ€ä»£ç†ã€AOPä¹Ÿä¸å­—èŠ‚ç å¢å¼ºå¯†åˆ‡ç›¸å…³ï¼Œå®ƒä»¬å®è´¨ä¸Šè¿˜æ˜¯åˆ©ç”¨å„ç§æ‰‹æ®µç”Ÿæˆç¬¦åˆè§„èŒƒçš„å­—èŠ‚ç æ–‡ä»¶ã€‚ç»¼ä¸Šæ‰€è¿°ï¼ŒæŒæ¡å­—èŠ‚ç å¢å¼ºåå¯ä»¥é«˜æ•ˆåœ°å®šä½å¹¶å¿«é€Ÿä¿®å¤ä¸€äº›æ£˜æ‰‹çš„é—®é¢˜ï¼ˆå¦‚çº¿ä¸Šæ€§èƒ½é—®é¢˜ã€æ–¹æ³•å‡ºç°ä¸å¯æ§çš„å‡ºå…¥å‚éœ€è¦ç´§æ€¥åŠ æ—¥å¿—ç­‰é—®é¢˜ï¼‰ï¼Œä¹Ÿå¯ä»¥åœ¨å¼€å‘ä¸­å‡å°‘å†—ä½™ä»£ç ï¼Œå¤§å¤§æé«˜å¼€å‘æ•ˆç‡ã€‚

## å‚è€ƒæ–‡çŒ®

- ã€ŠASM4-Guideã€‹
- Oracle:The class File Format
- Oracle:The Java Virtual Machine Instruction Set
- javassist tutorial
- JVM Tool Interface - Version 1.2

## ä½œè€…ç®€ä»‹

æ³½æ©ï¼Œç¾å›¢ç‚¹è¯„ç ”å‘å·¥ç¨‹å¸ˆã€‚

## æ–‡ç« æ¥æº

- ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ
- https://tech.meituan.com/2019/09/05/java-bytecode-enhancement.html